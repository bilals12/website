<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cookieJar</title>
    
<head>
    
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>cookieJar</title>
<meta name="description" content="">


<meta property="og:title" content="cookieJar">
<meta property="og:description" content="">

    
    



<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="cookieJar">
<meta name="twitter:description" content="">

    
    


    <base href="/">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/custom.css">
</head>
    <link rel="stylesheet" href="/css/custom.css">
</head>
<body>
    <div id="landing">
        <div id="landing-canva"></div>
        <div id="landing-content">
            <header>
    <a id="site-title" href="/">
        à¼§
    </a>
    <section id="social-links" class="header-group">
        
            <a href="mailto:bilal.s12@protonmail.com" class="header-icon" target="_blank" rel="noopener noreferrer">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
            </a>
        
            <a href="https://www.linkedin.com/in/bilal-s-b857601a/" class="header-icon" target="_blank" rel="noopener noreferrer">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg>
            </a>
        
            <a href="https://www.twitter.com/mescalinesun" class="header-icon" target="_blank" rel="noopener noreferrer">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg>
            </a>
        
            <a href="https://github.com/bilals12" class="header-icon" target="_blank" rel="noopener noreferrer">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
            </a>
        
            <a href="https://soundcloud.com/snr_1" class="header-icon" target="_blank" rel="noopener noreferrer">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M1.175 12.225c-.051 0-.094.046-.101.1l-.233 2.154.233 2.105c.007.058.05.098.101.098.05 0 .09-.04.099-.098l.255-2.105-.27-2.154c0-.057-.045-.1-.09-.1m-.899.828c-.06 0-.091.037-.104.094L0 14.479l.165 1.308c0 .055.045.094.09.094s.089-.045.104-.104l.21-1.319-.21-1.334c0-.061-.044-.09-.09-.09m1.83-1.229c-.061 0-.12.045-.12.104l-.21 2.563.225 2.458c0 .06.045.12.119.12.061 0 .105-.061.121-.12l.254-2.474-.254-2.548c-.016-.06-.061-.12-.121-.12m.945-.089c-.075 0-.135.06-.15.135l-.193 2.64.21 2.544c.016.077.075.138.149.138.075 0 .135-.061.15-.15l.24-2.532-.24-2.623c0-.075-.06-.135-.135-.135l-.031-.017zm1.155.36c-.005-.09-.075-.149-.159-.149-.09 0-.158.06-.164.149l-.217 2.43.2 2.563c0 .09.075.157.159.157.074 0 .148-.068.148-.158l.227-2.563-.227-2.444.033.015zm.809-1.709c-.101 0-.18.09-.18.181l-.21 3.957.187 2.563c0 .09.08.164.18.164.094 0 .174-.09.18-.18l.209-2.563-.209-3.972c-.008-.104-.088-.18-.18-.18m.959-.914c-.105 0-.195.09-.203.194l-.18 4.872.165 2.548c0 .12.09.209.195.209.104 0 .194-.089.21-.209l.193-2.548-.192-4.856c-.016-.12-.105-.21-.21-.21m.989-.449c-.121 0-.211.089-.225.209l-.165 5.275.165 2.52c.014.119.104.225.225.225.119 0 .225-.105.225-.225l.195-2.52-.196-5.275c0-.12-.105-.225-.225-.225m1.245.045c0-.135-.105-.24-.24-.24-.119 0-.24.105-.24.24l-.149 5.441.149 2.503c.016.135.121.24.256.24s.24-.105.24-.24l.164-2.503-.164-5.456-.016.015zm.749-.134c-.135 0-.255.119-.255.254l-.15 5.322.15 2.473c0 .15.12.255.255.255s.255-.12.255-.27l.15-2.474-.165-5.307c0-.148-.12-.27-.271-.27m1.005.166c-.164 0-.284.135-.284.285l-.103 5.143.135 2.474c0 .149.119.277.284.277.149 0 .271-.12.284-.285l.121-2.443-.135-5.112c-.012-.164-.135-.285-.285-.285m1.184-.945c-.045-.029-.105-.044-.165-.044s-.119.015-.165.044c-.09.054-.149.15-.149.255v.061l-.104 6.048.115 2.449v.008c.008.06.03.135.074.18.058.061.142.104.234.104.08 0 .158-.044.209-.09.058-.06.091-.135.091-.225l.015-.24.117-2.203-.135-6.086c0-.104-.061-.193-.135-.239l-.002-.022zm1.006-.547c-.045-.045-.09-.061-.15-.061-.074 0-.149.016-.209.061-.075.061-.119.15-.119.24v.029l-.137 6.609.076 1.215.061 1.185c0 .164.148.314.328.314.181 0 .33-.15.33-.329l.15-2.414-.15-6.637c0-.12-.074-.221-.165-.277m8.934 3.777c-.405 0-.795.086-1.139.232-.24-2.654-2.46-4.736-5.188-4.736-.659 0-1.305.135-1.889.359-.225.09-.27.18-.285.359v9.368c.016.18.15.33.33.345h8.185C22.681 17.218 24 15.914 24 14.28s-1.319-2.952-2.938-2.952"/></svg>
            </a>
        
            <a href="https://letterboxd.com/mescalinesun/" class="header-icon" target="_blank" rel="noopener noreferrer">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round"><path d="M8.224 14.352a4.447 4.447 0 0 1-3.775 2.092C1.992 16.444 0 14.454 0 12s1.992-4.444 4.45-4.444c1.592 0 2.988.836 3.774 2.092-.427.682-.673 1.488-.673 2.352s.246 1.67.673 2.352zM15.101 12c0-.864.247-1.67.674-2.352-.786-1.256-2.183-2.092-3.775-2.092s-2.989.836-3.775 2.092c.427.682.674 1.488.674 2.352s-.247 1.67-.674 2.352c.786 1.256 2.183 2.092 3.775 2.092s2.989-.836 3.775-2.092A4.42 4.42 0 0 1 15.1 12zm4.45-4.444a4.447 4.447 0 0 0-3.775 2.092c.427.682.673 1.488.673 2.352s-.246 1.67-.673 2.352a4.447 4.447 0 0 0 3.775 2.092C22.008 16.444 24 14.454 24 12s-1.992-4.444-4.45-4.444z"/></svg>
            </a>
        
            <a href="https://leetcode.com/0xME/" class="header-icon" target="_blank" rel="noopener noreferrer">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="0" stroke-linecap="round" stroke-linejoin="round"><path d="M16.102 17.93l-2.697 2.607c-.466.467-1.111.662-1.823.662s-1.357-.195-1.824-.662l-4.332-4.363c-.467-.467-.702-1.15-.702-1.863s.235-1.357.702-1.824l4.319-4.38c.467-.467 1.125-.645 1.837-.645s1.357.195 1.823.662l2.697 2.606c.514.515 1.365.497 1.9-.038.535-.536.553-1.387.039-1.901l-2.609-2.636a5.055 5.055 0 0 0-2.445-1.337l2.467-2.503c.516-.514.498-1.366-.037-1.901-.535-.535-1.387-.552-1.902-.038l-10.1 10.101c-.981.982-1.494 2.337-1.494 3.835 0 1.498.513 2.895 1.494 3.875l4.347 4.361c.981.979 2.337 1.452 3.834 1.452s2.853-.512 3.835-1.494l2.609-2.637c.514-.514.496-1.365-.039-1.9s-1.386-.553-1.899-.039zM20.811 13.01H10.666c-.702 0-1.27.604-1.27 1.346s.568 1.346 1.27 1.346h10.145c.701 0 1.27-.604 1.27-1.346s-.569-1.346-1.27-1.346z"/></svg>
            </a>
        
        <a href="/index.xml" class="header-icon">
            
        </a>
    </section>
</header>
            
<div id="content-area" data-page-type="single">
    <button id="back-button"></button>
    <article id="post">
        <h1 id="post-title">cookieJar</h1>
        <time datetime="2024-01-02T10:11:43-05:00" class="post-date-time">
            Jan 2, 2024
        </time>
        <div id="post-content" class="markdown-content">
            <p>a fun aspect of pentesting is finding interesting ways to get authenticated sessions running. usually, a session authentication relies on the user entering some kind of key (password) that corresponds to their user ID (username). however, in some cases an attacker can &ldquo;revive&rdquo; sessions using just the session cookies.</p>
<p>i wrote <code>cookieJar</code> for exactly this purpose: extracting cookies from various browsers (and factor in the OS) and then use them to create authenticated sessions. the script handles different formats and encryption methods (see: <code>Cryptodome</code>) and can extract cookies related to all websites or a specific domain.</p>
<p>some limitiations of the script:</p>
<p>if browsers update their cookie storage mechanisms (very likely), the script will stop working.</p>
<p>accounts with 2FA will stop the script from working.</p>
<p>sessions are managed server-side, so if specific parameters like user-agent, IP address, etc. don&rsquo;t line up, the script will stop working.</p>
<p>consent + security risks&hellip;</p>
<p><code>cookieJar</code> uses several libraries and modules to retrieve, decrypt, and manage browser cookies across multiple browsers and operating systems. arguably, the most important module i&rsquo;ve used is <code>Cryptodome</code>, which is included in the <a href="https://github.com/bilals12/cookieJar">source repo</a>.</p>
<h2 id="cryptodome">Cryptodome</h2>
<p>the <code>Cryptodome</code> module contains the <code>pycryptodome</code> library, which is used for secure hashing and encryption services. in the context of <code>cookieJar</code>, it&rsquo;s used for decrypting cookies.</p>
<p><code>AES.py</code>: used for decrypting cookies from browsers like chrome, opera, edge.</p>
<p><code>KDF.py</code>: a key derivation function that&rsquo;s used to generate a cryptographic key from a password. used in the <code>PBKDF2</code> function in <code>cookieJar</code>.</p>
<p><code>padding.py</code>: used in block cipher algorithms to ensure that the last block of data is the correct size. used in <code>unpad</code> to remove padding from the decrypted data.</p>
<p><code>lz4.block</code>: part of the <code>lz4</code> library, which provides bindings for the LZ4 compression algorithm. used specifically for handling cookies from firefox, which uses the compression algorithm to store its cookies.</p>
<h2 id="cookiejar">cookieJar</h2>
<p><img src="/download.png" alt="flowchart"></p>
<p><code>cookieJar</code> is a comprehensive python script for security research and penetration testing, as it allows researchers to analyze the cookies stored by a browser, which can contain sensitive information such as session identifiers and login tokens.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-http" data-lang="http"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;http.cookiejar.Cookie version=0 name=&#39;sessionid&#39; value=&#39;1234567890abcdef&#39; port=None port_specified=False domain=&#39;instagram.com&#39; domain_specified=True domain_initial_dot=False path=&#39;/&#39; path_specified=True secure=True expires=1672444800 discard=False comment=None comment_url=None rest={&#39;HttpOnly&#39;: None}, rfc2109=False&gt;
</span></span></span></code></pre></div><p>this cookie has the following properties:</p>
<p><code>name</code>: the name of the cookie (<code>sessionid</code>).</p>
<p><code>value</code>: the value of the cookie, usually a unique identifier that the server uses to recognize the client.</p>
<p><code>domain</code>: the domain that set the cookie (<code>instagram.com</code>).</p>
<p><code>path</code>: path on the domain where the cookie is valid. in this case, it&rsquo;s <code>/</code>, meaning the cookie is valid for the entire domain.</p>
<p><code>secure</code>: a boolean value indicating whether the cookie should only be sent over secure (<code>HTTPS</code>) connections.</p>
<p><code>expires</code>: expiration date of the cookie as a timestamp (<code>1672444800</code> corresponds to january 1st, 2024).</p>
<p><code>HttpOnly</code>: a flag indicating whether the cookie is inaccessible to javascript&rsquo;s <code>Document.cookie</code> API to mitigate XSS attacks.</p>
<p>the actual data stored in a cookie can vary greatly depending on the website and the purpose of the cookie. for example, a session cookie might contain a unique identifier that the server uses to keep track of your session, while a preference cookie might contain information about your preferred language or other settings.</p>
<p>when <code>cookieJar</code> collects cookies, it stores them in a <code>http.cookiejar.CookieJar</code> object. this object behaves like a list of <code>http.cookiejar.Cookie</code> objects, and you can iterate over it to access individual cookies.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>cookies <span style="color:#f92672">=</span> load()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> cookie <span style="color:#f92672">in</span> cookies:
</span></span><span style="display:flex;"><span>  print(cookie)
</span></span></code></pre></div><p>this will print out all the cookies stored in the <code>CookieJar</code>, one per line.</p>
<h2 id="importing-necessary-libraries">importing necessary libraries</h2>
<p>the script first imports some standard and 3rd-party libraries. they provide the necessary functionalities for file handling, database operations, encryption and more.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> configparser
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> contextlib
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> glob
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> http.cookiejar
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> struct
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> subprocess
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> tempfile
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> io <span style="color:#f92672">import</span> BytesIO
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Union
</span></span></code></pre></div><p>it also imports the <code>sqlite3</code> library, which is used to interact with SQLite databases that many browsers use to store cookies. if the <code>pysqlite2.dbapi2</code> module is available, it&rsquo;s used instead of the standard <code>sqlite3</code> module (improved performance + additional features).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">from</span> pysqlite2 <span style="color:#f92672">import</span> dbapi2 <span style="color:#66d9ef">as</span> sqlite3
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ImportError</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> sqlite3
</span></span></code></pre></div><p>for linux/BSD, the script imports either <code>dbus</code> or <code>jeepney</code>. these are used to interact with the d-bus message system, a mechanism that allows different parts of the system to communicate with each other. in this case, it&rsquo;s used to retrieve the encryption key for cookies from the system&rsquo;s keyring.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> sys<span style="color:#f92672">.</span>platform<span style="color:#f92672">.</span>startswith(<span style="color:#e6db74">&#39;linux&#39;</span>) <span style="color:#f92672">or</span> <span style="color:#e6db74">&#39;bsd&#39;</span> <span style="color:#f92672">in</span> sys<span style="color:#f92672">.</span>platform<span style="color:#f92672">.</span>lower():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">import</span> dbus
</span></span><span style="display:flex;"><span>        USE_DBUS_LINUX <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ImportError</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">import</span> jeepney
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">from</span> jeepney.io.blocking <span style="color:#f92672">import</span> open_dbus_connection
</span></span><span style="display:flex;"><span>        USE_DBUS_LINUX <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span></code></pre></div><p>the <code>lz4.block</code> is imported for handling LZ4-compressed cookies from firefox. LZ4 is a fast, lossless compression algorithm that firefox uses to store its cookies.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> lz4.block
</span></span></code></pre></div><p>finally, the script imports the aforementioned modules from the <code>Cryptodome</code> library.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> Cryptodome.Cipher <span style="color:#f92672">import</span> AES
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> Cryptodome.Protocol.KDF <span style="color:#f92672">import</span> PBKDF2
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> Cryptodome.Util.Padding <span style="color:#f92672">import</span> unpad
</span></span></code></pre></div><h2 id="defining-constants--helper-functions">defining constants + helper functions</h2>
<p>the script defines a constant for the default chromium password, used as the key for encrypting cookies in chromium-based browsers. it also defines a custom exception class for browser cookie errors.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ChromiumBasedBrowser</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># decrypt the cookie value</span>
</span></span><span style="display:flex;"><span>        value <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>_decrypt(value, enc_value)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_decrypt</span>(self, value, encrypted_value):
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> aes<span style="color:#f92672">.</span>decrypt_and_verify(encrypted_value[<span style="color:#ae81ff">12</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">16</span>], tag)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> data<span style="color:#f92672">.</span>decode()
</span></span></code></pre></div><p>the firefox class handles cookies from firefox, using the <code>lz4.block</code> module to decompress LZ4-compressed cookies.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Firefox</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__add_session_cookies_lz4</span>(self, cj):
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        json_data <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(lz4<span style="color:#f92672">.</span>block<span style="color:#f92672">.</span>decompress(file_obj<span style="color:#f92672">.</span>read()))
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span></code></pre></div><h2 id="loading-cookies-from-all-browsers">loading cookies from all browsers</h2>
<p>the <code>load</code> function loads cookies from all supported browsers and returns them in a combined <code>http.cookiejar.CookieJar</code> object. this function iterates over a list of functions that load cookies from each supported browser, and adds all the cookies they return to a single <code>CookieJar</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load</span>(domain_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># function to load cookies from all supported browsers and return combined cookie jar</span>
</span></span><span style="display:flex;"><span>    cj <span style="color:#f92672">=</span> http<span style="color:#f92672">.</span>cookiejar<span style="color:#f92672">.</span>CookieJar()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> cookie_fn <span style="color:#f92672">in</span> [chrome, chromium, opera, opera_gx, brave, edge, vivaldi, firefox, safari]:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> cookie <span style="color:#f92672">in</span> cookie_fn(domain_name<span style="color:#f92672">=</span>domain_name):
</span></span><span style="display:flex;"><span>                cj<span style="color:#f92672">.</span>set_cookie(cookie)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> BrowserCookieError:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> cj
</span></span></code></pre></div><p>the script includes a separate class for each browser, as each browser stores its cookies differently. these classes inherit from the <code>Browser</code> base class, which provides common functionality, and override the <code>load</code> method to implement specific cookie extraction and decryption.</p>
<p>for example, the <code>Chrome</code> class handles cookies from google chrome.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Chrome</span>(ChromiumBasedBrowser):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, cookie_file<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, domain_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>, key_file<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        super()<span style="color:#f92672">.</span>__init__(cookie_file, domain_name, key_file)
</span></span></code></pre></div><p>the firefox class handles cookies from firefox, but overrides the <code>load</code> method to handle firefox unique cookie storage format.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Firefox</span>(Browser):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, cookie_file<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, domain_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>):
</span></span><span style="display:flex;"><span>        super()<span style="color:#f92672">.</span>__init__(cookie_file, domain_name)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span></code></pre></div><h2 id="decrypting-cookies">decrypting cookies</h2>
<p>the ability to decrypt encrypted cookies is the most important part of <code>cookieJar</code>. it&rsquo;s done using the <code>Cryptodome</code> library, which provides a variety of cryptographic recipes and primitives.</p>
<p>the decryption process varies depending on the browser and the OS. for example, chromium-based browsers on windows use the windows data protection API (DPAPI) to encrypt cookies, while on linux/macOS, they use AES encryption with a key derived from a predefined password.</p>
<p>the <code>_decrypt</code> method in the <code>ChromiumBasedBrowser</code> handles this decryption process. it first checks the OS, then uses the appropriate decryption method.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_decrypt</span>(self, value, encrypted_value):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># method to decrypt encoded cookies</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> sys<span style="color:#f92672">.</span>platform <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;win32&#39;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># try to decrypt using the Windows Chromium method</span>
</span></span><span style="display:flex;"><span>            decrypted_value <span style="color:#f92672">=</span> _crypt_unprotect_data(encrypted_value)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> value
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># for Linux &amp; Mac, we have to remove the &#39;v10&#39; or &#39;v11&#39; prefix</span>
</span></span><span style="display:flex;"><span>        encrypted_value <span style="color:#f92672">=</span> encrypted_value[<span style="color:#ae81ff">3</span>:]
</span></span><span style="display:flex;"><span>        nonce, tag <span style="color:#f92672">=</span> encrypted_value[:<span style="color:#ae81ff">12</span>], encrypted_value[<span style="color:#f92672">-</span><span style="color:#ae81ff">16</span>:]
</span></span><span style="display:flex;"><span>        cipher <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>new(self<span style="color:#f92672">.</span>v10_key, AES<span style="color:#f92672">.</span>MODE_GCM, nonce<span style="color:#f92672">=</span>nonce)
</span></span><span style="display:flex;"><span>        decrypted_value <span style="color:#f92672">=</span> cipher<span style="color:#f92672">.</span>decrypt_and_verify(encrypted_value[<span style="color:#ae81ff">12</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">16</span>], tag)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> decrypted_value<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)
</span></span></code></pre></div><p>in the case of windows, the <code>_crypt_unprotect_data</code> function is used to decrypt the cookie using the DPAPI. this function uses the <code>CryptUnprotectData</code> function from the <code>crypt32.dll</code> library, which is a part of the windows API.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_crypt_unprotect_data</span>(
</span></span><span style="display:flex;"><span>        cipher_text<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>, entropy<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>, reserved<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, prompt_struct<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, is_key<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>):
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> ctypes<span style="color:#f92672">.</span>windll<span style="color:#f92672">.</span>crypt32<span style="color:#f92672">.</span>CryptUnprotectData(
</span></span><span style="display:flex;"><span>            ctypes<span style="color:#f92672">.</span>byref(blob_in), ctypes<span style="color:#f92672">.</span>byref(desc), ctypes<span style="color:#f92672">.</span>byref(blob_entropy),
</span></span><span style="display:flex;"><span>            reserved, prompt_struct, CRYPTPROTECT_UI_FORBIDDEN, ctypes<span style="color:#f92672">.</span>byref(blob_out)
</span></span><span style="display:flex;"><span>    ):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># if the function fails, raise a RuntimeError</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">RuntimeError</span>(<span style="color:#e6db74">&#39;Failed to decrypt the cipher text with DPAPI&#39;</span>)  <span style="color:#75715e"># raise an error</span>
</span></span></code></pre></div><p>on linux/macOS, the script uses the AES algorithm from the <code>Cryptodome.Cipher</code> module to decrypt the cookies. the key for the AES encryption is derived from the predefined password using the PBKDF2 algorithm from the <code>Cryptodome.Protocol.KDF</code> module.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>aes <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>new(self<span style="color:#f92672">.</span>v10_key, AES<span style="color:#f92672">.</span>MODE_GCM, nonce<span style="color:#f92672">=</span>nonce)
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> aes<span style="color:#f92672">.</span>decrypt_and_verify(encrypted_value[<span style="color:#ae81ff">12</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">16</span>], tag)
</span></span></code></pre></div><h2 id="error-handling">error handling</h2>
<p>issues can arise when dealing with cookies. for example, if a browser&rsquo;s cookies are stored in a SQLite database, and that database is locked because the browser is currently using it, the script creates a temporary copy of the database to avoid a locking error.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_create_local_copy</span>(cookie_file):
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> contextlib<span style="color:#f92672">.</span>closing(sqlite3<span style="color:#f92672">.</span>connect(<span style="color:#e6db74">&#39;file:</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">?mode=ro&#39;</span><span style="color:#f92672">.</span>format(pathname2url(cookie_file)), uri<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)) <span style="color:#66d9ef">as</span> conn:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> tempfile<span style="color:#f92672">.</span>TemporaryFile() <span style="color:#66d9ef">as</span> tmp_file:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> conn<span style="color:#f92672">.</span>iterdump():
</span></span><span style="display:flex;"><span>                tmp_file<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(line)<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span><span style="display:flex;"><span>            tmp_file<span style="color:#f92672">.</span>seek(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>            conn_temp <span style="color:#f92672">=</span> sqlite3<span style="color:#f92672">.</span>connect(<span style="color:#e6db74">&#39;file:</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">?mode=rw&#39;</span><span style="color:#f92672">.</span>format(pathname2url(tmp_file<span style="color:#f92672">.</span>name)), uri<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> conn_temp
</span></span></code></pre></div><p>the script also includes a custom exception class: <code>BrowserCookieError</code>. it&rsquo;s raised when there&rsquo;s an error retrieving or decrypting cookies, this allows the script to fail gracefully and provide usefull error messages.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BrowserCookieError</span>(<span style="color:#a6e22e">Exception</span>): <span style="color:#66d9ef">pass</span>
</span></span></code></pre></div><h2 id="conclusion">conclusion</h2>
<p>i wrote this for the same reason i wrote everything else: education. <code>cookieJar</code> illustrates key security concepts, specifically those related to web security, encryption, and data storage.</p>

        </div>
    </article>
    <div id="bottom-back-button-placeholder"></div>
</div>

        </div>
    </div>
    <script src="/p5/p5.min.js"></script>
    <script src="/js/genart.js"></script>
    <script src="/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            setupGenArt();
        });
    </script>
</body>
</html>